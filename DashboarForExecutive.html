<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ค้นหาใบแจ้งซ่อมพร้อมรายละเอียดช่าง</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f0f4f8;
      margin: 0; padding: 1rem;
      color: #1e293b; font-size: 0.9rem;
    }
    h1 {
      text-align: left;
      color: #1d4ed8;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    .search-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-start;
      margin-bottom: 1rem;
      align-items: center;
    }
    .search-bar select,
    .search-bar input[type="date"] {
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-size: 0.9rem;
      min-width: 140px;
    }
    .search-bar button {
      background: #1d4ed8;
      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .search-bar button:hover {
      background: #1e40af;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgb(100 116 139 / 0.1);
      font-size: 0.9rem;
      table-layout: fixed;
      margin-bottom: 1rem;
    }

    thead {
      background: #2563eb;
      color: white;
    }

    th, td {
      padding: 0.5rem 0.75rem;
      border: 1px solid #e2e8f0;
      text-align: left;
      vertical-align: middle;
      word-break: break-word;
    }
    table {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
    }

    th:nth-child(1), td:nth-child(1) { width: 50px;  text-align: left;}    /* ว/ด/ป */
    th:nth-child(2), td:nth-child(2) { width: 70px; text-align: center;}  /* ช่างผู้ทำ */
    th:nth-child(3), td:nth-child(3) { width: 100px;  text-align: center;}    /* เวลา */
    th:nth-child(4), td:nth-child(4) { width: 70px;  text-align: left;}    /* ใบแจ้งซ่อม */
    th:nth-child(5), td:nth-child(5) { width: 60px;  text-align: left;}    /* แผนก */
    th:nth-child(6), td:nth-child(6) { width: 140px; text-align: left; }    /* ชื่อเครื่อง */
    th:nth-child(7), td:nth-child(7) { width: 240px; text-align: left; }    /* ปัญหาอาการ */
    th:nth-child(8), td:nth-child(8) { width: 260px; text-align: left; }    /* การแก้ไข */
    th:nth-child(9), td:nth-child(9) { width: 70px; text-align: center; }  /* สถานะ */

    tbody tr:hover {
      background: #f0f9ff;
    }

    .status {
      padding: 0.15rem 0.5rem;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 0.75rem;
      display: inline-block;
    }

    .status.ซ่อมเสร็จ { background: #34d399; color: #065f46; }
    .status.รออะไหล่ { background: #fde68a; color: #92400e; }
    .status.อยู่ระหว่างดำเนินการ { background: #bfdbfe; color: #1e40af; }
    .status.ยกเลิกซ่อม { background: #fecaca; color: #991b1b; }
    .status.ไม่จบงาน { background: #fbbf24; color: #92400e; }
    .status.จบงาน { background: #34d399; color: #065f46; }

    #noData {
      text-align: center;
      margin-top: 2rem;
      color: #64748b;
      font-style: italic;
    }

    /* กราฟ */
    #chartsContainer {
      display: flex;
      gap: 1rem;
      justify-content: flex-start;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .chartBox {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgb(100 116 139 / 0.1);
      width: 260px;
      height: 260px;
    }
    .chartTitle {
      text-align: center;
      font-weight: 600;
      color: #1d4ed8;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        display: none;
      }
      tbody tr {
        margin-bottom: 1rem;
        background: white;
        box-shadow: 0 2px 8px rgb(100 116 139 / 0.1);
        border-radius: 10px;
        padding: 1rem;
      }
      tbody td {
        padding-left: 50%;
        position: relative;
        border: none;
        border-bottom: 1px solid #e2e8f0;
        text-align: right;
        font-size: 0.9rem;
      }
      tbody td:last-child {
        border-bottom: none;
      }
      tbody td::before {
        content: attr(data-label);
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-weight: 700;
        color: #334155;
        text-align: left;
        white-space: nowrap;
        width: 45%;
        font-size: 0.85rem;
      }

      #chartsContainer {
        justify-content: center;
      }
      .chartBox {
        width: 100%;
        max-width: 350px;
        height: 320px;
      }
    }
  </style>
</head>
<body>
  <h1>Maintenance Report</h1>
  <div class="search-bar">
    <input type="date" id="searchDateFrom" />
    <input type="date" id="searchDateTo" />
    <select id="searchDepartment">
      <option value="">-- หน่วยงาน --</option>
    </select>
    <select id="searchStatus">
      <option value="">-- สถานะ --</option>
      <option value="ไม่จบงาน">ไม่จบงาน</option>
      <option value="จบงาน">จบงาน</option>
    </select>
    <button onclick="searchData()">ค้นหา</button>
    <button onclick="resetSearch()">รีเซ็ต</button>
  </div>

  <div id="chartsContainer">
    <div class="chartBox">
      <div class="chartTitle">งานซ่อม แยกตามสถานะ</div>
      <canvas id="statusChart"></canvas>
    </div>
    <div class="chartBox">
      <div class="chartTitle">งานซ่อม แยกตามช่าง</div>
      <canvas id="empChart"></canvas>
    </div>
  </div>

  <table id="dataTable" style="display:none;">
    <thead>
      <tr>
        <th>ว/ด/ป</th>
        <th>ช่าง</th>
        <th>เวลา</th>
        <th>เลขที่</th>
        <th>แผนก</th>
        <th>ชื่อเครื่อง</th>
        <th>ปัญหา</th>
        <th>การแก้ไข</th>
        <th>สถานะ</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div id="noData" style="display:none;">ไม่พบข้อมูล</div>

  <script>
    const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
    const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

    const departmentsMap = {};
    let machinesMap = {};
    let empMap = {};
    let repairTechniciansMap = {};
    let cacheData = [];

    let statusChart, empChart;

    async function fetchDepartments() {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/Department/Find`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
        body: JSON.stringify({})
      });
      const data = await res.json();
      const select = document.getElementById("searchDepartment");
      data.forEach(d => {
        departmentsMap[d.DeptCode] = d.DeptNameEng || d.DeptName || d.DeptCode;
        const opt = document.createElement("option");
        opt.value = d.DeptCode;
        opt.textContent = departmentsMap[d.DeptCode];
        select.appendChild(opt);
      });
    }

    async function fetchMachines() {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Find`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
        body: JSON.stringify({})
      });
      const data = await res.json();
      machinesMap = {};
      data.forEach(m => {
        machinesMap[m["รหัสเครื่อง"]] = m["รายชื่อเครื่องจักร"] || m["รหัสเครื่อง"];
      });
    }

    async function fetchEmp() {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/Emp/Find`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
        body: JSON.stringify({})
      });
      const data = await res.json();
      empMap = {};
      data.forEach(e => {
        empMap[e.EmpCode] = e.EmpName || e.EmpNameEng || e.EmpCode;
      });
    }

    async function fetchRepairTechnicians() {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Find`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
        body: JSON.stringify({})
      });
      const data = await res.json();
      repairTechniciansMap = {};
      data.forEach(r => {
        const rqNo = r["เลขที่ใบแจ้งซ่อม"];
        if (!repairTechniciansMap[rqNo]) repairTechniciansMap[rqNo] = [];
        repairTechniciansMap[rqNo].push(r);
      });
    }

    async function fetchRepairRequests() {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/Machinesymptom/Find`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
        body: JSON.stringify({})
      });
      cacheData = await res.json();
    }

    function formatDateTH(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      if (isNaN(d)) return "-";
      const day = d.getDate().toString().padStart(2, "0");
      const month = (d.getMonth() + 1).toString().padStart(2, "0");
      const year = d.getFullYear() + 543;
      return `${day}/${month}/${year}`;
    }

    function formatDuration(mins) {
      if (!mins || isNaN(mins)) return "-";
      return mins < 60 ? `${mins} นาที` : `${Math.floor(mins / 60)} ชม.${mins % 60 > 0 ? ` ${mins % 60} นาที` : ""}`;
    }

    function calcDurationMinutes(start, end) {
      const d1 = new Date(start), d2 = new Date(end);
      return (!isNaN(d1) && !isNaN(d2)) ? Math.round((d2 - d1) / 60000) : null;
    }

    // กำหนดลำดับช่างตามที่ขอ
    const preferredEmpOrder = ["เกษม", "เอกพันธ์", "สมเจตน์"];

    function renderTableGroupedByDateAndEmp(requestFilter = null, statusFilter = "") {
      const tbody = document.getElementById("tableBody");
      const table = document.getElementById("dataTable");
      const noData = document.getElementById("noData");
      tbody.innerHTML = "";

      let rows = [];
      const dateGroup = {};

      Object.entries(repairTechniciansMap).forEach(([requestNumber, techList]) => {
        if (requestFilter && !requestFilter.includes(requestNumber)) return;
        const mainData = cacheData.find(row => row["เลขที่ใบแจ้งซ่อม"] === requestNumber);
        if (!mainData) return;

        techList.forEach(tech => {
          if (statusFilter && tech["สถานะของงานช่าง"] !== statusFilter) return;

          const startDateFormatted = formatDateTH(tech["เวลาเริ่ม"]);
          if (!dateGroup[startDateFormatted]) dateGroup[startDateFormatted] = {};
          const empName = empMap[tech.EmpCode] || tech.EmpCode;
          if (!dateGroup[startDateFormatted][empName]) dateGroup[startDateFormatted][empName] = [];

          const durationMins = calcDurationMinutes(tech["เวลาเริ่ม"], tech["เวลาจบ"]) || 0;
          const timeRange = tech["เวลาเริ่ม"] && tech["เวลาจบ"]
            ? `${new Date(tech["เวลาเริ่ม"]).toLocaleTimeString('th-TH', { hour12: false })} - ${new Date(tech["เวลาจบ"]).toLocaleTimeString('th-TH', { hour12: false })}`
            : "-";

          dateGroup[startDateFormatted][empName].push({
            startDate: new Date(tech["เวลาเริ่ม"]),
            empName,
            timeRange,
            durationMins,
            durationStr: formatDuration(durationMins),
            requestNumber,
            department: departmentsMap[mainData["หน่วยงาน"]] || "-",
            machineName: machinesMap[mainData["รหัสเครื่อง"]] || "-",
            symptom: mainData["รายละเอียดอาการเสีย"] || "-",
            comment: tech["การแก้ไขความคิดเห็น"] || "-",
            statusRaw: tech["สถานะของงานช่าง"] || "-",
            statusClass: (tech["สถานะของงานช่าง"] || "-").replace(/\s/g, "")
          });
        });
      });

      // เรียงวันที่ใหม่ → เก่า
      const sortedDates = Object.keys(dateGroup).sort((a,b) => {
        const toDate = str => {
          const [d,m,y] = str.split("/");
          return new Date(y-543, m-1, d);
        };
        return toDate(b) - toDate(a);
      });

      sortedDates.forEach(dateStr => {
        const empGroup = dateGroup[dateStr];
        // เรียงช่างตาม preferred order ที่กำหนดก่อน
        const sortedEmps = Object.keys(empGroup).sort((a,b) => {
          const aIndex = preferredEmpOrder.indexOf(a);
          const bIndex = preferredEmpOrder.indexOf(b);
          if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
          if (aIndex === -1) return 1;
          if (bIndex === -1) return -1;
          return aIndex - bIndex;
        });

        sortedEmps.forEach(empName => {
          empGroup[empName].sort((a,b) => b.durationMins - a.durationMins);
          empGroup[empName].forEach(item => rows.push(item));
        });
      });

      if (rows.length === 0) {
        table.style.display = "none";
        noData.style.display = "block";
      } else {
        table.style.display = "table";
        noData.style.display = "none";
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td data-label="ว/ด/ป">${formatDateTH(r.startDate)}</td>
            <td data-label="ช่าง">${r.empName}</td>
            <td data-label="เวลา" style="text-align:center;">
              <div style="font-size:0.85rem;">${r.timeRange}</div>
              <div style="color:#555; font-weight:600;">${r.durationStr}</div>
            </td>
            <td data-label="เลขที่">${r.requestNumber}</td>
            <td data-label="แผนก">${r.department}</td>
            <td data-label="ชื่อเครื่อง">${r.machineName}</td>
            <td data-label="ปัญหา">${r.symptom}</td>
            <td data-label="การแก้ไข">${r.comment}</td>
            <td data-label="สถานะ" style="text-align:center;">
              <span class="status ${r.statusClass}">${r.statusRaw}</span>
            </td>
          </tr>
        `).join("");
      }
    }

    function getStatusCount(filteredList, statusFilter) {
      const counts = {};
      filteredList.forEach(rqNo => {
        const techs = repairTechniciansMap[rqNo];
        if (!techs) return;
        techs.forEach(t => {
          if (statusFilter && t["สถานะของงานช่าง"] !== statusFilter) return;
          const st = t["สถานะของงานช่าง"] || "-";
          counts[st] = (counts[st] || 0) + 1;
        });
      });
      return counts;
    }

    function getEmpCount(filteredList, statusFilter) {
      const counts = {};
      filteredList.forEach(rqNo => {
        const techs = repairTechniciansMap[rqNo];
        if (!techs) return;
        techs.forEach(t => {
          if (statusFilter && t["สถานะของงานช่าง"] !== statusFilter) return;
          const empName = empMap[t.EmpCode] || t.EmpCode;
          counts[empName] = (counts[empName] || 0) + 1;
        });
      });
      return counts;
    }

    function updateCharts(filtered, statusFilter) {
      const ctxStatus = document.getElementById("statusChart").getContext("2d");
      const ctxEmp = document.getElementById("empChart").getContext("2d");

      // สถานะ
      const statusCount = getStatusCount(filtered, statusFilter);
      const statusLabels = Object.keys(statusCount);
      const statusData = statusLabels.map(l => statusCount[l]);
      const statusColors = statusLabels.map(l => {
        switch(l) {
          case "จบงาน": return "#34d399";
          case "ไม่จบงาน": return "#fbbf24";
          case "รออะไหล่": return "#fde68a";
          case "อยู่ระหว่างดำเนินการ": return "#bfdbfe";
          case "ยกเลิกซ่อม": return "#fecaca";
          case "ซ่อมเสร็จ": return "#34d399";
          default: return "#9ca3af";
        }
      });

      // ช่าง
      const empCount = getEmpCount(filtered, statusFilter);
      const empLabels = Object.keys(empCount);
      const empData = empLabels.map(l => empCount[l]);
      const empColors = empLabels.map((_, i) => `hsl(${i * 40 % 360}, 70%, 60%)`);

      if (statusChart) statusChart.destroy();
      if (empChart) empChart.destroy();

      statusChart = new Chart(ctxStatus, {
        type: "doughnut",
        data: {
          labels: statusLabels,
          datasets: [{
            data: statusData,
            backgroundColor: statusColors,
            borderWidth: 0,
          }]
        },
        options: {
          plugins: {
            legend: {
              position: "bottom",
              labels: { font: { size: 12 } }
            },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${ctx.parsed} งาน`
              }
            }
          },
          cutout: "70%",
          responsive: true,
          maintainAspectRatio: false,
        }
      });

      empChart = new Chart(ctxEmp, {
        type: "doughnut",
        data: {
          labels: empLabels,
          datasets: [{
            data: empData,
            backgroundColor: empColors,
            borderWidth: 0,
          }]
        },
        options: {
          plugins: {
            legend: {
              position: "bottom",
              labels: { font: { size: 12 } }
            },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${ctx.parsed} งาน`
              }
            }
          },
          cutout: "70%",
          responsive: true,
          maintainAspectRatio: false,
        }
      });
    }

    function resetSearch() {
      document.getElementById("searchDateFrom").value = "";
      document.getElementById("searchDateTo").value = "";
      document.getElementById("searchDepartment").value = "";
      document.getElementById("searchStatus").value = "";
      searchData();
    }

    function searchData() {
      const status = document.getElementById("searchStatus").value; // ค่าที่เลือก
      const dept = document.getElementById("searchDepartment").value;
      const from = document.getElementById("searchDateFrom").value;
      const to = document.getElementById("searchDateTo").value;

      const filteredSet = new Set();

      Object.entries(repairTechniciansMap).forEach(([rqNo, techList]) => {
        techList.forEach(tech => {
          const d = new Date(tech["เวลาเริ่ม"]);
          if (isNaN(d)) return;

          let valid = true;
          if (from) valid = d >= new Date(from + "T00:00:00");
          if (to && valid) valid = d <= new Date(to + "T23:59:59");

          // กรองตามสถานะ "จบงาน" หรือ "ไม่จบงาน" ตาม dropdown
          if (status && tech["สถานะของงานช่าง"] !== status) valid = false;

          if (valid) filteredSet.add(rqNo);
        });
      });

      let filtered = Array.from(filteredSet);
      if (dept) {
        filtered = filtered.filter(rqNo => {
          const mainData = cacheData.find(r => r["เลขที่ใบแจ้งซ่อม"] === rqNo);
          return mainData && mainData["หน่วยงาน"] === dept;
        });
      }

      renderTableGroupedByDateAndEmp(filtered, status);
      updateCharts(filtered, status);
    }

    async function loadAllData() {
      await fetchDepartments();
      await fetchMachines();
      await fetchEmp();
      await fetchRepairTechnicians();
      await fetchRepairRequests();
      searchData();
    }

    loadAllData();
  </script>
</body>
</html>
