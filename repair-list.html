<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f7f9fc; margin: 0; padding: 0; }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, #1976d2, #42a5f5);
      color: white;
      padding: 0.75rem 1.5rem;
      font-weight: 700;
      box-shadow: 0 4px 10px rgb(25 118 210 / 0.4);
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-grow: 1;
      min-width: 180px;
    }
    .navbar-logo { font-size: 1.5rem; animation: pulse 2.5s infinite ease-in-out; }
    .navbar-title { font-size: 1.25rem; letter-spacing: 0.04em; white-space: nowrap; }
    .navbar-right {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 1rem;
      white-space: nowrap;
    }
    .user-info strong { margin-left: 0.3rem; }
    .btn-primary {
      background-color: #1565c0;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      box-shadow: 0 2px 5px rgb(21 101 192 / 0.6);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    .btn-primary:hover {
      background-color: #0d47a1;
      box-shadow: 0 4px 12px rgb(13 71 161 / 0.8);
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    @media (max-width: 480px) {
      .navbar {
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem;
      }
      .navbar-right {
        gap: 0.6rem;
        font-size: 0.95rem;
      }
      .btn-primary {
        padding: 0.35rem 0.8rem;
        font-size: 0.9rem;
      }
    }

    .container {
      max-width: 960px;
      margin: 1rem auto;
      padding: 1rem;
      background: white;
      border-radius: 8px;
    }

    h2 { margin-top: 0; }

    /* ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */
    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .filter-group > div {
      flex: 1 1 200px;
      min-width: 140px;
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: 600;
      margin-bottom: 0.3rem;
    }
    input[type="date"], select {
      padding: 0.35rem 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: 'Sarabun', sans-serif;
      transition: border-color 0.3s;
    }
    input[type="date"]:focus, select:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 5px #1976d2aa;
    }
    button.btn-filter {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 0.5rem 1.2rem;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s;
      align-self: flex-end;
      height: 38px;
      font-size: 1rem;
    }
    button.btn-filter:hover {
      background-color: #115293;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
      font-size: 0.95rem;
      word-break: break-word;
    }
    th { background-color: #e3f2fd; }
    tr:hover { background-color: #f1faff; }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        display: none;
      }
      tr {
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 0.5rem;
        background: #f9f9f9;
      }
      td {
        border: none;
        padding-left: 50%;
        position: relative;
      }
      td::before {
        position: absolute;
        left: 0.75rem;
        width: 45%;
        white-space: nowrap;
        font-weight: 600;
        content: attr(data-label);
      }
    }
  </style>
</head>
<body>

<nav class="navbar">
  <div class="navbar-left">
    <span class="navbar-logo">üîß</span>
    <span class="navbar-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
  </div>
  <div class="navbar-right">
    <span class="user-info">üë§ <strong id="empDisplay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</strong></span>
    <a href="menu.html" class="btn-primary">üè† ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
  </div>
</nav>

<div class="container">
  <h2>üìã ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h2>

  <form id="filterForm" class="filter-group" autocomplete="off">
    <div>
      <label for="startDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label>
      <input type="date" id="startDate" name="startDate" />
    </div>
    <div>
      <label for="endDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)</label>
      <input type="date" id="endDate" name="endDate" />
    </div>
    <div>
      <label for="deptSelect">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
      <select id="deptSelect" name="deptSelect">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>
    </div>
    <div>
      <label for="statusSelect">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
      <select id="statusSelect" name="statusSelect">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
        <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
        <option value="‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</option>
        <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
      </select>
    </div>
    <div>
      <label style="visibility:hidden;">‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
      <button type="submit" class="btn-filter">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>
  </form>

  <table id="repairTable" aria-live="polite" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°">
    <thead>
      <tr>
        <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
        <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
        <th>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
        <th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || !user.EmpCode) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
    window.location.href = "login.html";
  } else {
    document.getElementById("empDisplay").textContent = `${user.EmpCode} ${user.EmpName || ""} ${user.LastName || ""}`;
  }

  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

  // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏° dropdown
  async function loadDepartments() {
    const url = `https://api.appsheet.com/api/v2/apps/${appId}/tables/Department/Find`;
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey,
      },
      body: JSON.stringify({}),
    });
    const data = await res.json();
    const deptSelect = document.getElementById("deptSelect");
    data.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.DeptCode || d.DeptName || "";
      opt.textContent = d.DeptName || d.DeptCode || "";
      deptSelect.appendChild(opt);
    });
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (yyyy-mm-dd) ‡πÄ‡∏õ‡πá‡∏ô timestamp ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
  function toTimestamp(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr + "T00:00:00"); // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô
    return d.getTime();
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
  async function loadRepairs(filters = {}) {
    // filter ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ AppSheet API ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö filter expression ‡∏†‡∏≤‡∏©‡∏≤ AppSheet ‡πÄ‡∏ä‡πà‡∏ô
    // [EmpCode] = "xxx" AND [‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°] >= "yyyy-mm-dd" AND [‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°] <= "yyyy-mm-dd" AND [‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô] = "xxx" AND [‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á] = "xxx"

    let filterParts = [`EmpCode = "${user.EmpCode}"`];

    if (filters.startDate) {
      filterParts.push(`"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" >= "${filters.startDate}"`);
    }
    if (filters.endDate) {
      filterParts.push(`"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" <= "${filters.endDate}"`);
    }
    if (filters.dept && filters.dept !== "") {
      filterParts.push(`"‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" = "${filters.dept}"`);
    }
    if (filters.status && filters.status !== "") {
      filterParts.push(`"‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á" = "${filters.status}"`);
    }

    const filterExp = filterParts.join(" AND ");

    const url = `https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Find`;
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey,
      },
      body: JSON.stringify({
        filter: filterExp,
        // limit: 100, // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
        orderby: `"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" desc`
      }),
    });

    const data = await res.json();
    const tbody = document.querySelector("#repairTable tbody");
    tbody.innerHTML = "";

    if (!data.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" style="text-align:center; font-style: italic;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td>`;
      tbody.appendChild(tr);
      return;
    }

    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td data-label="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á">${row['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'] || "-"}</td>
        <td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á">${row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'] ? row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'].slice(0,10) : "-"}</td>
        <td data-label="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô">${row['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'] || "-"}</td>
        <td data-label="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">${row['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'] || "-"}</td>
        <td data-label="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢">${row['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢'] || "-"}</td>
        <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞">${row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á'] || "-"}</td>
        <td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£">
          <a class="btn-primary" href="tech-detail.html?request=${encodeURIComponent(row['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'])}">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  async function init() {
    await loadDepartments();
    // ‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ (‡∏Ñ‡πà‡∏≤ default)
    const today = new Date();
    const twoDaysAgo = new Date(today);
    twoDaysAgo.setDate(today.getDate() - 2);
    document.getElementById("startDate").value = twoDaysAgo.toISOString().slice(0,10);
    document.getElementById("endDate").value = today.toISOString().slice(0,10);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô default
    loadRepairs({
      startDate: document.getElementById("startDate").value,
      endDate: document.getElementById("endDate").value,
      dept: "",
      status: ""
    });
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ submit form ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  document.getElementById("filterForm").addEventListener("submit", e => {
    e.preventDefault();
    const filters = {
      startDate: document.getElementById("startDate").value,
      endDate: document.getElementById("endDate").value,
      dept: document.getElementById("deptSelect").value,
      status: document.getElementById("statusSelect").value,
    };
    loadRepairs(filters);
  });

  init();
</script>

</body>
</html>
