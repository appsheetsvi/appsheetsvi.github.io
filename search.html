<!DOCTYPE html>
<html lang="th" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° - ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* scrollbar ‡∏™‡∏ß‡∏¢‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà */
    #partsTable tbody {
      max-height: 200px;
      overflow-y: auto;
      display: block;
    }
    #partsTable thead, #partsTable tbody tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }
  </style>
</head>
<body class="bg-blue-50 font-sarabun min-h-screen flex flex-col items-center p-4">

  <h1 class="text-3xl font-bold text-blue-700 mb-6 select-none">üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>

  <!-- Filter -->
  <div class="w-full max-w-6xl bg-white p-6 rounded-lg shadow-md mb-6 flex flex-wrap gap-6 justify-center">
    <div class="flex flex-col">
      <label for="dateFrom" class="font-semibold select-none mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° ‡∏à‡∏≤‡∏Å:</label>
      <input type="date" id="dateFrom" class="border border-blue-300 rounded px-3 py-1" />
    </div>
    <div class="flex flex-col">
      <label for="dateTo" class="font-semibold select-none mb-1">‡∏ñ‡∏∂‡∏á:</label>
      <input type="date" id="dateTo" class="border border-blue-300 rounded px-3 py-1" />
    </div>
    <div class="flex flex-col min-w-[150px]">
      <label for="filterDepartment" class="font-semibold select-none mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</label>
      <select id="filterDepartment" class="border border-blue-300 rounded px-3 py-1">
        <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>
      </select>
    </div>
    <div class="flex flex-col min-w-[150px]">
      <label for="filterStatus" class="font-semibold select-none mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á:</label>
      <select id="filterStatus" class="border border-blue-300 rounded px-3 py-1">
        <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
        <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
        <option value="‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</option>
        <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
        <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏°">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏°</option>
      </select>
    </div>
    <div class="flex items-end gap-4">
      <button id="btnSearch" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded px-5 py-2 transition">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <button id="btnReset" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold rounded px-5 py-2 transition">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å -->
  <div class="w-full max-w-6xl overflow-x-auto bg-white rounded-lg shadow-md p-4">
    <table class="min-w-full border border-gray-300 text-center">
      <thead class="bg-blue-100 text-blue-800 font-semibold">
        <tr>
          <th class="border border-gray-300 px-3 py-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th>
          <th class="border border-gray-300 px-3 py-2 max-w-xs">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</th>
          <th class="border border-gray-300 px-3 py-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
          <th class="border border-gray-300 px-3 py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á</th>
          <th class="border border-gray-300 px-3 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="mainTableBody" class="divide-y divide-gray-200"></tbody>
    </table>
    <p id="noDataMsg" class="text-center text-gray-500 mt-4 hidden">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
  </div>

  <!-- Modal ‡∏£‡∏ß‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ -->
  <div id="manageModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start pt-16 z-50 hidden overflow-auto">
    <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full mx-4 p-6 relative">
      <h2 class="text-2xl font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2>
      <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>

      <!-- Section: Machinesymptom -->
      <section class="mb-6">
        <h3 class="font-semibold text-lg mb-2 border-b border-gray-300 pb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Machinesymptom)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1 font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
            <input type="text" id="mRequestNumber" disabled class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100" />
          </div>
          <div>
            <label class="block mb-1 font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
            <select id="mStatus" class="w-full border border-gray-300 rounded px-3 py-2">
              <option>‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
              <option>‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</option>
              <option>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
              <option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏°</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block mb-1 font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
            <textarea id="mSymptom" rows="3" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
          </div>
        </div>
      </section>

      <!-- Section: RepairTechnicians -->
      <section class="mb-6">
        <h3 class="font-semibold text-lg mb-2 border-b border-gray-300 pb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á (RepairTechnicians)</h3>
        <textarea id="rSymptom" rows="4" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
      </section>

      <!-- Section: RepairParts -->
      <section>
        <h3 class="font-semibold text-lg mb-2 border-b border-gray-300 pb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (RepairParts)</h3>

        <div class="overflow-x-auto max-h-52 border border-gray-300 rounded mb-3">
          <table id="partsTable" class="min-w-full text-center divide-y divide-gray-200">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th class="border px-2 py-1 w-14">Seq</th>
                <th class="border px-2 py-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</th>
                <th class="border px-2 py-1 w-20">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th class="border px-2 py-1 w-24">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                <th class="border px-2 py-1 w-28">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <form id="partForm" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
          <input type="hidden" id="partId" />
          <div>
            <label for="partSeq" class="block font-semibold mb-1">‡∏•‡∏≥‡∏î‡∏±‡∏ö (Seq)</label>
            <input type="number" id="partSeq" min="1" class="border border-gray-300 rounded px-3 py-2" required />
          </div>
          <div class="md:col-span-2">
            <label for="partName" class="block font-semibold mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label>
            <input type="text" id="partName" class="border border-gray-300 rounded px-3 py-2" required />
          </div>
          <div>
            <label for="partQty" class="block font-semibold mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
            <input type="number" id="partQty" min="0" step="any" class="border border-gray-300 rounded px-3 py-2" required />
          </div>
          <div>
            <label for="partUnit" class="block font-semibold mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
            <input type="text" id="partUnit" class="border border-gray-300 rounded px-3 py-2" required />
          </div>
          <div>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold rounded px-4 py-2 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
          </div>
        </form>
      </section>

      <div class="flex justify-end gap-4 mt-6">
        <button id="btnSaveAll" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold rounded px-6 py-2 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button onclick="closeModal()" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold rounded px-6 py-2 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <script>
    const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
    const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let allMachinesymptom = [];
    let allRepairTechnicians = [];
    let allRepairParts = [];
    let departmentsMap = {}; // ‡∏£‡∏´‡∏±‡∏™ -> ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô

    let currentRequestNumber = null;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
    async function loadAllData() {
      try {
        const [ms, rt, rp, dp] = await Promise.all([
          fetchTable("Machinesymptom"),
          fetchTable("RepairTechnicians"),
          fetchTable("RepairParts"),
          fetchTable("Department"),
        ]);

        allMachinesymptom = ms;
        allRepairTechnicians = rt;
        allRepairParts = rp;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á map ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
        departmentsMap = {};
        dp.forEach(d => {
          departmentsMap[d["DeptCode"]] = d["DeptNameEng"] || d["DeptName"] || d["DeptCode"];
        });

        loadDepartmentFilterOptions(dp);

        renderMainTable(allMachinesymptom);
        document.getElementById('noDataMsg').classList.add("hidden");
      } catch(e) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + e.message);
      }
    }

    async function fetchTable(tableName) {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Find`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({})
      });
      if (!res.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á ${tableName} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
      return await res.json();
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏á filter
    function loadDepartmentFilterOptions(departments) {
      const select = document.getElementById("filterDepartment");
      select.innerHTML = `<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>`;
      departments.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d["DeptCode"];
        opt.textContent = departmentsMap[d["DeptCode"]];
        select.appendChild(opt);
      });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á dd/mm/yyyy
    function formatDateDisplay(dateVal) {
      if (!dateVal) return "-";
      const d = new Date(dateVal);
      if (isNaN(d)) return "-";
      const day = d.getDate().toString().padStart(2,'0');
      const month = (d.getMonth()+1).toString().padStart(2,'0');
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å
    function renderMainTable(data) {
      const tbody = document.getElementById("mainTableBody");
      tbody.innerHTML = "";
      if (!data || data.length === 0) {
        document.getElementById('noDataMsg').classList.remove("hidden");
        return;
      }
      document.getElementById('noDataMsg').classList.add("hidden");

      data.forEach(row => {
        const reqNum = row["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"];
        const symptomDetail = row["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "-";
        const deptCode = row["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "";
        const deptName = departmentsMap[deptCode] || deptCode || "-";

        // ‡∏´‡∏≤ RepairTechnicians ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏ô‡∏µ‡πâ
        const rts = allRepairTechnicians.filter(rt => rt["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === reqNum);
        let status = "-";
        if (rts.length > 0) {
          rts.sort((a,b) => new Date(b["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]) - new Date(a["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]));
          status = rts[0]["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || "-";
        }

        tbody.insertAdjacentHTML('beforeend', `
          <tr class="hover:bg-blue-100 cursor-pointer">
            <td class="border px-2 py-1">${reqNum}</td>
            <td class="border px-2 py-1 max-w-xs overflow-hidden text-ellipsis whitespace-nowrap" title="${symptomDetail}">${symptomDetail}</td>
            <td class="border px-2 py-1">${deptName}</td>
            <td class="border px-2 py-1">${status}</td>
            <td class="border px-2 py-1">
              <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition" onclick="openManageModal('${reqNum}')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
            </td>
          </tr>
        `);
      });
    }

    // ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
    function filterData() {
      const dateFrom = document.getElementById("dateFrom").value;
      const dateTo = document.getElementById("dateTo").value;
      const filterDept = document.getElementById("filterDepartment").value;
      const filterStatus = document.getElementById("filterStatus").value;

      let filtered = [...allMachinesymptom];

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      if (dateFrom) {
        filtered = filtered.filter(r => {
          const d = new Date(r["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || r["CreatedDate"] || "");
          return !isNaN(d) && d >= new Date(dateFrom);
        });
      }
      if (dateTo) {
        filtered = filtered.filter(r => {
          const d = new Date(r["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || r["CreatedDate"] || "");
          return !isNaN(d) && d <= new Date(dateTo);
        });
      }

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
      if (filterDept) {
        filtered = filtered.filter(r => (r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "") === filterDept);
      }

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á
      if (filterStatus) {
        filtered = filtered.filter(r => {
          const reqNum = r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"];
          const rts = allRepairTechnicians.filter(rt => rt["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === reqNum);
          if (rts.length === 0) return false;
          rts.sort((a,b) => new Date(b["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]) - new Date(a["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]));
          const status = rts[0]["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || "";
          return status === filterStatus;
        });
      }

      renderMainTable(filtered);
    }

    // ‡πÄ‡∏õ‡∏¥‡∏î modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    function openManageModal(reqNum) {
      currentRequestNumber = reqNum;

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
      const ms = allMachinesymptom.find(m => m["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === reqNum) || {};
      document.getElementById("mRequestNumber").value = reqNum;
      document.getElementById("mSymptom").value = ms["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
      document.getElementById("mStatus").value = ms["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à";

      // ‡πÇ‡∏´‡∏•‡∏î RepairTechnicians ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      const rts = allRepairTechnicians.filter(rt => rt["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === reqNum);
      rts.sort((a,b) => new Date(b["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]) - new Date(a["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]));
      document.getElementById("rSymptom").value = rts.length > 0 ? (rts[0]["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "") : "";

      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
      const rps = allRepairParts.filter(rp => rp["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === reqNum);
      renderPartsTable(rps);

      clearPartForm();

      document.getElementById("manageModal").classList.remove("hidden");
    }

    // ‡∏õ‡∏¥‡∏î modal
    function closeModal() {
      document.getElementById("manageModal").classList.add("hidden");
      currentRequestNumber = null;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
    function renderPartsTable(parts) {
      const tbody = document.querySelector("#partsTable tbody");
      tbody.innerHTML = "";
      if (parts.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</td></tr>`;
        return;
      }
      parts.sort((a,b) => (a["Seq"]||0) - (b["Seq"]||0));
      parts.forEach(p => {
        tbody.insertAdjacentHTML("beforeend", `
          <tr data-id="${p["ID"]}">
            <td class="border px-2 py-1">${p["Seq"] || ""}</td>
            <td class="border px-2 py-1 text-left" title="${p["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"]}">${p["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"] || ""}</td>
            <td class="border px-2 py-1">${p["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] || ""}</td>
            <td class="border px-2 py-1">${p["‡∏´‡∏ô‡πà‡∏ß‡∏¢"] || ""}</td>
            <td class="border px-2 py-1">
              <button class="bg-yellow-400 hover:bg-yellow-500 text-black rounded px-2 py-1 mr-2" onclick="editPart('${p["ID"]}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="bg-red-500 hover:bg-red-600 text-white rounded px-2 py-1" onclick="deletePart('${p["ID"]}')">‡∏•‡∏ö</button>
            </td>
          </tr>
        `);
      });
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
    function clearPartForm() {
      document.getElementById("partId").value = "";
      document.getElementById("partSeq").value = "";
      document.getElementById("partName").value = "";
      document.getElementById("partQty").value = "";
      document.getElementById("partUnit").value = "";
    }

    // ‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
    function editPart(partId) {
      const part = allRepairParts.find(p => p["ID"] === partId);
      if (!part) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà");
      document.getElementById("partId").value = partId;
      document.getElementById("partSeq").value = part["Seq"] || "";
      document.getElementById("partName").value = part["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"] || "";
      document.getElementById("partQty").value = part["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] || "";
      document.getElementById("partUnit").value = part["‡∏´‡∏ô‡πà‡∏ß‡∏¢"] || "";
    }

    // ‡∏•‡∏ö‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
    async function deletePart(partId) {
      if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ô‡∏µ‡πâ?")) return;
      try {
        const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Delete`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey,
          },
          body: JSON.stringify({Key: partId})
        });
        if (!res.ok) throw new Error("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        alert("‡∏•‡∏ö‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        await reloadAllDataAndModal();
      } catch(e) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏•‡∏ö‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà");
        console.error(e);
      }
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
    document.getElementById("partForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const partId = document.getElementById("partId").value;
      const seq = parseInt(document.getElementById("partSeq").value);
      const name = document.getElementById("partName").value.trim();
      const qty = parseFloat(document.getElementById("partQty").value);
      const unit = document.getElementById("partUnit").value.trim();

      if (!seq || !name || isNaN(qty) || !unit) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
        return;
      }

      try {
        if (partId) {
          // update
          const updates = {
            "Seq": seq,
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": name,
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": qty,
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢": unit,
            "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": currentRequestNumber
          };
          const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Update`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ApplicationAccessKey": apiKey,
            },
            body: JSON.stringify({Key: partId, Updates: updates})
          });
          if (!res.ok) throw new Error("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        } else {
          // add new
          const adds = {
            "Seq": seq,
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": name,
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": qty,
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢": unit,
            "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": currentRequestNumber
          };
          const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Add`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ApplicationAccessKey": apiKey,
            },
            body: JSON.stringify({Properties: {}, Rows: [adds]})
          });
          if (!res.ok) throw new Error("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }
        clearPartForm();
        await reloadAllDataAndModal();
      } catch(e) {
        alert(e.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà");
      }
    });

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Machinesymptom + RepairTechnicians
    document.getElementById("btnSaveAll").addEventListener("click", async () => {
      if (!currentRequestNumber) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°");

      const msUpdate = {
        "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": document.getElementById("mSymptom").value.trim(),
        "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": document.getElementById("mStatus").value
      };
      const rSymptomText = document.getElementById("rSymptom").value.trim();

      try {
        // update Machinesymptom
        let res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/Machinesymptom/Update`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey,
          },
          body: JSON.stringify({Key: currentRequestNumber, Updates: msUpdate})
        });
        if (!res.ok) throw new Error("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

        // update or add RepairTechnicians (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ update ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ add)
        const rts = allRepairTechnicians.filter(r => r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === currentRequestNumber);
        if (rts.length > 0) {
          // update ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          rts.sort((a,b) => new Date(b["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]) - new Date(a["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]));
          const latest = rts[0];
          res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Update`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ApplicationAccessKey": apiKey,
            },
            body: JSON.stringify({
              Key: latest["ID"],
              Updates: { "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": rSymptomText }
            })
          });
          if (!res.ok) throw new Error("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï RepairTechnicians ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        } else {
          // add new
          res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Add`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ApplicationAccessKey": apiKey,
            },
            body: JSON.stringify({
              Properties: {},
              Rows: [{
                "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": currentRequestNumber,
                "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": rSymptomText,
                "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": new Date().toISOString(),
                "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": msUpdate["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]
              }]
            })
          });
          if (!res.ok) throw new Error("‡πÄ‡∏û‡∏¥‡πà‡∏° RepairTechnicians ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        await reloadAllDataAndModal();
        closeModal();
      } catch(e) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + e.message);
      }
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á + modal
    async function reloadAllDataAndModal() {
      await loadAllData();
      if (currentRequestNumber) {
        openManageModal(currentRequestNumber);
      }
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    document.getElementById("btnSearch").addEventListener("click", filterData);
    // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
    document.getElementById("btnReset").addEventListener("click", () => {
      document.getElementById("dateFrom").value = "";
      document.getElementById("dateTo").value = "";
      document.getElementById("filterDepartment").value = "";
      document.getElementById("filterStatus").value = "";
      renderMainTable(allMachinesymptom);
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏à
    loadAllData();

  </script>

</body>
</html>
