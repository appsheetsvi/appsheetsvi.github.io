<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>จัดการงานช่าง + อะไหล่ + ความคืบหน้า</title>
<style>
  body {
    font-family: 'Sarabun', sans-serif;
    background: #f9fafb;
    margin: 0; padding: 1rem;
    color: #222;
  }
  h1 {
    text-align: center;
    color: #2563eb;
    margin-bottom: 1rem;
  }
  #filterContainer {
    max-width: 900px;
    margin: 0 auto 1rem auto;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    align-items: center;
  }
  select {
    padding: 0.3rem 0.5rem;
    font-size: 1rem;
    border-radius: 6px;
    border: 1.5px solid #60a5fa;
  }
  #cardsContainer {
    max-width: 900px;
    margin: 0 auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 6px rgb(0 0 0 / 0.1);
  }
  thead {
    background-color: #2563eb;
    color: white;
  }
  th, td {
    padding: 0.6rem 0.8rem;
    border: 1px solid #ddd;
    text-align: left;
    vertical-align: middle;
  }
  tbody tr:nth-child(even) {
    background: #f3f4f6;
  }
  button.edit-btn {
    background: #2563eb;
    border: none;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  button.edit-btn:hover {
    background-color: #1e40af;
  }
  /* Modal */
  #editModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #editModal.show {
    display: flex;
  }
  #editModal .modal-content {
    background: white;
    border-radius: 10px;
    padding: 1.5rem 2rem;
    max-width: 600px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
  }
  #editModal h2 {
    margin-top: 0;
    color: #2563eb;
    text-align: center;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
  }
  input[type="text"], input[type="datetime-local"], select, textarea {
    width: 100%;
    padding: 0.4rem 0.6rem;
    margin-top: 0.3rem;
    border: 1.5px solid #60a5fa;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
  }
  textarea {
    min-height: 80px;
    resize: vertical;
  }
  .buttons {
    margin-top: 1.5rem;
    text-align: right;
  }
  .buttons button {
    padding: 0.5rem 1.2rem;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-left: 0.5rem;
    font-size: 0.9rem;
    transition: background-color 0.3s;
  }
  .buttons .save-btn {
    background-color: #2563eb;
    color: white;
  }
  .buttons .save-btn:hover {
    background-color: #1e40af;
  }
  .buttons .cancel-btn {
    background-color: #ddd;
    color: #333;
  }
  .buttons .cancel-btn:hover {
    background-color: #bbb;
  }
  /* อะไหล่ ใน modal */
  #partsContainer {
    margin-top: 0.8rem;
    border: 1px solid #60a5fa;
    border-radius: 8px;
    padding: 0.5rem;
    background: #f0f9ff;
  }
  .part-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
    align-items: center;
  }
  .part-row input[type="text"], .part-row input[type="number"] {
    flex: 1;
    padding: 0.4rem 0.6rem;
    border: 1.2px solid #60a5fa;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  .part-row button.remove-part {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.3rem 0.7rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    flex-shrink: 0;
  }
  .part-row button.remove-part:hover {
    background: #b91c1c;
  }
  #addPartBtn {
    margin-top: 0.3rem;
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.4rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  #addPartBtn:hover {
    background: #1e40af;
  }
</style>
</head>
<body>

<h1>จัดการงานช่าง + อะไหล่ + ความคืบหน้า</h1>

<div id="filterContainer">
  <label for="statusFilter">สถานะงานช่าง:</label>
  <select id="statusFilter">
    <option value="all">ทั้งหมด</option>
    <option value="finished">จบงาน</option>
    <option value="unfinished">ไม่จบงาน</option>
  </select>
</div>

<div id="cardsContainer">กำลังโหลดข้อมูล...</div>

<!-- Modal -->
<div id="editModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <h2 id="modalTitle">แก้ไข / เพิ่มงานช่าง</h2>
    <form id="editForm">
      <label for="editRequestNumber">เลขที่ใบแจ้งซ่อม</label>
      <input type="text" id="editRequestNumber" readonly />

      <label for="editEmpCode">รหัสช่าง (EmpCode) <span style="color:red;">*</span></label>
      <input type="text" id="editEmpCode" class="form-control" required />

      <label for="editStatus">สถานะงานช่าง <span style="color:red;">*</span></label>
      <select id="editStatus" required>
        <option value="">-- เลือกสถานะ --</option>
        <option value="อยู่ระหว่างดำเนินการ">อยู่ระหว่างดำเนินการ</option>
        <option value="ซ่อมเสร็จ">ซ่อมเสร็จ</option>
        <option value="รออะไหล่">รออะไหล่</option>
        <option value="ยกเลิก">ยกเลิก</option>
      </select>

      <label for="editComment">ความคิดเห็น</label>
      <textarea id="editComment" placeholder="รายละเอียดเพิ่มเติม"></textarea>

      <label for="editStartTime">เวลาเริ่มงาน</label>
      <input type="datetime-local" id="editStartTime" />

      <label for="editEndTime">เวลาสิ้นสุดงาน</label>
      <input type="datetime-local" id="editEndTime" />

      <hr style="margin: 1rem 0;" />

      <label>รายการอะไหล่</label>
      <div id="partsContainer"></div>
      <button type="button" id="addPartBtn">+ เพิ่มรายการอะไหล่</button>

      <div class="buttons">
        <button type="button" class="cancel-btn" id="modalCancelBtn">ยกเลิก</button>
        <button type="submit" class="save-btn">บันทึก</button>
      </div>
    </form>
  </div>
</div>

<script>
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

  const cardsContainer = document.getElementById("cardsContainer");
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const partsContainer = document.getElementById("partsContainer");
  const addPartBtn = document.getElementById("addPartBtn");
  const modalCancelBtn = document.getElementById("modalCancelBtn");
  const statusFilter = document.getElementById("statusFilter");

  let techniciansData = []; // ข้อมูลงานช่าง
  let partsData = []; // ข้อมูลอะไหล่ทั้งหมด
  let currentEditRecord = null; // ข้อมูลงานช่างที่กำลังแก้ไข

  // แปลง ISO date -> dd/mm/yyyy HH:MM
  function formatDateTimeLocal(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  }

  // แปลง Date -> yyyy-MM-ddTHH:mm สำหรับ input datetime-local
  function toDatetimeLocalString(date) {
    if (!date) return "";
    const d = new Date(date);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}T${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  }

  // โหลดข้อมูลงานช่างและอะไหล่พร้อมกัน
  async function loadData() {
    cardsContainer.textContent = "กำลังโหลดข้อมูล...";

    try {
      // โหลดงานช่าง
      const resTech = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({ Action: "Find", Expression: "TRUE" })
      });
      if (!resTech.ok) throw new Error("โหลดข้อมูลงานช่างล้มเหลว");
      techniciansData = await resTech.json();
      if (!Array.isArray(techniciansData)) techniciansData = [];

      // โหลดอะไหล่
      const resParts = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({ Action: "Find", Expression: "TRUE" })
      });
      if (!resParts.ok) throw new Error("โหลดข้อมูลอะไหล่ล้มเหลว");
      partsData = await resParts.json();
      if (!Array.isArray(partsData)) partsData = [];

      renderCards();
    } catch (err) {
      cardsContainer.innerHTML = `<p style="color:red;text-align:center;">เกิดข้อผิดพลาด: ${err.message}</p>`;
      console.error(err);
    }
  }

  // กรอง techniciansData ตาม dropdown สถานะ
  function filterTechniciansByStatus(data, status) {
    if (status === "all") return data;
    if (status === "finished") {
      return data.filter(d => d["สถานะของงานช่าง"] === "ซ่อมเสร็จ");
    }
    if (status === "unfinished") {
      return data.filter(d => d["สถานะของงานช่าง"] !== "ซ่อมเสร็จ");
    }
    return data;
  }

  // แสดงรายการงานช่าง พร้อมอะไหล่ที่เกี่ยวข้อง แบบตาราง
  function renderCards() {
    if (techniciansData.length === 0) {
      cardsContainer.innerHTML = `<p style="text-align:center; color:#666;">ไม่มีข้อมูลงานช่าง</p>`;
      return;
    }

    const filteredData = filterTechniciansByStatus(techniciansData, statusFilter.value);

    if (filteredData.length === 0) {
      cardsContainer.innerHTML = `<p style="text-align:center; color:#666;">ไม่มีข้อมูลงานช่างตามเงื่อนไข</p>`;
      return;
    }

    // จัดกลุ่มอะไหล่ตามเลขที่ใบแจ้งซ่อม
    const partsByRequest = {};
    for (const p of partsData) {
      const reqNo = p["เลขที่ใบแจ้งซ่อม"] || "";
      if (!partsByRequest[reqNo]) partsByRequest[reqNo] = [];
      partsByRequest[reqNo].push(p);
    }

    let html = `<table><thead><tr>
      <th>เลขที่ใบแจ้งซ่อม</th>
      <th>รหัสช่าง (EmpCode)</th>
      <th>สถานะงานช่าง</th>
      <th>เวลาเริ่มงาน</th>
      <th>เวลาสิ้นสุดงาน</th>
      <th>ความคิดเห็น</th>
      <th>รายการอะไหล่ (ลำดับ, รายการ, จำนวน, หน่วย)</th>
      <th>จัดการ</th>
    </tr></thead><tbody>`;

    filteredData.forEach(rec => {
      const reqNo = rec["เลขที่ใบแจ้งซ่อม"] || "-";
      const parts = partsByRequest[reqNo] || [];

      const partsHtml = parts.length
        ? parts
            .sort((a, b) => (a.Seq || 0) - (b.Seq || 0))
            .map(p => `${p.Seq || '-'}: ${p["รายการอะไหล่"]} จำนวน ${p["จำนวน"]} ${p["หน่วย"]}`)
            .join("<br>")
        : '<span style="color:#999;">ไม่มีอะไหล่</span>';

      html += `<tr>
        <td>${reqNo}</td>
        <td>${rec.EmpCode || "-"}</td>
        <td>${rec["สถานะของงานช่าง"] || "-"}</td>
        <td>${formatDateTimeLocal(rec["เวลาเริ่ม"])}</td>
        <td>${formatDateTimeLocal(rec["เวลาจบ"])}</td>
        <td>${rec["การแก้ไขความคิดเห็น"] || "-"}</td>
        <td style="white-space: nowrap;">${partsHtml}</td>
        <td><button class="edit-btn" data-id="${rec.ID}">แก้ไข / เพิ่ม</button></td>
      </tr>`;
    });

    html += "</tbody></table>";
    cardsContainer.innerHTML = html;

    // ผูก event ให้ปุ่มแก้ไข
    const editButtons = cardsContainer.querySelectorAll("button.edit-btn");
    editButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        openEditModal(id);
      });
    });
  }

  // เปิด modal แก้ไขงานช่าง พร้อมโหลดอะไหล่ที่เกี่ยวข้อง
  function openEditModal(recordId) {
    const record = techniciansData.find(r => String(r.ID) === recordId);
    if (!record) return alert("ไม่พบข้อมูลที่เลือก");

    currentEditRecord = record;

    // เติมข้อมูล form
    document.getElementById("editRequestNumber").value = record["เลขที่ใบแจ้งซ่อม"] || "";
    document.getElementById("editEmpCode").value = record.EmpCode || "";
    document.getElementById("editStatus").value = record["สถานะของงานช่าง"] || "";
    document.getElementById("editComment").value = record["การแก้ไขความคิดเห็น"] || "";
    document.getElementById("editStartTime").value = toDatetimeLocalString(record["เวลาเริ่ม"]);
    document.getElementById("editEndTime").value = toDatetimeLocalString(record["เวลาจบ"]);

    // ล้างอะไหล่เก่า
    partsContainer.innerHTML = "";

    // โหลดอะไหล่ที่เกี่ยวข้อง
    const partsForThis = partsData.filter(p => p["เลขที่ใบแจ้งซ่อม"] === record["เลขที่ใบแจ้งซ่อม"]);

    if (partsForThis.length === 0) {
      addPartRow(); // เพิ่มแถวเปล่า 1 แถว
    } else {
      partsForThis
        .sort((a, b) => (a.Seq || 0) - (b.Seq || 0))
        .forEach(p => addPartRow(p["รายการอะไหล่"], p["จำนวน"], p["หน่วย"]));
    }

    // แสดง modal
    editModal.classList.add("show");
  }

  // เพิ่มแถวอะไหล่ใน modal
  function addPartRow(item = "", qty = "", unit = "") {
    const row = document.createElement("div");
    row.className = "part-row";

    row.innerHTML = `
      <input type="text" class="part-item" placeholder="รายการอะไหล่" value="${item}" required />
      <input type="number" class="part-qty" placeholder="จำนวน" min="1" value="${qty}" required />
      <input type="text" class="part-unit" placeholder="หน่วย" value="${unit}" />
      <button type="button" class="remove-part" title="ลบรายการ">x</button>
    `;

    // ลบแถว
    row.querySelector(".remove-part").addEventListener("click", () => {
      partsContainer.removeChild(row);
    });

    partsContainer.appendChild(row);
  }

  // ปิด modal
  function closeModal() {
    editModal.classList.remove("show");
    currentEditRecord = null;
    editForm.reset();
    partsContainer.innerHTML = "";
  }

  // บันทึกข้อมูล
  editForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!currentEditRecord) {
      alert("ไม่มีข้อมูลที่จะแก้ไข");
      return;
    }

    const reqNo = document.getElementById("editRequestNumber").value.trim();
    const empCode = document.getElementById("editEmpCode").value.trim();
    const status = document.getElementById("editStatus").value.trim();
    const comment = document.getElementById("editComment").value.trim();
    const startTime = document.getElementById("editStartTime").value;
    const endTime = document.getElementById("editEndTime").value;

    if (!empCode) {
      alert("กรุณากรอกรหัสช่าง (EmpCode)");
      return;
    }
    if (!status) {
      alert("กรุณาเลือกสถานะงานช่าง");
      return;
    }

    try {
      // เพิ่มแถวใหม่ใน RepairTechnicians (ไม่แก้ไขแถวเก่า)
      const newTechRow = {
        "เลขที่ใบแจ้งซ่อม": reqNo,
        EmpCode: empCode,
        "สถานะของงานช่าง": status,
        "การแก้ไขความคิดเห็น": comment,
        "เวลาเริ่ม": startTime ? new Date(startTime).toISOString() : null,
        "เวลาจบ": endTime ? new Date(endTime).toISOString() : null,
      };

      const resAddTech = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({ Action: "Add", Rows: [newTechRow] })
      });

      if (!resAddTech.ok) throw new Error("บันทึกงานช่างล้มเหลว");

      // ลบอะไหล่เก่าใน RepairParts ของเลขที่ใบแจ้งซ่อมนี้ก่อน
      const resDeleteParts = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({ Action: "Delete", Expression: `[เลขที่ใบแจ้งซ่อม] = "${reqNo}"` })
      });

      if (!resDeleteParts.ok) throw new Error("ลบอะไหล่เก่าล้มเหลว");

      // เพิ่มอะไหล่ใหม่พร้อม Seq
      const newPartsRows = [];
      const partRows = partsContainer.querySelectorAll(".part-row");
      partRows.forEach((row, index) => {
        const item = row.querySelector(".part-item").value.trim();
        const qty = row.querySelector(".part-qty").value.trim();
        const unit = row.querySelector(".part-unit").value.trim();
        if (item && qty) {
          newPartsRows.push({
            "เลขที่ใบแจ้งซ่อม": reqNo,
            "รายการอะไหล่": item,
            "จำนวน": Number(qty),
            "หน่วย": unit,
            "EmpCode": empCode,
            "Seq": index + 1  // ลำดับตามแถว
          });
        }
      });

      if (newPartsRows.length > 0) {
        const resAddParts = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Action`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey,
          },
          body: JSON.stringify({ Action: "Add", Rows: newPartsRows })
        });

        if (!resAddParts.ok) throw new Error("บันทึกอะไหล่ล้มเหลว");
      }

      alert("บันทึกข้อมูลสำเร็จ");
      closeModal();
      await loadData();
    } catch (err) {
      alert("เกิดข้อผิดพลาด: " + err.message);
      console.error(err);
    }
  });

  // ปุ่มเพิ่มแถวอะไหล่
  addPartBtn.addEventListener("click", () => addPartRow());

  // ปุ่มยกเลิก modal
  modalCancelBtn.addEventListener("click", () => closeModal());

  // ปรับ filter สถานะ
  statusFilter.addEventListener("change", () => {
    renderCards();
  });

  // โหลดข้อมูลตอนเปิดหน้า
  loadData();

</script>
</body>
</html>
