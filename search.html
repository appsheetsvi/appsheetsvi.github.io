<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ระบบจัดการงานซ่อม</title>
<style>
  body { font-family: 'Sarabun', sans-serif; margin: 10px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  .actions button { margin-right: 5px; }
  #manageModal { 
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.5); 
    justify-content: center; align-items: center; 
  }
  #manageModal.show { display: flex; }
  #manageModalContent {
    background: white; padding: 20px; border-radius: 5px; width: 700px; max-height: 90vh; overflow-y: auto;
  }
  fieldset { margin-bottom: 15px; }
  legend { font-weight: bold; }
  label { display: block; margin: 3px 0; }
  .checkbox-group { max-height: 120px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; }
</style>
</head>
<body>

<h2>ระบบจัดการงานซ่อม</h2>

<div id="message"></div>

<!-- ตัวกรอง -->
<div style="margin-bottom:10px;">
  วันที่แจ้งซ่อม: 
  <input type="date" id="dateFrom" /> ถึง 
  <input type="date" id="dateTo" />
  หน่วยงาน:
  <select id="filterDepartment">
    <option value="">-- ทุกหน่วยงาน --</option>
  </select>
  สถานะงานช่าง:
  <select id="filterStatus">
    <option value="">-- ทุกสถานะ --</option>
    <option value="จบงาน">จบงาน</option>
    <option value="ไม่จบงาน">ไม่จบงาน</option>
    <option value="รออะไหล่">รออะไหล่</option>
  </select>
  <button onclick="applyFilters()">ค้นหา</button>
  <button onclick="resetFilters()">ล้าง</button>
</div>

<!-- ตารางแสดงข้อมูล -->
<table>
  <thead>
    <tr>
      <th>เลขที่ใบแจ้งซ่อม</th>
      <th>รายละเอียดอาการเสีย</th>
      <th>หน่วยงาน</th>
      <th>วันที่แจ้งซ่อม</th>
      <th>สถานะของงานช่าง</th>
      <th>จัดการ</th>
    </tr>
  </thead>
  <tbody id="mainTableBody"></tbody>
</table>

<!-- Modal จัดการ -->
<div id="manageModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="manageModalLabel">
  <div id="manageModalContent" role="document">
    <h3 id="manageModalLabel">จัดการใบแจ้งซ่อม</h3>
    <form id="manageForm">
      <fieldset>
        <legend>ข้อมูลใบแจ้งซ่อม</legend>
        <label>เลขที่ใบแจ้งซ่อม: <input type="text" id="manageRequestNumber" readonly /></label>
        <label>รายละเอียดอาการเสีย:<br />
          <textarea id="manageSymptom" rows="3" style="width:100%"></textarea>
        </label>
        <label>แก้ไขความคิดเห็น:<br />
          <textarea id="manageComment" rows="2" style="width:100%"></textarea>
        </label>
      </fieldset>

      <fieldset>
        <legend>สถานะของงานช่าง</legend>
        <div id="statusCheckboxes" class="checkbox-group">
          <label><input type="radio" name="manageStatus" value="จบงาน" /> จบงาน</label>
          <label><input type="radio" name="manageStatus" value="ไม่จบงาน" /> ไม่จบงาน</label>
          <label><input type="radio" name="manageStatus" value="รออะไหล่" /> รออะไหล่</label>
        </div>
      </fieldset>

      <fieldset>
        <legend>เลือกช่าง (รหัสช่าง)</legend>
        <div id="technicianCheckboxes" class="checkbox-group">
          กำลังโหลดรายชื่อช่าง...
        </div>
      </fieldset>

      <fieldset>
        <legend>รายการอะไหล่</legend>
        <table style="width:100%; border:1px solid #ccc; border-collapse: collapse;">
          <thead>
            <tr>
              <th>ลำดับ</th>
              <th>รายการอะไหล่</th>
              <th>จำนวน</th>
              <th>หน่วย</th>
              <th>จัดการ</th>
            </tr>
          </thead>
          <tbody id="partsTableBody">
            <tr><td colspan="5" style="text-align:center; color:#888;">ยังไม่มีรายการอะไหล่</td></tr>
          </tbody>
        </table>
        <div style="margin-top:5px;">
          <input type="hidden" id="partId" />
          <input type="text" id="partName" placeholder="รายการอะไหล่" />
          <input type="number" id="partQty" placeholder="จำนวน" min="0" step="1" style="width:80px;" />
          <input type="text" id="partUnit" placeholder="หน่วย" style="width:80px;" />
          <button type="button" id="partSaveBtn">เพิ่ม/แก้ไข</button>
          <button type="button" onclick="clearPartForm()">ยกเลิก</button>
        </div>
      </fieldset>

      <div style="margin-top:15px; text-align:right;">
        <button type="submit">บันทึกข้อมูล</button>
        <button type="button" onclick="closeManageModal()">ยกเลิก</button>
      </div>
    </form>
  </div>
</div>

<script>
  // --------- BEGIN SCRIPT ----------
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

  let allMachinesymptom = [];
  let allRepairTechnicians = [];
  let allRepairParts = [];
  let departmentsMap = {};
  let allEmp = [];

  let currentRequestNumber = null;
  let partsBuffer = [];

  async function loadDepartments() {
    try {
      const depts = await fetchTable("Department");
      const select = document.getElementById("filterDepartment");
      depts.forEach(d => {
        const code = d["DeptCode"] || d["รหัสหน่วยงาน"] || "";
        const name = d["DeptNameEng"] || d["DeptName"] || code;
        departmentsMap[code] = name;
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = name;
        select.appendChild(opt);
      });
    } catch {
      showMessage("ไม่สามารถโหลดข้อมูลหน่วยงานได้");
    }
  }

  async function fetchTable(tableName) {
    try {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Find`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({})
      });
      if (!res.ok) throw new Error(`ไม่สามารถโหลดข้อมูลจากตาราง ${tableName} ได้`);
      const json = await res.json();
      return json.rows || json;
    } catch (e) {
      console.error(e);
      throw e;
    }
  }

  async function loadAllData() {
    try {
      showMessage("กำลังโหลดข้อมูล...");
      [allMachinesymptom, allRepairTechnicians, allRepairParts] = await Promise.all([
        fetchTable("Machinesymptom"),
        fetchTable("RepairTechnicians"),
        fetchTable("RepairParts")
      ]);
      allMachinesymptom.sort((a,b) => {
        const d1 = new Date(a["วันที่แจ้งซ่อม"] || 0);
        const d2 = new Date(b["วันที่แจ้งซ่อม"] || 0);
        return d2 - d1;
      });
      renderMainTable(allMachinesymptom);
      showMessage("");
    } catch(e) {
      showMessage("เกิดข้อผิดพลาดในการโหลดข้อมูล");
      console.error(e);
    }
  }

  async function loadEmpTechnicians() {
    try {
      const emps = await fetchTable("Emp");
      allEmp = emps.filter(e => {
        const deptCode = e["DeptCode"] || e["รหัสหน่วยงาน"] || "";
        const empStatus = e["EmpStatus"] !== undefined ? e["EmpStatus"] : e["สถานะพนักงาน"];
        return (deptCode === "A12") && (empStatus === 0 || empStatus === "0");
      });
      renderTechnicianCheckboxes();
    } catch (e) {
      console.error("โหลดข้อมูลช่างไม่ได้", e);
      document.getElementById("technicianCheckboxes").textContent = "โหลดข้อมูลช่างไม่ได้";
    }
  }

  function renderTechnicianCheckboxes() {
    const container = document.getElementById("technicianCheckboxes");
    container.innerHTML = "";
    if (!allEmp.length) {
      container.textContent = "ไม่มีข้อมูลช่าง";
      return;
    }
    allEmp.forEach(emp => {
      const empCode = emp["EmpCode"] || emp["รหัสพนักงาน"] || "";
      const empName = emp["ชื่อพนักงาน"] || emp["EmpName"] || empCode;
      const label = document.createElement("label");
      label.style.display = "block";
      label.innerHTML = `<input type="checkbox" name="manageEmpCode" value="${empCode}" /> ${empName}`;
      container.appendChild(label);
    });
  }

  function showMessage(msg) {
    document.getElementById("message").textContent = msg;
  }

  // แสดงแค่วันที่ ไม่แสดงเวลา
  function formatDateOnly(dateTimeStr) {
    if (!dateTimeStr) return "-";
    const d = new Date(dateTimeStr);
    if (isNaN(d)) return "-";
    return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()+543}`;
  }

  function renderMainTable(data) {
    const tbody = document.getElementById("mainTableBody");
    tbody.innerHTML = "";
    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#888;">ไม่พบข้อมูล</td></tr>`;
      return;
    }
    for (const row of data) {
      const reqNo = row["เลขที่ใบแจ้งซ่อม"];
      // หาค่าเวลาที่เริ่มงานช่างล่าสุด
      const latestTech = allRepairTechnicians
        .filter(rt => rt["เลขที่ใบแจ้งซ่อม"] === reqNo)
        .sort((a,b) => new Date(b["วันที่แจ้งซ่อม"]||0) - new Date(a["วันที่แจ้งซ่อม"]||0))[0];
      const status = latestTech ? latestTech["สถานะของงานช่าง"] : "-";

      // ดึงวันที่แจ้งซ่อม (ถ้ามีเวลาเริ่มงานช่างก็แสดงวันที่นั้นแทน)
      const startTime = latestTech ? latestTech["วันที่แจ้งซ่อม"] : row["วันที่แจ้งซ่อม"];

      const deptCode = row["หน่วยงาน"] || "";
      const deptName = departmentsMap[deptCode] || deptCode;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${reqNo || "-"}</td>
          <td title="${row["รายละเอียดอาการเสีย"] || "-"}">${(row["รายละเอียดอาการเสีย"] || "-").substring(0,60)}</td>
          <td>${deptName}</td>
          <td>${formatDateOnly(startTime)}</td>
          <td>${status}</td>
          <td class="actions">
            <button class="edit-btn" aria-label="จัดการ ${reqNo}" onclick="openManageModal('${reqNo}')">จัดการ</button>
          </td>
        </tr>
      `);
    }
  }

  function applyFilters() {
    const dateFrom = document.getElementById("dateFrom").value;
    const dateTo = document.getElementById("dateTo").value;
    const dept = document.getElementById("filterDepartment").value;
    const status = document.getElementById("filterStatus").value;

    let filtered = allMachinesymptom;

    if (dateFrom) filtered = filtered.filter(r => {
      const dt = new Date(r["วันที่แจ้งซ่อม"]);
      return dt >= new Date(dateFrom);
    });
    if (dateTo) filtered = filtered.filter(r => {
      const dt = new Date(r["วันที่แจ้งซ่อม"]);
      return dt <= new Date(dateTo + "T23:59:59");
    });
    if (dept) filtered = filtered.filter(r => r["หน่วยงาน"] === dept);
    if (status) {
      filtered = filtered.filter(r => {
        const reqNo = r["เลขที่ใบแจ้งซ่อม"];
        const latestTech = allRepairTechnicians
          .filter(rt => rt["เลขที่ใบแจ้งซ่อม"] === reqNo)
          .sort((a,b) => new Date(b["วันที่แจ้งซ่อม"]||0) - new Date(a["วันที่แจ้งซ่อม"]||0))[0];
        return latestTech && latestTech["สถานะของงานช่าง"] === status;
      });
    }

    renderMainTable(filtered);
  }

  function resetFilters() {
    document.getElementById("dateFrom").value = "";
    document.getElementById("dateTo").value = "";
    document.getElementById("filterDepartment").value = "";
    document.getElementById("filterStatus").value = "";
    renderMainTable(allMachinesymptom);
    showMessage("");
  }

  function openManageModal(requestNumber) {
    currentRequestNumber = requestNumber;
    clearManageForm();
    loadManageData(requestNumber);
    document.getElementById("manageModal").classList.add("show");
    document.getElementById("manageModal").focus();
  }

  function closeManageModal() {
    currentRequestNumber = null;
    partsBuffer = [];
    clearManageForm();
    document.getElementById("manageModal").classList.remove("show");
  }

  function clearManageForm() {
    document.getElementById("manageRequestNumber").value = "";
    document.getElementById("manageSymptom").value = "";
    document.getElementById("manageComment").value = "";
    // clear status radio
    const statusRadios = document.getElementsByName("manageStatus");
    statusRadios.forEach(r => r.checked = false);
    clearPartsTable();
    clearPartForm();

    // clear checked technicians
    const techChecks = document.querySelectorAll('#technicianCheckboxes input[type="checkbox"]');
    techChecks.forEach(chk => chk.checked = false);
  }

  function loadManageData(requestNumber) {
    const symptomRow = allMachinesymptom.find(r => r["เลขที่ใบแจ้งซ่อม"] === requestNumber);
    if (!symptomRow) {
      alert("ไม่พบข้อมูลใบแจ้งซ่อม: " + requestNumber);
      return;
    }
    document.getElementById("manageRequestNumber").value = requestNumber;
    document.getElementById("manageSymptom").value = symptomRow["รายละเอียดอาการเสีย"] || "";
    document.getElementById("manageComment").value = symptomRow["แก้ไขความคิดเห็น"] || "";

    // โหลดสถานะล่าสุด
    const latestTech = allRepairTechnicians
      .filter(rt => rt["เลขที่ใบแจ้งซ่อม"] === requestNumber)
      .sort((a,b) => new Date(b["วันที่แจ้งซ่อม"]||0) - new Date(a["วันที่แจ้งซ่อม"]||0))[0];

    // set status radio checked
    if (latestTech) {
      const statusRadios = document.getElementsByName("manageStatus");
      statusRadios.forEach(r => r.checked = (r.value === latestTech["สถานะของงานช่าง"]));
    }

    // โหลดช่างที่บันทึก (ถ้ามี)
    const techRows = allRepairTechnicians.filter(rt => rt["เลขที่ใบแจ้งซ่อม"] === requestNumber);
    const selectedEmpCodes = techRows.map(t => t["รหัสช่าง"]).filter(x => x);

    const techChecks = document.querySelectorAll('#technicianCheckboxes input[type="checkbox"]');
    techChecks.forEach(chk => {
      chk.checked = selectedEmpCodes.includes(chk.value);
    });

    partsBuffer = allRepairParts.filter(p => p["เลขที่ใบแจ้งซ่อม"] === requestNumber).map(p => ({...p}));
    renderPartsTable();
  }

  function renderPartsTable() {
    const tbody = document.getElementById("partsTableBody");
    tbody.innerHTML = "";
    if (partsBuffer.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#888;">ยังไม่มีรายการอะไหล่</td></tr>`;
      return;
    }
    partsBuffer.forEach((p, i) => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${i+1}</td>
          <td>${p["รายการอะไหล่"] || "-"}</td>
          <td>${p["จำนวน"] || "-"}</td>
          <td>${p["หน่วย"] || "-"}</td>
          <td>
            <button type="button" onclick="editPart(${i})">แก้ไข</button>
            <button type="button" onclick="deletePart(${i})">ลบ</button>
          </td>
        </tr>
      `);
    });
  }

  function clearPartsTable() {
    partsBuffer = [];
    renderPartsTable();
  }

  function clearPartForm() {
    document.getElementById("partId").value = "";
    document.getElementById("partName").value = "";
    document.getElementById("partQty").value = "";
    document.getElementById("partUnit").value = "";
    document.getElementById("partSaveBtn").textContent = "เพิ่ม/แก้ไข";
  }

  document.getElementById("partSaveBtn").addEventListener("click", () => {
    const id = document.getElementById("partId").value;
    const name = document.getElementById("partName").value.trim();
    const qty = Number(document.getElementById("partQty").value);
    const unit = document.getElementById("partUnit").value.trim();
    if (!name) {
      alert("กรุณากรอกชื่อรายการอะไหล่");
      return;
    }
    if (!qty || qty <= 0) {
      alert("กรุณากรอกจำนวนให้ถูกต้อง");
      return;
    }
    if (!unit) {
      alert("กรุณากรอกหน่วย");
      return;
    }
    if (id === "") {
      // เพิ่ม
      partsBuffer.push({
        "รายการอะไหล่": name,
        "จำนวน": qty,
        "หน่วย": unit
      });
    } else {
      // แก้ไข
      const idx = parseInt(id);
      if (idx >= 0 && idx < partsBuffer.length) {
        partsBuffer[idx]["รายการอะไหล่"] = name;
        partsBuffer[idx]["จำนวน"] = qty;
        partsBuffer[idx]["หน่วย"] = unit;
      }
    }
    clearPartForm();
    renderPartsTable();
  });

  function editPart(idx) {
    if (idx < 0 || idx >= partsBuffer.length) return;
    const p = partsBuffer[idx];
    document.getElementById("partId").value = idx;
    document.getElementById("partName").value = p["รายการอะไหล่"] || "";
    document.getElementById("partQty").value = p["จำนวน"] || "";
    document.getElementById("partUnit").value = p["หน่วย"] || "";
    document.getElementById("partSaveBtn").textContent = "แก้ไข";
  }

  function deletePart(idx) {
    if (idx < 0 || idx >= partsBuffer.length) return;
    if (!confirm("ต้องการลบรายการอะไหล่ใช่หรือไม่?")) return;
    partsBuffer.splice(idx, 1);
    renderPartsTable();
  }

  document.getElementById("manageForm").addEventListener("submit", async e => {
    e.preventDefault();
    if (!currentRequestNumber) {
      alert("ไม่มีเลขที่ใบแจ้งซ่อมสำหรับบันทึก");
      return;
    }
    const symptom = document.getElementById("manageSymptom").value.trim();
    const comment = document.getElementById("manageComment").value.trim();
    const statusRadios = document.getElementsByName("manageStatus");
    let statusVal = "";
    for (const r of statusRadios) {
      if (r.checked) {
        statusVal = r.value;
        break;
      }
    }
    if (!statusVal) {
      alert("กรุณาเลือกสถานะของงานช่าง");
      return;
    }

    // ช่างที่เลือก
    const selectedEmpCodes = [];
    const techChecks = document.querySelectorAll('#technicianCheckboxes input[type="checkbox"]:checked');
    techChecks.forEach(chk => selectedEmpCodes.push(chk.value));

    if (selectedEmpCodes.length === 0) {
      alert("กรุณาเลือกช่างอย่างน้อยหนึ่งคน");
      return;
    }

    try {
      showMessage("กำลังบันทึกข้อมูล...");
      // 1. บันทึก Machinesymptom (แก้ไขรายละเอียด + ความคิดเห็น)
      await updateMachinesymptom(currentRequestNumber, symptom, comment);

      // 2. ลบ RepairTechnicians ที่มีเลขที่ใบแจ้งซ่อมนี้ก่อน (ถ้ามี)
      await deleteRepairTechniciansByRequestNumber(currentRequestNumber);

      // 3. เพิ่ม RepairTechnicians ใหม่ ตามที่เลือก
      const promisesTech = selectedEmpCodes.map(empCode => insertRepairTechnician({
        "เลขที่ใบแจ้งซ่อม": currentRequestNumber,
        "รหัสช่าง": empCode,
        "สถานะของงานช่าง": statusVal,
        "วันที่แจ้งซ่อม": new Date().toISOString()
      }));
      await Promise.all(promisesTech);

      // 4. ลบ RepairParts ที่มีเลขที่ใบแจ้งซ่อมนี้ก่อน (ถ้ามี)
      await deleteRepairPartsByRequestNumber(currentRequestNumber);

      // 5. เพิ่ม RepairParts ใหม่ จาก partsBuffer
      const promisesParts = partsBuffer.map(p => insertRepairPart({
        "เลขที่ใบแจ้งซ่อม": currentRequestNumber,
        "รายการอะไหล่": p["รายการอะไหล่"],
        "จำนวน": p["จำนวน"],
        "หน่วย": p["หน่วย"]
      }));
      await Promise.all(promisesParts);

      showMessage("บันทึกข้อมูลสำเร็จ");
      await loadAllData();
      closeManageModal();
    } catch (e) {
      showMessage("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
      console.error(e);
    }
  });

  async function updateMachinesymptom(reqNo, symptom, comment) {
    try {
      // ดึง row เดิมเพื่อหา RowKey
      const row = allMachinesymptom.find(r => r["เลขที่ใบแจ้งซ่อม"] === reqNo);
      if (!row) throw new Error("ไม่พบข้อมูลใน Machinesymptom");

      // อัปเดตโดยส่งคำสั่ง Update ผ่าน API
      const rowKey = row["_rowKey"] || row["_RowKey"] || row["__rowKey"]; 
      if (!rowKey) throw new Error("ไม่พบคีย์สำหรับอัปเดต");

      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/Machinesymptom/Rows/${rowKey}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({
          "รายละเอียดอาการเสีย": symptom,
          "แก้ไขความคิดเห็น": comment
        })
      });
      if (!res.ok) throw new Error("Update Machinesymptom ล้มเหลว");
    } catch (e) {
      throw e;
    }
  }

  async function deleteRepairTechniciansByRequestNumber(reqNo) {
    // ลบ RepairTechnicians ที่เลขที่ใบแจ้งซ่อม = reqNo
    try {
      const toDelete = allRepairTechnicians.filter(rt => rt["เลขที่ใบแจ้งซ่อม"] === reqNo);
      for (const row of toDelete) {
        const rowKey = row["_rowKey"] || row["_RowKey"] || row["__rowKey"];
        if (!rowKey) continue;
        await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Rows/${rowKey}`, {
          method: "DELETE",
          headers: {
            "ApplicationAccessKey": apiKey,
          }
        });
      }
    } catch (e) {
      throw e;
    }
  }

  async function insertRepairTechnician(data) {
    try {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Rows`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error("Insert RepairTechnicians ล้มเหลว");
    } catch (e) {
      throw e;
    }
  }

  async function deleteRepairPartsByRequestNumber(reqNo) {
    try {
      const toDelete = allRepairParts.filter(p => p["เลขที่ใบแจ้งซ่อม"] === reqNo);
      for (const row of toDelete) {
        const rowKey = row["_rowKey"] || row["_RowKey"] || row["__rowKey"];
        if (!rowKey) continue;
        await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Rows/${rowKey}`, {
          method: "DELETE",
          headers: {
            "ApplicationAccessKey": apiKey,
          }
        });
      }
    } catch (e) {
      throw e;
    }
  }

  async function insertRepairPart(data) {
    try {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Rows`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error("Insert RepairParts ล้มเหลว");
    } catch (e) {
      throw e;
    }
  }

  // เริ่มต้นโหลดข้อมูล
  async function init() {
    await loadDepartments();
    await loadEmpTechnicians();
    await loadAllData();
  }

  init();
</script>
</body>
</html>
