<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RepairTechnicians Management</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:"Sarabun",sans-serif;background:#f1f5f9;color:#0f172a;padding:1rem}
  h1{color:#1e40af;margin-bottom:1rem}
  table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  th,td{padding:0.5rem;border:1px solid #e6eef6;text-align:left;vertical-align:middle}
  thead th{background:#1e40af;color:white;font-weight:600;font-size:0.95rem}
  tbody tr:hover{background:#f8fafc}
  .status{display:inline-block;padding:0.15rem 0.5rem;border-radius:9999px;font-weight:600;font-size:0.78rem}
  .status.‡∏à‡∏ö‡∏á‡∏≤‡∏ô{background:#34d399;color:#064e3b}
  .status.‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô{background:#fbbf24;color:#7c2d12}
  .modal-bg{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:50;padding:1rem}
  .modal{background:white;border-radius:8px;padding:1rem;max-width:900px;width:100%;max-height:90vh;overflow:auto}
  input,select,textarea{width:100%;padding:0.45rem;border:1px solid #cbd5e1;border-radius:6px;margin-bottom:0.5rem}
  .btn{padding:0.45rem 0.8rem;border-radius:6px;font-weight:600;cursor:pointer}
  .btn-blue{background:#1e3a8a;color:#fff}
  .btn-blue:hover{background:#1e40af}
  .btn-gray{background:#e6eef6;color:#0f172a}
  .chip{display:inline-block;padding:0.25rem 0.5rem;border-radius:999px;border:1px solid #cbd5e1}
  @media (max-width:640px){ th,td{font-size:0.78rem} }
</style>
</head>
<body>
<nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
<a href="https://appsheetsvi.github.io/Menu.html" class="font-semibold">üè† Home</a>
<div class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
<div></div>
</nav>
<h1>RepairTechnicians Management</h1>

<!-- Filters -->
<div class="mb-4 flex flex-wrap gap-3 items-end">
  <div>
    <label class="block text-sm font-semibold">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" id="filterFrom">
  </div>
  <div>
    <label class="block text-sm font-semibold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" id="filterTo">
  </div>
  <div>
    <label class="block text-sm font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
    <select id="filterDept"><option value="">-- ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option></select>
  </div>
  <div>
    <label class="block text-sm font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
    <select id="filterStatus">
      <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
      <option value="‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
      <option value="‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
    </select>
  </div>
  <div class="ml-auto flex gap-2">
    <button class="btn btn-blue" id="btnFilter">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    <button class="btn btn-gray" id="btnReset">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    <button class="btn btn-blue" id="btnAdd">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button class="btn btn-gray" id="btnExport">Export CSV</button>
  </div>
</div>

<!-- Table -->
<div id="tableWrap" class="overflow-x-auto">
  <table id="dataTable" style="display:none">
    <thead>
      <tr>
        <th>‡∏ß/‡∏î/‡∏õ</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
        <th>‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
        <th>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th>
        <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
        <th>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
        <th>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th>
        <th>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div id="noData" class="text-center text-gray-500 italic mt-4" style="display:none">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
</div>

<!-- Modal Add/Edit -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <div class="flex justify-between items-start mb-3">
      <h2 id="modalTitle" class="text-xl font-semibold text-blue-700">‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h2>
      <button onclick="closeModal()" class="text-xl font-bold">√ó</button>
    </div>

    <div>
      <!-- hidden -->
      <input type="hidden" id="recID">
      <input type="hidden" id="recVersion">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
          <input id="fieldRequestNo" type="text" />
        </div>
        <div>
          <label class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
          <select id="fieldDept"></select>
        </div>
        <div>
          <label class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
          <select id="fieldMachine"></select>
        </div>
        <div>
          <label class="font-semibold">‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥ (EmpCode)</label>
          <select id="fieldEmp"></select>
        </div>
      </div>

      <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
          <input id="fieldStart" type="datetime-local" />
        </div>
        <div>
          <label class="font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</label>
          <input id="fieldEnd" type="datetime-local" />
        </div>
      </div>

      <div class="mt-2">
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea id="fieldProblem" rows="2"></textarea>
      </div>

      <div class="mt-2">
        <label class="font-semibold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="fieldCause" rows="2"></textarea>
      </div>

      <div class="mt-2">
        <label class="font-semibold">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
        <textarea id="fieldFix" rows="2"></textarea>
      </div>

      <div class="mt-2">
        <label class="font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á</label>
        <select id="fieldStatus">
          <option value="‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
          <option value="‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
        </select>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="btn btn-gray" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-blue" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ============ CONFIG ============ */
const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

/* ============ STATE ============ */
let repairData = [];
let empList = [];
let deptList = [];
let machineList = [];

/* ============ HELPERS ============ */
const apiCall = (table, payload) => fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${table}/Action`, {
  method: "POST",
  headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
  body: JSON.stringify(payload)
}).then(r => r.json());

function fmtDateThai(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  if(isNaN(d)) return "-";
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()+543}`;
}
function toInputLocal(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(isNaN(d)) return "";
  const pad=(n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function timeRange(startIso,endIso){
  if(!startIso || !endIso) return "-";
  const s = new Date(startIso);
  const e = new Date(endIso);
  if(isNaN(s)||isNaN(e)) return "-";
  const opts={hour:'2-digit',minute:'2-digit',hour12:false};
  return `${s.toLocaleTimeString('th-TH',opts)} - ${e.toLocaleTimeString('th-TH',opts)}`;
}

/* ============ LOAD SUPPORTING DATA ============ */
async function loadLookups(){
  try{
    // Dept
    const deptRes = await apiCall("Department",{Action:"Find",Expression:"TRUE"});
    deptList = Array.isArray(deptRes)? deptRes : (deptRes.Rows || []);
    const fldDept = document.getElementById("fieldDept");
    const fFilterDept = document.getElementById("filterDept");
    fldDept.innerHTML = "<option value=''>--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>";
    fFilterDept.innerHTML = "<option value=''>-- ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>";
    deptList.forEach(d=>{
      const code = d.DeptCode || d["‡∏£‡∏´‡∏±‡∏™"] || d["DepartmentID"] || d.DeptCode;
      const name = d.DeptNameEng || d.DeptName || code;
      if(!code) return;
      const opt = document.createElement("option"); opt.value=code; opt.textContent = name;
      fldDept.appendChild(opt);
      fFilterDept.appendChild(opt.cloneNode(true));
    });

    // Emp
    const empRes = await apiCall("Emp",{Action:"Find",Expression:"TRUE"});
    empList = Array.isArray(empRes)? empRes : (empRes.Rows || []);
    const fldEmp = document.getElementById("fieldEmp");
    fldEmp.innerHTML = "<option value=''>--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á--</option>";
    empList.forEach(e=>{
      const code = e.EmpCode || e["‡∏£‡∏´‡∏±‡∏™"] || "";
      const name = e.EmpName || e.EmpNameEng || e["‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"] || code;
      if(!code) return;
      const opt = document.createElement("option"); opt.value=code; opt.textContent=name;
      fldEmp.appendChild(opt);
    });

    // Machine
    const mRes = await apiCall("MachineMaster",{Action:"Find",Expression:"TRUE"});
    machineList = Array.isArray(mRes)? mRes : (mRes.Rows || []);
    const fldMachine = document.getElementById("fieldMachine");
    fldMachine.innerHTML = "<option value=''>--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á--</option>";
    machineList.forEach(m=>{
      const code = m.MachineCode || m["‡∏£‡∏´‡∏±‡∏™"] || m["‡∏£_code"] || m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "";
      const name = m.MachineName || m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"] || code;
      if(!code) return;
      const opt = document.createElement("option"); opt.value=code; opt.textContent = `${code} - ${name}`;
      fldMachine.appendChild(opt);
    });
  }catch(err){
    console.error("loadLookups:",err);
  }
}

/* ============ LOAD REPAIR DATA ============ */
async function loadRepairData(expression="TRUE"){
  try{
    document.getElementById("tableBody").innerHTML = "";
    document.getElementById("dataTable").style.display = "none";
    document.getElementById("noData").style.display = "block";
    const res = await apiCall("RepairTechnicians",{Action:"Find",Expression: expression});
    repairData = Array.isArray(res) ? res : (res.Rows || []);
    renderTable();
  }catch(err){
    console.error("loadRepairData",err);
    document.getElementById("noData").textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
    document.getElementById("noData").style.display = "block";
  }
}

/* ============ RENDER TABLE ============ */
function renderTable(){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;
  const dept = document.getElementById("filterDept").value;
  const status = document.getElementById("filterStatus").value;

  const filtered = repairData.filter(r=>{
    const d = r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"] ? new Date(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]) : null;
    if(status && (r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"]||"") !== status) return false;
    if(dept && (r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]||"") !== dept) return false;
    if(from && d && d < new Date(from+"T00:00:00")) return false;
    if(to && d && d > new Date(to+"T23:59:59")) return false;
    return true;
  });

  if(!filtered.length){
    document.getElementById("dataTable").style.display = "none";
    document.getElementById("noData").style.display = "block";
    return;
  }
  document.getElementById("dataTable").style.display = "";
  document.getElementById("noData").style.display = "none";

  filtered.forEach(r=>{
    const empName = (r.EmpCode || "").split(",").map(code=>{
      const e = empList.find(x => (x.EmpCode||x["‡∏£‡∏´‡∏±‡∏™"]) === code.trim());
      return e ? (e.EmpName||e.EmpNameEng||code) : code;
    }).join(", ") || "-";
// ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏´‡∏±‡∏™ - ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"
const mObj = machineList.find(m => 
    (m.MachineCode || m["‡∏£‡∏´‡∏±‡∏™"] || m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]) === r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]
);
const machineName = mObj 
    ? `${mObj.MachineCode || mObj["‡∏£‡∏´‡∏±‡∏™"] || ""} - ${mObj.MachineName || mObj["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"] || ""}` 
    : r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "-";


    const date = fmtDateThai(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${date}</td>
      <td style="text-align:center">${timeRange(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"], r["‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö"])}</td>
      <td>${empName}</td>
      <td>${r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "-"}</td>
      <td>${(deptList.find(d=> (d.DeptCode||d["‡∏£‡∏´‡∏±‡∏™"])===r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"])?.DeptNameEng) || r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "-"}</td>
      <td>${machineName}</td>
      <td>${r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "-"}</td>
      <td>${r["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "-"}</td>
      <td><span class="status ${ (r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"]||"").replace(/\s/g,"") }">${r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || "-"}</span></td>
      <td><button class="btn btn-blue" onclick="openEdit('${r.ID}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* small helper used above */
function fmtDateThai(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  if(isNaN(d)) return "-";
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()+543}`;
}

/* ============ MODAL: open add / edit / close ============ */
function openAdd(){
  document.getElementById("modalTitle").textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà";
  document.getElementById("recID").value = "";
  document.getElementById("recVersion").value = "";
  document.getElementById("fieldRequestNo").value = "";
  document.getElementById("fieldDept").value = "";
  document.getElementById("fieldMachine").value = "";
  document.getElementById("fieldEmp").value = "";
  document.getElementById("fieldStart").value = "";
  document.getElementById("fieldEnd").value = "";
  document.getElementById("fieldProblem").value = "";
  document.getElementById("fieldCause").value = "";
  document.getElementById("fieldFix").value = "";
  document.getElementById("fieldStatus").value = "‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô";
  document.getElementById("modalBg").style.display = "flex";
}
function openEdit(id){
  const rec = repairData.find(r=>r.ID===id);
  if(!rec) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
  document.getElementById("modalTitle").textContent = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
  document.getElementById("recID").value = rec.ID || "";
  document.getElementById("recVersion").value = rec.Version || "";
  document.getElementById("fieldRequestNo").value = rec["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "";
  document.getElementById("fieldDept").value = rec["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "";
  document.getElementById("fieldMachine").value = rec["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "";
  document.getElementById("fieldEmp").value = rec.EmpCode || "";
  document.getElementById("fieldStart").value = toInputLocal(rec["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]);
  document.getElementById("fieldEnd").value = toInputLocal(rec["‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö"]);
  document.getElementById("fieldProblem").value = rec["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
  document.getElementById("fieldCause").value = rec["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || "";
  document.getElementById("fieldFix").value = rec["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "";
  document.getElementById("fieldStatus").value = rec["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || "‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô";
  document.getElementById("modalBg").style.display = "flex";
}
function closeModal(){
  document.getElementById("modalBg").style.display = "none";
}

/* ============ SAVE (Add/Edit) ============ */
async function saveRecord(){
  const id = document.getElementById("recID").value;
  const version = document.getElementById("recVersion").value;
  const row = {
    "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": document.getElementById("fieldRequestNo").value.trim(),
    "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": document.getElementById("fieldDept").value,
    "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": document.getElementById("fieldMachine").value,
    "EmpCode": document.getElementById("fieldEmp").value,
    "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": document.getElementById("fieldProblem").value,
    "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": document.getElementById("fieldCause").value,
    "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": document.getElementById("fieldFix").value,
    "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": document.getElementById("fieldStart").value || null,
    "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": document.getElementById("fieldEnd").value || null,
    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": document.getElementById("fieldStatus").value,
    UpdatedBy: "WebUser",
    DateModified: new Date().toISOString()
  };

  try{
    if(id){
      // Edit: must include ID and optionally Version
      const editRow = Object.assign({ ID: id }, row);
      if(version) editRow.Version = version;
      await apiCall("RepairTechnicians",{ Action: "Edit", Rows: [editRow] });
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    } else {
      // Add
      await apiCall("RepairTechnicians",{ Action: "Add", Rows: [row] });
      alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    }
    closeModal();
    await loadRepairData(); // reload
  }catch(err){
    console.error("saveRecord",err);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏î‡∏π console)");
  }
}

/* ============ Export CSV ============ */
function exportCSV(){
  const rows = [];
  const header = ["‡∏ß/‡∏î/‡∏õ","‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ","‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥","‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°","‡πÅ‡∏ú‡∏ô‡∏Å","‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£","‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£","‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"];
  rows.push(header);
  document.querySelectorAll("#tableBody tr").forEach(tr=>{
    const cols = Array.from(tr.querySelectorAll("td")).slice(0,9).map(td=>td.innerText.replace(/\n/g," ").trim());
    rows.push(cols);
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const uri = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
  const a = document.createElement("a");
  a.href = uri;
  a.download = `RepairTechnicians_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
}

/* ============ INIT handlers ============ */
document.getElementById("btnFilter").addEventListener("click", ()=>renderTable());
document.getElementById("btnReset").addEventListener("click", ()=>{
  document.getElementById("filterFrom").value="";
  document.getElementById("filterTo").value="";
  document.getElementById("filterDept").value="";
  document.getElementById("filterStatus").value="";
  renderTable();
});
document.getElementById("btnAdd").addEventListener("click", ()=>openAdd());
document.getElementById("btnExport").addEventListener("click", ()=>exportCSV());
document.getElementById("btnSave").addEventListener("click", ()=>saveRecord());

/* ============ BOOT ============ */
(async function init(){
  try{
   // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const today = new Date();
    const threeDaysAgo = new Date();
    threeDaysAgo.setDate(today.getDate() - 2); // ‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

    // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏õ‡πá‡∏ô yyyy-mm-dd ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input type="date"
    const pad = n => String(n).padStart(2,"0");
    document.getElementById("filterFrom").value = `${threeDaysAgo.getFullYear()}-${pad(threeDaysAgo.getMonth()+1)}-${pad(threeDaysAgo.getDate())}`;
    document.getElementById("filterTo").value = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;


    await loadLookups();
    await loadRepairData(); // ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
  }catch(err){
    console.error("init",err);
  }
})();
</script>

</body>
</html>

