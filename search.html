<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>จัดการงานช่าง + อะไหล่ + ความคืบหน้า</title>
<style>
  body {
    font-family: 'Sarabun', sans-serif;
    background: #f9fafb;
    margin: 0; padding: 1rem;
    color: #222;
  }
  h1 {
    text-align: center;
    color: #2563eb;
    margin-bottom: 1rem;
  }
  #filterContainer {
    max-width: 900px;
    margin: 0 auto 1rem auto;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    align-items: center;
  }
  select {
    padding: 0.3rem 0.5rem;
    font-size: 1rem;
    border-radius: 6px;
    border: 1.5px solid #60a5fa;
  }
  #cardsContainer {
    max-width: 900px;
    margin: 0 auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 6px rgb(0 0 0 / 0.1);
  }
  thead {
    background-color: #2563eb;
    color: white;
  }
  th, td {
    padding: 0.6rem 0.8rem;
    border: 1px solid #ddd;
    text-align: left;
    vertical-align: middle;
  }
  tbody tr:nth-child(even) {
    background: #f3f4f6;
  }
  button.edit-btn {
    background: #2563eb;
    border: none;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  button.edit-btn:hover {
    background-color: #1e40af;
  }
  /* Modal */
  #editModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #editModal.show {
    display: flex;
  }
  #editModal .modal-content {
    background: white;
    border-radius: 10px;
    padding: 1.5rem 2rem;
    max-width: 600px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
  }
  #editModal h2 {
    margin-top: 0;
    color: #2563eb;
    text-align: center;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
  }
  input[type="text"], input[type="datetime-local"], select, textarea {
    width: 100%;
    padding: 0.4rem 0.6rem;
    margin-top: 0.3rem;
    border: 1.5px solid #60a5fa;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
  }
  textarea {
    min-height: 80px;
    resize: vertical;
  }
  .buttons {
    margin-top: 1.5rem;
    text-align: right;
  }
  .buttons button {
    padding: 0.5rem 1.2rem;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-left: 0.5rem;
    font-size: 0.9rem;
    transition: background-color 0.3s;
  }
  .buttons .save-btn {
    background-color: #2563eb;
    color: white;
  }
  .buttons .save-btn:hover {
    background-color: #1e40af;
  }
  .buttons .cancel-btn {
    background-color: #ddd;
    color: #333;
  }
  .buttons .cancel-btn:hover {
    background-color: #bbb;
  }
  /* อะไหล่ ใน modal */
  #partsContainer {
    margin-top: 0.8rem;
    border: 1px solid #60a5fa;
    border-radius: 8px;
    padding: 0.5rem;
    background: #f0f9ff;
  }
  .part-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
    align-items: center;
  }
  .part-row input[type="text"], .part-row input[type="number"] {
    flex: 1;
    padding: 0.4rem 0.6rem;
    border: 1.2px solid #60a5fa;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  .part-row button.remove-part {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.3rem 0.7rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    flex-shrink: 0;
  }
  .part-row button.remove-part:hover {
    background: #b91c1c;
  }
  #addPartBtn {
    margin-top: 0.3rem;
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.4rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  #addPartBtn:hover {
    background: #1e40af;
  }
</style>
</head>
<body>

<h1>จัดการงานช่าง + อะไหล่ + ความคืบหน้า</h1>

<div id="filterContainer">
  <label for="statusFilter">สถานะงานช่าง:</label>
  <select id="statusFilter">
    <option value="all">ทั้งหมด</option>
    <option value="finished">จบงาน</option>
    <option value="unfinished">ไม่จบงาน</option>
  </select>
</div>

<div id="cardsContainer">กำลังโหลดข้อมูล...</div>

<!-- Modal -->
<div id="editModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <h2 id="modalTitle">แก้ไข / เพิ่มงานช่าง</h2>
    <form id="editForm">
      <label for="editRequestNumber">เลขที่ใบแจ้งซ่อม</label>
      <input type="text" id="editRequestNumber" readonly />

      <label for="editEmpCode">รหัสช่าง (EmpCode) <span style="color:red;">*</span></label>
      <input type="text" id="editEmpCode" class="form-control" required />

      <label for="editStatus">สถานะงานช่าง <span style="color:red;">*</span></label>
      <select id="editStatus" required>
        <option value="">-- เลือกสถานะ --</option>
        <option value="อยู่ระหว่างดำเนินการ">อยู่ระหว่างดำเนินการ</option>
        <option value="ซ่อมเสร็จ">ซ่อมเสร็จ</option>
        <option value="รออะไหล่">รออะไหล่</option>
        <option value="ยกเลิก">ยกเลิก</option>
      </select>

      <label for="editComment">ความคิดเห็น</label>
      <textarea id="editComment" placeholder="รายละเอียดเพิ่มเติม"></textarea>

      <label for="editStartTime">เวลาเริ่มงาน</label>
      <input type="datetime-local" id="editStartTime" />

      <label for="editEndTime">เวลาสิ้นสุดงาน</label>
      <input type="datetime-local" id="editEndTime" />

      <hr style="margin: 1rem 0;" />

      <label>รายการอะไหล่</label>
      <div id="partsContainer"></div>
      <button type="button" id="addPartBtn">+ เพิ่มรายการอะไหล่</button>

      <div class="buttons">
        <button type="button" class="cancel-btn" id="modalCancelBtn">ยกเลิก</button>
        <button type="submit" class="save-btn">บันทึก</button>
      </div>
    </form>
  </div>
</div>

<script>
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

  const cardsContainer = document.getElementById("cardsContainer");
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const partsContainer = document.getElementById("partsContainer");
  const addPartBtn = document.getElementById("addPartBtn");
  const modalCancelBtn = document.getElementById("modalCancelBtn");
  const statusFilter = document.getElementById("statusFilter");

  let techniciansData = []; // ข้อมูลงานช่าง
  let partsData = []; // ข้อมูลอะไหล่ทั้งหมด
  let currentEditRecord = null; // ข้อมูลงานช่างที่กำลังแก้ไข

  // แปลงวันที่แบบ พ.ศ. dd/mm/yyyy hh:mm:ss เป็น Date (ปี ค.ศ.)
  function parseThaiDateTimeToDate(thaiDateStr) {
    if (!thaiDateStr) return null;
    // คาดว่า format เช่น "8/8/2568 3:00:00"
    const [datePart, timePart] = thaiDateStr.split(' ');
    if (!datePart) return null;
    const [day, month, year] = datePart.split('/').map(Number);
    if (!day || !month || !year) return null;
    const yearCE = year - 543;
    const time = timePart || "00:00:00";
    // สร้าง ISO string เช่น "2025-08-08T03:00:00"
    const isoString = `${yearCE.toString().padStart(4, '0')}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}T${time}`;
    const date = new Date(isoString);
    if (isNaN(date)) return null;
    return date;
  }

  // แปลง ISO string หรือ Date Object -> dd/mm/yyyy HH:MM โดยบวก +7 ชั่วโมง (เวลาไทย)
  function formatDateTimeLocal(iso) {
    if (!iso) return "-";
    let date;
    if (typeof iso === "string") {
      date = new Date(iso);
      if (isNaN(date)) {
        // อาจเป็นวันที่แบบไทย (พ.ศ.)
        date = parseThaiDateTimeToDate(iso);
        if (!date) return "-";
      }
    } else if (iso instanceof Date) {
      date = iso;
    } else {
      return "-";
    }

    // บวกเวลา 7 ชม. (เวลาไทย)
    date = new Date(date.getTime() + 7*60*60*1000);

    const d = String(date.getDate()).padStart(2,"0");
    const m = String(date.getMonth()+1).padStart(2,"0");
    const y = date.getFullYear();
    const h = String(date.getHours()).padStart(2,"0");
    const min = String(date.getMinutes()).padStart(2,"0");
    return `${d}/${m}/${y} ${h}:${min}`;
  }

  // แปลง Date หรือ ISO string -> yyyy-MM-ddTHH:mm สำหรับ input[type=datetime-local]
  function toDatetimeLocalString(dateInput) {
    let date;
    if (!dateInput) return "";
    if (typeof dateInput === "string") {
      date = new Date(dateInput);
      if (isNaN(date)) {
        // ถ้าเป็นรูปแบบ พ.ศ. แปลงก่อน
        date = parseThaiDateTimeToDate(dateInput);
        if (!date) return "";
      }
    } else if (dateInput instanceof Date) {
      date = dateInput;
    } else {
      return "";
    }

    // ลบเวลา 7 ชม. เพื่อให้ตรงกับเวลาที่ input datetime-local ต้องการ (ซึ่งไม่มี timezone)
    date = new Date(date.getTime() - 7*60*60*1000);

    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    const h = String(date.getHours()).padStart(2, "0");
    const min = String(date.getMinutes()).padStart(2, "0");

    return `${y}-${m}-${d}T${h}:${min}`;
  }

  // โหลดข้อมูลงานช่างและอะไหล่พร้อมกัน
  async function loadData() {
    cardsContainer.textContent = "กำลังโหลดข้อมูล...";

    try {
      // โหลดงานช่าง
      const resTech = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({ Action: "Find", Expression: "TRUE" })
      });
      if (!resTech.ok) throw new Error("โหลดข้อมูลงานช่างล้มเหลว");
      techniciansData = await resTech.json();
      if (!Array.isArray(techniciansData)) techniciansData = [];

      // โหลดอะไหล่
      const resParts = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({ Action: "Find", Expression: "TRUE" })
      });
      if (!resParts.ok) throw new Error("โหลดข้อมูลอะไหล่ล้มเหลว");
      partsData = await resParts.json();
      if (!Array.isArray(partsData)) partsData = [];

      renderCards();
    } catch (err) {
      cardsContainer.innerHTML = `<p style="color:red;text-align:center;">เกิดข้อผิดพลาด: ${err.message}</p>`;
      console.error(err);
    }
  }

  // กรอง techniciansData ตาม dropdown สถานะ
  function filterTechniciansByStatus(data, status) {
    if (status === "all") return data;
    if (status === "finished") {
      return data.filter(d => d["สถานะของงานช่าง"] === "ซ่อมเสร็จ");
    }
    if (status === "unfinished") {
      return data.filter(d => d["สถานะของงานช่าง"] !== "ซ่อมเสร็จ");
    }
    return data;
  }

  // แสดงรายการงานช่าง พร้อมอะไหล่ที่เกี่ยวข้อง แบบตาราง
  function renderCards() {
    if (techniciansData.length === 0) {
      cardsContainer.innerHTML = `<p style="text-align:center; color:#666;">ไม่มีข้อมูลงานช่าง</p>`;
      return;
    }

    const filteredData = filterTechniciansByStatus(techniciansData, statusFilter.value);

    if (filteredData.length === 0) {
      cardsContainer.innerHTML = `<p style="text-align:center; color:#666;">ไม่มีข้อมูลงานช่างตามเงื่อนไข</p>`;
      return;
    }

    // จัดกลุ่มอะไหล่ตามเลขที่ใบแจ้งซ่อม
    const partsByRequest = {};
    for (const p of partsData) {
      const reqNo = p["เลขที่ใบแจ้งซ่อม"] || "";
      if (!partsByRequest[reqNo]) partsByRequest[reqNo] = [];
      partsByRequest[reqNo].push(p);
    }

    let html = `<table><thead><tr>
      <th>เลขที่ใบแจ้งซ่อม</th>
      <th>รหัสช่าง (EmpCode)</th>
      <th>สถานะงานช่าง</th>
      <th>เวลาเริ่มงาน</th>
      <th>เวลาสิ้นสุดงาน</th>
      <th>ความคิดเห็น</th>
      <th>รายการอะไหล่ (ลำดับ, รายการ, จำนวน, หน่วย)</th>
      <th>จัดการ</th>
    </tr></thead><tbody>`;

    filteredData.forEach(rec => {
      const reqNo = rec["เลขที่ใบแจ้งซ่อม"] || "-";
      const parts = partsByRequest[reqNo] || [];

      const partsHtml = parts.length
        ? parts
            .sort((a, b) => (a.Seq || 0) - (b.Seq || 0))
            .map(p => `${p.Seq || '-'}: ${p["รายการอะไหล่"]} จำนวน ${p["จำนวน"]} ${p["หน่วย"]}`)
            .join("<br>")
        : '<span style="color:#999;">ไม่มีอะไหล่</span>';

      html += `<tr>
        <td>${reqNo}</td>
        <td>${rec.EmpCode || "-"}</td>
        <td>${rec["สถานะของงานช่าง"] || "-"}</td>
        <td>${formatDateTimeLocal(rec["เวลาเริ่ม"])}</td>
        <td>${formatDateTimeLocal(rec["เวลาจบ"])}</td>
        <td>${rec["การแก้ไขความคิดเห็น"] || "-"}</td>
        <td style="white-space: nowrap;">${partsHtml}</td>
        <td><button class="edit-btn" data-reqno="${reqNo}" data-empcode="${rec.EmpCode}">แก้ไข</button></td>
      </tr>`;
    });

    html += "</tbody></table>";

    cardsContainer.innerHTML = html;

    // ผูก event ปุ่มแก้ไข
    document.querySelectorAll(".edit-btn").forEach(btn => {
      btn.onclick = () => {
        const reqNo = btn.getAttribute("data-reqno");
        const empCode = btn.getAttribute("data-empcode");
        openEditModal(reqNo, empCode);
      };
    });
  }

  // เปิด modal พร้อมโหลดข้อมูลงานช่างและอะไหล่
  function openEditModal(requestNumber, empCode) {
    currentEditRecord = techniciansData.find(
      rec => rec["เลขที่ใบแจ้งซ่อม"] === requestNumber && rec.EmpCode === empCode
    );

    // กรณีไม่มีข้อมูล ให้สร้างใหม่ (กรณีเพิ่มงานใหม่)
    if (!currentEditRecord) {
      currentEditRecord = {
        "เลขที่ใบแจ้งซ่อม": requestNumber,
        EmpCode: empCode,
        "สถานะของงานช่าง": "",
        "การแก้ไขความคิดเห็น": "",
        "เวลาเริ่ม": "",
        "เวลาจบ": ""
      };
    }

    // กรอกข้อมูลใน form
    editForm.reset();
    document.getElementById("editRequestNumber").value = currentEditRecord["เลขที่ใบแจ้งซ่อม"] || "";
    document.getElementById("editEmpCode").value = currentEditRecord.EmpCode || "";
    document.getElementById("editStatus").value = currentEditRecord["สถานะของงานช่าง"] || "";
    document.getElementById("editComment").value = currentEditRecord["การแก้ไขความคิดเห็น"] || "";
    document.getElementById("editStartTime").value = toDatetimeLocalString(currentEditRecord["เวลาเริ่ม"]);
    document.getElementById("editEndTime").value = toDatetimeLocalString(currentEditRecord["เวลาจบ"]);

    // โหลดอะไหล่ของใบแจ้งซ่อมนี้
    const partsForThisRequest = partsData.filter(p => p["เลขที่ใบแจ้งซ่อม"] === requestNumber && p.EmpCode === empCode);

    renderParts(partsForThisRequest);

    editModal.classList.add("show");
  }

  // แสดงอะไหล่ใน modal
  function renderParts(partsList) {
    partsContainer.innerHTML = "";
    if (partsList.length === 0) {
      partsContainer.innerHTML = "<p style='color:#666;'>ยังไม่มีรายการอะไหล่</p>";
      return;
    }
    partsList.forEach(p => {
      addPartRow(p);
    });
  }

  // สร้างแถวอะไหล่ใหม่ใน modal
  function addPartRow(data = {}) {
    const row = document.createElement("div");
    row.className = "part-row";

    // Seq
    const inputSeq = document.createElement("input");
    inputSeq.type = "number";
    inputSeq.min = "1";
    inputSeq.placeholder = "ลำดับ";
    inputSeq.value = data.Seq || "";
    inputSeq.title = "ลำดับ";
    inputSeq.required = true;

    // รายการอะไหล่
    const inputItem = document.createElement("input");
    inputItem.type = "text";
    inputItem.placeholder = "รายการอะไหล่";
    inputItem.value = data["รายการอะไหล่"] || "";
    inputItem.required = true;

    // จำนวน
    const inputQty = document.createElement("input");
    inputQty.type = "number";
    inputQty.min = "0";
    inputQty.placeholder = "จำนวน";
    inputQty.value = data["จำนวน"] || "";
    inputQty.required = true;

    // หน่วย
    const inputUnit = document.createElement("input");
    inputUnit.type = "text";
    inputUnit.placeholder = "หน่วย";
    inputUnit.value = data["หน่วย"] || "";
    inputUnit.required = true;

    // ปุ่มลบ
    const btnRemove = document.createElement("button");
    btnRemove.type = "button";
    btnRemove.className = "remove-part";
    btnRemove.textContent = "ลบ";
    btnRemove.onclick = () => row.remove();

    row.appendChild(inputSeq);
    row.appendChild(inputItem);
    row.appendChild(inputQty);
    row.appendChild(inputUnit);
    row.appendChild(btnRemove);

    partsContainer.appendChild(row);
  }

  addPartBtn.onclick = () => {
    addPartRow();
  };

  modalCancelBtn.onclick = () => {
    editModal.classList.remove("show");
  };

  editForm.onsubmit = async (evt) => {
    evt.preventDefault();

    // ตรวจสอบข้อมูลก่อนบันทึก
    const requestNumber = document.getElementById("editRequestNumber").value.trim();
    const empCode = document.getElementById("editEmpCode").value.trim();
    const status = document.getElementById("editStatus").value;
    const comment = document.getElementById("editComment").value.trim();
    const startTime = document.getElementById("editStartTime").value;
    const endTime = document.getElementById("editEndTime").value;

    if (!requestNumber) {
      alert("เลขที่ใบแจ้งซ่อมไม่ถูกต้อง");
      return;
    }
    if (!empCode) {
      alert("กรุณากรอกรหัสช่าง (EmpCode)");
      return;
    }
    if (!status) {
      alert("กรุณาเลือกสถานะงานช่าง");
      return;
    }

    // เตรียมข้อมูลงานช่างสำหรับบันทึก
    const techRecord = {
      "เลขที่ใบแจ้งซ่อม": requestNumber,
      EmpCode: empCode,
      "สถานะของงานช่าง": status,
      "การแก้ไขความคิดเห็น": comment,
      "เวลาเริ่ม": startTime ? new Date(new Date(startTime).getTime() + 7*60*60*1000).toISOString() : "",
      "เวลาจบ": endTime ? new Date(new Date(endTime).getTime() + 7*60*60*1000).toISOString() : ""
    };

    try {
      // อัปเดตหรือเพิ่มงานช่าง (Upsert)
      await upsertRecord("RepairTechnicians", techRecord);

      // ลบอะไหล่เก่าของใบแจ้งซ่อมนี้ (เฉพาะที่ EmpCode ตรงกัน)
      const deleteExpr = `AND([เลขที่ใบแจ้งซ่อม]="${requestNumber}", [EmpCode]="${empCode}")`;
      await deleteRecords("RepairParts", deleteExpr);

      // เตรียมข้อมูลอะไหล่ใหม่จาก form
      const newParts = [];
      const rows = partsContainer.querySelectorAll(".part-row");
      rows.forEach(row => {
        const inputs = row.querySelectorAll("input");
        const seq = inputs[0].value.trim();
        const item = inputs[1].value.trim();
        const qty = inputs[2].value.trim();
        const unit = inputs[3].value.trim();
        if (seq && item && qty && unit) {
          newParts.push({
            "เลขที่ใบแจ้งซ่อม": requestNumber,
            EmpCode: empCode,
            Seq: parseInt(seq),
            "รายการอะไหล่": item,
            "จำนวน": qty,
            "หน่วย": unit
          });
        }
      });

      // เพิ่มอะไหล่ใหม่ทีละแถว (จะได้แยกแถวแต่ละรายการ)
      for (const part of newParts) {
        await addRecord("RepairParts", part);
      }

      alert("บันทึกสำเร็จ");
      editModal.classList.remove("show");
      await loadData();
    } catch (err) {
      alert("เกิดข้อผิดพลาดในการบันทึก: " + err.message);
      console.error(err);
    }
  };

  // เพิ่ม record ใหม่ในตาราง
  async function addRecord(tableName, record) {
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey,
      },
      body: JSON.stringify({
        Action: "Add",
        Properties: {},
        Rows: [record]
      })
    });
    if (!res.ok) throw new Error(`เพิ่มข้อมูลใน ${tableName} ล้มเหลว`);
    const json = await res.json();
    return json;
  }

  // อัปเดต record (ถ้ามีแถวเดียวตรงคีย์) หรือเพิ่มใหม่
  async function upsertRecord(tableName, record) {
    // ลอง update ก่อน (key คือ [เลขที่ใบแจ้งซ่อม] + EmpCode)
    const resUpdate = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey,
      },
      body: JSON.stringify({
        Action: "Edit",
        Properties: {},
        Rows: [record]
      })
    });
    if (resUpdate.ok) {
      const json = await resUpdate.json();
      if (json && json.length && json[0].Status === "Success") return json;
    }
    // ถ้าแก้ไขไม่ได้ ให้เพิ่มใหม่แทน
    return await addRecord(tableName, record);
  }

  // ลบ record จากตารางโดย Expression (filter)
  async function deleteRecords(tableName, expression) {
    // ใช้ Action Delete ตาม Expression ได้ (แต่ API อาจจำกัด)
    // วิธีนี้เป็นการหา record ก่อนแล้วลบทีละแถว
    // แต่ API AppSheet ไม่มี Delete by Expression แบบตรงๆ
    // ดังนั้นต้อง Find แล้ว Delete ทีละแถว
    const resFind = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey,
      },
      body: JSON.stringify({ Action: "Find", Expression: expression })
    });
    if (!resFind.ok) throw new Error(`ค้นหาข้อมูลสำหรับลบใน ${tableName} ล้มเหลว`);
    const foundRows = await resFind.json();

    if (!Array.isArray(foundRows) || foundRows.length === 0) return;

    for (const row of foundRows) {
      const key = row["Key"] || row["__RowNumber"]; // ใช้ key หรือเลขแถว
      if (!key) continue;
      const resDel = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({
          Action: "Delete",
          Properties: {},
          Rows: [{ "Key": key }]
        })
      });
      // ไม่ต้อง throw error ถ้าลบไม่สำเร็จ เพราะอาจไม่มี key หรืออะไร
    }
  }

  // โหลดข้อมูลตอนเปิดเพจ
  loadData();

  // กรองสถานะงานช่าง
  statusFilter.onchange = () => {
    renderCards();
  };

</script>

</body>
</html>
