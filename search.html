<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>จัดการงานช่าง + บันทึก RepairProgress + อะไหล่</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
<style>
  /* (เหมือนเดิม) */
  body {
    font-family: 'Sarabun', sans-serif;
    background: #f0f4f8;
    margin: 0; padding: 1rem;
    color: #1e293b;
    font-size: 0.9rem;
  }
  h1 {
    text-align: center;
    color: #2563eb;
    margin-bottom: 1rem;
  }
  #cardsContainer {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 800px;
    margin: 0 auto 2rem auto;
  }
  .card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(100,116,139,0.1);
  }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    color: #1e40af;
  }
  .card-body {
    margin-top: 0.5rem;
    color: #475569;
  }
  button.edit-btn {
    margin-top: 0.8rem;
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.4rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  button.edit-btn:hover {
    background: #1e40af;
  }
  #editModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #editModal.show {
    display: flex;
  }
  #editModal .modal-content {
    background: white;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    width: 95%;
    max-width: 600px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    font-size: 0.9rem;
    max-height: 90vh;
    overflow-y: auto;
  }
  #editModal h2 {
    margin-top: 0;
    color: #2563eb;
    font-size: 1.2rem;
    text-align: center;
  }
  #editModal label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
    color: #1e293b;
  }
  #editModal input, #editModal select, #editModal textarea {
    width: 100%;
    margin-top: 0.3rem;
    padding: 0.5rem;
    font-size: 0.9rem;
    border: 1.5px solid #60a5fa;
    border-radius: 6px;
    font-family: inherit;
    resize: vertical;
    box-sizing: border-box;
  }
  #editModal textarea {
    min-height: 80px;
  }
  #editModal .buttons {
    margin-top: 1.5rem;
    text-align: right;
  }
  #editModal .buttons button {
    padding: 0.5rem 1.2rem;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-left: 0.5rem;
    font-size: 0.9rem;
  }
  #editModal .buttons .save-btn {
    background-color: #2563eb;
    color: white;
  }
  #editModal .buttons .cancel-btn {
    background-color: #ddd;
    color: #333;
  }
  #editModal .buttons .save-btn:hover {
    background-color: #1e40af;
  }
  #editModal .buttons .cancel-btn:hover {
    background-color: #bbb;
  }
  /* อะไหล่ */
  #partsContainer {
    margin-top: 1rem;
    border: 1px solid #60a5fa;
    border-radius: 8px;
    padding: 0.5rem;
    background: #f9fafb;
  }
  .part-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
    align-items: center;
  }
  .part-row input[type="text"], .part-row input[type="number"] {
    flex: 1;
    padding: 0.4rem 0.6rem;
    border: 1.2px solid #60a5fa;
    border-radius: 4px;
  }
  .part-row input.part-id {
    display: none;
  }
  .part-row button.remove-part {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
  }
  .part-row button.remove-part:hover {
    background: #b91c1c;
  }
  #addPartBtn {
    margin-top: 0.5rem;
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.4rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  #addPartBtn:hover {
    background: #1e40af;
  }
</style>
</head>
<body>

<h1>จัดการงานช่างและบันทึกประวัติ RepairProgress พร้อมอะไหล่</h1>

<div id="cardsContainer">กำลังโหลดข้อมูล...</div>

<!-- Modal แก้ไข/เพิ่มงานช่าง และจัดการอะไหล่ -->
<div id="editModal">
  <div class="modal-content">
    <h2>แก้ไข/เพิ่มงานช่าง</h2>
    <form id="editForm">
      <label>เลขที่ใบแจ้งซ่อม</label>
      <input type="text" id="editRequestNumber" readonly />

      <label>รหัสช่าง (EmpCode)</label>
      <input type="text" id="editEmpCode" required />

      <label>สถานะของงานช่าง</label>
      <select id="editStatus" required>
        <option value="">-- เลือกสถานะ --</option>
        <option value="อยู่ระหว่างดำเนินการ">อยู่ระหว่างดำเนินการ</option>
        <option value="ซ่อมเสร็จ">ซ่อมเสร็จ</option>
        <option value="รออะไหล่">รออะไหล่</option>
        <option value="ยกเลิก">ยกเลิก</option>
      </select>

      <label>การแก้ไขความคิดเห็น</label>
      <textarea id="editComment" placeholder="ระบุรายละเอียดเพิ่มเติม"></textarea>

      <label>เวลาเริ่มงาน</label>
      <input type="datetime-local" id="editStartTime" />

      <label>เวลาสิ้นสุดงาน</label>
      <input type="datetime-local" id="editEndTime" />

      <hr style="margin:1rem 0;" />

      <label>รายการอะไหล่</label>
      <div id="partsContainer">
        <!-- แถวอะไหล่จะมาแสดงที่นี่ -->
      </div>
      <button type="button" id="addPartBtn">+ เพิ่มรายการอะไหล่</button>

      <div class="buttons">
        <button type="button" class="cancel-btn" onclick="closeModal()">ยกเลิก</button>
        <button type="submit" class="save-btn">บันทึก</button>
      </div>
    </form>
  </div>
</div>

<script>
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

  let dataList = [];
  let currentEditId = null;
  let currentEditData = null;

  const cardsContainer = document.getElementById("cardsContainer");
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const partsContainer = document.getElementById("partsContainer");
  const addPartBtn = document.getElementById("addPartBtn");

  // โหลดข้อมูล RepairTechnicians ทั้งหมด
  async function loadRepairTechnicians() {
    cardsContainer.innerHTML = "กำลังโหลดข้อมูล...";
    try {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Find`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({}) // ดึงทั้งหมด
      });
      if (!res.ok) throw new Error("โหลดข้อมูลล้มเหลว");
      dataList = await res.json();
      if (!Array.isArray(dataList)) dataList = [];

      if (dataList.length === 0) {
        cardsContainer.innerHTML = "<p style='text-align:center; color:#666;'>ไม่พบข้อมูลงานช่าง</p>";
        return;
      }
      renderCards(dataList);
    } catch (error) {
      cardsContainer.innerHTML = `<p style="text-align:center; color:red;">เกิดข้อผิดพลาด: ${error.message}</p>`;
      console.error(error);
    }
  }

  // สร้าง card รายการงานช่าง
  function renderCards(list) {
    cardsContainer.innerHTML = "";
    list.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";

      const startTime = item["เวลาเริ่ม"] ? formatDateTimeLocal(item["เวลาเริ่ม"]) : "-";
      const endTime = item["เวลาจบ"] ? formatDateTimeLocal(item["เวลาจบ"]) : "-";

      card.innerHTML = `
        <div class="card-header">
          <div>เลขที่ใบแจ้งซ่อม: <b>${item["เลขที่ใบแจ้งซ่อม"] || "-"}</b></div>
          <div>สถานะ: <b>${item["สถานะของงานช่าง"] || "-"}</b></div>
        </div>
        <div class="card-body">
          <div><strong>รหัสช่าง:</strong> ${item.EmpCode || "-"}</div>
          <div><strong>เริ่ม:</strong> ${startTime}</div>
          <div><strong>จบ:</strong> ${endTime}</div>
          <div><strong>ความคิดเห็น:</strong><br/>${item["การแก้ไขความคิดเห็น"] || "-"}</div>
          <button class="edit-btn" onclick="openEditModal('${item.ID}')">แก้ไข / เพิ่มงานใหม่</button>
        </div>
      `;
      cardsContainer.appendChild(card);
    });
  }

  // ฟังก์ชันแปลง ISO เป็นวันที่แบบไทย (dd/mm/yyyy HH:MM)
  function formatDateTimeLocal(isoStr) {
    try {
      const d = new Date(isoStr);
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    } catch {
      return isoStr;
    }
  }

  // ฟังก์ชันแปลง Date เป็นรูปแบบ datetime-local input (yyyy-MM-ddTHH:mm)
  function toDatetimeLocal(date) {
    const pad = num => num.toString().padStart(2, "0");
    return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  // เปิด modal สำหรับแก้ไข/เพิ่มงานใหม่
  async function openEditModal(id) {
    currentEditId = id;
    currentEditData = dataList.find(d => d.ID === id);
    if (!currentEditData) {
      alert("ไม่พบข้อมูลสำหรับแก้ไข");
      return;
    }

    // กรอกข้อมูลในฟอร์ม
    document.getElementById("editRequestNumber").value = currentEditData["เลขที่ใบแจ้งซ่อม"] || "";
    document.getElementById("editEmpCode").value = currentEditData.EmpCode || "";
    document.getElementById("editStatus").value = currentEditData["สถานะของงานช่าง"] || "";
    document.getElementById("editComment").value = currentEditData["การแก้ไขความคิดเห็น"] || "";
    document.getElementById("editStartTime").value = currentEditData["เวลาเริ่ม"] ? toDatetimeLocal(new Date(currentEditData["เวลาเริ่ม"])) : "";
    document.getElementById("editEndTime").value = currentEditData["เวลาจบ"] ? toDatetimeLocal(new Date(currentEditData["เวลาจบ"])) : "";

    // โหลดข้อมูลอะไหล่ตามเลขที่ใบแจ้งซ่อม
    await loadRepairParts(currentEditData["เลขที่ใบแจ้งซ่อม"]);

    editModal.classList.add("show");
  }

  // ปิด modal
  function closeModal() {
    editModal.classList.remove("show");
    currentEditId = null;
    currentEditData = null;
    editForm.reset();
    clearParts();
  }

  // โหลดอะไหล่ RepairParts ตามเลขที่ใบแจ้งซ่อม
  async function loadRepairParts(requestNumber) {
    partsContainer.innerHTML = "กำลังโหลดอะไหล่...";
    try {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Find`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({
          Filter: `[เลขที่ใบแจ้งซ่อม] = '${requestNumber}'`
        })
      });
      if (!res.ok) throw new Error("โหลดอะไหล่ล้มเหลว");
      const partsData = await res.json();
      if (!Array.isArray(partsData)) {
        partsContainer.innerHTML = "<p style='color:#666;'>ไม่พบข้อมูลอะไหล่</p>";
        return;
      }
      renderParts(partsData);
    } catch (error) {
      partsContainer.innerHTML = `<p style="color:red;">เกิดข้อผิดพลาด: ${error.message}</p>`;
      console.error(error);
    }
  }

  // แสดงอะไหล่ใน modal
  function renderParts(parts) {
    clearParts();
    parts.forEach(p => {
      addPartRow(p.ID, p["รายการอะไหล่"], p["จำนวน"], p["หน่วย"]);
    });
  }

  // เคลียร์อะไหล่ใน modal
  function clearParts() {
    partsContainer.innerHTML = "";
  }

  // เพิ่มแถวอะไหล่ใน modal
  function addPartRow(id = "", name = "", qty = "", unit = "") {
    const row = document.createElement("div");
    row.className = "part-row";

    row.innerHTML = `
      <input type="hidden" class="part-id" value="${id}" />
      <input type="text" class="part-name" placeholder="ชื่ออะไหล่" value="${name}" required />
      <input type="number" class="part-qty" placeholder="จำนวน" value="${qty}" min="1" required />
      <input type="text" class="part-unit" placeholder="หน่วย" value="${unit}" required />
      <button type="button" class="remove-part" title="ลบรายการอะไหล่">X</button>
    `;

    row.querySelector(".remove-part").addEventListener("click", () => {
      row.remove();
    });

    partsContainer.appendChild(row);
  }

  addPartBtn.addEventListener("click", () => {
    addPartRow();
  });

  // บันทึกข้อมูลเมื่อ submit ฟอร์ม
  editForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
      const requestNumber = document.getElementById("editRequestNumber").value.trim();
      const empCodeNew = document.getElementById("editEmpCode").value.trim();
      const statusNew = document.getElementById("editStatus").value;
      const commentNew = document.getElementById("editComment").value.trim();
      const startTimeNew = document.getElementById("editStartTime").value;
      const endTimeNew = document.getElementById("editEndTime").value;

      if (!empCodeNew || !statusNew) {
        alert("กรุณากรอกข้อมูลรหัสช่างและสถานะให้ครบถ้วน");
        return;
      }

      // เพิ่มแถวใหม่ใน RepairTechnicians เสมอ (ไม่แก้ไขแถวเดิม)
      const newTechData = {
        "เลขที่ใบแจ้งซ่อม": requestNumber,
        EmpCode: empCodeNew,
        "สถานะของงานช่าง": statusNew,
        "การแก้ไขความคิดเห็น": commentNew,
        "เวลาเริ่ม": startTimeNew ? new Date(startTimeNew).toISOString() : null,
        "เวลาจบ": endTimeNew ? new Date(endTimeNew).toISOString() : null,
      };

      const resAddTech = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({
          Action: "Add",
          Rows: [newTechData],
        }),
      });

      if (!resAddTech.ok) throw new Error("เพิ่มข้อมูลงานช่างล้มเหลว");

      // เพิ่มแถวใหม่ใน RepairProgress ทุกกรณี
      const newProgressData = {
        "เลขที่ใบแจ้งซ่อม": requestNumber,
        "วันที่อัปเดต": new Date().toISOString(),
        "สถานะ": statusNew,
        "รายละเอียดเพิ่มเติม": commentNew,
        "ผู้แก้ไข": empCodeNew,
      };

      const resAddProgress = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairProgress/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({
          Action: "Add",
          Rows: [newProgressData],
        }),
      });

      if (!resAddProgress.ok) throw new Error("เพิ่มประวัติ RepairProgress ล้มเหลว");

      // บันทึกอะไหล่ (เพิ่ม/แก้ไข) โดยไม่ลบข้อมูลเดิม
      await saveRepairParts(requestNumber);

      alert("บันทึกข้อมูลเรียบร้อยแล้ว");
      closeModal();
      await loadRepairTechnicians();

    } catch (error) {
      alert("เกิดข้อผิดพลาด: " + error.message);
      console.error(error);
    }
  });

  // บันทึกอะไหล่ (เพิ่ม/แก้ไข) โดยไม่ลบข้อมูลเดิม
  async function saveRepairParts(requestNumber) {
    const rowsToAddOrUpdate = [];

    const partRows = partsContainer.querySelectorAll(".part-row");
    for (const row of partRows) {
      const id = row.querySelector(".part-id").value;
      const name = row.querySelector(".part-name").value.trim();
      const qty = parseInt(row.querySelector(".part-qty").value);
      const unit = row.querySelector(".part-unit").value.trim();

      if (!name || !qty || qty <= 0 || !unit) {
        alert("กรุณากรอกข้อมูลอะไหล่ให้ครบถ้วนและถูกต้อง");
        throw new Error("ข้อมูลอะไหล่ไม่ครบถ้วน");
      }

      const rowData = {
        "เลขที่ใบแจ้งซ่อม": requestNumber,
        "รายการอะไหล่": name,
        จำนวน: qty,
        หน่วย: unit,
      };
      if (id) {
        rowData.ID = id;
      }
      rowsToAddOrUpdate.push(rowData);
    }

    if (rowsToAddOrUpdate.length > 0) {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({
          Action: "Edit",
          Rows: rowsToAddOrUpdate,
        }),
      });
      if (!res.ok) throw new Error("บันทึกอะไหล่ล้มเหลว");
      return res.json();
    }
  }

  // โหลดข้อมูลเมื่อเริ่มต้น
  loadRepairTechnicians();

</script>

</body>
</html>
