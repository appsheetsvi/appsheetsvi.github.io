<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RepairTechnicians Management</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:"Sarabun",sans-serif;background:#f1f5f9;color:#0f172a;padding:1rem}
  table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
  th,td{padding:0.75rem;border:1px solid #e2e8f0;text-align:left}
  thead th{background:#1e40af;color:white;font-weight:600;font-size:0.9rem}
  tbody tr:hover{background:#f8fafc}
  .status{display:inline-block;padding:0.2rem 0.6rem;border-radius:9999px;font-weight:600;font-size:0.75rem}
  .status.‡∏à‡∏ö‡∏á‡∏≤‡∏ô{background:#d1fae5;color:#065f46}
  .status.‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô{background:#fef3c7;color:#92400e}
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:50;padding:1rem}
  .modal{background:white;border-radius:12px;padding:1.5rem;max-width:900px;width:100%;max-height:90vh;overflow:auto}
  input,select,textarea{width:100%;padding:0.5rem;border:1px solid #cbd5e1;border-radius:6px;margin-top:0.25rem}
  .btn{padding:0.5rem 1rem;border-radius:6px;font-weight:600;cursor:pointer;transition:all 0.2s}
  .btn-blue{background:#1e40af;color:white}
  .btn-blue:hover{background:#1e3a8a}
  .btn-gray{background:#e2e8f0;color:#475569}
  .readonly-input{background-color: #f8fafc; color: #64748b; cursor: not-allowed;}
  
  /* ===== Mobile Card View ===== */
body{
  font-family:"Sarabun",system-ui,-apple-system,BlinkMacSystemFont;
  background:linear-gradient(180deg,#f8fafc,#e2e8f0);
  color:#0f172a;
  padding:0.75rem;

  font-size:13px;        /* ‡∏ê‡∏≤‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏ö‡∏ö M-FLOW */
  line-height:1.45;
  letter-spacing:0.01em;
}

/* ===== Card Mobile ===== */
@media (max-width: 768px) {

  table thead{display:none}

  table,tbody,tr,td{
    display:block;
    width:100%;
  }

  table tr{
    background:rgba(255,255,255,0.92);
    border-radius:16px;
    padding:0.85rem 0.9rem;
    margin-bottom:0.75rem;
    box-shadow:
      0 8px 20px rgba(15,23,42,.06),
      inset 0 1px 0 rgba(255,255,255,.6);
    border:1px solid #e5e7eb;
    backdrop-filter: blur(8px);
  }

  table td{
    border:none;
    padding:0.25rem 0;
    font-size:0.78rem;
    line-height:1.35;
    color:#334155;
  }

  table td::before{
    content:attr(data-label);
    display:block;
    font-size:0.6rem;
    letter-spacing:0.04em;
    text-transform:uppercase;
    font-weight:600;
    color:#64748b;
    margin-bottom:1px;
  }

  /* Status */
  .status{
  font-size:0.6rem;
  padding:0.16rem 0.55rem;
  font-weight:700;
  letter-spacing:0.03em;
}


  .status.‡∏à‡∏ö‡∏á‡∏≤‡∏ô{
    background:linear-gradient(135deg,#bbf7d0,#86efac);
    color:#065f46;
  }

  .status.‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô{
    background:linear-gradient(135deg,#fde68a,#fcd34d);
    color:#92400e;
  }

  /* Button */
  .btn{
  font-size:0.7rem;
  padding:0.4rem 0.7rem;
  border-radius:9px;
  font-weight:600;
  letter-spacing:0.02em;
}

.btn-blue{
  background:linear-gradient(135deg,#2563eb,#1e40af);
}


/* ===== Text Clamp ===== */
.clamp-2{
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.clamp-3{
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
}
table td{
  font-size:0.78rem;
  color:#334155;
}

table td::before{
  font-size:0.58rem;
  font-weight:600;
  color:#64748b;
  letter-spacing:0.05em;
}
.text-detail{
  font-size:0.75rem;
  color:#475569;
  line-height:1.4;
}


</style>
</head>
<body>

<nav class="bg-blue-600 text-white p-4 flex justify-between items-center rounded-lg mb-4">
  <div class="flex items-center gap-4">
    <a href="https://appsheetsvi.github.io/Menu.html" class="hover:underline">üè† Home</a>
    <span class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
  </div>
</nav>

<div class="bg-white p-4 rounded-lg shadow-sm mb-4">
  <h1 class="text-xl font-bold text-blue-900 mb-4">Maintenance Report</h1>
  <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
    <div><label class="text-xs font-bold">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="filterFrom"></div>
    <div><label class="text-xs font-bold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="filterTo"></div>
    <div><label class="text-xs font-bold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label><select id="filterDept"><option value="">-- ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option></select></div>
    <div><label class="text-xs font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select id="filterStatus"><option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option><option value="‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option><option value="‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option></select></div>
    <div class="flex gap-2"><button class="btn btn-blue flex-1" id="btnFilter">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button><button class="btn btn-gray" id="btnReset">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button></div>
  </div>
</div>

<div class="overflow-x-auto">
  <table id="dataTable" style="display:none">
    <thead>
      <tr>
        <th>‡∏ß/‡∏î/‡∏õ</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
        <th>‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
        <th>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th>
        <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
        <th>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
        <th>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th>
        <th>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div id="noData" class="text-center p-10 text-gray-400 italic" style="display:none">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
</div>

<div class="modal-bg" id="modalBg">
  <div class="modal shadow-2xl">
    <div class="flex justify-between items-center mb-4 border-b pb-2 gap-3">

  <h2 id="modalTitle" class="text-lg font-bold text-blue-800">
    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°
  </h2>

  <div class="flex items-center gap-2">

    <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô (‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏°) -->
    <select
      id="fieldStatus"
      class="status text-[0.7rem] cursor-pointer border-none outline-none">
      <option value="‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
      <option value="‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
    </select>

    <button onclick="closeModal()"
      class="text-xl text-slate-500 hover:text-red-500 font-bold">
      √ó
    </button>
  </div>

</div>



    <div id="timerDisplay" class="text-xs text-orange-600 font-bold mb-2 h-4"></div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="hidden" id="recID">
      <div><label class="text-sm font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label><input id="fieldRequestNo" type="text" readonly class="readonly-input"></div>
      <div><label class="text-sm font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label><input id="fieldDept" type="text" readonly class="readonly-input"></div>
      <div><label class="text-sm font-semibold">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input id="fieldMachine" type="text" readonly class="readonly-input"></div>
      <div><label class="text-sm font-semibold">‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥</label><input id="fieldEmp" type="text" readonly class="readonly-input"></div>
      <div><label class="text-sm font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input id="fieldStart" type="datetime-local"></div>
      <div><label class="text-sm font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</label><input id="fieldEnd" type="datetime-local"></div>
    </div>
    
<div class="mt-4">
  <label class="text-sm font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
  <textarea id="fieldProblem" rows="2"></textarea>
</div>

<div class="mt-4">
  <label class="text-sm font-semibold text-purple-700">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
  <textarea id="fieldCause" rows="2"></textarea>
</div>

<div class="mt-4">
  <label class="text-sm font-semibold">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
  <textarea id="fieldFix" rows="2"></textarea>
</div>

    

    <div class="mt-6 flex justify-end gap-3">
      <button class="btn btn-gray" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-blue" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>
</div>

<script>
const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

let repairData = [], empList = [], deptList = [], machineList = [];
let typingStartTime = null;

const apiCall = (table, payload) => fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${table}/Action`, {
  method: "POST",
  headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
  body: JSON.stringify(payload)
}).then(r => r.json());

function formatTypingTime(t){
  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HH:MM:SS ‡∏´‡∏£‡∏∑‡∏≠ MM:SS
  if(!t) return "";

  const parts = t.split(":").map(Number);

  let totalSeconds = 0;
  if(parts.length === 3){
    totalSeconds = parts[0]*3600 + parts[1]*60 + parts[2];
  }else if(parts.length === 2){
    totalSeconds = parts[0]*60 + parts[1];
  }

  const mm = Math.floor(totalSeconds / 60).toString().padStart(2,"0");
  const ss = (totalSeconds % 60).toString().padStart(2,"0");

  return `${mm}:${ss}`;
}

function renderTable(){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  const fFrom = document.getElementById("filterFrom").value;
  const fTo = document.getElementById("filterTo").value;
  const fDept = document.getElementById("filterDept").value;
  const fStatus = document.getElementById("filterStatus").value;

  const filtered = repairData.filter(r => {
    const d = r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"] ? new Date(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]) : null;
    if(fStatus && r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] !== fStatus) return false;
    if(fDept && r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] !== fDept) return false;
    if(fFrom && d && d < new Date(fFrom + "T00:00:00")) return false;
    if(fTo && d && d > new Date(fTo + "T23:59:59")) return false;
    return true;
  });

  if(!filtered.length) {
    document.getElementById("dataTable").style.display = "none";
    document.getElementById("noData").style.display = "block";
    return;
  }
  
  document.getElementById("dataTable").style.display = "table";
  document.getElementById("noData").style.display = "none";

  filtered.forEach(r => {
    const dObj = deptList.find(d => (d.DeptCode || d["‡∏£‡∏´‡∏±‡∏™"]) === r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]);
    const deptFull = dObj ? (dObj.DeptName || r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]) : (r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "-");
   // ===============================
// Map ‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥ (Emp)
// ===============================
const empCode = r.EmpCode || "";

const empObj = empList.find(e =>
  String(e.EmpCode).trim()
  ===
  String(empCode).trim()
);

const empFull = empObj
  ? empObj.EmpName
  : empCode || "-";

   
    const mObj = machineList.find(m =>
  String(
    m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] ||
    m["MachineID"] ||
    m["Machine Code"] ||
    m["Code"] ||
    m.MachineCode
  ).trim()
  ===
  String(r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]).trim()
);
const machineFull = mObj
  ? (mObj["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"] || r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"])
  : r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];



    const startIso = r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"];
    const endIso = r["‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö"];
    let timeRangeText = "--:-- - --:-- (0 ‡∏ô‡∏≤‡∏ó‡∏µ)";
let saveTimeText = "";

if (startIso && endIso) {
  const dS = new Date(startIso);
  const dE = new Date(endIso);

  if (!isNaN(dS) && !isNaN(dE)) {
    const diffMin = Math.round((dE - dS) / 60000);

    const tStart = dS.toLocaleTimeString('th-TH',{
      hour:'2-digit', minute:'2-digit', hour12:false
    });
    const tEnd = dE.toLocaleTimeString('th-TH',{
      hour:'2-digit', minute:'2-digit', hour12:false
    });

    timeRangeText = `${tStart} - ${tEnd} (${diffMin} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
  }
}

// ‡πÄ‡∏ß‡∏•‡∏≤ Save + ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å
if (r["EndBeforeSave"] && r["TimeBeforeSave"]) {
  const saveOnly = r["EndBeforeSave"].substring(0,5); // HH:mm
  const typingMMSS = formatTypingTime(r["TimeBeforeSave"]);
saveTimeText = `${saveOnly} (${typingMMSS} ‡∏ô‡∏≤‡∏ó‡∏µ)`;

}


    const tr = document.createElement("tr");
    tr.innerHTML = `
<td data-label="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">${startIso ? new Date(startIso).toLocaleDateString('th-TH') : '-'}</td>

<td data-label="‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ">
  <div class="font-semibold text-blue-700 text-[0.75rem]">
    ${timeRangeText}
  </div>

  ${
    saveTimeText
    ? `<div class="text-slate-500 text-[0.65rem] mt-0.5">
         ${saveTimeText}
       </div>`
    : ""
  }
</td>


<td data-label="‡∏ä‡πà‡∏≤‡∏á">
  <div class="font-medium text-slate-700 text-[0.75rem]">
    ${empFull}
  </div>
</td>


<td data-label="‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" class="font-bold text-slate-700">
  ${r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "-"}
</td>

<td data-label="‡πÅ‡∏ú‡∏ô‡∏Å">${deptFull}</td>

<td data-label="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">
  <div class="font-medium text-slate-700 text-[0.75rem]">
    ${machineFull}
  </div>
</td>


<td data-label="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£">
  <div class="text-detail clamp-2">
    ${r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "-"}
  </div>
</td>

<td data-label="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
  <div class="text-detail clamp-2">
    ${r["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "-"}
  </div>
</td>



<td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞">
  <span class="status ${(r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"]||"").replace(/\s/g,"")}">
    ${r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"]}
  </span>
</td>
<td>
  <button 
    class="btn btn-blue"
    onclick="openEdit('${r.ID}')">
    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  </button>
</td>

`;


    tbody.appendChild(tr);
  });
}

async function saveRecord() {
    const id = document.getElementById("recID").value;
    const requestNo = document.getElementById("fieldRequestNo").value; // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°)
    const newStatus = document.getElementById("fieldStatus").value;   // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà
    const saveTime = new Date();
    
    const formatTimeOnly = (date) => {
        return date.getHours().toString().padStart(2, '0') + ":" + 
               date.getMinutes().toString().padStart(2, '0') + ":" + 
               date.getSeconds().toString().padStart(2, '0');
    };

    try {
        // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏´‡∏•‡∏±‡∏Å
        const mainRec = repairData.find(r => r.ID === id);
        if (!mainRec) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏´‡∏•‡∏±‡∏Å");

        let rowsToUpdate = [];

        // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏´‡∏•‡∏±‡∏Å (‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
        const mainRow = {
            "ID": id,
            "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": requestNo,
            "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": newStatus,
            "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": document.getElementById("fieldProblem").value.trim(),
            "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": document.getElementById("fieldCause").value.trim(),
            "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": document.getElementById("fieldFix").value.trim(),
            "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": document.getElementById("fieldStart").value.replace('T', ' '),
            "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": document.getElementById("fieldEnd").value.replace('T', ' '),
            "DateModified": (saveTime.getMonth() + 1) + "/" + saveTime.getDate() + "/" + saveTime.getFullYear(),
            "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": mainRec["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"], // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": mainRec["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"],
            "EmpCode": mainRec["EmpCode"]
        };

        // ‡πÉ‡∏™‡πà‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ (Typing Time)
        if (typingStartTime) {
            mainRow["StartBeforeSave"] = formatTimeOnly(typingStartTime);
            mainRow["EndBeforeSave"] = formatTimeOnly(saveTime);
            const diffSec = Math.round((saveTime.getTime() - typingStartTime.getTime()) / 1000);
            const h = Math.floor(diffSec / 3600);
            const m = Math.floor((diffSec % 3600) / 60);
            const s = diffSec % 60;
            mainRow["TimeBeforeSave"] = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }
        rowsToUpdate.push(mainRow);

        // 3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏°‡∏µ "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≤‡∏°
        const relatedRows = repairData.filter(r => 
            r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === requestNo && r.ID !== id
        );

        relatedRows.forEach(rel => {
            rowsToUpdate.push({
                "ID": rel.ID,
                "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": requestNo, // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á Key/‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": newStatus,
                "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": rel["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"], // ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
                "DateModified": mainRow.DateModified
            });
        });

        // 4. ‡∏¢‡∏¥‡∏á API ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å Rows
        const response = await apiCall("RepairTechnicians", { 
            Action: "Edit", 
            Rows: rowsToUpdate 
        });

        if (response) {
            alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rowsToUpdate.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            closeModal();
            location.reload();
        }

    } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    }
}


function openEdit(id){
  const r = repairData.find(x => x.ID === id);
  if(!r) return;

  typingStartTime = new Date();
  document.getElementById("timerDisplay").textContent =
    "‚è± ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤: " + typingStartTime.toLocaleTimeString();

  // Lookup ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
  const dObj = deptList.find(d =>
    (d.DeptCode || d["‡∏£‡∏´‡∏±‡∏™"]) === r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]
  );
  const deptFull = dObj ? (dObj.DeptName || r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]) : r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"];

// ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å RepairTechnicians
const machineCode = r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "";

// Lookup ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£
const mObj = machineList.find(m =>
  String(m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]).trim()
  ===
  String(machineCode).trim()
);

const machineFull = mObj
  ? `${mObj["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]} (${machineCode})`
  : machineCode;


  // Lookup ‡∏ä‡πà‡∏≤‡∏á
  const empObj = empList.find(e => e.EmpCode === r.EmpCode);
  const empFull = empObj ? empObj.EmpName : r.EmpCode;

  document.getElementById("recID").value = r.ID;
  document.getElementById("fieldRequestNo").value = r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "";
  document.getElementById("fieldDept").value = deptFull || "";
  document.getElementById("fieldMachine").value = machineFull || "";
  document.getElementById("fieldEmp").value = empFull || "";
  document.getElementById("fieldStart").value = toInputLocal(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]);
  document.getElementById("fieldEnd").value = toInputLocal(r["‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö"]);
  document.getElementById("fieldProblem").value = r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
  document.getElementById("fieldFix").value = r["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "";
  document.getElementById("fieldCause").value =
  r["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || "";

  document.getElementById("fieldStatus").value = r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || "‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô";

  document.getElementById("modalBg").style.display = "flex";
 
 const statusEl = document.getElementById("fieldStatus");

function syncStatusClass(){
  statusEl.classList.remove("‡∏à‡∏ö‡∏á‡∏≤‡∏ô","‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô");
  if(statusEl.value){
    statusEl.classList.add(statusEl.value);
  }
}

syncStatusClass();
statusEl.onchange = syncStatusClass;



}

async function loadLookups(){
  const [dRes, eRes, mRes] = await Promise.all([
    apiCall("Department",{Action:"Find",Expression:"TRUE"}),
    apiCall("Emp",{Action:"Find",Expression:"TRUE"}),
    apiCall("MachineMaster",{Action:"Find",Expression:"TRUE"})
  ]);
  deptList = dRes.Rows || dRes;
  empList = eRes.Rows || eRes;
  machineList = mRes.Rows || mRes;

  const fFilterDept = document.getElementById("filterDept");
  fFilterDept.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
  deptList.forEach(d => {
    const val = d.DeptCode || d["‡∏£‡∏´‡∏±‡∏™"];
    fFilterDept.add(new Option(d.DeptName || val, val));
  });
}

async function loadRepairData(){
  const res = await apiCall("RepairTechnicians",{Action:"Find",Expression:"TRUE"});
  repairData = res.Rows || res;
  renderTable();
}

function closeModal(){ document.getElementById("modalBg").style.display = "none"; }
function toInputLocal(iso){
  if(!iso) return "";
  const d = new Date(iso);
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

document.getElementById("btnFilter").onclick = renderTable;
document.getElementById("btnReset").onclick = () => { location.reload(); };
document.getElementById("btnSave").onclick = saveRecord;

(async function init(){
  const today = new Date();
  const pad = n => String(n).padStart(2,"0");
  document.getElementById("filterFrom").value = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
  document.getElementById("filterTo").value = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
  await loadLookups();
  await loadRepairData();
})();
</script>
</body>
</html>