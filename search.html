<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RepairTechnicians Management</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:"Sarabun",sans-serif;background:#f1f5f9;color:#0f172a;padding:1rem}
  h1{color:#1e40af;margin-bottom:1rem}
  table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  th,td{padding:0.5rem;border:1px solid #e6eef6;text-align:left;vertical-align:middle}
  thead th{background:#1e40af;color:white;font-weight:600;font-size:0.95rem}
  tbody tr:hover{background:#f8fafc}
  .status{display:inline-block;padding:0.15rem 0.5rem;border-radius:9999px;font-weight:600;font-size:0.78rem}
  .status.จบงาน{background:#34d399;color:#064e3b}
  .status.ไม่จบงาน{background:#fbbf24;color:#7c2d12}
  .modal-bg{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:50;padding:1rem}
  .modal{background:white;border-radius:8px;padding:1rem;max-width:900px;width:100%;max-height:90vh;overflow:auto}
  input,select,textarea{width:100%;padding:0.45rem;border:1px solid #cbd5e1;border-radius:6px;margin-bottom:0.5rem}
  .btn{padding:0.45rem 0.8rem;border-radius:6px;font-weight:600;cursor:pointer}
  .btn-blue{background:#1e3a8a;color:#fff}
  .btn-blue:hover{background:#1e40af}
  .btn-gray{background:#e6eef6;color:#0f172a}
  .chip{display:inline-block;padding:0.25rem 0.5rem;border-radius:999px;border:1px solid #cbd5e1}
  @media (max-width:640px){ th,td{font-size:0.78rem} }
</style>
</head>
<body>

<h1>RepairTechnicians Management</h1>

<!-- Filters -->
<div class="mb-4 flex flex-wrap gap-3 items-end">
  <div>
    <label class="block text-sm font-semibold">จากวันที่</label>
    <input type="date" id="filterFrom">
  </div>
  <div>
    <label class="block text-sm font-semibold">ถึงวันที่</label>
    <input type="date" id="filterTo">
  </div>
  <div>
    <label class="block text-sm font-semibold">หน่วยงาน</label>
    <select id="filterDept"><option value="">-- ทุกแผนก --</option></select>
  </div>
  <div>
    <label class="block text-sm font-semibold">สถานะ</label>
    <select id="filterStatus">
      <option value="">-- ทั้งหมด --</option>
      <option value="ไม่จบงาน">ไม่จบงาน</option>
      <option value="จบงาน">จบงาน</option>
    </select>
  </div>
  <div class="ml-auto flex gap-2">
    <button class="btn btn-blue" id="btnFilter">ค้นหา</button>
    <button class="btn btn-gray" id="btnReset">รีเซ็ต</button>
    <button class="btn btn-blue" id="btnAdd">เพิ่มรายการ</button>
    <button class="btn btn-gray" id="btnExport">Export CSV</button>
  </div>
</div>

<!-- Table -->
<div id="tableWrap" class="overflow-x-auto">
  <table id="dataTable" style="display:none">
    <thead>
      <tr>
        <th>ว/ด/ป</th>
        <th>เวลาที่ใช้</th>
        <th>ช่างผู้ทำ</th>
        <th>ใบแจ้งซ่อม</th>
        <th>แผนก</th>
        <th>รายชื่อเครื่องจักร</th>
        <th>ปัญหาอาการ</th>
        <th>การแก้ไข</th>
        <th>สถานะ</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div id="noData" class="text-center text-gray-500 italic mt-4" style="display:none">ไม่พบข้อมูล</div>
</div>

<!-- Modal Add/Edit -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <div class="flex justify-between items-start mb-3">
      <h2 id="modalTitle" class="text-xl font-semibold text-blue-700">เพิ่ม / แก้ไข</h2>
      <button onclick="closeModal()" class="text-xl font-bold">×</button>
    </div>

    <div>
      <!-- hidden -->
      <input type="hidden" id="recID">
      <input type="hidden" id="recVersion">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">เลขที่ใบแจ้งซ่อม</label>
          <input id="fieldRequestNo" type="text" />
        </div>
        <div>
          <label class="font-semibold">หน่วยงาน</label>
          <select id="fieldDept"></select>
        </div>
        <div>
          <label class="font-semibold">รหัสเครื่อง</label>
          <select id="fieldMachine"></select>
        </div>
        <div>
          <label class="font-semibold">ช่างผู้ทำ (EmpCode)</label>
          <select id="fieldEmp"></select>
        </div>
      </div>

      <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">เวลาเริ่ม</label>
          <input id="fieldStart" type="datetime-local" />
        </div>
        <div>
          <label class="font-semibold">เวลาจบ</label>
          <input id="fieldEnd" type="datetime-local" />
        </div>
      </div>

      <div class="mt-2">
        <label class="font-semibold">รายละเอียดอาการเสีย</label>
        <textarea id="fieldProblem" rows="2"></textarea>
      </div>

      <div class="mt-2">
        <label class="font-semibold">วิเคราะห์สาเหตุ</label>
        <textarea id="fieldCause" rows="2"></textarea>
      </div>

      <div class="mt-2">
        <label class="font-semibold">การแก้ไขความคิดเห็น</label>
        <textarea id="fieldFix" rows="2"></textarea>
      </div>

      <div class="mt-2">
        <label class="font-semibold">สถานะของงานช่าง</label>
        <select id="fieldStatus">
          <option value="ไม่จบงาน">ไม่จบงาน</option>
          <option value="จบงาน">จบงาน</option>
        </select>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="btn btn-gray" onclick="closeModal()">ยกเลิก</button>
        <button class="btn btn-blue" id="btnSave">บันทึก</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ============ CONFIG ============ */
const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

/* ============ STATE ============ */
let repairData = [];
let empList = [];
let deptList = [];
let machineList = [];

/* ============ HELPERS ============ */
const apiCall = (table, payload) => fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${table}/Action`, {
  method: "POST",
  headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
  body: JSON.stringify(payload)
}).then(r => r.json());

function fmtDateThai(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  if(isNaN(d)) return "-";
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()+543}`;
}
function toInputLocal(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(isNaN(d)) return "";
  const pad=(n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function timeRange(startIso,endIso){
  if(!startIso || !endIso) return "-";
  const s = new Date(startIso);
  const e = new Date(endIso);
  if(isNaN(s)||isNaN(e)) return "-";
  const opts={hour:'2-digit',minute:'2-digit',hour12:false};
  return `${s.toLocaleTimeString('th-TH',opts)} - ${e.toLocaleTimeString('th-TH',opts)}`;
}

/* ============ LOAD SUPPORTING DATA ============ */
async function loadLookups(){
  try{
    // Dept
    const deptRes = await apiCall("Department",{Action:"Find",Expression:"TRUE"});
    deptList = Array.isArray(deptRes)? deptRes : (deptRes.Rows || []);
    const fldDept = document.getElementById("fieldDept");
    const fFilterDept = document.getElementById("filterDept");
    fldDept.innerHTML = "<option value=''>--เลือก--</option>";
    fFilterDept.innerHTML = "<option value=''>-- ทุกแผนก --</option>";
    deptList.forEach(d=>{
      const code = d.DeptCode || d["รหัส"] || d["DepartmentID"] || d.DeptCode;
      const name = d.DeptNameEng || d.DeptName || code;
      if(!code) return;
      const opt = document.createElement("option"); opt.value=code; opt.textContent = name;
      fldDept.appendChild(opt);
      fFilterDept.appendChild(opt.cloneNode(true));
    });

    // Emp
    const empRes = await apiCall("Emp",{Action:"Find",Expression:"TRUE"});
    empList = Array.isArray(empRes)? empRes : (empRes.Rows || []);
    const fldEmp = document.getElementById("fieldEmp");
    fldEmp.innerHTML = "<option value=''>--เลือกช่าง--</option>";
    empList.forEach(e=>{
      const code = e.EmpCode || e["รหัส"] || "";
      const name = e.EmpName || e.EmpNameEng || e["ชื่อพนักงาน"] || code;
      if(!code) return;
      const opt = document.createElement("option"); opt.value=code; opt.textContent=name;
      fldEmp.appendChild(opt);
    });

    // Machine
    const mRes = await apiCall("MachineMaster",{Action:"Find",Expression:"TRUE"});
    machineList = Array.isArray(mRes)? mRes : (mRes.Rows || []);
    const fldMachine = document.getElementById("fieldMachine");
    fldMachine.innerHTML = "<option value=''>--เลือกเครื่อง--</option>";
    machineList.forEach(m=>{
      const code = m.MachineCode || m["รหัส"] || m["ร_code"] || m["รหัสเครื่อง"] || "";
      const name = m.MachineName || m["รายชื่อเครื่องจักร"] || code;
      if(!code) return;
      const opt = document.createElement("option"); opt.value=code; opt.textContent = `${code} - ${name}`;
      fldMachine.appendChild(opt);
    });
  }catch(err){
    console.error("loadLookups:",err);
  }
}

/* ============ LOAD REPAIR DATA ============ */
async function loadRepairData(expression="TRUE"){
  try{
    document.getElementById("tableBody").innerHTML = "";
    document.getElementById("dataTable").style.display = "none";
    document.getElementById("noData").style.display = "block";
    const res = await apiCall("RepairTechnicians",{Action:"Find",Expression: expression});
    repairData = Array.isArray(res) ? res : (res.Rows || []);
    renderTable();
  }catch(err){
    console.error("loadRepairData",err);
    document.getElementById("noData").textContent = "โหลดข้อมูลผิดพลาด";
    document.getElementById("noData").style.display = "block";
  }
}

/* ============ RENDER TABLE ============ */
function renderTable(){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;
  const dept = document.getElementById("filterDept").value;
  const status = document.getElementById("filterStatus").value;

  const filtered = repairData.filter(r=>{
    const d = r["เวลาเริ่ม"] ? new Date(r["เวลาเริ่ม"]) : null;
    if(status && (r["สถานะของงานช่าง"]||"") !== status) return false;
    if(dept && (r["หน่วยงาน"]||"") !== dept) return false;
    if(from && d && d < new Date(from+"T00:00:00")) return false;
    if(to && d && d > new Date(to+"T23:59:59")) return false;
    return true;
  });

  if(!filtered.length){
    document.getElementById("dataTable").style.display = "none";
    document.getElementById("noData").style.display = "block";
    return;
  }
  document.getElementById("dataTable").style.display = "";
  document.getElementById("noData").style.display = "none";

  filtered.forEach(r=>{
    const empName = (r.EmpCode || "").split(",").map(code=>{
      const e = empList.find(x => (x.EmpCode||x["รหัส"]) === code.trim());
      return e ? (e.EmpName||e.EmpNameEng||code) : code;
    }).join(", ") || "-";
    const machineName = machineList.find(m=> (m.MachineCode||m["รหัส"]) === r["รหัสเครื่อง"])?.MachineName
                        || r["รหัสเครื่อง"] || "-";
    const date = fmtDateThai(r["เวลาเริ่ม"]);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${date}</td>
      <td style="text-align:center">${timeRange(r["เวลาเริ่ม"], r["เวลาจบ"])}</td>
      <td>${empName}</td>
      <td>${r["เลขที่ใบแจ้งซ่อม"] || "-"}</td>
      <td>${(deptList.find(d=> (d.DeptCode||d["รหัส"])===r["หน่วยงาน"])?.DeptNameEng) || r["หน่วยงาน"] || "-"}</td>
      <td>${machineName}</td>
      <td>${r["รายละเอียดอาการเสีย"] || "-"}</td>
      <td>${r["การแก้ไขความคิดเห็น"] || "-"}</td>
      <td><span class="status ${ (r["สถานะของงานช่าง"]||"").replace(/\s/g,"") }">${r["สถานะของงานช่าง"] || "-"}</span></td>
      <td><button class="btn btn-blue" onclick="openEdit('${r.ID}')">แก้ไข</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* small helper used above */
function fmtDateThai(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  if(isNaN(d)) return "-";
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()+543}`;
}

/* ============ MODAL: open add / edit / close ============ */
function openAdd(){
  document.getElementById("modalTitle").textContent = "เพิ่มรายการใหม่";
  document.getElementById("recID").value = "";
  document.getElementById("recVersion").value = "";
  document.getElementById("fieldRequestNo").value = "";
  document.getElementById("fieldDept").value = "";
  document.getElementById("fieldMachine").value = "";
  document.getElementById("fieldEmp").value = "";
  document.getElementById("fieldStart").value = "";
  document.getElementById("fieldEnd").value = "";
  document.getElementById("fieldProblem").value = "";
  document.getElementById("fieldCause").value = "";
  document.getElementById("fieldFix").value = "";
  document.getElementById("fieldStatus").value = "ไม่จบงาน";
  document.getElementById("modalBg").style.display = "flex";
}
function openEdit(id){
  const rec = repairData.find(r=>r.ID===id);
  if(!rec) return alert("ไม่พบข้อมูลที่จะแก้ไข");
  document.getElementById("modalTitle").textContent = "แก้ไขรายการ";
  document.getElementById("recID").value = rec.ID || "";
  document.getElementById("recVersion").value = rec.Version || "";
  document.getElementById("fieldRequestNo").value = rec["เลขที่ใบแจ้งซ่อม"] || "";
  document.getElementById("fieldDept").value = rec["หน่วยงาน"] || "";
  document.getElementById("fieldMachine").value = rec["รหัสเครื่อง"] || "";
  document.getElementById("fieldEmp").value = rec.EmpCode || "";
  document.getElementById("fieldStart").value = toInputLocal(rec["เวลาเริ่ม"]);
  document.getElementById("fieldEnd").value = toInputLocal(rec["เวลาจบ"]);
  document.getElementById("fieldProblem").value = rec["รายละเอียดอาการเสีย"] || "";
  document.getElementById("fieldCause").value = rec["วิเคราะห์สาเหตุ"] || "";
  document.getElementById("fieldFix").value = rec["การแก้ไขความคิดเห็น"] || "";
  document.getElementById("fieldStatus").value = rec["สถานะของงานช่าง"] || "ไม่จบงาน";
  document.getElementById("modalBg").style.display = "flex";
}
function closeModal(){
  document.getElementById("modalBg").style.display = "none";
}

/* ============ SAVE (Add/Edit) ============ */
async function saveRecord(){
  const id = document.getElementById("recID").value;
  const version = document.getElementById("recVersion").value;
  const row = {
    "เลขที่ใบแจ้งซ่อม": document.getElementById("fieldRequestNo").value.trim(),
    "หน่วยงาน": document.getElementById("fieldDept").value,
    "รหัสเครื่อง": document.getElementById("fieldMachine").value,
    "EmpCode": document.getElementById("fieldEmp").value,
    "รายละเอียดอาการเสีย": document.getElementById("fieldProblem").value,
    "วิเคราะห์สาเหตุ": document.getElementById("fieldCause").value,
    "การแก้ไขความคิดเห็น": document.getElementById("fieldFix").value,
    "เวลาเริ่ม": document.getElementById("fieldStart").value || null,
    "เวลาจบ": document.getElementById("fieldEnd").value || null,
    "สถานะของงานช่าง": document.getElementById("fieldStatus").value,
    UpdatedBy: "WebUser",
    DateModified: new Date().toISOString()
  };

  try{
    if(id){
      // Edit: must include ID and optionally Version
      const editRow = Object.assign({ ID: id }, row);
      if(version) editRow.Version = version;
      await apiCall("RepairTechnicians",{ Action: "Edit", Rows: [editRow] });
      alert("บันทึกการแก้ไขเรียบร้อย");
    } else {
      // Add
      await apiCall("RepairTechnicians",{ Action: "Add", Rows: [row] });
      alert("เพิ่มรายการเรียบร้อย");
    }
    closeModal();
    await loadRepairData(); // reload
  }catch(err){
    console.error("saveRecord",err);
    alert("เกิดข้อผิดพลาดขณะบันทึก (ดู console)");
  }
}

/* ============ Export CSV ============ */
function exportCSV(){
  const rows = [];
  const header = ["ว/ด/ป","เวลาที่ใช้","ช่างผู้ทำ","ใบแจ้งซ่อม","แผนก","รายชื่อเครื่องจักร","ปัญหาอาการ","การแก้ไข","สถานะ"];
  rows.push(header);
  document.querySelectorAll("#tableBody tr").forEach(tr=>{
    const cols = Array.from(tr.querySelectorAll("td")).slice(0,9).map(td=>td.innerText.replace(/\n/g," ").trim());
    rows.push(cols);
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
  const uri = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
  const a = document.createElement("a");
  a.href = uri;
  a.download = `RepairTechnicians_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
}

/* ============ INIT handlers ============ */
document.getElementById("btnFilter").addEventListener("click", ()=>renderTable());
document.getElementById("btnReset").addEventListener("click", ()=>{
  document.getElementById("filterFrom").value="";
  document.getElementById("filterTo").value="";
  document.getElementById("filterDept").value="";
  document.getElementById("filterStatus").value="";
  renderTable();
});
document.getElementById("btnAdd").addEventListener("click", ()=>openAdd());
document.getElementById("btnExport").addEventListener("click", ()=>exportCSV());
document.getElementById("btnSave").addEventListener("click", ()=>saveRecord());

/* ============ BOOT ============ */
(async function init(){
  try{
    await loadLookups();
    await loadRepairData();
  }catch(err){
    console.error("init",err);
  }
})();
</script>

</body>
</html>
