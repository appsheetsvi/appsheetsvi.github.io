<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ค้นหาใบแจ้งซ่อมพร้อมรายละเอียดช่าง</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Sarabun', sans-serif;
    background: #f0f4f8;
    margin: 0; padding: 1rem;
    color: #1e293b; font-size: 0.9rem;
  }
  h1 {
    text-align: center;
    color: #1d4ed8;
    margin-bottom: 1rem;
    font-size: 1.5rem;
  }
  .search-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin-bottom: 1rem;
  }
  .search-bar select,
  .search-bar input[type="date"] {
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    border: 1px solid #cbd5e1;
    font-size: 0.9rem;
    min-width: 140px;
  }
  .search-bar button {
    background: #1d4ed8;
    color: white;
    border: none;
    padding: 0.4rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .search-bar button:hover {
    background: #1e40af;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgb(100 116 139 / 0.1);
    font-size: 0.9rem;
  }
  thead {
    background: #2563eb;
    color: white;
  }
  th, td {
    padding: 0.5rem 0.75rem;
    border: 1px solid #e2e8f0;
    text-align: left;
    vertical-align: middle;
    word-break: break-word;
  }
  tbody tr:hover {
    background: #f0f9ff;
  }
  .status {
    padding: 0.15rem 0.5rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.75rem;
    display: inline-block;
  }
  .status.ซ่อมเสร็จ { background: #34d399; color: #065f46; }
  .status.รออะไหล่ { background: #fde68a; color: #92400e; }
  .status.อยู่ระหว่างดำเนินการ { background: #bfdbfe; color: #1e40af; }
  .status.ยกเลิกซ่อม { background: #fecaca; color: #991b1b; }
  .status.ไม่จบงาน { background: #fbbf24; color: #92400e; }
  .status.จบงาน { background: #34d399; color: #065f46; }

  #noData {
    text-align: center;
    margin-top: 2rem;
    color: #64748b;
    font-style: italic;
  }

  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr {
      display: none;
    }
    tbody tr {
      margin-bottom: 1rem;
      background: white;
      box-shadow: 0 2px 8px rgb(100 116 139 / 0.1);
      border-radius: 10px;
      padding: 1rem;
    }
    tbody td {
      padding-left: 50%;
      position: relative;
      border: none;
      border-bottom: 1px solid #e2e8f0;
      text-align: right;
      font-size: 0.9rem;
    }
    tbody td:last-child {
      border-bottom: none;
    }
    tbody td::before {
      content: attr(data-label);
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-weight: 700;
      color: #334155;
      text-align: left;
      white-space: nowrap;
      width: 45%;
      font-size: 0.85rem;
    }
  }
</style>
</head>
<body>

<h1>ค้นหาใบแจ้งซ่อมพร้อมรายละเอียดช่าง</h1>

<div class="search-bar">
  <select id="searchDepartment">
    <option value="">-- หน่วยงาน --</option>
  </select>
  <input type="date" id="searchDateFrom" />
  <input type="date" id="searchDateTo" />
  <button onclick="searchData()">ค้นหา</button>
  <button onclick="resetSearch()">รีเซ็ต</button>
</div>

<table id="dataTable" style="display:none;">
  <thead>
    <tr>
      <th>ว/ด/ป</th>
      <th>เวลาที่ใช้</th>
      <th>ช่างผู้ทำ</th>
      <th>ใบแจ้งซ่อม</th>
      <th>แผนก</th>
      <th>ชื่อเครื่อง</th>
      <th>ปัญหาอาการ</th>
      <th>การแก้ไข</th>
      <th>สถานะ</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div id="noData" style="display:none;">ไม่พบข้อมูล</div>

<script>
const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

const departmentsMap = {};
let machinesMap = {};
let empMap = {};
let repairTechniciansMap = {};
let cacheData = [];

async function fetchDepartments() {
  try {
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/Department/Find`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify({})
    });
    const data = await res.json();
    const select = document.getElementById("searchDepartment");
    data.forEach(d => {
      departmentsMap[d.DeptCode] = d.DeptNameEng || d.DeptName || d.DeptCode;
      const opt = document.createElement("option");
      opt.value = d.DeptCode;
      opt.textContent = d.DeptNameEng || d.DeptName || d.DeptCode;
      select.appendChild(opt);
    });
  } catch (e) {
    console.error("Error fetching departments", e);
  }
}

async function fetchMachines() {
  try {
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Find`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify({})
    });
    const data = await res.json();
    machinesMap = {};
    data.forEach(m => {
      machinesMap[m["รหัสเครื่อง"]] = m["รายชื่อเครื่องจักร"] || m["รหัสเครื่อง"];
    });
  } catch (e) {
    console.error("Error fetching machines", e);
  }
}

async function fetchEmp() {
  try {
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/Emp/Find`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify({})
    });
    const data = await res.json();
    empMap = {};
    data.forEach(e => {
      empMap[e.EmpCode] = e.EmpName || e.EmpNameEng || e.EmpCode;
    });
  } catch (e) {
    console.error("Error fetching Emp", e);
  }
}

async function fetchRepairTechnicians() {
  try {
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Find`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify({})
    });
    const data = await res.json();
    repairTechniciansMap = {};
    data.forEach(r => {
      const rqNo = r["เลขที่ใบแจ้งซ่อม"];
      if (!repairTechniciansMap[rqNo]) repairTechniciansMap[rqNo] = [];
      repairTechniciansMap[rqNo].push(r);
    });
  } catch (e) {
    console.error("Error fetching RepairTechnicians", e);
  }
}

async function fetchRepairRequests() {
  try {
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/Machinesymptom/Find`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify({})
    });
    const data = await res.json();
    cacheData = data;
  } catch (e) {
    console.error("Error fetching repair requests", e);
  }
}

function formatDateTH(dateStr) {
  if (!dateStr) return "-";
  const d = new Date(dateStr);
  if (isNaN(d)) return "-";

  const day = d.getDate().toString().padStart(2, "0");
  const month = (d.getMonth() + 1).toString().padStart(2, "0");
  const yearCE = d.getFullYear();

  let yearBE = yearCE;
  if (yearCE > 1900 && yearCE < 3000) {
    yearBE = yearCE + 543;
  } else if (yearCE < 1900) {
    return "-";
  }

  return `${day}/${month}/${yearBE}`;
}

function formatDuration(mins) {
  if (mins === null || mins === undefined || isNaN(mins)) return "-";
  if (mins < 60) return `${mins} นาที`;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return m === 0 ? `${h} ชม.` : `${h} ชม. ${m} นาที`;
}

function calcDurationMinutes(start, end) {
  if (!start || !end) return null;
  const d1 = new Date(start);
  const d2 = new Date(end);
  if (isNaN(d1) || isNaN(d2)) return null;
  const diffMs = d2 - d1;
  if (diffMs < 0) return null;
  return Math.round(diffMs / 60000);
}

// ฟังก์ชันแสดงตารางโดยกลุ่มเลขที่/ใบแจ้งซ่อม แสดงเลขที่แค่แถวแรก
function renderTableSortedByStartDate(requestFilter = null) {
  const table = document.getElementById("dataTable");
  const tbody = document.getElementById("tableBody");
  const noData = document.getElementById("noData");

  tbody.innerHTML = "";

  // รวมข้อมูลแถว RepairTechnicians ที่จะเอามาแสดง
  let rows = [];

  Object.entries(repairTechniciansMap).forEach(([requestNumber, techList]) => {
    if (requestFilter && !requestFilter.includes(requestNumber)) return;

    const mainData = cacheData.find(row => row["เลขที่ใบแจ้งซ่อม"] === requestNumber);
    if (!mainData) return;

    techList.forEach(tech => {
      const empName = empMap[tech.EmpCode] || tech.EmpCode;
      const comment = tech["การแก้ไขความคิดเห็น"] || "-";
      const durationMinutes = calcDurationMinutes(tech["เวลาเริ่ม"], tech["เวลาจบ"]);
      const durationFormatted = formatDuration(durationMinutes);

      let statusTextRaw = tech["สถานะของงานช่าง"] || "-";
      let statusText = statusTextRaw;
      if (statusTextRaw === "จบงาน") statusText = "แล้วเสร็จ";
      else if (statusTextRaw === "ไม่จบงาน") statusText = "ไม่เสร็จ";

      const statusClass = statusTextRaw.replace(/\s/g, "");

      rows.push({
        requestNumber,
        startDate: new Date(tech["เวลาเริ่ม"]),
        rowHtml: `
        <tr>
          <td data-label="ว/ด/ป">${formatDateTH(tech["เวลาเริ่ม"]) || "-"}</td>
          <td data-label="เวลาที่ใช้">
            ${formatDateTH(tech["เวลาเริ่ม"]) || "-"} - ${formatDateTH(tech["เวลาจบ"]) || "-"}<br />
            <small style="color:#555;">${durationFormatted}</small>
          </td>
          <td data-label="ช่างผู้ทำ">${empName}</td>
          <td data-label="ใบแจ้งซ่อม">${requestNumber}</td>
          <td data-label="แผนก">${departmentsMap[mainData["หน่วยงาน"]] || "-"}</td>
          <td data-label="ชื่อเครื่อง">${machinesMap[mainData["รหัสเครื่อง"]] || "-"}</td>
          <td data-label="ปัญหาอาการ">${mainData["รายละเอียดอาการเสีย"] || "-"}</td>
          <td data-label="การแก้ไข">${comment}</td>
          <td data-label="สถานะ"><span class="status ${statusClass}">${statusText}</span></td>
        </tr>
      `
      });
    });
  });

  // เรียงจากวันที่ เวลาเริ่ม จากมากไปน้อย
  rows.sort((a, b) => b.startDate - a.startDate);

  if (rows.length === 0) {
    table.style.display = "none";
    noData.style.display = "block";
  } else {
    table.style.display = "table";
    noData.style.display = "none";
    tbody.innerHTML = rows.map(r => r.rowHtml).join("");
  }
}

function searchData() {
  const dept = document.getElementById("searchDepartment").value;
  let from = document.getElementById("searchDateFrom").value;
  let to = document.getElementById("searchDateTo").value;

  // กรณีไม่เลือกวันที่ ให้ดึงวันที่ล่าสุดจาก RepairTechnicians เวลาเริ่ม
  if (!from && !to) {
    let maxDate = null;
    Object.values(repairTechniciansMap).forEach(techList => {
      techList.forEach(tech => {
        const d = new Date(tech["เวลาเริ่ม"]);
        if (!isNaN(d)) {
          if (!maxDate || d > maxDate) maxDate = d;
        }
      });
    });

    if (maxDate) {
      const yyyy = maxDate.getFullYear();
      const mm = (maxDate.getMonth() + 1).toString().padStart(2, "0");
      const dd = maxDate.getDate().toString().padStart(2, "0");
      from = `${yyyy}-${mm}-${dd}`;
      to = from;
      document.getElementById("searchDateFrom").value = from;
      document.getElementById("searchDateTo").value = to;
    }
  }

  const filteredRequestNumbersSet = new Set();

  Object.entries(repairTechniciansMap).forEach(([requestNumber, techList]) => {
    techList.forEach(tech => {
      const d = new Date(tech["เวลาเริ่ม"]);
      if (isNaN(d)) return;

      let ok = true;
      if (from) ok = d >= new Date(from + "T00:00:00");
      if (to && ok) ok = d <= new Date(to + "T23:59:59");

      if (ok) filteredRequestNumbersSet.add(requestNumber);
    });
  });

  let filteredRequestNumbers = Array.from(filteredRequestNumbersSet);

  if (dept) {
    filteredRequestNumbers = filteredRequestNumbers.filter(rqNo => {
      const mainData = cacheData.find(row => row["เลขที่ใบแจ้งซ่อม"] === rqNo);
      return mainData && mainData["หน่วยงาน"] === dept;
    });
  }

  renderTableSortedByStartDate(filteredRequestNumbers);
}

function resetSearch() {
  document.getElementById("searchDepartment").value = "";
  document.getElementById("searchDateFrom").value = "";
  document.getElementById("searchDateTo").value = "";
  renderTableSortedByStartDate();
}

window.addEventListener("DOMContentLoaded", async () => {
  await fetchDepartments();
  await fetchMachines();
  await fetchEmp();
  await fetchRepairTechnicians();
  await fetchRepairRequests();
  renderTableSortedByStartDate();
});
</script>

</body>
</html>
