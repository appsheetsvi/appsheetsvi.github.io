<!DOCTYPE html> 
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Maintenance Report + History</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Sarabun', sans-serif; background:#f0f4f8; margin:0; padding:1rem; color:#1e293b; font-size:0.9rem; }
h1 { color:#1d4ed8; margin:0 0 0.5rem 0; font-size:1.5rem; }

/* ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */
.search-bar { display:flex; flex-wrap:wrap; gap:0.5rem; justify-content:space-between; margin-bottom:1rem; }
.search-bar > div { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; }
.search-bar select, .search-bar input[type="date"] { padding:0.35rem 0.5rem; border-radius:6px; border:1px solid #cbd5e1; font-size:0.9rem; min-width:120px; }
.search-bar button { background:#1d4ed8; color:white; border:none; padding:0.35rem 0.8rem; border-radius:6px; font-weight:600; cursor:pointer; font-size:0.9rem; }
.search-bar button:hover { background:#1e40af; }

/* ‡∏Å‡∏£‡∏≤‡∏ü */
.chart-wrapper { display:flex; justify-content:center; flex-wrap:wrap; gap:1rem; margin-bottom:0.5rem; }
.chart-box {
  width: 180px;
  max-width: 45vw;
  height: 180px;
  padding:0.5rem;
  background:transparent;
  border-radius:8px;
  box-shadow:none;
}
.chart-label {
  text-align:center;
  font-size:0.78rem;
  margin-top:0.25rem;
  color:#0f172a;
}
.chart-legend-custom {
  font-size:0.78rem;
  text-align:center;
  margin-top:0.25rem;
}

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
.table-container { width:100%; overflow-x:auto; }
table { width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; box-shadow:0 2px 8px rgb(100 116 139 / 0.1); font-size:0.9rem; }
thead { background:#2563eb; color:white; position:sticky; top:0; z-index:10; }
th, td { padding:0.5rem 0.75rem; border:1px solid #e2e8f0; text-align:left; vertical-align:middle; }
td.time-used { min-width:140px; white-space:nowrap; }
tbody tr:hover { background:#f0f9ff; }

/* status pill */
.status { display:inline-block; padding:0.25rem 0.75rem; border-radius:9999px; font-weight:600; font-size:0.75rem; line-height:1.25rem; text-align:center; white-space:nowrap; }
.status.‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à, .status.‡∏à‡∏ö‡∏á‡∏≤‡∏ô { background:#34d399; color:#065f46; }
.status.‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà { background:#fde68a; color:#92400e; }
.status.‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ { background:#bfdbfe; color:#1e40af; }
.status.‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏° { background:#fecaca; color:#991b1b; }
.status.‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô { background:#fbbf24; color:#92400e; }

td.request-number { font-size:0.75rem; color:#1e40af; font-weight:600; cursor:pointer; text-decoration:none; }
td.request-number:hover { color:#2563eb; }
#noData { text-align:center; margin-top:1rem; color:#64748b; font-style:italic; }

/* Modal */
#historyModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; overflow:auto; }
#historyModal .modal-content { background:white; margin:5% auto; padding:1rem; border-radius:10px; max-width:900px; max-height:80%; overflow:auto; }
#historyModal table { width:100%; border-collapse:collapse; font-size:0.85rem; }
#historyModal th, #historyModal td { border:1px solid #e2e8f0; padding:0.4rem 0.6rem; }
#historyModal thead { background:#2563eb; color:white; position:sticky; top:0; z-index:5; }

/* Responsive: ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö card ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
@media (max-width:768px){
  table, thead, tbody, th, td, tr { display:block; }
  thead { display:none; }
  tbody tr { margin-bottom:1rem; background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:0.8rem 1rem; }
  tbody td { border:none; padding:0.4rem 0; font-size:0.9rem; display:flex; justify-content:space-between; }
  tbody td::before { content: attr(data-label); font-weight:600; color:#2563eb; margin-right:0.5rem; }
}

/* ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° */
#dataTable th[data-label="‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"],
#dataTable td.request-number {
  font-size: 0.65rem;
  width: 60px;
  white-space: normal;
  word-wrap: break-word;
  overflow: hidden;
}
/* ‡πÅ‡∏ú‡∏ô‡∏Å */
#dataTable th[data-label="‡πÅ‡∏ú‡∏ô‡∏Å"],
#dataTable td[data-label="‡πÅ‡∏ú‡∏ô‡∏Å"] {
  font-size: 0.75rem;
  width: 45px;
  white-space: normal;
  word-wrap: break-word;
  overflow: hidden;
}
/* ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ */
#dataTable th[data-label="‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ"],
#dataTable td.time-used {
  font-size: 0.75rem;
  width: 172px;
  white-space: normal;
  word-wrap: break-word;
  overflow: hidden;
}
/* ‡∏ß/‡∏î/‡∏õ */
#dataTable th[data-label="‡∏ß/‡∏î/‡∏õ"],
#dataTable td[data-label="‡∏ß/‡∏î/‡∏õ"] {
  font-size: 0.72rem;
  width: 80px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
/* ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ */
#dataTable th[data-label="‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"],
#dataTable td[data-label="‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"] {
  font-size: 0.85rem;
  max-width: 200px;
  white-space: normal;
  word-wrap: break-word;
  overflow: hidden;
}
/* ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ */
#dataTable th[data-label="‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"],
#dataTable td[data-label="‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"] {
  font-size: 0.85rem;
  max-width: 1200px;
  white-space: normal;
  word-wrap: break-word;
  overflow: hidden; 
}
</style>
</head>
<body>
<nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
  <a href="https://appsheetsvi.github.io/Menu.html" class="font-semibold">üè† Home</a>
  <div class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
</nav>

<!-- ‡∏Å‡∏£‡∏≤‡∏ü -->
<div class="chart-wrapper">
  <div>
    <div class="chart-box"><canvas id="technicianChart"></canvas></div>
    <div id="technicianLegend" class="chart-legend-custom"></div>
    <div class="chart-label">‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥</div>
  </div>
  <div>
    <div class="chart-box"><canvas id="statusChart"></canvas></div>
    <div class="chart-label">(‡∏à‡∏ö‡∏á‡∏≤‡∏ô / ‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô)</div>
    <div class="chart-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</div>
  </div>
</div>

<h1>Maintenance Report</h1>

<div class="search-bar">
  <div>
    <p>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>
    <input type="date" id="searchDateFrom" />
    <p>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>
    <input type="date" id="searchDateTo" />
    <p>‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥</p>
    <select id="searchTechnician">  
      <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
    </select>
    <p>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</p>
    <select id="searchDepartment">
      <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
    </select>
    
    <!-- ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ PM/Breakdown ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡∏°‡∏µ checkbox -->
    <!--
    <p>PM/Breakdown</p>
    <select id="searchType">
      <option value="all">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
      <option value="pm">PM</option>
      <option value="breakdown">Breakdown</option>
    </select>
    -->
    <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
    <select id="searchStatus">
      <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
      <option value="‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
      <option value="‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
    </select>
    <label class="inline-flex items-center space-x-1">
      <input type="checkbox" id="searchPMOnly" />
      <span>‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PM</span>
    </label>
  </div>
  <div>
    <button onclick="renderTable()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    <button onclick="resetSearch()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
  </div>
</div>

<div class="table-container">
  <table id="dataTable" style="display:none;">
    <thead>
      <tr>
        <th>‡∏ß/‡∏î/‡∏õ</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
        <th>‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
        <th>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th>
        <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
        <th>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
        <th>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th>
        <th>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>
<div id="noData" style="display:none;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>

<!-- History Modal -->
<div id="historyModal">
  <div class="modal-content relative">
    <button class="absolute right-2 top-2 text-red-500 font-bold text-lg" onclick="document.getElementById('historyModal').style.display='none'">‚úï</button>
    <h2 class="text-xl font-semibold mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</h2>
    <table>
      <thead>
        <tr>
          <th>‡∏ß/‡∏î/‡∏õ</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
          <th>‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
          <th>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th>
          <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
          <th>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
          <th>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th>
          <th>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody id="historyContent"></tbody>
    </table>
  </div>
</div>

<script>
const appId="ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey="V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
let repairTableName="RepairTechnicians";

const departmentsMap = {}; // DeptCode -> DeptNameEng
const empMap = {};         // EmpCode -> EmpName
const machineMap = {};     // MachineCode -> MachineName
let cacheData = [];
let techChart = null;
let statusChart = null;

// Helper
function formatDateTH(dateStr){
  if(!dateStr) return "-";
  const d=new Date(dateStr);
  if(isNaN(d)) return "-";
  return `${d.getDate().toString().padStart(2,"0")}/${(d.getMonth()+1).toString().padStart(2,"0")}/${d.getFullYear()+543}`;
}
function formatTimeRangeAndDuration(startTime,endTime){
  const start=new Date(startTime);
  const end=new Date(endTime);
  if(isNaN(start)||isNaN(end)) return "-";
  const opts={hour:"2-digit",minute:"2-digit",hour12:false};
  const timeRange=`${start.toLocaleTimeString("th-TH",opts)} - ${end.toLocaleTimeString("th-TH",opts)}`;
  let mins=Math.round((end-start)/60000);
  const hours=Math.floor(mins/60); mins=mins%60;
  let dur=""; if(hours>0) dur+=hours+" ‡∏ä‡∏°."; if(mins>0) dur+=(dur?" ":"")+mins+" ‡∏ô‡∏≤‡∏ó‡∏µ"; if(!dur) dur="0 ‡∏ô‡∏≤‡∏ó‡∏µ";
  return `${timeRange} (${dur})`;
}
function getTechNamesFromEmpCode(empCodeStr){
  if(!empCodeStr) return "-";
  return empCodeStr
    .split(",")
    .map(c=>c.trim())
    .filter(c=>c)
    .map(c=>empMap[c] || c)
    .filter((v,i,a)=>a.indexOf(v)===i)
    .join(", ");
}

// Generic fetch
async function safeFetch(url,bodyObj,label){
  try{
    const res=await fetch(url,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey": apiKey},
      body:JSON.stringify(bodyObj||{})
    });
    const text=await res.text();
    try { return JSON.parse(text); }
    catch(e){ console.error(label,"not JSON",text); return null; }
  }catch(err){
    console.error(label,"fetch error",err);
    return null;
  }
}

// Fetch Emp (for dropdown + map)
async function fetchEmp(){
  const url=`https://api.appsheet.com/api/v2/apps/${appId}/tables/Emp/Find`;
  const data = await safeFetch(url, {}, "Emp");
  if(Array.isArray(data)){
    const techSelect = document.getElementById("searchTechnician");
    techSelect.innerHTML = '<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>';

    data
      .filter(e => 
        e.DeptCode === "A12" && 
        (e.EmpStatus === 0 || e.EmpStatus === "0")
      )
      .sort((a,b)=>(a.EmpName||"").localeCompare(b.EmpName||""))
      .forEach(e=>{
        if(e.EmpCode && e.EmpName){
          empMap[e.EmpCode] = e.EmpName;
          const opt=document.createElement("option");
          opt.value = e.EmpCode;
          opt.textContent = e.EmpName;
          techSelect.appendChild(opt);
        }
      });
  } else {
    console.error("Emp data is not array:", data);
  }
}

// Fetch Departments
async function fetchDepartments(){
  const url=`https://api.appsheet.com/api/v2/apps/${appId}/tables/Department/Find`;
  const data=await safeFetch(url,{},"Department");
  if(Array.isArray(data)){
    const select=document.getElementById("searchDepartment");
    data.forEach(d=>{
      const code=d.DeptCode;
      const eng = d.DeptNameEng || d.DeptCode;
      departmentsMap[code]=eng;
      const opt=document.createElement("option");
      opt.value=code;
      opt.textContent=eng;
      select.appendChild(opt);
    });
  }
}

// Fetch Machine
async function fetchMachines(){
  const url=`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Find`;
  const data=await safeFetch(url,{},"MachineMaster");
  if(Array.isArray(data)){
    data.forEach(m=>{
      const code = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      const name = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"];
      if(code){
        machineMap[code] = name || code;
      }
    });
  }
}

// Fetch RepairTechnicians
async function fetchRepairTechnicians(){
  const url=`https://api.appsheet.com/api/v2/apps/${appId}/tables/${repairTableName}/Find`;
  const data=await safeFetch(url,{},"RepairTechnicians");
  cacheData = Array.isArray(data)?data:[];
}

// Render Table + Filter + Group
function renderTable(){
  const tbody=document.getElementById("tableBody");
  const table=document.getElementById("dataTable");
  const noData=document.getElementById("noData");
  tbody.innerHTML="";
  if(cacheData.length===0){
    table.style.display="none";
    noData.style.display="block";
    updateCharts([]);  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏£‡∏≤‡∏ü
    return;
  }

  const statusFilter=document.getElementById("searchStatus").value;
  const deptFilter=document.getElementById("searchDepartment").value;
  const techFilter=document.getElementById("searchTechnician").value; // EmpCode
  const from=document.getElementById("searchDateFrom").value;
  const to=document.getElementById("searchDateTo").value;
  const pmOnly = document.getElementById("searchPMOnly").checked;

  // group by ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° + ‡πÅ‡∏ú‡∏ô‡∏Å + ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á + ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ + ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  const grouped={};
  cacheData.forEach(row=>{
    const key = [
      row["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"],
      row["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"],
      row["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"],
      row["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"],
      row["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"]
    ].join("||");
    if(!grouped[key]) grouped[key]=[];
    grouped[key].push(row);
  });

  const rows=[];
  let filteredForChart = []; // ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö filter

  Object.values(grouped).forEach(group=>{
    if(group.length===0) return;
    const main=group[0];

    // ‡∏ï‡∏£‡∏ß‡∏à PM ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    const desc = (main["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "").toLowerCase();
    const descRaw = main["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
    const isPM = desc.includes("pm") || descRaw.includes("‡∏û‡∏µ‡πÄ‡∏≠‡πá‡∏°");

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PM ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà PM -> ‡∏Ç‡πâ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á group
    if(pmOnly && !isPM) return;

    const filtered = group.filter(r => {
      const d = new Date(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"] || r.start);
      if (isNaN(d)) return false;
      
      const statusVal = r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || r.status || "";
      if (statusFilter && statusVal !== statusFilter) return false;

      const deptVal = r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || r.dept || "";
      if (deptFilter && deptVal !== deptFilter) return false;

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á
      if (techFilter) {
        const allEmpCodes = group.map(f => f.EmpCode || "").join(",");
        const allTechNames = getTechNamesFromEmpCode(allEmpCodes);
        const selectedTechName = empMap[techFilter] || techFilter;
        if (!allTechNames.split(", ").includes(selectedTechName)) return false;
      }

      if (from && d < new Date(from + "T00:00:00")) return false;
      if (to && d > new Date(to + "T23:59:59")) return false;

      return true;
    });

    if(filtered.length===0) return;

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
    filteredForChart.push(...filtered);

    const allEmpCodes = filtered.map(f=>f.EmpCode||"").join(",");
    const techNames = getTechNamesFromEmpCode(allEmpCodes);

    const machineNames = [...new Set(filtered.map(f=>{
      const mc = f["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      return machineMap[mc] || mc || "-";
    }))].join(", ");

    const start = main["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"] || main.start;
    const end   = main["‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö"]   || main.end;
    const timeText = (start && end) ? formatTimeRangeAndDuration(start,end) : "-";
    const statusRaw = main["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || main.status || "-";
    const statusClass = statusRaw.replace(/\s/g,"");
    const deptCode = main["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"];
    const deptNameEng = departmentsMap[deptCode] || deptCode || "-";

    rows.push({
  startDate: new Date(start),
  rowHtml: `
    <tr style="cursor:pointer;" onclick="showHistory('${main["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]}')">
      <td data-label="‡∏ß/‡∏î/‡∏õ">${formatDateTH(start)}</td>
      <td data-label="‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" class="time-used">
        ${timeText}<br> ${main["TimeBeforeSave"] ? `(‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å : ${main["TimeBeforeSave"]})` : ""}
      </td>
      <td data-label="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥">${techNames}</td>
      <td data-label="‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" class="request-number" style="text-decoration:none;">
        ${main["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "-"}
      </td>
      <td data-label="‡πÅ‡∏ú‡∏ô‡∏Å">${deptNameEng}</td>
      <td data-label="‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£">${machineNames}</td>
      <td data-label="‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£">${main["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "-"}</td>
      <td data-label="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">${main["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "-"}</td>
      <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"><span class="status ${statusClass}">${statusRaw}</span></td>
    </tr>
  `
});

  });

  rows.sort((a,b)=>b.startDate-a.startDate);

  if(rows.length>0){
    table.style.display="table";
    noData.style.display="none";
    tbody.innerHTML = rows.map(r=>r.rowHtml).join("");
  }else{
    table.style.display="none";
    noData.style.display="block";
  }

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
  updateCharts(filteredForChart);
}

function showHistory(requestNumber){
  const modal = document.getElementById("historyModal");
  const tbody = document.getElementById("historyContent");
  tbody.innerHTML = "";

  // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
  const mainRow = cacheData.find(r => r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === requestNumber);
  if(!mainRow){
    modal.style.display = "block";
    return;
  }

  // ‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ
  const machineCode = mainRow["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
  const history = cacheData
    .filter(r => r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] === machineCode)
    .sort((a,b) => new Date(a["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]) - new Date(b["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]));

  // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô PM / Breakdown
  let totalPM = 0;
  let totalBreakdown = 0;
  history.forEach(r => {
    const symptom = (r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "").toLowerCase();
    if(symptom.includes("pm")) totalPM++;
    else totalBreakdown++;
  });

  // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ã‡πâ‡∏≥ (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
  const grouped = {};
  history.forEach(r => {
    const key = [
      (r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "").toLowerCase(),
      (r["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "").toLowerCase()
    ].join("||");

    if(!grouped[key]) grouped[key] = { rows: [], empCodes: [] };
    grouped[key].rows.push(r);

    if(r.EmpCode){
      const codes = r.EmpCode.split(",").map(c=>c.trim());
      grouped[key].empCodes.push(...codes);
    }
  });

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Modal
  Object.values(grouped).forEach(group => {
    const uniqueEmpCodes = [...new Set(group.empCodes)];
    const techNames = getTechNamesFromEmpCode(uniqueEmpCodes.join(","));
    const firstRow = group.rows[0];

    const start = firstRow["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"];
    const end   = firstRow["‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö"];
    const timeText = (start && end) ? formatTimeRangeAndDuration(start,end) : "-";
    const statusRaw = firstRow["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || firstRow.status || "-";
    const statusClass = statusRaw.replace(/\s/g,"");
    const deptNameEng = departmentsMap[firstRow["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]] || firstRow["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "-";
    const machineName = machineMap[machineCode] || machineCode || "-";

    tbody.innerHTML += `
      <tr>
        <td>${formatDateTH(start)}</td>
        <td>${timeText}<br> ${firstRow["TimeBeforeSave"] ? `(‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å : ${firstRow["TimeBeforeSave"]})` : ""}</td>
        <td>${techNames}</td>
        <td>${firstRow["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "-"}</td>
        <td>${deptNameEng}</td>
        <td>${machineName}</td>
        <td>${firstRow["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "-"}</td>
        <td>${firstRow["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "-"}</td>
        <td><span class="status ${statusClass}">${statusRaw}</span></td>
      </tr>
    `;
  });

  // ‡πÅ‡∏Å‡πâ‡∏´‡∏±‡∏ß Modal ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô PM/Breakdown
  const machineNameDisplay = machineMap[machineCode] || machineCode || "-";
  modal.querySelector("h2").innerHTML = 
    `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${machineNameDisplay} ‚Äî 
     ‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span style="color:#1d4ed8;">${history.length}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 
     (PM: <span style="color:#059669;">${totalPM}</span>, 
      Breakdown: <span style="color:#dc2626;">${totalBreakdown}</span>)`;

  modal.style.display = "block";
}


function resetSearch(){
  const today=new Date();
  const oneDayAgo=new Date(today.getTime()-1*24*60*60*1000);
  document.getElementById("searchDateFrom").value=oneDayAgo.toISOString().split("T")[0];
  document.getElementById("searchDateTo").value=today.toISOString().split("T")[0];
  document.getElementById("searchDepartment").value="";
  document.getElementById("searchStatus").value="";
  document.getElementById("searchTechnician").value="";
  document.getElementById("searchPMOnly").checked=false;
  renderTable();
}

// Chart
function updateCharts(dataArr){
  const techCounts = {};
  const statusCounts = {};

  (dataArr || []).forEach(r=>{
    const empCodes = (r.EmpCode || "").split(",").map(x=>x.trim()).filter(x=>x);
    const empNames = empCodes.map(c=>empMap[c] || c);
    empNames.forEach(n=>{
      techCounts[n] = (techCounts[n] || 0) + 1;
    });

    const status = r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || r.status || "-";
    statusCounts[status] = (statusCounts[status] || 0) + 1;
  });

  const techCtx=document.getElementById("technicianChart").getContext("2d");
  const statusCtx=document.getElementById("statusChart").getContext("2d");
  if(techChart) techChart.destroy();
  if(statusChart) statusChart.destroy();

  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins:{
      legend:{ display:false },
      tooltip:{ enabled:true }
    }
  };

  // ‡∏Å‡∏£‡∏≤‡∏ü‡∏ä‡πà‡∏≤‡∏á
  techChart = new Chart(techCtx,{
    type:'doughnut',
    data:{
      labels:Object.keys(techCounts),
      datasets:[{
        label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô',
        data:Object.values(techCounts),
        backgroundColor:[
          '#2563eb','#34d399','#f97316','#facc15','#a855f7',
          '#f472b6','#22c55e','#0ea5e9','#fb7185','#64748b'
        ],
        borderWidth:0
      }]
    },
    options: commonOptions
  });

  // ‡πÅ‡∏™‡∏î‡∏á legend ‡πÅ‡∏ö‡∏ö custom ‡πÉ‡∏ï‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡∏ä‡πà‡∏≤‡∏á
  const techLegendDiv = document.getElementById("technicianLegend");
  if(Object.keys(techCounts).length === 0){
    techLegendDiv.innerHTML = '<span class="text-gray-400 text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
  }else{
    const parts = Object.entries(techCounts).map(([name,count])=>`${name} : ${count}`);
    techLegendDiv.innerHTML = parts.join(" | ");
  }

  // ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏ô‡πâ‡∏ô ‡∏à‡∏ö‡∏á‡∏≤‡∏ô / ‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô)
  const statusLabels = ["‡∏à‡∏ö‡∏á‡∏≤‡∏ô","‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô"];
  const statusData = [
    statusCounts["‡∏à‡∏ö‡∏á‡∏≤‡∏ô"] || 0,
    statusCounts["‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô"] || 0
  ];

  statusChart = new Chart(statusCtx,{
    type:'doughnut',
    data:{
      labels:statusLabels,
      datasets:[{
        label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô',
        data:statusData,
        backgroundColor:['#34d399','#fbbf24'],
        borderWidth:0
      }]
    },
    options: commonOptions
  });
}

// Init
async function initApp(){
  await fetchDepartments();
  await fetchMachines();
  await fetchEmp();
  await fetchRepairTechnicians();
  renderTable();
}
initApp();

window.addEventListener("DOMContentLoaded", () => {
  const today = new Date();
  const oneDayAgo = new Date(today.getTime() - 1*24*60*60*1000);
  document.getElementById("searchDateFrom").value = oneDayAgo.toISOString().split("T")[0];
  document.getElementById("searchDateTo").value = today.toISOString().split("T")[0];
});
</script>
</body>
</html>

