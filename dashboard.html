<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Repair Feedback Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .table-fixed-header thead {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-6 font-sans">

  <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">Repair Feedback Dashboard</h1>

  <!-- Filters -->
  <div class="flex flex-wrap gap-4 justify-center mb-6">
    <div>
      <label class="block font-semibold mb-1">From Date</label>
      <input type="date" id="filterFromDate" class="border border-gray-300 rounded px-3 py-2" />
    </div>
    <div>
      <label class="block font-semibold mb-1">To Date</label>
      <input type="date" id="filterToDate" class="border border-gray-300 rounded px-3 py-2" />
    </div>
    <div>
      <label class="block font-semibold mb-1">Department</label>
      <select id="filterDepartment" class="border border-gray-300 rounded px-3 py-2">
        <option value="">-- All --</option>
      </select>
    </div>
    <div>
      <label class="block font-semibold mb-1">Status</label>
      <select id="filterStatus" class="border border-gray-300 rounded px-3 py-2">
        <option value="">-- All --</option>
        <option value="ซ่อมเสร็จ">Completed</option>
        <option value="รออะไหล่">Waiting for Parts</option>
        <option value="อยู่ระหว่างซ่อม">In Progress</option>
        <option value="ยกเลิกซ่อม">Cancelled</option>
      </select>
    </div>
    <div class="flex items-end">
      <button id="btnFilter" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Search</button>
    </div>
  </div>

  <!-- KPI Summary -->
  <div class="mb-6 text-center">
    <span class="text-xl font-semibold">Total Requests: </span><span id="kpiTotal">0</span>
  </div>

  <!-- Chart -->
  <div class="max-w-xl mx-auto mb-8">
    <canvas id="departmentChart"></canvas>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto max-w-full">
    <table class="min-w-full bg-white rounded shadow table-fixed-header">
      <thead>
        <tr class="bg-blue-200 text-blue-900">
          <th class="p-2 border">Request No.</th>
          <th class="p-2 border">Symptom</th>
          <th class="p-2 border">Report Date</th>
          <th class="p-2 border">Evaluation Finish</th>
          <th class="p-2 border">Eval. Duration (hrs)</th>
          <th class="p-2 border">Status</th>
          <th class="p-2 border">Department</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
    const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

    // Maps for Department English Names (DeptCode -> DeptNameEng)
    let departmentsMap = {};

    // Cached Data
    let machinesymptomData = [];
    let repairFeedbackData = [];

    // Chart instance
    let deptChart;

    // Fetch generic table data from AppSheet API
    async function fetchTableData(tableName) {
      const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Find`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({})
      });
      if (!res.ok) throw new Error(`Failed to fetch ${tableName}`);
      return res.json();
    }

    // Initialize - load Departments, Machinesymptom, RepairFeedback
    async function initialize() {
      try {
        const departments = await fetchTableData("Department");
        departments.forEach(d => {
          departmentsMap[d.DeptCode] = d.DeptNameEng || d.DeptName || d.DeptCode;
        });

        // Populate department filter dropdown
        const deptSelect = document.getElementById("filterDepartment");
        Object.entries(departmentsMap).forEach(([code, name]) => {
          const opt = document.createElement("option");
          opt.value = code;
          opt.textContent = name;
          deptSelect.appendChild(opt);
        });

        // Load Machinesymptom data
        machinesymptomData = await fetchTableData("Machinesymptom");
        // Load RepairFeedback data
        repairFeedbackData = await fetchTableData("RepairFeedback");

        // Initially show all data
        filterAndRender();

      } catch (error) {
        alert("Error loading data: " + error.message);
      }
    }

    // Helper: Parse date string or datetime to Date object (Thai Buddhist year to AD)
    function parseThaiDate(dateStr) {
      if (!dateStr) return null;
      // Try to parse with Date constructor first
      let dt = new Date(dateStr);
      if (!isNaN(dt)) {
        // Adjust year if Buddhist Era year (>= 2500)
        const year = dt.getFullYear();
        if (year > 2500) {
          dt.setFullYear(year - 543);
        }
        return dt;
      }
      return null;
    }

    // Calculate duration in hours between two dates
    function calcDurationHours(startDate, endDate) {
      if (!startDate || !endDate) return "-";
      const diffMs = endDate - startDate;
      if (diffMs < 0) return "-";
      return (diffMs / (1000 * 3600)).toFixed(2);
    }

    // Main filtering and rendering function
    function filterAndRender() {
      const fromDateStr = document.getElementById("filterFromDate").value;
      const toDateStr = document.getElementById("filterToDate").value;
      const deptFilter = document.getElementById("filterDepartment").value;
      const statusFilter = document.getElementById("filterStatus").value;

      const fromDate = fromDateStr ? new Date(fromDateStr) : null;
      const toDate = toDateStr ? new Date(toDateStr) : null;

      // Filter Machinesymptom by date, dept, status
      let filteredRequests = machinesymptomData.filter(r => {
        const reportDate = parseThaiDate(r["วันที่แจ้งซ่อม"]);
        if (!reportDate) return false;

        if (fromDate && reportDate < fromDate) return false;
        if (toDate && reportDate > toDate) return false;

        if (deptFilter && r["หน่วยงาน"] !== deptFilter) return false;
        if (statusFilter && r["สถานะเครื่อง"] !== statusFilter) return false;

        return true;
      });

      // Map RepairFeedback by RequestNo (เลขที่ใบแจ้งซ่อม) to get latest Timestamp
      const feedbackByRequest = {};
      repairFeedbackData.forEach(fb => {
        const rq = fb["เลขที่ใบแจ้งซ่อม"];
        if (!feedbackByRequest[rq]) {
          feedbackByRequest[rq] = [];
        }
        feedbackByRequest[rq].push(fb);
      });

      // Compute evaluation finish date (latest Timestamp per request)
      filteredRequests.forEach(rq => {
        const fbList = feedbackByRequest[rq["เลขที่ใบแจ้งซ่อม"]] || [];
        if (fbList.length) {
          // Get max timestamp
          const latestTS = fbList.reduce((max, fb) => {
            const ts = parseThaiDate(fb.Timestamp) || new Date(0);
            return ts > max ? ts : max;
          }, new Date(0));
          rq.evalFinish = latestTS;
        } else {
          rq.evalFinish = null;
        }
        // Parse report date as Date
        rq.reportDateObj = parseThaiDate(rq["วันที่แจ้งซ่อม"]);
      });

      // Calculate duration hours for each request (evaluation finish - report date)
      filteredRequests.forEach(rq => {
        rq.evalDuration = rq.evalFinish && rq.reportDateObj ?
          ((rq.evalFinish - rq.reportDateObj) / (1000*3600)).toFixed(2) : "-";
      });

      // Update KPI
      document.getElementById("kpiTotal").textContent = filteredRequests.length;

      renderTable(filteredRequests);
      renderChart(filteredRequests);
    }

    // Render table rows
    function renderTable(data) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4">No data found</td></tr>`;
        return;
      }

      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-100";
        tr.innerHTML = `
          <td class="p-2 border">${row["เลขที่ใบแจ้งซ่อม"] || "-"}</td>
          <td class="p-2 border max-w-xs break-words">${row["รายละเอียดอาการเสีย"] || "-"}</td>
          <td class="p-2 border">${row.reportDateObj ? row.reportDateObj.toLocaleDateString() : "-"}</td>
          <td class="p-2 border">${row.evalFinish ? row.evalFinish.toLocaleString() : "-"}</td>
          <td class="p-2 border text-right">${row.evalDuration}</td>
          <td class="p-2 border">${row["สถานะเครื่อง"] || "-"}</td>
          <td class="p-2 border">${departmentsMap[row["หน่วยงาน"]] || row["หน่วยงาน"] || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Render department pie chart
    function renderChart(data) {
      const ctx = document.getElementById("departmentChart").getContext("2d");

      // Count by department
      const counts = {};
      data.forEach(r => {
        const deptName = departmentsMap[r["หน่วยงาน"]] || r["หน่วยงาน"] || "Unknown";
        counts[deptName] = (counts[deptName] || 0) + 1;
      });

      const labels = Object.keys(counts);
      const values = Object.values(counts);

      if (deptChart) deptChart.destroy();

      deptChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: [
              "#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#6366f1",
              "#ec4899", "#14b8a6", "#f97316", "#8b5cf6", "#22c55e"
            ],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { enabled: true },
            title: {
              display: true,
              text: "Repair Requests by Department"
            }
          }
        }
      });
    }

    // Init and event listeners
    document.getElementById("btnFilter").addEventListener("click", filterAndRender);

    initialize();
  </script>

</body>
</html>
