<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡πà‡∏≤‡∏á</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
<style>
  /* CSS ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏´‡πâ (‡∏¢‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö) */
  body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #f7f9fc; }
  .navbar { display: flex; justify-content: space-between; align-items: center; background: #1976d2; color: white; padding: 0.5rem 1rem; font-weight: 600; }
  .container { max-width: 960px; margin: 1rem auto; padding: 0 1rem; }
  form { background: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgb(0 0 0 / 0.1); }
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 1rem; }
  .field { display: flex; flex-direction: column; }
  label { font-weight: 600; margin-bottom: 0.3rem; font-size: 0.9rem; }
  input[type=text], input[type=datetime-local], select, textarea { border: 1px solid #ccc; border-radius: 4px; padding: 0.4rem 0.6rem; font-size: 0.95rem; transition: border-color 0.3s; font-family: 'Sarabun', sans-serif; }
  input[type=text]:focus, input[type=datetime-local]:focus, select:focus, textarea:focus { outline: none; border-color: #1976d2; box-shadow: 0 0 5px #1976d2aa; }
  textarea { resize: vertical; min-height: 70px; }
  .field.full { grid-column: 1 / -1; }
  .tech-detail-box { margin-top: 1.5rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; background: #fafafa; }
  .tech-detail-box h2 { margin-top: 0; margin-bottom: 1rem; color: #1976d2; }
  .parts-list label { font-weight: 600; margin-bottom: 0.5rem; display: block; }
  #partsContainer { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.8rem; }
  .part-row { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
  .part-row input { flex: 1 1 150px; min-width: 100px; }
  .part-row input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô[]"] { max-width: 80px; }
  .part-row button.remove-btn { background: #d32f2f; color: white; border: none; border-radius: 4px; padding: 0.2rem 0.5rem; cursor: pointer; font-weight: 700; font-size: 1.1rem; line-height: 1; height: 30px; width: 30px; display: flex; justify-content: center; align-items: center; }
  .add-part-btn { background: #1976d2; color: white; border: none; border-radius: 4px; padding: 0.4rem 0.8rem; cursor: pointer; font-weight: 600; font-size: 0.95rem; margin-top: 0.4rem; display: inline-block; }
  .submit-btn { margin-top: 1.5rem; text-align: center; }
  .submit-btn button { background: #1976d2; color: white; border: none; padding: 0.8rem 2rem; font-size: 1.1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.3s; }
  .submit-btn button:hover { background: #115293; }
  @media (max-width: 480px) {
    .form-grid { grid-template-columns: 1fr !important; }
    .part-row input { flex: 1 1 100%; min-width: auto; }
    .part-row button.remove-btn { width: 28px; height: 28px; font-size: 1rem; }
    .submit-btn button { width: 100%; }
  }
</style>
</head>
<body>

<nav class="navbar">
  <div>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡πà‡∏≤‡∏á</div>
  <div>
    üë§ ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="empCodeDisplay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
    <a href="menu.html" class="btn" style="color: white; text-decoration:none; margin-left: 1rem;">üè† ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
  </div>
</nav>

<div class="container">
  <form id="techForm">
    <div class="form-grid">
      <div class="field">
        <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input type="text" name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" id="requestNumber" readonly required />
      </div>
      <div class="field">
        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
        <select name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" id="deptSelect" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>
        </select>
      </div>
      <div class="field">
        <label>‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label>
        <select name="‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô" id="jobTypeSelect" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô --</option>
        </select>
      </div>
      <div class="field">
        <label>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
        <select name="‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">üö® ‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô">‚ö†Ô∏è ‡∏î‡πà‡∏ß‡∏ô</option>
          <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô">‚è≥ ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</option>
        </select>
      </div>
      <div class="field">
        <label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <input type="text" id="machineSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." autocomplete="off" required />
        <select name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" id="machineSelect" size="5" style="display:none; margin-top: 0.3rem; font-size: 0.9rem; cursor:pointer;"></select>
      </div>
      <div class="field full">
        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢" rows="3" required></textarea>
      </div>
    </div>

    <div class="tech-detail-box">
      <h2>üß∞ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡πà‡∏≤‡∏á</h2>
      <div class="field full">
        <label>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
        <textarea name="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô" rows="3"></textarea>
      </div>
      <div class="parts-list">
        <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
        <div id="partsContainer"></div>
        <button type="button" onclick="addPart()" class="add-part-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
      </div>
      <div class="form-grid">
        <div class="field">
          <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
          <input type="datetime-local" name="‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°" />
        </div>
        <div class="field">
          <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</label>
          <input type="datetime-local" name="‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö" />
        </div>
        <div class="field">
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á</label>
          <select name="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
            <option value="‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</option>
            <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
          </select>
        </div>
      </div>
    </div>

    <div class="submit-btn">
      <button type="submit">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </form>
</div>

<script>
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡∏à‡∏≤‡∏Å localStorage
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || !user.EmpCode) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
    window.location.href = "login.html";
  } else {
    document.getElementById("empCodeDisplay").textContent = `${user.EmpCode} ${user.TitleName || ""} ${user.EmpName || ""} ${user.LastName || ""}`.trim();
  }

  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
  const baseUrl = `https://api.appsheet.com/api/v2/apps/${appId}/tables/`;

  const jobTypeMap = new Map();
  let machineList = [];

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å URL
  function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  async function fetchFromTable(table, filter = null) {
    const body = filter ? { filter } : {};
    const res = await fetch(`${baseUrl}${table}/Find`, {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify(body)
    });
    return res.ok ? await res.json() : [];
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ default ‡πÑ‡∏î‡πâ)
  function addPart(name = '', qty = '', unit = '') {
    const c = document.getElementById('partsContainer');
    const div = document.createElement('div');
    div.className = 'part-row';
    div.innerHTML = `
      <input type="text" name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà[]" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" required value="${name}" />
      <input type="number" name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required min="1" value="${qty}" />
      <input type="text" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢[]" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" required value="${unit}" />
      <button type="button" class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
    `;
    c.appendChild(div);
  }

  async function init() {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
    const depts = await fetchFromTable('Department');
    const sd = document.getElementById('deptSelect');
    sd.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>`;
    depts.forEach(d => sd.innerHTML += `<option value="${d.DeptCode}">${d.DeptName}</option>`);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô
    const jts = await fetchFromTable('MachineJobType');
    const sj = document.getElementById('jobTypeSelect');
    sj.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô --</option>`;
    jts.forEach(j => {
      jobTypeMap.set(j['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô'], j['‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô']);
      sj.innerHTML += `<option value="${j['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô']}">${j['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô']}</option>`;
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    machineList = await fetchFromTable('MachineMaster');

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° input ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏Å‡∏±‡∏ö select ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    const machineSearch = document.getElementById('machineSearch');
    const machineSelect = document.getElementById('machineSelect');

    machineSearch.addEventListener('input', () => {
      const val = machineSearch.value.trim().toLowerCase();
      if (!val) {
        machineSelect.style.display = 'none';
        machineSelect.innerHTML = '';
        return;
      }
      const filtered = machineList.filter(m =>
        m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']?.toLowerCase().includes(val) ||
        m['‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£']?.toLowerCase().includes(val)
      );
      if (filtered.length === 0) {
        machineSelect.style.display = 'none';
        machineSelect.innerHTML = '';
        return;
      }
      machineSelect.innerHTML = '';
      filtered.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'];
        opt.textContent = `${m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']} ‚Äì ${m['‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£']}`;
        machineSelect.appendChild(opt);
      });
      machineSelect.style.display = 'block';
    });

    machineSelect.addEventListener('change', () => {
      machineSearch.value = machineSelect.value;
      machineSelect.style.display = 'none';
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà
    const requestNum = getQueryParam('request');
    if (!requestNum) {
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
      window.location.href = 'repair-list.html'; // ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      return;
    }
    document.getElementById('requestNumber').value = requestNum;

    await loadDataForRequest(requestNum);
  }

  async function loadDataForRequest(requestNum) {
    try {
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å Machinesymptom
      const mainData = await fetchFromTable('Machinesymptom', `"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" = "${requestNum}"`);
      if (mainData.length === 0) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ô‡∏µ‡πâ');
        window.location.href = 'repair-list.html';
        return;
      }
      const main = mainData[0];

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å
      document.querySelector('select[name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]').value = main['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'] || '';
      document.querySelector('select[name="‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô"]').value = main['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô'] || '';
      document.querySelector('select[name="‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"]').value = main['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'] || '';
      document.getElementById('machineSearch').value = main['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'] || '';
      document.querySelector('textarea[name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"]').value = main['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢'] || '';

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairTechnicians
      const techData = await fetchFromTable('RepairTechnicians', `"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" = "${requestNum}"`);
      if (techData.length > 0) {
        const tech = techData[0];
        document.querySelector('textarea[name="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"]').value = tech['‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô'] || '';
        document.querySelector('input[name="‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]').value = tech['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°'] || '';
        document.querySelector('input[name="‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö"]').value = tech['‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö'] || '';
        document.querySelector('select[name="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"]').value = tech['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á'] || '';
      }

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairParts
      const partsData = await fetchFromTable('RepairParts', `"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" = "${requestNum}"`);
      const partsContainer = document.getElementById('partsContainer');
      partsContainer.innerHTML = '';
      if (partsData.length > 0) {
        partsData.forEach(p => {
          addPart(p['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'], p['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'], p['‡∏´‡∏ô‡πà‡∏ß‡∏¢']);
        });
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏ñ‡∏ß‡πÄ‡∏õ‡∏•‡πà‡∏≤
        addPart();
      }

    } catch (err) {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err.message);
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï
  async function updateTable(table, data) {
    const res = await fetch(`${baseUrl}${table}/Update`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'ApplicationAccessKey': apiKey
      },
      body: JSON.stringify({ rows: [data] })
    });
    const resJson = await res.json();
    if (!res.ok || resJson.error) {
      throw new Error(resJson.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    }
    return resJson;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°
  document.getElementById('techForm').addEventListener('submit', async e => {
    e.preventDefault();

    try {
      const form = e.target;
      const requestNum = form['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'].value;

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Machinesymptom
      const mainData = {
        '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°': requestNum,
        '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô': form['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'].value,
        '‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô': form['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô'].value,
        '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç': form['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'].value,
        '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á': form['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']?.value || form['machineSearch']?.value || '',
        '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢': form['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢'].value
      };

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairTechnicians
      const techData = {
        '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°': requestNum,
        '‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô': form['‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô'].value,
        '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°': form['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°'].value || null,
        '‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö': form['‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö'].value || null,
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á': form['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á'].value || ''
      };

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairParts: ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏õ‡πá‡∏ô array object
      const partNames = Array.from(form.querySelectorAll('input[name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà[]"]')).map(i => i.value.trim());
      const partQtys = Array.from(form.querySelectorAll('input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô[]"]')).map(i => i.value.trim());
      const partUnits = Array.from(form.querySelectorAll('input[name="‡∏´‡∏ô‡πà‡∏ß‡∏¢[]"]')).map(i => i.value.trim());

      // ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏•‡∏ö‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á RepairParts (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      // - ‡∏•‡∏ö‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÄ‡∏î‡∏¥‡∏°
      await fetch(`${baseUrl}RepairParts/Delete`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'ApplicationAccessKey': apiKey
        },
        body: JSON.stringify({
          filter: `"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" = "${requestNum}"`
        })
      });

      // - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß
      for (let i = 0; i < partNames.length; i++) {
        if (partNames[i]) {
          const partRow = {
            '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°': requestNum,
            '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà': partNames[i],
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': parseFloat(partQtys[i]) || 1,
            '‡∏´‡∏ô‡πà‡∏ß‡∏¢': partUnits[i] || ''
          };
          await fetch(`${baseUrl}RepairParts/Add`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'ApplicationAccessKey': apiKey
            },
            body: JSON.stringify({ rows: [partRow] })
          });
        }
      }

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï Machinesymptom
      await updateTable('Machinesymptom', mainData);
      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï RepairTechnicians
      await updateTable('RepairTechnicians', techData);

      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      // ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      window.location.href = 'repair-list.html';

    } catch (err) {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + err.message);
    }
  });

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å init ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
  window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
