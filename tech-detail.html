<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>รายละเอียดช่าง</title>
<style>
  /* สไตล์พื้นฐาน */
  body { font-family: 'Sarabun', sans-serif; background: #f7f9fc; margin:0; padding:1rem; }
  form { background:#fff; padding:1rem; border-radius:8px; max-width: 900px; margin:auto; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
  label { font-weight: 600; display: block; margin-bottom: 0.3rem; }
  input[type=text], input[type=datetime-local], select, textarea {
    width: 100%; padding: 0.4rem 0.6rem; border: 1px solid #ccc; border-radius: 4px;
    font-family: 'Sarabun', sans-serif; font-size: 1rem; box-sizing: border-box;
  }
  textarea { min-height: 70px; resize: vertical; }
  .form-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .form-group { flex: 1 1 300px; min-width: 250px; }
  button { background: #1976d2; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem; }
  button:hover { background: #115293; }
  #partsContainer .part-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; align-items: center; }
  #partsContainer input { flex: 1 1 150px; min-width: 100px; }
  #partsContainer input.qty { max-width: 80px; }
  #partsContainer button.remove-btn {
    background: #d32f2f; width: 30px; height: 30px; border-radius: 4px;
    font-size: 1.2rem; font-weight: 700; color: white; line-height: 1; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  @media (max-width: 480px) {
    .form-row { flex-direction: column; }
    #partsContainer .part-row input { flex: 1 1 100%; }
  }
</style>
</head>
<body>

<form id="techForm">
  <div class="form-row">
    <div class="form-group">
      <label>เลขที่ใบแจ้งซ่อม</label>
      <input type="text" id="requestNumber" name="เลขที่ใบแจ้งซ่อม" readonly required />
    </div>
  </div>

  <fieldset style="border:1px solid #ccc; border-radius:8px; padding: 1rem; margin-bottom: 1rem;">
    <legend style="font-weight: 600; color:#1976d2;">รายละเอียดช่าง</legend>

    <div class="form-row">
      <div class="form-group" style="flex: 1 1 100%;">
        <label>การแก้ไขความคิดเห็น</label>
        <textarea name="การแก้ไขความคิดเห็น" rows="3"></textarea>
      </div>
    </div>

    <div>
      <label>รายการอะไหล่ที่ใช้</label>
      <div id="partsContainer"></div>
      <button type="button" onclick="addPart()">+ เพิ่มอะไหล่</button>
    </div>

    <div class="form-row" style="margin-top:1rem;">
      <div class="form-group">
        <label>เวลาเริ่ม</label>
        <input type="datetime-local" name="เวลาเริ่ม" />
      </div>
      <div class="form-group">
        <label>เวลาจบ</label>
        <input type="datetime-local" name="เวลาจบ" />
      </div>
      <div class="form-group">
        <label>สถานะของงานช่าง</label>
        <select name="สถานะของงานช่าง">
          <option value="">-- เลือก --</option>
          <option value="อยู่ระหว่างดำเนินการ">อยู่ระหว่างดำเนินการ</option>
          <option value="ซ่อมเสร็จ">ซ่อมเสร็จ</option>
          <option value="รออะไหล่">รออะไหล่</option>
          <option value="ยกเลิก">ยกเลิก</option>
        </select>
      </div>
    </div>
  </fieldset>

  <div style="text-align:center;">
    <button type="submit">✅ บันทึกข้อมูล</button>
  </div>
</form>

<script>
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
  const baseUrl = `https://api.appsheet.com/api/v2/apps/${appId}/tables/`;

  // จำลอง user login (เปลี่ยนตามระบบจริง)
  const user = JSON.parse(localStorage.getItem("user")) || { EmpCode: "1900", TitleName: "นาย", EmpName: "สมชาย", LastName: "ใจดี" };
  document.title = `รายละเอียดช่าง - ${user.EmpCode}`;

  document.getElementById("requestNumber").value = "";

  const jobTypeMap = new Map();
  let machineList = [];

  async function fetchFromTable(table, filter = null) {
    const bodyObj = filter ? { Filter: filter } : {};
    const res = await fetch(`${baseUrl}${table}/Find`, {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify(bodyObj)
    });
    if (!res.ok) return [];
    return await res.json();
  }

  async function init() {
    // แสดง EmpCode
    console.log(`User logged in: ${user.EmpCode} ${user.TitleName} ${user.EmpName} ${user.LastName}`);

    // ดึงเลขที่ใบแจ้งซ่อมล่าสุด + 1
    const ms = await fetchFromTable('Machinesymptom');
    let lastNo = ms.map(r => r['เลขที่ใบแจ้งซ่อม']).filter(Boolean).sort().pop();
    let nextNo = lastNo ? String(parseInt(lastNo) + 1).padStart(7, '0') : '2506001';
    document.getElementById('requestNumber').value = nextNo;

    // โหลดหน่วยงาน
    const depts = await fetchFromTable('Department');
    const deptSelect = document.getElementById('deptSelect');
    deptSelect.innerHTML = `<option value="">-- เลือกหน่วยงาน --</option>`;
    depts.forEach(d => {
      if(d.DeptCode && d.DeptNameEng){
        deptSelect.innerHTML += `<option value="${d.DeptCode}">${d.DeptNameEng}</option>`;
      }
    });

    // โหลดชนิดงาน
    const jts = await fetchFromTable('MachineJobType');
    const jobTypeSelect = document.getElementById('jobTypeSelect');
    jobTypeSelect.innerHTML = `<option value="">-- เลือกชนิดงาน --</option>`;
    jts.forEach(j => {
      jobTypeMap.set(j['ชนิดงาน'], j['รหัสงาน']);
      jobTypeSelect.innerHTML += `<option value="${j['ชนิดงาน']}">${j['ชนิดงาน']}</option>`;
    });

    // โหลดเครื่องจักร
    machineList = await fetchFromTable('MachineMaster');

    // event เครื่องจักรค้นหา
    const machineSearch = document.getElementById('machineSearch');
    const machineSelect = document.getElementById('machineSelect');

    machineSearch.addEventListener('input', () => {
      const val = machineSearch.value.trim().toLowerCase();
      if (!val) {
        machineSelect.style.display = 'none';
        machineSelect.innerHTML = '';
        return;
      }
      const filtered = machineList.filter(m =>
        (m['รหัสเครื่อง'] || '').toLowerCase().includes(val) ||
        (m['รายชื่อเครื่องจักร'] || '').toLowerCase().includes(val)
      );
      if (filtered.length === 0) {
        machineSelect.style.display = 'none';
        machineSelect.innerHTML = '';
        return;
      }
      machineSelect.innerHTML = '';
      filtered.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m['รหัสเครื่อง'];
        opt.textContent = `${m['รหัสเครื่อง']} – ${m['รายชื่อเครื่องจักร']}`;
        machineSelect.appendChild(opt);
      });
      machineSelect.style.display = 'block';
    });

    machineSelect.addEventListener('change', () => {
      if (machineSelect.value) {
        machineSearch.value = machineSelect.value;
        machineSelect.style.display = 'none';
      }
    });

    machineSelect.addEventListener('click', e => {
      if (e.target.tagName === 'OPTION') {
        machineSearch.value = e.target.value;
        machineSelect.style.display = 'none';
      }
    });

    machineSearch.addEventListener('blur', () => {
      setTimeout(() => {
        machineSelect.style.display = 'none';
      }, 200);
    });

    // เริ่มเพิ่มอะไหล่ 1 รายการ
    addPart();
  }

  function addPart(name = '', qty = '', unit = '') {
    const container = document.getElementById('partsContainer');
    const div = document.createElement('div');
    div.className = 'part-row';
    div.innerHTML = `
      <input type="text" name="รายการอะไหล่[]" placeholder="ชื่ออะไหล่" value="${name}" required />
      <input type="number" name="จำนวน[]" class="qty" placeholder="จำนวน" min="1" value="${qty}" required />
      <input type="text" name="หน่วย[]" placeholder="หน่วย" value="${unit}" required />
      <button type="button" class="remove-btn" title="ลบอะไหล่" onclick="this.parentElement.remove()">×</button>
    `;
    container.appendChild(div);
  }

  async function fetchRepairParts(requestNumber) {
    const res = await fetch(`${baseUrl}RepairParts/Find`, {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify({
        Filter: [
          { Column: "เลขที่ใบแจ้งซ่อม", Expression: "Equals", Value: requestNumber }
        ]
      })
    });
    if (!res.ok) return [];
    return await res.json();
  }

  document.getElementById('techForm').addEventListener('submit', async e => {
    e.preventDefault();

    const f = new FormData(e.target);
    const main = {};
    f.forEach((v, k) => {
      if (!k.includes('[]')) main[k] = v.trim();
    });
    main.EmpCode = user.EmpCode;

    // แปลง ชนิดงาน เป็น รหัสงาน
    if (jobTypeMap.has(main['ชนิดงาน'])) {
      main['ชนิดงาน'] = jobTypeMap.get(main['ชนิดงาน']);
    }

    // เตรียมข้อมูล RepairTechnicians
    const tech = {
      'เลขที่ใบแจ้งซ่อม': main['เลขที่ใบแจ้งซ่อม'],
      EmpCode: user.EmpCode,
      'การแก้ไขความคิดเห็น': f.get('การแก้ไขความคิดเห็น')?.trim() || '',
      'เวลาเริ่ม': f.get('เวลาเริ่ม') || null,
      'เวลาจบ': f.get('เวลาจบ') || null,
      'สถานะของงานช่าง': f.get('สถานะของงานช่าง') || ''
    };

    // เตรียมอะไหล่จากฟอร์ม
    const names = f.getAll('รายการอะไหล่[]');
    const nums = f.getAll('จำนวน[]');
    const units = f.getAll('หน่วย[]');
    let partsToSave = [];
    for(let i=0; i < names.length; i++) {
      if(names[i].trim() === '') continue;
      partsToSave.push({
        'เลขที่ใบแจ้งซ่อม': main['เลขที่ใบแจ้งซ่อม'],
        EmpCode: user.EmpCode,
        'รายการอะไหล่': names[i].trim(),
        จำนวน: nums[i],
        หน่วย: units[i].trim()
      });
    }

    try {
      // บันทึก Machinesymptom (เพิ่ม/แก้ไขตามจริงอาจต้องแยก action Add/Edit)
      await fetch(`${baseUrl}Machinesymptom/Action`, {
        method: 'POST',
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({ Action: 'Add', Properties: { Locale: 'th-TH' }, Rows: [main] })
      });

      // บันทึก RepairTechnicians
      await fetch(`${baseUrl}RepairTechnicians/Action`, {
        method: 'POST',
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({ Action: 'Add', Properties: { Locale: 'th-TH' }, Rows: [tech] })
      });

      // ดึงข้อมูล RepairParts เก่าตามเลขที่ใบแจ้งซ่อม
      const oldParts = await fetchRepairParts(main['เลขที่ใบแจ้งซ่อม']);

      // หา map key: "EmpCode|เลขที่ใบแจ้งซ่อม|รายการอะไหล่"
      const oldPartsMap = new Map();
      oldParts.forEach(p => {
        const key = `${p.EmpCode}|${p['เลขที่ใบแจ้งซ่อม']}|${p['รายการอะไหล่']}`;
        oldPartsMap.set(key, p);
      });

      const partsToAdd = [];
      const partsToEdit = [];

      partsToSave.forEach(p => {
        const key = `${p.EmpCode}|${p['เลขที่ใบแจ้งซ่อม']}|${p['รายการอะไหล่']}`;
        if (oldPartsMap.has(key)) {
          // มีรายการเดิม -> แก้ไข โดยต้องใส่ ID
          p.ID = oldPartsMap.get(key).ID;
          partsToEdit.push(p);
        } else {
          partsToAdd.push(p);
        }
      });

      // อัปเดต RepairParts
      for(const p of partsToEdit) {
        await fetch(`${baseUrl}RepairParts/Action`, {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey
          },
          body: JSON.stringify({ Action: 'Edit', Properties: { Locale: 'th-TH' }, Rows: [p] })
        });
      }

      // เพิ่ม RepairParts ใหม่
      if(partsToAdd.length > 0) {
        await fetch(`${baseUrl}RepairParts/Action`, {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey
          },
          body: JSON.stringify({ Action: 'Add', Properties: { Locale: 'th-TH' }, Rows: partsToAdd })
        });
      }

      alert('✅ บันทึกข้อมูลเรียบร้อยแล้ว');
      window.location.reload();

    } catch(err) {
      alert('❌ เกิดข้อผิดพลาดในการบันทึก: ' + err.message);
      console.error(err);
    }
  });

  // เริ่มต้นโหลดข้อมูล
  init();
</script>
</body>
</html>
