<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡πà‡∏≤‡∏á</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #f7f9fc; }
    .navbar { display: flex; justify-content: space-between; align-items: center; background: #1976d2; color: white; padding: 0.5rem 1rem; font-weight: 600; }
    .container { max-width: 960px; margin: 1rem auto; padding: 0 1rem; }
    form { background: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgb(0 0 0 / 0.1); }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 1rem; }
    .field { display: flex; flex-direction: column; }
    label { font-weight: 600; margin-bottom: 0.3rem; font-size: 0.9rem; }
    input[type=text], input[type=number], select, textarea {
      border: 1px solid #ccc; border-radius: 4px; padding: 0.4rem 0.6rem;
      font-size: 0.95rem; transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: #1976d2; box-shadow: 0 0 5px #1976d2aa;
    }
    textarea { resize: vertical; min-height: 70px; }
    .field.full { grid-column: 1 / -1; }
    .tech-detail-box { margin-top: 1.5rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; background: #fafafa; }
    .tech-detail-box h2 { margin-top: 0; margin-bottom: 1rem; color: #1976d2; }
    #partsContainer { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.8rem; }
    .part-row { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
    .part-row input, .part-row select { flex: 1 1 150px; min-width: 100px; }
    .part-row input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô[]"] { max-width: 80px; }
    .part-row button.remove-btn {
      background: #d32f2f; color: white; border: none; border-radius: 4px;
      padding: 0.2rem 0.5rem; cursor: pointer; font-weight: 700;
      font-size: 1.1rem; line-height: 1; height: 30px; width: 30px;
      display: flex; justify-content: center; align-items: center;
    }
    .add-part-btn { background: #1976d2; color: white; border: none; border-radius: 4px;
      padding: 0.4rem 0.8rem; cursor: pointer; font-weight: 600; font-size: 0.95rem; margin-top: 0.4rem; }
    .submit-btn { margin-top: 1.5rem; text-align: center; }
    .submit-btn button {
      background: #1976d2; color: white; border: none; padding: 0.8rem 2rem;
      font-size: 1.1rem; border-radius: 6px; cursor: pointer; font-weight: 600;
    }
    .submit-btn button:hover { background: #115293; }
    @media (max-width: 480px) {
      .form-grid { grid-template-columns: 1fr !important; }
      .part-row input, .part-row select { flex: 1 1 100%; min-width: auto; }
      .submit-btn button { width: 100%; }
    }
  </style>
</head>
<body>

<nav class="navbar">
  <div>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡πà‡∏≤‡∏á</div>
  <div>
    üë§ ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="empCodeDisplay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
    <a href="menu.html" style="color:white; text-decoration:none; margin-left: 1rem;">üè† ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
  </div>
</nav>

<div class="container">
  <form id="techForm">
    <div class="form-grid">
      <div class="field">
        <label for="requestNumber">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input type="text" id="requestNumber" name="requestNumber" readonly />
      </div>
      <div class="field">
        <label for="empCode">‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
        <input type="text" id="empCode" name="empCode" readonly />
      </div>
      <div class="field full">
        <label for="comments">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô/‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
        <textarea id="comments" name="comments"></textarea>
      </div>
    </div>

    <div class="tech-detail-box">
      <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</h2>
      <div id="partsContainer">
        <!-- part rows ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
      </div>
      <button type="button" class="add-part-btn" id="addPartBtn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
    </div>

    <div class="submit-btn">
      <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </form>
</div>

<script>
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
  const baseUrl = `https://api.appsheet.com/api/v2/apps/${appId}/tables/`;

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡∏à‡∏≤‡∏Å localStorage
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || !user.EmpCode) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
    window.location.href = "login.html";
  } else {
    document.getElementById("empCodeDisplay").textContent = `${user.EmpCode} ${user.TitleName || ""} ${user.EmpName || ""} ${user.LastName || ""}`.trim();
    document.getElementById("empCode").value = user.EmpCode;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• object ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  function addPartRow(partData = {}) {
    const container = document.getElementById('partsContainer');
    const row = document.createElement('div');
    row.className = 'part-row';

    row.innerHTML = `
      <input type="hidden" name="partID[]" value="${partData.ID || ''}" />
      <input type="text" name="partName[]" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" value="${partData['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'] || ''}" required />
      <input type="number" name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" min="1" value="${partData['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] || 1}" required />
      <input type="text" name="unit[]" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" value="${partData['‡∏´‡∏ô‡πà‡∏ß‡∏¢'] || ''}" />
      <button type="button" class="remove-btn" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">&times;</button>
    `;

    row.querySelector('.remove-btn').addEventListener('click', () => {
      container.removeChild(row);
    });

    container.appendChild(row);
  }

  document.getElementById('addPartBtn').addEventListener('click', () => addPartRow());

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
  async function fetchData(table, filterExp) {
    const url = `${baseUrl}${table}/Find`;
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'ApplicationAccessKey': apiKey
      },
      body: JSON.stringify({ filter: filterExp })
    });
    if (!res.ok) throw new Error(`API error ${res.status}`);
    return await res.json();
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  async function loadData(requestNumber, empCode) {
    try {
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á
      const techData = await fetchData("RepairTechnicians", `"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" = "${requestNumber}" AND "‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" = "${empCode}"`);
      if (techData.length > 0) {
        const tech = techData[0];
        document.getElementById('requestNumber').value = tech['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'] || requestNumber;
        document.getElementById('empCode').value = tech['‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö'] || empCode;
        document.getElementById('comments').value = tech['‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô'] || "";
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô RepairTechnicians ‡∏Å‡πá‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å param
        document.getElementById('requestNumber').value = requestNumber;
        document.getElementById('empCode').value = empCode;
      }

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
      const partsData = await fetchData("RepairParts", `"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" = "${requestNumber}" AND "EmpCode" = "${empCode}"`);
      const partsContainer = document.getElementById('partsContainer');
      partsContainer.innerHTML = "";
      if (partsData.length > 0) {
        partsData.forEach(p => addPartRow(p));
      } else {
        addPartRow();
      }
    } catch (err) {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + err.message);
    }
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
  async function saveData(dataTech, dataParts) {
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï RepairTechnicians
    const urlTech = `${baseUrl}RepairTechnicians/Update`;
    const resTech = await fetch(urlTech, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey,
      },
      body: JSON.stringify({ rows: [dataTech] }),
    });
    if (!resTech.ok) throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${resTech.status}`);

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï RepairParts ‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
    for (const part of dataParts) {
      const urlParts = part.ID ? `${baseUrl}RepairParts/Update` : `${baseUrl}RepairParts/Add`;
      const method = "POST";
      const body = JSON.stringify({ rows: [part] });

      const resPart = await fetch(urlParts, {
        method,
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body,
      });
      if (!resPart.ok) throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${resPart.status}`);
    }
  }

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
  window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const requestNumber = urlParams.get('request');
    if (!requestNumber) {
      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏ô URL");
      return;
    }
    const empCode = user.EmpCode;

    loadData(requestNumber, empCode);
  });

  // Submit ‡∏ü‡∏≠‡∏£‡πå‡∏°
  document.getElementById('techForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
      const requestNumber = document.getElementById('requestNumber').value.trim();
      const empCode = document.getElementById('empCode').value.trim();
      const comments = document.getElementById('comments').value.trim();

      if (!requestNumber || !empCode) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á");
        return;
      }

      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairTechnicians
      const dataTech = {
        "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": requestNumber,
        "‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö": empCode,
        "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": comments,
      };

      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairParts ‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
      const partsContainer = document.getElementById('partsContainer');
      const partRows = partsContainer.querySelectorAll('.part-row');
      let dataParts = [];

      partRows.forEach(row => {
        const id = row.querySelector('input[name="partID[]"]').value.trim();
        const name = row.querySelector('input[name="partName[]"]').value.trim();
        const qty = row.querySelector('input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô[]"]').value.trim();
        const unit = row.querySelector('input[name="unit[]"]').value.trim();

        if (name && qty) {
          const part = {
            "ID": id || undefined,
            "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": requestNumber,
            "EmpCode": empCode,
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": name,
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": Number(qty),
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢": unit,
          };
          dataParts.push(part);
        }
      });

      await saveData(dataTech, dataParts);
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô
      // loadData(requestNumber, empCode);
    } catch (err) {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + err.message);
    }
  });
</script>

</body>
</html>
