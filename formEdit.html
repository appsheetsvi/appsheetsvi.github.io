<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ระบบจัดการงานซ่อม</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sarabun p-4">

<h1 class="text-2xl font-bold text-center text-blue-600 mb-4">ระบบจัดการงานซ่อม</h1>

<!-- Filter -->
<div class="max-w-6xl mx-auto bg-white p-4 rounded-lg shadow mb-4 flex flex-wrap gap-4 items-end">
  <div>
    <label class="font-semibold">จากวันที่</label>
    <input type="date" id="filterStart" class="border border-blue-400 rounded px-2 py-1" />
  </div>
  <div>
    <label class="font-semibold">ถึงวันที่</label>
    <input type="date" id="filterEnd" class="border border-blue-400 rounded px-2 py-1" />
  </div>
  <div class="flex items-center gap-2">
    <input type="checkbox" id="statusUnfinished" checked />
    <label for="statusUnfinished">ไม่จบงาน</label>
  </div>
  <div class="flex items-center gap-2">
    <input type="checkbox" id="statusFinished" />
    <label for="statusFinished">จบงาน</label>
  </div>
  <button id="filterBtn" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">ค้นหา</button>
</div>

<!-- ตารางงานซ่อม -->
<div class="max-w-6xl mx-auto overflow-x-auto" id="cardsContainer">กำลังโหลดข้อมูล...</div>

<!-- Modal แก้ไข / เพิ่ม -->
<div id="editModal" class="fixed inset-0 hidden bg-black bg-opacity-30 justify-center items-start overflow-auto py-8 z-50">
  <div class="bg-white rounded-lg shadow max-w-3xl w-full p-6 relative">
    <h2 class="text-xl font-bold text-blue-600 mb-4">แก้ไข / เพิ่มงานซ่อม</h2>
    <form id="editForm" class="space-y-3">
      <div>
        <label class="font-semibold">เลขที่ใบแจ้งซ่อม</label>
        <input type="text" id="editRequestNumber" readonly class="w-full border border-blue-400 rounded px-2 py-1 bg-gray-100"/>
      </div>

      <div>
        <label class="font-semibold">รหัสช่าง (เลือกได้หลายคน)</label>
        <div id="empContainer" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto border border-blue-400 p-2 rounded"></div>
      </div>

      <div>
        <label class="font-semibold">สถานะงานช่าง</label>
        <div class="flex gap-4 mt-1">
          <label><input type="checkbox" id="editStatusUnfinished" /> ไม่จบงาน</label>
          <label><input type="checkbox" id="editStatusFinished" /> จบงาน</label>
        </div>
      </div>

      <div>
        <label class="font-semibold">ความคิดเห็น</label>
        <textarea id="editComment" class="w-full border border-blue-400 rounded px-2 py-1"></textarea>
      </div>

      <div class="flex gap-4">
        <div>
          <label class="font-semibold">เวลาเริ่มงาน</label>
          <input type="datetime-local" id="editStartTime" class="border border-blue-400 rounded px-2 py-1"/>
        </div>
        <div>
          <label class="font-semibold">เวลาสิ้นสุดงาน</label>
          <input type="datetime-local" id="editEndTime" class="border border-blue-400 rounded px-2 py-1"/>
        </div>
      </div>

      <div>
        <label class="font-semibold">รายการอะไหล่</label>
        <div id="partsContainer" class="space-y-2 border border-blue-400 p-2 rounded max-h-40 overflow-y-auto"></div>
        <button type="button" id="addPartBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 mt-2">+ เพิ่มรายการอะไหล่</button>
      </div>

      <div class="flex justify-end gap-2 mt-4">
        <button type="button" id="modalCancelBtn" class="px-4 py-1 rounded bg-gray-300 hover:bg-gray-400">ยกเลิก</button>
        <button type="submit" class="px-4 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">บันทึก</button>
      </div>
    </form>
  </div>
</div>

<script>
const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

let techniciansData = [];
let partsData = [];
let empData = [];
let currentEditRecord = null;

// โหลดข้อมูล
async function loadData() {
  document.getElementById("cardsContainer").textContent = "กำลังโหลดข้อมูล...";
  try {
    // งานซ่อม
    const resTech = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Action`, {
      method: "POST",
      headers: { "Content-Type":"application/json","ApplicationAccessKey":apiKey },
      body: JSON.stringify({ Action:"Find", Expression:"TRUE" })
    });
    techniciansData = await resTech.json();

    // อะไหล่
    const resParts = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Action`, {
      method:"POST", headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
      body: JSON.stringify({ Action:"Find", Expression:"TRUE" })
    });
    partsData = await resParts.json();

    // ช่าง
    const resEmp = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/Emp/Action`, {
      method:"POST", headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
      body: JSON.stringify({ Action:"Find", Expression:`[DeptCode]="a12"` })
    });
    empData = await resEmp.json();

    renderCards();
  } catch(err){ console.error(err); document.getElementById("cardsContainer").textContent="โหลดข้อมูลผิดพลาด"; }
}

// แสดงตารางงานซ่อม
function renderCards() {
  const container = document.getElementById("cardsContainer");
  const start = document.getElementById("filterStart").value;
  const end = document.getElementById("filterEnd").value;
  const statusUnfinished = document.getElementById("statusUnfinished").checked;
  const statusFinished = document.getElementById("statusFinished").checked;

  const filtered = techniciansData.filter(r=>{
    const tDate = new Date(r["เวลาเริ่ม"]);
    const afterStart = !start || tDate >= new Date(start);
    const beforeEnd = !end || tDate <= new Date(end);
    const statusMatch = (statusUnfinished && r["สถานะของงานช่าง"]!=="จบงาน") || (statusFinished && r["สถานะของงานช่าง"]==="จบงาน");
    return afterStart && beforeEnd && statusMatch;
  });

  if(filtered.length===0){ container.innerHTML=`<p class="text-center text-gray-500">ไม่พบงานตามเงื่อนไข</p>`; return;}

  const partsByReq = {};
  partsData.forEach(p=>{
    const req = p["เลขที่ใบแจ้งซ่อม"];
    if(!partsByReq[req]) partsByReq[req]=[];
    partsByReq[req].push(p);
  });

  let html = `<table class="w-full border-collapse bg-white shadow rounded"><thead class="bg-blue-600 text-white"><tr>
    <th class="px-2 py-1 border">เลขที่ใบแจ้งซ่อม</th>
    <th class="px-2 py-1 border">หน่วยงาน</th>
    <th class="px-2 py-1 border">รหัสช่าง</th>
    <th class="px-2 py-1 border">สถานะงานช่าง</th>
    <th class="px-2 py-1 border">เวลาเริ่ม</th>
    <th class="px-2 py-1 border">เวลาสิ้นสุด</th>
    <th class="px-2 py-1 border">ความคิดเห็น</th>
    <th class="px-2 py-1 border">อะไหล่</th>
    <th class="px-2 py-1 border">จัดการ</th>
  </tr></thead><tbody>`;

  filtered.forEach(r=>{
    const parts = partsByReq[r["เลขที่ใบแจ้งซ่อม"]]||[];
    const partsHtml = parts.map(p=>`${p.Seq||"-"}: ${p["รายการอะไหล่"]} ${p["จำนวน"]} ${p["หน่วย"]}`).join("<br>");
    html+=`<tr class="border-b"><td class="px-2 py-1">${r["เลขที่ใบแจ้งซ่อม"]}</td>
      <td class="px-2 py-1">${r["หน่วยงาน"]||"-"}</td>
      <td class="px-2 py-1">${r.EmpCode||"-"}</td>
      <td class="px-2 py-1">${r["สถานะของงานช่าง"]||"-"}</td>
      <td class="px-2 py-1">${r["เวลาเริ่ม"]?new Date(r["เวลาเริ่ม"]).toLocaleString():"-"}</td>
      <td class="px-2 py-1">${r["เวลาจบ"]?new Date(r["เวลาจบ"]).toLocaleString():"-"}</td>
      <td class="px-2 py-1">${r["การแก้ไขความคิดเห็น"]||"-"}</td>
      <td class="px-2 py-1">${partsHtml||"-"}</td>
      <td class="px-2 py-1"><button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="openEditModal('${r.ID}')">แก้ไข / เพิ่ม</button></td>
    </tr>`;
  });

  html+="</tbody></table>";
  container.innerHTML = html;
}

// เปิด modal
function openEditModal(id){
  const rec = techniciansData.find(r=>r.ID===id);
  if(!rec) return alert("ไม่พบข้อมูล");

  currentEditRecord = rec;
  document.getElementById("editRequestNumber").value = rec["เลขที่ใบแจ้งซ่อม"]||"";
  document.getElementById("editComment").value = rec["การแก้ไขความคิดเห็น"]||"";
  document.getElementById("editStartTime").value = rec["เวลาเริ่ม"]?new Date(rec["เวลาเริ่ม"]).toISOString().slice(0,16):"";
  document.getElementById("editEndTime").value = rec["เวลาจบ"]?new Date(rec["เวลาจบ"]).toISOString().slice(0,16):"";

  document.getElementById("editStatusUnfinished").checked = rec["สถานะของงานช่าง"]!=="จบงาน";
  document.getElementById("editStatusFinished").checked = rec["สถานะของงานช่าง"]==="จบงาน";

  // แสดง checkbox ช่าง
  const empContainer = document.getElementById("empContainer");
  empContainer.innerHTML="";
  empData.forEach(emp=>{
    const cb = document.createElement("label");
    cb.className="mr-2";
    cb.innerHTML=`<input type="checkbox" class="emp-checkbox" value="${emp.EmpCode}" ${rec.EmpCode===emp.EmpCode?"checked":""} /> ${emp.EmpName}`;
    empContainer.appendChild(cb);
  });

  // อะไหล่
  const partsContainer = document.getElementById("partsContainer");
  partsContainer.innerHTML="";
  const parts = partsData.filter(p=>p["เลขที่ใบแจ้งซ่อม"]===rec["เลขที่ใบแจ้งซ่อม"]);
  if(parts.length===0) addPartRow();
  else parts.forEach(p=>addPartRow(p["รายการอะไหล่"],p["จำนวน"],p["หน่วย"]));

  document.getElementById("editModal").classList.remove("hidden");
}

// เพิ่มแถวอะไหล่
function addPartRow(item="", qty="", unit=""){
  const container = document.getElementById("partsContainer");
  const row = document.createElement("div");
  row.className="flex gap-2 items-center";
  row.innerHTML=`<input type="text" class="part-item border border-blue-400 rounded px-1 py-1 flex-1" value="${item}" placeholder="รายการอะไหล่" required />
  <input type="number" class="part-qty border border-blue-400 rounded px-1 py-1 w-20" value="${qty}" placeholder="จำนวน" required />
  <input type="text" class="part-unit border border-blue-400 rounded px-1 py-1 w-20" value="${unit}" placeholder="หน่วย" />
  <button type="button" class="bg-red-600 text-white px-2 py-1 rounded" onclick="this.parentNode.remove()">x</button>`;
  container.appendChild(row);
}

// ปิด modal
document.getElementById("modalCancelBtn").addEventListener("click",()=>document.getElementById("editModal").classList.add("hidden"));

// เพิ่ม part
document.getElementById("addPartBtn").addEventListener("click",()=>addPartRow());

// บันทึก
document.getElementById("editForm").addEventListener("submit", async e=>{
  e.preventDefault();
  if(!currentEditRecord) return alert("ไม่มีข้อมูลที่แก้ไข");

  const empCodes = Array.from(document.querySelectorAll(".emp-checkbox:checked")).map(c=>c.value);
  const status = document.getElementById("editStatusFinished").checked?"จบงาน":"ไม่จบงาน";
  const comment = document.getElementById("editComment").value;
  const startTime = document.getElementById("editStartTime").value;
  const endTime = document.getElementById("editEndTime").value;

  // บันทึก RepairTechnicians
  const techBody = {
    Action:"Edit",
    Properties:{},
    Rows:[{
      ID: currentEditRecord.ID,
      EmpCode: empCodes.join(","),
      "สถานะของงานช่าง": status,
      "การแก้ไขความคิดเห็น": comment,
      "เวลาเริ่ม": startTime,
      "เวลาจบ": endTime,
      Version: (currentEditRecord.Version||0)+1,
      UpdatedBy: "WebUser",
      DateModified: new Date().toISOString()
    }]
  };

  await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairTechnicians/Action`, {
    method:"POST", headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
    body: JSON.stringify(techBody)
  });

  // บันทึก RepairParts
  const partRows = Array.from(document.querySelectorAll("#partsContainer > div")).map((div,i)=>({
    ID: div.dataset.id||"",
    "เลขที่ใบแจ้งซ่อม": currentEditRecord["เลขที่ใบแจ้งซ่อม"],
    "รหัสเครื่อง": currentEditRecord["รหัสเครื่อง"],
    EmpCode: empCodes.join(","),
    Seq: i+1,
    "รายการอะไหล่": div.querySelector(".part-item").value,
    "จำนวน": div.querySelector(".part-qty").value,
    "หน่วย": div.querySelector(".part-unit").value
  }));

  for(const p of partRows){
    const existing = partsData.find(x=>x["เลขที่ใบแจ้งซ่อม"]===p["เลขที่ใบแจ้งซ่อม"] && x.Seq===p.Seq);
    const action = existing?"Edit":"Add";
    await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/RepairParts/Action`,{
      method:"POST", headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
      body: JSON.stringify({ Action:action, Rows:[p] })
    });
  }

  alert("บันทึกเรียบร้อย");
  document.getElementById("editModal").classList.add("hidden");
  loadData();
});

// Filter
document.getElementById("filterBtn").addEventListener("click", renderCards);

// โหลดครั้งแรก
loadData();
</script>

</body>
</html>
