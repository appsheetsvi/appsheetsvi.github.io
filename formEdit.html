<!DOCTYPE html> 
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .tab { @apply px-4 py-2 font-semibold rounded-t; }
  .tab-active { @apply bg-blue-200; }
  .tab-inactive { @apply bg-gray-200; }
  .chip { @apply inline-block px-2 py-0.5 rounded-full border text-sm; }
</style>
</head>
<body class="bg-gray-100 font-sarabun p-4">
<div>
  <nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <a href="https://appsheetsvi.github.io/Menu.html" class="font-semibold">üè† Home</a>
    <div class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
  </nav>
</div>

<h1 class="text-2xl font-bold text-center text-blue-600 mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h1>

<!-- Tabs -->
<div class="max-w-7xl mx-auto mb-3">
  <div class="flex border-b border-gray-300">
    <button id="tabEditBtn" class="tab tab-active">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</button>
    <button id="tabAddonBtn" class="tab tab-inactive ml-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
  </div>
</div>
    <!‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á--->
<!-- REPORT FILTER -->
<div class="max-w-7xl mx-auto bg-white p-3 rounded-lg shadow mb-3">
  <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">

    <div class="md:col-span-3">
      <label class="font-semibold text-sm">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="filterStart"
        class="w-full border border-blue-400 rounded px-2 py-1">
    </div>

    <div class="md:col-span-3">
      <label class="font-semibold text-sm">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="filterEnd"
        class="w-full border border-blue-400 rounded px-2 py-1">
    </div>

    <div class="md:col-span-3">
      <label class="font-semibold text-sm">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
      <select id="filterDept"
        class="w-full border border-blue-400 rounded px-2 py-1">
        <option value="">-- ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
      </select>
    </div>

    <div class="md:col-span-3">
      <label class="font-semibold text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      <select id="filterStatus"
        class="w-full border border-blue-400 rounded px-2 py-1">
        <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
        <option value="‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
        <option value="‡∏à‡∏ö‡∏á‡∏≤‡∏ô">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</option>
      </select>
    </div>

    <div class="md:col-span-12 flex gap-2 justify-end mt-2">
      <button onclick="applyFilter()"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      </button>
      <button onclick="resetFilter()"
        class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">
        ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
      </button>
    </div>

  </div>
</div>


<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° -->
<div class="max-w-7xl mx-auto overflow-x-auto" id="cardsContainer">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<!-- Modal (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á Edit & Add-on) -->
<div id="editModal" class="fixed inset-0 hidden bg-black bg-opacity-30 justify-center items-start overflow-auto py-6 z-50">
  <div class="bg-white rounded-lg shadow max-w-3xl w-full p-4 relative">
    <h2 id="modalTitle" class="text-lg md:text-xl font-bold text-blue-600 mb-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h2>
    <form id="editForm" class="space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
          <input type="text" id="editRequestNumber" class="w-full border border-blue-400 rounded px-2 py-1" />
        </div>
        <div>
          <label class="font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á</label>
          <div class="flex gap-4 mt-1">
            <label class="chip"><input type="checkbox" id="editStatusUnfinished" /> ‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</label>
            <label class="chip"><input type="checkbox" id="editStatusFinished" /> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</label>
          </div>
        </div>
      </div>

      <div>
        <label class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô) ‚Äî ‡πÅ‡∏ú‡∏ô‡∏Å A12</label>
        <div id="empContainer" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto border border-blue-400 p-2 rounded"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
          <input list="deptList" id="editDept" class="w-full border border-blue-400 rounded px-2 py-1" />
        </div>
        <div>
          <label class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
          <input list="machineList" id="editMachineCode" class="w-full border border-blue-400 rounded px-2 py-1" />
          <datalist id="machineList"></datalist>
        </div>
      </div>

      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea id="editProblem" class="w-full border border-blue-400 rounded px-2 py-1" rows="2"></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
          <input type="datetime-local" id="editStartTime" class="w-full border border-blue-400 rounded px-2 py-1"/>
        </div>
        <div>
          <label class="font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏á‡∏≤‡∏ô</label>
          <input type="datetime-local" id="editEndTime" class="w-full border border-blue-400 rounded px-2 py-1"/>
        </div>
      </div>

      <div>
        <label class="font-semibold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="editCause" class="w-full border border-blue-400 rounded px-2 py-1" rows="2"></textarea>
      </div>

      <div>
        <label class="font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô / ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
        <textarea id="editComment" class="w-full border border-blue-400 rounded px-2 py-1" rows="2"></textarea>
      </div>

      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label>
        <div id="partsContainer" class="space-y-2 border border-blue-400 p-2 rounded max-h-40 overflow-y-auto"></div>
        <button type="button" id="addPartBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 mt-2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="modalCancelBtn" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

/* ===== STATE ===== */
let mode = "edit"; // "edit" | "addon"
let techniciansData = [];
let partsData = [];
let empData = [];
let deptData = [];
let machineData = [];
let currentRow = null;
let startBeforeSave = null; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Edit/Add-on

/* ===== HELPERS ===== */
const api = (table, payload) =>
  fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${table}/Action`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
    body: JSON.stringify(payload)
  }).then(r => r.json());

const fmtDateTimeCell = (iso) => {
  if (!iso) return "-";
  const d = new Date(iso);
  return d.toLocaleString('th-TH', {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false
  }).replace(",", "");
};

const toInputLocal = (iso) => {
  if (!iso) return "";
  const d = new Date(iso);
  const pad = (n) => String(n).padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
};

function unique(arr){ return [...new Set(arr)]; }

// ‡πÄ‡∏ß‡∏•‡∏≤ HH:MM:SS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö StartBeforeSave / EndBeforeSave
function formatTimeOnly(date) {
  const pad = (n) => String(n).padStart(2, "0");
  return `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
}
// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° + ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö RepairTechnicians)


// ms ‚Üí Duration (h:mm:ss) ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå TimeBeforeSave (Duration)
function formatDurationMsToAppsheet(msDiff) {
  let totalSeconds = Math.floor(msDiff / 1000);
  if (totalSeconds < 0) totalSeconds = 0;

  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;

  const pad2 = (n) => String(n).padStart(2, "0");
  return `${hours}:${pad2(minutes)}:${pad2(seconds)}`;
}

   function buildDeptDropdown() {
  const deptSelect = document.getElementById("filterDept");
  const selectedValue = deptSelect.value; // ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ

  deptSelect.innerHTML = `<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>`;

  deptData.forEach(d => {
    if (d.DeptCode && d.DeptNameEng) {
      const opt = document.createElement("option");
      opt.value = d.DeptCode;          // ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏Å‡∏£‡∏≠‡∏á
      opt.textContent = d.DeptNameEng; // ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÅ‡∏™‡∏î‡∏á
      deptSelect.appendChild(opt);
    }
  });

  // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
  deptSelect.value = selectedValue;
}

  
/* ===== LOAD DATA ===== */
async function loadAll(expression = "TRUE") {
  const container = document.getElementById("cardsContainer");
 // ‚úÖ Loader ‡∏™‡∏ß‡∏¢ ‡πÜ
  container.innerHTML = `
    <div class="flex flex-col items-center justify-center py-20 text-gray-500">
      <svg class="animate-spin h-8 w-8 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
    </div>
  `;

 try {
    const [tech, parts, emp, dept, machine] = await Promise.all([
      api("RepairTechnicians", { Action: "Find", Expression: expression }),
      api("RepairParts", { Action: "Find", Expression: "TRUE" }),
      api("Emp", { Action: "Find", Expression: "TRUE" }),
      api("Department", { Action: "Find", Expression: "TRUE" }),
      api("MachineMaster", { Action: "Find", Expression: "TRUE" }),
    ]);

    techniciansData = Array.isArray(tech) ? tech : [];
    partsData = Array.isArray(parts) ? parts : [];
    empData = Array.isArray(emp) ? emp : [];
    deptData = Array.isArray(dept) ? dept : [];
    machineData = Array.isArray(machine) ? machine : [];

    buildDeptDropdown();
    renderTable();
  } catch (e) {
    console.error(e);
    container.innerHTML = `<p class="text-center text-red-500 py-10">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>`;
  }
}

function renderTable() {
  const container = document.getElementById("cardsContainer");
  if (!techniciansData.length) {
    container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô</p>`;
    return;
  }

  // ===== 1) ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° =====
  const groups = {}; // key = ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°

  techniciansData.forEach(r => {
    const reqNo = r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"];
    if (!reqNo) return;

    if (!groups[reqNo]) {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏µ‡πâ
      groups[reqNo] = {
        reqNo,
        rows: [],
        deptCode: r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "",
        machineCode: r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "",
        problem: r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "",
        comment: r["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "",
        startTime: r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"] || "",
        timeUsed: r["TimeBeforeSave"] || r.TimeBeforeSave || "",
      };
    }
    groups[reqNo].rows.push(r);
  });

  // ‡πÅ‡∏õ‡∏•‡∏á groups ‚Üí array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö render
  const groupedRows = Object.values(groups);

  if (!groupedRows.length) {
    container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô</p>`;
    return;
  }

  // ===== 2) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á =====
  let html = `
  <table class="w-full border-collapse bg-white shadow rounded text-sm">
    <thead class="bg-blue-600 text-white">
      <tr>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏ß/‡∏î/‡∏õ</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡πÅ‡∏ú‡∏ô‡∏Å</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</th>
        <th class="pz-2 py-1 border whitespace-nowrap">‡∏™‡∏ñ‡∏≤‡∏ô‡∏á‡∏≤‡∏ô</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody>`;

  // ===== 3) ‡∏ß‡∏ô‡∏ó‡∏µ‡∏•‡∏∞ "‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á" ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß =====
  groupedRows.forEach(g => {
    // ‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏µ‡πâ
    const empCodes = g.rows
      .map(r => r.EmpCode || "")
      .join(",")                 // ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      .split(",")                // ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô array
      .map(c => c.trim())
      .filter(c => c);           // ‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á

    const uniqueEmpCodes = [...new Set(empCodes)]; // ‡πÄ‡∏≠‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥

    const empNames = uniqueEmpCodes.length
      ? uniqueEmpCodes.map(code => {
          const e = empData.find(x => x.EmpCode === code);
          return e ? e.EmpName : code;
        }).join(", ")
      : "-";

    // ‡πÅ‡∏ú‡∏ô‡∏Å ‚Üí DeptNameEng
    const deptFull = g.deptCode
      ? (deptData.find(d => d.DeptCode === g.deptCode)?.DeptNameEng || g.deptCode)
      : "-";

    // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å MachineMaster
    const machineName = g.machineCode
      ? (machineData.find(m => m.MachineCode === g.machineCode)?.["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"] || g.machineCode)
      : "-";

    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
    const dateDisplay = g.startTime ? fmtDateTimeCell(g.startTime).split(" ")[0] : "-";
          // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
const statusDisplay = g.rows[0]["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] || "-";

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
let statusClass = "";
if(statusDisplay === "‡∏à‡∏ö‡∏á‡∏≤‡∏ô") statusClass = "bg-green-200 text-green-800";
else if(statusDisplay === "‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô") statusClass = "bg-red-200 text-red-800";

html += `
  <tr class="border-b">
    <td class="px-2 py-1">${dateDisplay}</td>
    <td class="px-2 py-1">${empNames}</td>
    <td class="px-2 py-1">${g.reqNo}</td>
    <td class="px-2 py-1">${deptFull}</td>
    <td class="px-2 py-1">${machineName}</td>
    <td class="px-2 py-1">${g.problem || "-"}</td>
    <td class="px-2 py-1">${g.comment || "-"}</td>
    <td class="px-2 py-1 w-32 break-words">
      <span class="px-2 py-0.5 rounded ${statusClass}">${statusDisplay}</span>
    </td>
    <td class="px-2 py-1">
      <div class="flex gap-1">
        <button class="bg-blue-600 text-white px-2 py-1 rounded"
                onclick="openEdit('${g.rows[0].ID}')">Edit</button>
        <button class="bg-green-600 text-white px-2 py-1 rounded"
                onclick="openAddon('${g.rows[0].ID}')">‡∏ï‡πà‡∏≠‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á</button>
      </div>
    </td>
  </tr>`;

  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}

/* ===== MODAL TOOLS ===== */
function fillEmpChoices(selectedCsv="") {
  const wrap = document.getElementById("empContainer");
  wrap.innerHTML = "";
  const selected = selectedCsv ? selectedCsv.split(",") : [];
  empData
    .filter(e => e.DeptCode === "A12")
    .forEach(e => {
      const checked = selected.includes(e.EmpCode) ? "checked" : "";
      const item = document.createElement("label");
      item.className = "chip border-blue-400";
      item.innerHTML = `<input type="checkbox" class="emp-checkbox" value="${e.EmpCode}" ${checked}/> ${e.EmpName}`;
      wrap.appendChild(item);
    });
}

function clearParts(){ document.getElementById("partsContainer").innerHTML=""; }

function addPartRow(item="", qty="", unit=""){
  const row = document.createElement("div");
  row.className = "flex gap-2 items-center";
  row.innerHTML = `
    <input type="text" class="part-item border border-blue-400 rounded px-2 py-1 flex-1" value="${item}" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" />
    <input type="number" class="part-qty border border-blue-400 rounded px-2 py-1 w-24" value="${qty}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" />
    <input type="text" class="part-unit border border-blue-400 rounded px-2 py-1 w-24" value="${unit}" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" />
    <button type="button" class="bg-red-600 text-white px-2 py-1 rounded" onclick="this.parentNode.remove()">‡∏•‡∏ö</button>`;
  document.getElementById("partsContainer").appendChild(row);
}

/* ===== OPEN EDIT / ADDON ===== */
function openEdit(id){
  mode = "edit";
  const r = techniciansData.find(x => x.ID === id);
  if (!r) return;
  currentRow = r;

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
  startBeforeSave = new Date();

  document.getElementById("modalTitle").textContent = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°";
  document.getElementById("editRequestNumber").value = r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "";
  document.getElementById("editDept").value = r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "";
  document.getElementById("editMachineCode").value = r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "";
  document.getElementById("editProblem").value = r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
  document.getElementById("editCause").value = r["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || "";
  document.getElementById("editComment").value = r["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "";
  document.getElementById("editStartTime").value = toInputLocal(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]);
  document.getElementById("editEndTime").value = toInputLocal(r["‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö"]);
  document.getElementById("editStatusFinished").checked = r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] === "‡∏à‡∏ö‡∏á‡∏≤‡∏ô";
  document.getElementById("editStatusUnfinished").checked = r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] !== "‡∏à‡∏ö‡∏á‡∏≤‡∏ô";

  fillEmpChoices(r.EmpCode || "");
  clearParts();
  const parts = partsData.filter(p => p["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] && (p.EmpCode||"") === (r.EmpCode||""));
  if (parts.length) parts.forEach(p => addPartRow(p["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"], p["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"], p["‡∏´‡∏ô‡πà‡∏ß‡∏¢"]));
  if (!parts.length) addPartRow();

  document.getElementById("editModal").classList.remove("hidden");
  document.getElementById("editModal").classList.add("flex");
}

function openAddon(id){
  mode = "addon";
  const r = techniciansData.find(x => x.ID === id);
  if (!r) return;
  currentRow = r;

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
  startBeforeSave = new Date();

  document.getElementById("modalTitle").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)";
  document.getElementById("editRequestNumber").value = r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "";
  document.getElementById("editDept").value = r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "";
  document.getElementById("editMachineCode").value = r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "";
  document.getElementById("editProblem").value = r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
  document.getElementById("editCause").value = r["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || "";
  document.getElementById("editComment").value = "";
  document.getElementById("editStartTime").value = "";
  document.getElementById("editEndTime").value = "";
  document.getElementById("editStatusFinished").checked = false;
  document.getElementById("editStatusUnfinished").checked = true;

  fillEmpChoices(""); // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà
  clearParts();
  addPartRow();

  document.getElementById("editModal").classList.remove("hidden");
  document.getElementById("editModal").classList.add("flex");
}

/* ===== SUBMIT ===== */
document.getElementById("editForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const reqNo = document.getElementById("editRequestNumber").value?.trim();
  const dept = document.getElementById("editDept").value?.trim();
  const machineCodeInput = document.getElementById("editMachineCode").value?.trim();
  const machineFound = machineData.find(m => m.MachineCode === machineCodeInput || m.MachineName === machineCodeInput);
  const machineCode = machineFound ? machineFound.MachineCode : machineCodeInput;

  const problem = document.getElementById("editProblem").value?.trim();
  const cause = document.getElementById("editCause").value?.trim();
  const comment = document.getElementById("editComment").value?.trim();
  const startTime = document.getElementById("editStartTime").value;
  const endTime = document.getElementById("editEndTime").value;
  const status = document.getElementById("editStatusFinished").checked ? "‡∏à‡∏ö‡∏á‡∏≤‡∏ô" : "‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô";
  const selectedEmp = Array.from(document.querySelectorAll(".emp-checkbox:checked")).map(i=>i.value);

  if (!reqNo) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"); return; }
  if (!dept) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"); return; }
  if (!machineCode) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"); return; }

  if (mode === "addon" && !selectedEmp.length) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô");
    return;
  }

  // parts rows
  const partRows = Array.from(document.querySelectorAll("#partsContainer > div")).map((div,i)=>({
    Seq: i+1,
    Item: div.querySelector(".part-item").value?.trim() || "",
    Qty: div.querySelector(".part-qty").value || "",
    Unit: div.querySelector(".part-unit").value?.trim() || ""
  })).filter(p => p.Item);

  // ===== ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ Start/End/Duration ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å =====
  const endBeforeSaveDate = new Date();
  const startBeforeSaveDate = startBeforeSave || endBeforeSaveDate;

  const startBeforeSaveStr = formatTimeOnly(startBeforeSaveDate);
  const endBeforeSaveStr   = formatTimeOnly(endBeforeSaveDate);
  const timeBeforeSaveStr  = formatDurationMsToAppsheet(endBeforeSaveDate - startBeforeSaveDate);

  console.log("DEBUG TIME SAVE =>", {
    startBeforeSaveStr,
    endBeforeSaveStr,
    timeBeforeSaveStr
  });

  try {
    if (mode === "edit") {
      const payload = {
        ID: currentRow.ID,
        Version: (currentRow.Version || 0) + 1,
        "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNo,
        "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": dept,
        "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
        "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": problem,
        "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": cause,
        "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": comment,
        "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": startTime,
        "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": endTime,
        "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": status,
        EmpCode: (currentRow.EmpCode || ""),
        UpdatedBy: (currentRow.EmpCode || ""),
        DateModified: new Date().toISOString(),

        StartBeforeSave: startBeforeSaveStr,
        EndBeforeSave: endBeforeSaveStr,
        TimeBeforeSave: timeBeforeSaveStr
      };
      await api("RepairTechnicians", { Action: "Edit", Rows: [payload] });

      // ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà: Add ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° logic Delete ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á)
      for (const p of partRows) {
        await api("RepairParts", { Action: "Add", Rows: [{
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNo,
          "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
          EmpCode: (currentRow.EmpCode || ""),
          Seq: p.Seq,
          "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": p.Item,
          "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": p.Qty,
          "‡∏´‡∏ô‡πà‡∏ß‡∏¢": p.Unit
        }]});
      }
    } else {
      // addon: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠ Emp ‡πÉ‡∏´‡∏°
      for (const emp of selectedEmp) {
        const techRow = {
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNo,
          "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": dept,
          "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
          "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": problem,
          "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": cause,
          "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": comment,
          "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": startTime,
          "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": endTime,
          "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": status,
          EmpCode: emp,
          UpdatedBy: emp,
          DateModified: new Date().toISOString(),

          StartBeforeSave: startBeforeSaveStr,
          EndBeforeSave: endBeforeSaveStr,
          TimeBeforeSave: timeBeforeSaveStr
        };
        await api("RepairTechnicians", { Action: "Add", Rows: [techRow] });

        for (const p of partRows) {
          await api("RepairParts", { Action: "Add", Rows: [{
            "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNo,
            "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
            EmpCode: emp,
            Seq: p.Seq,
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": p.Item,
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": p.Qty,
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢": p.Unit
          }]});
        }
      }
    }

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    document.getElementById("editModal").classList.add("hidden");
    document.getElementById("editModal").classList.remove("flex");
    startBeforeSave = null; // reset
    await applyFilter();
  } catch (e) {
    console.error(e);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }
});

/* ===== PARTS BUTTONS ===== */
document.getElementById("addPartBtn").onclick = () => addPartRow();
document.getElementById("modalCancelBtn").onclick = () => {
  document.getElementById("editModal").classList.add("hidden");
  document.getElementById("editModal").classList.remove("flex");
  startBeforeSave = null;
};
function parseThaiDate(input) {
  if(!input) return null;
  const parts = input.split('-'); // yyyy-mm-dd
  if(parts.length !== 3) return null;
  const year = parseInt(parts[0],10) - 543; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏® ‚Üí ‡∏Ñ.‡∏®
  const month = parts[1];
  const day = parts[2];
  return `${year}-${month}-${day}`;
}
// ==================== FILTER ====================
async function applyFilter(){
  const s=document.getElementById("filterStart").value;
  const e=document.getElementById("filterEnd").value;
  const dept=document.getElementById("filterDept").value?.trim();
  const status=document.getElementById("filterStatus").value?.trim();
  await loadAll("TRUE");
  let filtered=techniciansData;
  if(s) filtered=filtered.filter(r=>r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"] && new Date(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"])>=new Date(s+"T00:00:00"));
  if(e) filtered=filtered.filter(r=>r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"] && new Date(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"])<=new Date(e+"T23:59:59"));
  if(dept) filtered=filtered.filter(r=>r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]===dept);
  if(status) filtered=filtered.filter(r=>r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"]===status);
  const old=techniciansData; techniciansData=filtered; renderTable(); techniciansData=old;
}
function resetFilter(){document.getElementById("filterStart").value="";document.getElementById("filterEnd").value="";document.getElementById("filterDept").value="";document.getElementById("filterStatus").value=""; applyFilter();}

// ==================== TABS ====================
document.getElementById("tabEditBtn").onclick=()=>{mode="edit"; document.getElementById("tabEditBtn").classList.add("tab-active"); document.getElementById("tabAddonBtn").classList.remove("tab-active");};
document.getElementById("tabAddonBtn").onclick=()=>{mode="addon"; document.getElementById("tabAddonBtn").classList.add("tab-active"); document.getElementById("tabEditBtn").classList.remove("tab-active");};

// ==================== INIT ====================
document.addEventListener("DOMContentLoaded",async()=>{
  const today=new Date(); const start=new Date(today); start.setDate(today.getDate()-2);
  document.getElementById("filterStart").value=start.toISOString().slice(0,10);
  document.getElementById("filterEnd").value=today.toISOString().slice(0,10);

  // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î + ‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  await applyFilter();
});
</script>
</body>
</html>
