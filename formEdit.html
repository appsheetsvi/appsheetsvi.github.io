<!DOCTYPE html> 
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .tab { @apply px-4 py-2 font-semibold rounded-t; }
  .tab-active { @apply bg-blue-200; }
  .tab-inactive { @apply bg-gray-200; }
  .chip { @apply inline-block px-2 py-0.5 rounded-full border text-sm; }
</style>
</head>
<body class="bg-gray-100 font-sarabun p-4">
<div>
<nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
<a href="https://appsheetsvi.github.io/Menu.html" class="font-semibold">üè† Home</a>
<div class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
</div>
</nav>
<h1 class="text-2xl font-bold text-center text-blue-600 mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h1>

<!-- Tabs -->
<div class="max-w-7xl mx-auto mb-3">
  <div class="flex border-b border-gray-300">
    <button id="tabEditBtn" class="tab tab-active">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</button>
    <button id="tabAddonBtn" class="tab tab-inactive ml-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
  </div>
</div>

<!-- Global Filter -->
<div id="globalFilter" class="max-w-7xl mx-auto bg-white p-3 rounded-lg shadow mb-3 grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
  <div class="md:col-span-3">
    <label class="font-semibold">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" id="filterStart" class="w-full border border-blue-400 rounded px-2 py-1" />
  </div>
  <div class="md:col-span-3">
    <label class="font-semibold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" id="filterEnd" class="w-full border border-blue-400 rounded px-2 py-1" />
  </div>
  <div class="md:col-span-3">
    <label class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
    <input list="deptList" id="filterDept" class="w-full border border-blue-400 rounded px-2 py-1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"/>
    <datalist id="deptList"></datalist>
  </div>
  <div class="md:col-span-3 flex gap-3 items-center">
    <label class="flex items-center gap-2"><input type="checkbox" id="statusUnfinished" checked /> ‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</label>
    <label class="flex items-center gap-2"><input type="checkbox" id="statusFinished" /> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</label>
  </div>
  <div class="md:col-span-12 flex gap-2">
    <button id="filterBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    <button id="resetBtn" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</button>
  </div>
</div>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° -->
<div class="max-w-7xl mx-auto overflow-x-auto" id="cardsContainer">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<!-- Modal (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á Edit & Add-on) -->
<div id="editModal" class="fixed inset-0 hidden bg-black bg-opacity-30 justify-center items-start overflow-auto py-6 z-50">
  <div class="bg-white rounded-lg shadow max-w-3xl w-full p-4 relative">
    <h2 id="modalTitle" class="text-lg md:text-xl font-bold text-blue-600 mb-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h2>
    <form id="editForm" class="space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
          <input type="text" id="editRequestNumber" class="w-full border border-blue-400 rounded px-2 py-1" />
        </div>
        <div>
          <label class="font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á</label>
          <div class="flex gap-4 mt-1">
            <label class="chip"><input type="checkbox" id="editStatusUnfinished" /> ‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</label>
            <label class="chip"><input type="checkbox" id="editStatusFinished" /> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</label>
          </div>
        </div>
      </div>

      <div>
        <label class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô) ‚Äî ‡πÅ‡∏ú‡∏ô‡∏Å A12</label>
        <div id="empContainer" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto border border-blue-400 p-2 rounded"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
          <input list="deptList" id="editDept" class="w-full border border-blue-400 rounded px-2 py-1" />
        </div>
        <div>
          <label class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
          <input list="machineList" id="editMachineCode" class="w-full border border-blue-400 rounded px-2 py-1" />
          <datalist id="machineList"></datalist>
        </div>
      </div>

      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea id="editProblem" class="w-full border border-blue-400 rounded px-2 py-1" rows="2"></textarea>
      </div>

      <!-- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ -->
      <div>
        <label class="font-semibold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="editCause" class="w-full border border-blue-400 rounded px-2 py-1" rows="2"></textarea>
      </div>

      <div>
        <label class="font-semibold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
        <textarea id="editComment" class="w-full border border-blue-400 rounded px-2 py-1" rows="2"></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
          <input type="datetime-local" id="editStartTime" class="w-full border border-blue-400 rounded px-2 py-1"/>
        </div>
        <div>
          <label class="font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏á‡∏≤‡∏ô</label>
          <input type="datetime-local" id="editEndTime" class="w-full border border-blue-400 rounded px-2 py-1"/>
        </div>
      </div>

      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label>
        <div id="partsContainer" class="space-y-2 border border-blue-400 p-2 rounded max-h-40 overflow-y-auto"></div>
        <button type="button" id="addPartBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 mt-2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="modalCancelBtn" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";

/* ===== STATE ===== */
let mode = "edit"; // "edit" | "addon"
let techniciansData = [];
let partsData = [];
let empData = [];
let deptData = [];
let machineData = [];
let currentRow = null;

/* ===== HELPERS ===== */
const api = (table, payload) =>
  fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${table}/Action`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
    body: JSON.stringify(payload)
  }).then(r => r.json());

const fmtDateTimeCell = (iso) => {
  if (!iso) return "-";
  const d = new Date(iso);
  return d.toLocaleString('th-TH', {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', hour12: false
  }).replace(",", "");
};

const toInputLocal = (iso) => {
  if (!iso) return "";
  const d = new Date(iso);
  const pad = (n) => String(n).padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
};

function unique(arr){ return [...new Set(arr)]; }

/* ===== LOAD DATA ===== */
async function loadAll(expression = "TRUE") {
  const container = document.getElementById("cardsContainer");
  container.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
  try {
    const [tech, parts, emp, dept, machine] = await Promise.all([
      api("RepairTechnicians", { Action: "Find", Expression: expression }),
      api("RepairParts", { Action: "Find", Expression: "TRUE" }),
      api("Emp", { Action: "Find", Expression: "TRUE" }),
      api("Department", { Action: "Find", Expression: "TRUE" }),
      api("MachineMaster", { Action: "Find", Expression: "TRUE" }),
    ]);
    techniciansData = Array.isArray(tech) ? tech : [];
    partsData = Array.isArray(parts) ? parts : [];
    empData = Array.isArray(emp) ? emp : [];
    deptData = Array.isArray(dept) ? dept : [];
    machineData = Array.isArray(machine) ? machine : [];

    const deptList = document.getElementById("deptList");
    deptList.innerHTML = unique(deptData.map(d => d.DeptNameEng).filter(Boolean))
      .map(x => `<option value="${x}">`).join("");

    const machineList = document.getElementById("machineList");
    machineList.innerHTML = machineData.map(m =>
      `<option value="${m.MachineCode}">${m.MachineName||m.MachineCode}</option>`).join("");

    renderTable();
  } catch (e) {
    console.error(e);
    container.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
  }
}

/* ===== RENDER TABLE ===== */
function renderTable() {
  const container = document.getElementById("cardsContainer");
  if (!techniciansData.length) {
    container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô</p>`;
    return;
  }

  let html = `
  <table class="w-full border-collapse bg-white shadow rounded text-sm">
    <thead class="bg-blue-600 text-white">
      <tr>
        <th class="px-2 py-1 border whitespace-nowrap">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</th>
        <th class="px-2 py-1 border whitespace-nowrap">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>
    </thead>
    <tbody>`;

  techniciansData.forEach(r => {
    const empNames = r.EmpCode ? r.EmpCode.split(",").map(c => {
      const e = empData.find(x => x.EmpCode === c.trim());
      return e ? e.EmpName : c;
    }).join(", ") : "-";

    const machineName = r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]
      ? (machineData.find(m => m.MachineCode === r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"])?.MachineName || r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"])
      : "-";

    html += `
      <tr class="border-b">
        <td class="px-2 py-1">${r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]||"-"}</td>
        <td class="px-2 py-1">${empNames}</td>
        <td class="px-2 py-1">${r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"]||"-"}</td>
        <td class="px-2 py-1">${fmtDateTimeCell(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"])}</td>
        <td class="px-2 py-1">${r["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"]||"-"}</td>
        <td class="px-2 py-1">${r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]||"-"}</td>
        <td class="px-2 py-1">${machineName}</td>
        <td class="px-2 py-1">${r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"]||"-"}</td>
        <td class="px-2 py-1">
          <div class="flex gap-1">
            <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="openEdit('${r.ID}')">Edit</button>
            <button class="bg-green-600 text-white px-2 py-1 rounded" onclick="openAddon('${r.ID}')">‡∏ï‡πà‡∏≠‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á</button>
          </div>
        </td>
      </tr>`;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}

/* ===== MODAL HELPERS ===== */
function fillEmpChoices(selectedCsv="") {
  const wrap = document.getElementById("empContainer");
  wrap.innerHTML = "";
  const selected = selectedCsv ? selectedCsv.split(",") : [];
  empData
    .filter(e => e.DeptCode === "A12")
    .forEach(e => {
      const checked = selected.includes(e.EmpCode) ? "checked" : "";
      const item = document.createElement("label");
      item.className = "chip border-blue-400";
      item.innerHTML = `<input type="checkbox" class="emp-checkbox" value="${e.EmpCode}" ${checked}/> ${e.EmpName}`;
      wrap.appendChild(item);
    });
}
function clearParts(){ document.getElementById("partsContainer").innerHTML=""; }
function addPartRow(item="", qty="", unit=""){
  const row = document.createElement("div");
  row.className = "flex gap-2 items-center";
  row.innerHTML = `
    <input type="text" class="part-item border border-blue-400 rounded px-2 py-1 flex-1" value="${item}" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" />
    <input type="number" class="part-qty border border-blue-400 rounded px-2 py-1 w-24" value="${qty}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" />
    <input type="text" class="part-unit border border-blue-400 rounded px-2 py-1 w-24" value="${unit}" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" />
    <button type="button" class="bg-red-600 text-white px-2 py-1 rounded" onclick="this.parentNode.remove()">‡∏•‡∏ö</button>`;
  document.getElementById("partsContainer").appendChild(row);
}

/* ===== OPEN EDIT ===== */
function openEdit(id){
  mode = "edit";
  const r = techniciansData.find(x => x.ID === id);
  if (!r) return;
  currentRow = r;

  document.getElementById("modalTitle").textContent = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°";
  document.getElementById("editRequestNumber").value = r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "";
  document.getElementById("editDept").value = r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "";
  document.getElementById("editMachineCode").value = r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "";
  document.getElementById("editProblem").value = r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
  document.getElementById("editCause").value = r["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || "";
  document.getElementById("editComment").value = r["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "";
  document.getElementById("editStartTime").value = toInputLocal(r["‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°"]);
  document.getElementById("editEndTime").value = toInputLocal(r["‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö"]);
  document.getElementById("editStatusFinished").checked = r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] === "‡∏à‡∏ö‡∏á‡∏≤‡∏ô";
  document.getElementById("editStatusUnfinished").checked = r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á"] !== "‡∏à‡∏ö‡∏á‡∏≤‡∏ô";

  fillEmpChoices(r.EmpCode || "");
  clearParts();
  const parts = partsData.filter(p => 
    p["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] === r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] && 
    (p.EmpCode||"") === (r.EmpCode||"") &&
    p["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] === r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]
  );
  if (parts.length) parts.forEach(p => addPartRow(p["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"], p["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"], p["‡∏´‡∏ô‡πà‡∏ß‡∏¢"]));
  if (!parts.length) addPartRow();

  document.getElementById("editModal").classList.remove("hidden");
  document.getElementById("editModal").classList.add("flex");
}

/* ===== OPEN ADDON (‡∏ï‡πà‡∏≠‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°) ===== */
function openAddon(id){
  mode = "addon";
  const r = techniciansData.find(x => x.ID === id);
  if (!r) return;
  currentRow = r;

  document.getElementById("modalTitle").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)";
  document.getElementById("editRequestNumber").value = r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"] || "";
  document.getElementById("editDept").value = r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || "";
  document.getElementById("editMachineCode").value = r["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "";
  document.getElementById("editProblem").value = r["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
  document.getElementById("editCause").value = r["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || "";
  document.getElementById("editComment").value = "";
  document.getElementById("editStartTime").value = "";
  document.getElementById("editEndTime").value = "";
  document.getElementById("editStatusFinished").checked = false;
  document.getElementById("editStatusUnfinished").checked = true;

  fillEmpChoices(""); // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
  clearParts();
  addPartRow();

  document.getElementById("editModal").classList.remove("hidden");
  document.getElementById("editModal").classList.add("flex");
}

/* ===== SUBMIT FORM ===== */
document.getElementById("editForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const reqNo = document.getElementById("editRequestNumber").value?.trim();
  const dept = document.getElementById("editDept").value?.trim();
  const machineCodeInput = document.getElementById("editMachineCode").value?.trim();
  const machineFound = machineData.find(m => m.MachineCode === machineCodeInput || m.MachineName === machineCodeInput);
  const machineCode = machineFound ? machineFound.MachineCode : machineCodeInput;

  const problem = document.getElementById("editProblem").value?.trim();
  const cause = document.getElementById("editCause").value?.trim();
  const comment = document.getElementById("editComment").value?.trim();
  const startTime = document.getElementById("editStartTime").value;
  const endTime = document.getElementById("editEndTime").value;
  const status = document.getElementById("editStatusFinished").checked ? "‡∏à‡∏ö‡∏á‡∏≤‡∏ô" : "‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô";
  const selectedEmp = Array.from(document.querySelectorAll(".emp-checkbox:checked")).map(i=>i.value);

  if (!reqNo) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"); return; }
  if (!dept) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"); return; }
  if (!machineCode) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"); return; }
  if (mode==="addon" && !selectedEmp.length) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô"); return; }

  const partRows = Array.from(document.querySelectorAll("#partsContainer > div")).map((div,i)=>({
    Seq: i+1,
    Item: div.querySelector(".part-item").value?.trim() || "",
    Qty: div.querySelector(".part-qty").value || "",
    Unit: div.querySelector(".part-unit").value?.trim() || ""
  })).filter(p => p.Item);

  try {
    if (mode === "edit") {
      const payload = {
        ID: currentRow.ID,
        Version: (currentRow.Version || 0) + 1,
        "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNo,
        "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": dept,
        "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
        "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": problem,
        "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": cause,
        "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": comment,
        "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": startTime,
        "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": endTime,
        "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": status,
        EmpCode: (currentRow.EmpCode || ""),
        UpdatedBy: (currentRow.EmpCode || ""),
        DateModified: new Date().toISOString()
      };
      await api("RepairTechnicians", { Action: "Edit", Rows: [payload] });

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤)
      for (const p of partRows) {
        await api("RepairParts", { Action: "Add", Rows: [{
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNo,
          "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
          EmpCode: (currentRow.EmpCode || ""),
          Seq: p.Seq,
          "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": p.Item,
          "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": p.Qty,
          "‡∏´‡∏ô‡πà‡∏ß‡∏¢": p.Unit
        }]});
      }
    } else {
      // addon: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
      for (const emp of selectedEmp) {
        const techRow = {
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNo,
          "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": dept,
          "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
          "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": problem,
          "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": cause,
          "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": comment,
          "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": startTime,
          "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": endTime,
          "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": status,
          EmpCode: emp,
          UpdatedBy: emp,
          DateModified: new Date().toISOString()
        };
        await api("RepairTechnicians", { Action: "Add", Rows: [techRow] });

        for (const p of partRows) {
          await api("RepairParts", { Action: "Add", Rows: [{
            "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNo,
            "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
            EmpCode: emp,
            Seq: p.Seq,
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": p.Item,
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": p.Qty,
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢": p.Unit
          }]});
        }
      }
    }

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    document.getElementById("editModal").classList.add("hidden");
    document.getElementById("editModal").classList.remove("flex");
    await applyFilter();
  } catch (e) {
    console.error(e);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }
});

/* ===== PARTS BUTTONS ===== */
document.getElementById("addPartBtn").onclick = () => addPartRow();
document.getElementById("modalCancelBtn").onclick = () => {
  document.getElementById("editModal").classList.add("hidden");
  document.getElementById("editModal").classList.remove("flex");
};

/* ===== FILTER ===== */
async function applyFilter(){
  const s = document.getElementById("filterStart").value;
  const e = document.getElementById("filterEnd").value;
  const dept = document.getElementById("filterDept").value?.trim();
  const uf = document.getElementById("statusUnfinished").checked;
  const f  = document.getElementById("statusFinished").checked;

  let exp = "TRUE";

  if (s && e) {
    exp = `AND(${exp}, DATE([‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°]) >= DATE("${s}"), DATE([‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°]) <= DATE("${e}"))`;
  } else if (s && !e) {
    exp = `AND(${exp}, DATE([‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°]) >= DATE("${s}"))`;
  } else if (!s && e) {
    exp = `AND(${exp}, DATE([‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°]) <= DATE("${e}"))`;
  }

  if (dept) {
    exp = `AND(${exp}, [‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô] = "${dept}")`;
  }

  const statusList = [];
  if (uf) statusList.push(`[‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á] <> "‡∏à‡∏ö‡∏á‡∏≤‡∏ô"`);
  if (f)  statusList.push(`[‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á] = "‡∏à‡∏ö‡∏á‡∏≤‡∏ô"`);
  if (statusList.length === 1) exp = `AND(${exp}, ${statusList[0]})`;

  await loadAll(exp);
}

document.getElementById("filterBtn").onclick = applyFilter;
document.getElementById("resetBtn").onclick = async ()=>{
  document.getElementById("filterStart").value = "";
  document.getElementById("filterEnd").value = "";
  document.getElementById("filterDept").value = "";
  document.getElementById("statusUnfinished").checked = true;
  document.getElementById("statusFinished").checked = false;
  await loadAll("TRUE");
};

/* ===== TABS ===== */
document.getElementById("tabEditBtn").onclick = ()=>{
  mode = "edit";
  document.getElementById("tabEditBtn").classList.add("tab-active");
  document.getElementById("tabEditBtn").classList.remove("tab-inactive");
  document.getElementById("tabAddonBtn").classList.remove("tab-active");
  document.getElementById("tabAddonBtn").classList.add("tab-inactive");
};
document.getElementById("tabAddonBtn").onclick = ()=>{
  mode = "addon";
  document.getElementById("tabAddonBtn").classList.add("tab-active");
  document.getElementById("tabAddonBtn").classList.remove("tab-inactive");
  document.getElementById("tabEditBtn").classList.remove("tab-active");
  document.getElementById("tabEditBtn").classList.add("tab-inactive");
};

/* ===== ROW OPENERS ===== */
window.openEdit = openEdit;
window.openAddon = openAddon;

/* ===== INIT ===== */
loadAll("TRUE");
</script>
</body>
</html>
