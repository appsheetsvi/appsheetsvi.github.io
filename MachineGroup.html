<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Kanit', sans-serif; background-color: #f0f4ff; margin: 0; padding: 1rem; color: #222; }
    h1 { color: #1d4ed8; text-align: center; margin-bottom:1rem; }
    form { max-width: 600px; margin: auto; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    label { display: block; margin: 0.8rem 0 0.3rem; font-weight: bold; font-size:0.9rem;}
    input, select, button { width: 100%; padding: 0.5rem; border: 1.5px solid #93c5fd; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; }
    button { margin-top: 1rem; font-weight: bold; cursor: pointer; color: white; border: none; border-radius: 6px; }
    #addBtn { background-color: #2563eb; } #addBtn:hover { background-color: #1e40af; }
    #editBtn { background-color: #f59e0b; display:none;} #editBtn:hover { background-color: #b45309; }
    .msg { text-align:center; font-weight:bold; margin-top:0.8rem; font-size:0.9rem; }

    #machineListContainer { max-width: 900px; margin: 1.5rem auto; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 1rem; }
    .search-row { display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.5rem;}
    .search-row input { flex:1; font-size:0.85rem; padding:0.4rem; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    thead { background-color: #2563eb; color: white; }
    th, td { padding:0.5rem; border:1px solid #ddd; text-align:left; }
    tbody tr:hover { background-color:#f0f4ff; cursor:pointer; }

    @media (max-width:700px){
      table, thead, tbody, th, td, tr { display:block; }
      thead tr { display:none; }
      tbody tr { margin-bottom:0.5rem; border:1px solid #ccc; border-radius:6px; padding:0.3rem; }
      tbody td { border:none; padding:0.3rem 0.5rem; position:relative; padding-left:50%; text-align:left; }
      tbody td::before { position:absolute; top:0.3rem; left:0.5rem; width:45%; white-space:nowrap; font-weight:bold; content:attr(data-label); font-size:0.8rem;}
    }
  </style>
</head>
<body>
  <h1>üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1>
  <form id="machineForm" onsubmit="return false;">
    <label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
    <input type="text" id="machineCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" required />
    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</label>
    <input type="text" id="machineName1" required />
    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</label>
    <input type="text" id="machineName" required />
    <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM)</label>
    <select id="groupCode">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ --</option>
    </select>
    <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
    <select id="deptCode" required>
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
    </select>
    <button id="addBtn" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    <button id="editBtn" type="button">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    <div class="msg" id="message"></div>
  </form>

  <div id="machineListContainer">
    <div class="search-row">
      <input type="text" id="searchCode" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">
      <input type="text" id="searchNick" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ NickName">
      <input type="text" id="searchName" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£">
      <input type="text" id="searchDept" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å">
    </div>
    <table id="machineListTable">
      <thead>
        <tr>
          <th>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
          <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
          <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
let machinesData = [], deptsData=[], groupsData=[];

async function fetchTable(tableName){
  const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Find`,{
    method:"POST",
    headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
    body:JSON.stringify({})
  });
  if(!res.ok) throw new Error(`Failed to fetch table ${tableName}`);
  return res.json();
}

async function loadDropdowns(){
  deptsData = await fetchTable("Department");
  groupsData = await fetchTable("MachineGroup");

  const deptSelect = document.getElementById("deptCode");
  deptSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>`;
  deptsData.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = d["DeptCode"];
    opt.textContent = `${d["DeptCode"]} : ${d["DeptNameEng"]}`;
    deptSelect.appendChild(opt);
  });

  const groupSelect = document.getElementById("groupCode");
  groupSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ --</option>`;
  groupsData.forEach(g=>{
    const opt = document.createElement("option");
    opt.value = g["GroupCode"];
    opt.textContent = g["GroupName"];
    groupSelect.appendChild(opt);
  });
}

function renderMachineList(){
  const tbody = document.querySelector("#machineListTable tbody");
  tbody.innerHTML="";

  const fCode = document.getElementById("searchCode").value.toLowerCase();
  const fNick = document.getElementById("searchNick").value.toLowerCase();
  const fName = document.getElementById("searchName").value.toLowerCase();
  const fDept = document.getElementById("searchDept").value.toLowerCase();

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á
  if(!fCode && !fNick && !fName && !fDept){
    const tr = document.createElement("tr");
    const td = document.createElement("td"); td.colSpan=5; td.style.textAlign="center";
    td.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  let filtered = machinesData.filter(m=>{
    const deptText = deptsData.find(d=>d["DeptCode"]===m["DeptCode"]);
    const deptFull = m["DeptCode"] + " : " + (deptText ? deptText["DeptNameEng"] : "");
    return (!fCode || (m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]||"").toLowerCase().includes(fCode)) &&
           (!fNick || (m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||"").toLowerCase().includes(fNick)) &&
           (!fName || (m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]||"").toLowerCase().includes(fName)) &&
           (!fDept || deptFull.toLowerCase().includes(fDept));
  });

  if(filtered.length===0){
    const tr = document.createElement("tr");
    const td = document.createElement("td"); td.colSpan=5; td.style.textAlign="center";
    td.textContent="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  filtered.forEach(m=>{
    const tr = document.createElement("tr");
    const deptText = deptsData.find(d=>d["DeptCode"]===m["DeptCode"]);
    const groupText = groupsData.find(g=>g["GroupCode"]===m["GroupCode"]);
    tr.innerHTML=`
      <td data-label="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]||""}</td>
      <td data-label="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)">${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||""}</td>
      <td data-label="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£">${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]||""}</td>
      <td data-label="‡πÅ‡∏ú‡∏ô‡∏Å">${m["DeptCode"]} : ${deptText?deptText["DeptNameEng"]:""}</td>
      <td data-label="‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM)">${groupText?groupText["GroupName"]:""}</td>
    `;
    tr.addEventListener("click",()=>fillForm(m));
    tbody.appendChild(tr);
  });
}

function fillForm(data){
  document.getElementById("machineCode").value = data["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
  document.getElementById("machineCode").disabled = true;
  document.getElementById("machineName1").value = data["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||"";
  document.getElementById("machineName").value = data["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]||"";
  document.getElementById("groupCode").value = data["GroupCode"]||"";
  document.getElementById("deptCode").value = data["DeptCode"]||"";

  document.getElementById("addBtn").style.display="none";
  document.getElementById("editBtn").style.display="block";
}

function resetForm(){
  document.getElementById("machineForm").reset();
  document.getElementById("machineCode").disabled=false;
  document.getElementById("addBtn").style.display="block";
  document.getElementById("editBtn").style.display="none";
  document.getElementById("message").textContent="";
}

async function addMachine(){
  const code = document.getElementById("machineCode").value.trim();
  const name1 = document.getElementById("machineName1").value.trim();
  const name = document.getElementById("machineName").value.trim();
  const group = document.getElementById("groupCode").value;
  const dept = document.getElementById("deptCode").value;
  const msg = document.getElementById("message");

  if(!code || !name1 || !name || !dept){
    msg.style.color="red"; msg.textContent="‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"; return;
  }

  const payload={ Action:"Add", Rows:[{
    "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": code,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1": name1,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£": name,
    "GroupCode": group,
    "DeptCode": dept
  }]};

  try{
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
      method:"POST",
      headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
      body:JSON.stringify(payload)
    });
    if(res.ok){
      msg.style.color="green"; msg.textContent="‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
      machinesData = await fetchTable("MachineMaster");
      resetForm(); renderMachineList();
    }else{
      const text = await res.text();
      msg.style.color="red"; msg.textContent="‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+text;
    }
  }catch(e){
    msg.style.color="red"; msg.textContent="‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+e.message;
  }
}

async function editMachine(){
  const code = document.getElementById("machineCode").value.trim();
  const name1 = document.getElementById("machineName1").value.trim();
  const name = document.getElementById("machineName").value.trim();
  const group = document.getElementById("groupCode").value;
  const dept = document.getElementById("deptCode").value;
  const msg = document.getElementById("message");

  if(!code || !name1 || !name || !dept){
    msg.style.color="red"; msg.textContent="‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"; return;
  }

  const payload={ Action:"Edit", Rows:[{
    "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": code,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1": name1,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£": name,
    "GroupCode": group,
    "DeptCode": dept
  }]};

  try{
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
      method:"POST",
      headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
      body:JSON.stringify(payload)
    });
    if(res.ok){
      msg.style.color="green"; msg.textContent="‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
      machinesData = await fetchTable("MachineMaster");
      resetForm(); renderMachineList();
    }else{
      const text = await res.text();
      msg.style.color="red"; msg.textContent="‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+text;
    }
  }catch(e){
    msg.style.color="red"; msg.textContent="‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+e.message;
  }
}

document.getElementById("addBtn").addEventListener("click",addMachine);
document.getElementById("editBtn").addEventListener("click",editMachine);
document.getElementById("searchCode").addEventListener("input",renderMachineList);
document.getElementById("searchNick").addEventListener("input",renderMachineList);
document.getElementById("searchName").addEventListener("input",renderMachineList);
document.getElementById("searchDept").addEventListener("input",renderMachineList);

async function init(){
  await loadDropdowns();
  machinesData = await fetchTable("MachineMaster");
  // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  renderMachineList();
}

init();
</script>
</body>
</html>
