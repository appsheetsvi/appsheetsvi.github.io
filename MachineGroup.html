<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MachineMaster</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.autocomplete-suggestions { 
  position:absolute; 
  z-index:50; 
  background:white; 
  border:1px solid #93c5fd; 
  border-radius:0.5rem; 
  max-height:200px; 
  overflow-y:auto; 
  width:100%;
}
.autocomplete-suggestion:hover { background:#e0f2fe; cursor:pointer; }
.table-container { max-height:400px; overflow-y:auto; }
</style>
</head>
<body class="bg-gray-100 font-sans p-4">

<h1 class="text-3xl font-bold text-blue-700 text-center mb-6">üì¶ MachineMaster</h1>

<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">
  <!-- Form -->
  <form id="machineForm" class="space-y-4" onsubmit="return false;">
    <div class="relative">
      <label class="block font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</label>
      <input type="text" id="machineSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="w-full border-2 border-blue-300 rounded-md p-2"/>
      <div id="suggestions" class="autocomplete-suggestions"></div>
    </div>

    <label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
    <input type="text" id="machineCode" class="w-full border-2 border-blue-300 rounded-md p-2" required />

    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</label>
    <input type="text" id="machineName1" class="w-full border-2 border-blue-300 rounded-md p-2" required />

    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</label>
    <input type="text" id="machineName" class="w-full border-2 border-blue-300 rounded-md p-2" required />

    <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
    <select id="deptCode" class="w-full border-2 border-blue-300 rounded-md p-2" required></select>

    <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM) 
      <a href="https://appsheetsvi.github.io/MachineGroup1.html" target="_blank" class="ml-2 text-blue-600 hover:text-blue-800 font-bold">üóÇÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°</a>
    </label>
    <select id="groupCode" class="w-full border-2 border-blue-300 rounded-md p-2"></select>

    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
    <select id="status" class="w-full border-2 border-blue-300 rounded-md p-2">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
      <option value="‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
      <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
    </select>

    <div class="flex gap-2">
      <button id="addBtn" type="button" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-md flex-1">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <button id="editBtn" type="button" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md flex-1 hidden">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
    <div id="message" class="text-center font-semibold mt-2"></div>
  </form>

  <!-- Search -->
  <div class="my-4">
    <input type="text" id="searchAll" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå..." class="w-full border-2 border-blue-300 rounded-md p-2"/>
  </div>

  <!-- Table -->
  <div class="table-container border rounded-lg shadow">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-blue-600 text-white sticky top-0">
        <tr>
          <th class="px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
          <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</th>
          <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
          <th class="px-4 py-2 text-left">‡πÅ‡∏ú‡∏ô‡∏Å</th>
          <th class="px-4 py-2 text-left">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM)</th>
          <th class="px-4 py-2 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody id="machineListTable" class="bg-white divide-y divide-gray-200">
        <tr><td colspan="6" class="text-center py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const appId="ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey="V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
const currentEmp = localStorage.getItem("EmpCode") || "EMP001";

let machinesData=[], groupsData=[], deptsData=[];

// ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
async function fetchTable(tableName){
  const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Find`,{
    method:"POST",
    headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
    body:JSON.stringify({})
  });
  return res.json();
}

// ‡πÇ‡∏´‡∏•‡∏î dropdown ‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
async function loadDropdowns(){
  deptsData = await fetchTable("Department");
  groupsData = await fetchTable("MachineGroup");

  const deptSelect = document.getElementById("deptCode");
  deptSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
  deptsData.forEach(d=>{
    const opt = document.createElement("option");
    opt.value=d.DeptCode;
    opt.textContent=`${d.DeptCode} : ${d.DeptNameEng}`;
    deptSelect.appendChild(opt);
  });

  const groupSelect = document.getElementById("groupCode");
  groupSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>';
  groupsData.forEach(g=>{
    const opt = document.createElement("option");
    opt.value=g.GroupCode;
    opt.textContent=g.GroupName;
    groupSelect.appendChild(opt);
  });
}

// Render Table
function renderMachineList(){
  const tbody = document.getElementById("machineListTable");
  tbody.innerHTML="";
  const filter = document.getElementById("searchAll").value.toLowerCase();
  if(!filter){ tbody.innerHTML=`<tr><td colspan="6" class="text-center py-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }

  const filtered = machinesData.filter(m=>{
    const deptText = deptsData.find(d=>d.DeptCode===m.DeptCode);
    const str = `${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]||""} ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||""} ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]||""} ${m.DeptCode}:${deptText?deptText.DeptNameEng:""} ${m.GroupCode||""} ${m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||""}`.toLowerCase();
    return str.includes(filter);
  });

  if(filtered.length===0){ tbody.innerHTML=`<tr><td colspan="6" class="text-center py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return;}

  filtered.forEach(m=>{
    const tr = document.createElement("tr");
    const deptText = deptsData.find(d=>d.DeptCode===m.DeptCode);
    tr.innerHTML=`<td class="px-4 py-2">${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]||""}</td>
      <td class="px-4 py-2">${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||""}</td>
      <td class="px-4 py-2">${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]||""}</td>
      <td class="px-4 py-2">${deptText?deptText.DeptNameEng:""}</td>
      <td class="px-4 py-2">${groupsData.find(g=>g.GroupCode===m.GroupCode)?.GroupName||""}</td>
      <td class="px-4 py-2 ${m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞==='‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'?'text-red-600 font-bold':'text-green-600 font-bold'}">${m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||""}</td>`;
    tr.addEventListener("click",()=>fillMachineForm(m));
    tbody.appendChild(tr);
  });
}

// Fill form
function fillMachineForm(m){
  document.getElementById("machineSearch").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
  document.getElementById("machineCode").value=m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
  document.getElementById("machineName1").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
  document.getElementById("machineName").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"];
  document.getElementById("deptCode").value=m.DeptCode;
  document.getElementById("groupCode").value=m.GroupCode;
  document.getElementById("status").value=m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||"";
  document.getElementById("addBtn").classList.add("hidden");
  document.getElementById("editBtn").classList.remove("hidden");
}

// Add / Edit
async function addMachine(){
  const code=document.getElementById("machineCode").value.trim();
  const nick=document.getElementById("machineName1").value.trim();
  const name=document.getElementById("machineName").value.trim();
  const dept=document.getElementById("deptCode").value;
  const group=document.getElementById("groupCode").value;
  const status=document.getElementById("status").value;
  const msg=document.getElementById("message");
  if(!code||!nick||!name||!dept){ msg.style.color="red"; msg.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"; return; }

  const payload={ Action:"Add", Rows:[{
    "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": code,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1": nick,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£": name,
    "DeptCode": dept,
    "GroupCode": group,
    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": status,
    "CreatedBy": currentEmp
  }]};

  try{
    const res=await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify(payload)
    });
    if(res.ok){ 
      msg.style.color="green"; msg.textContent="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; 
      machinesData=await fetchTable("MachineMaster"); renderMachineList(); 
      document.getElementById("machineForm").reset(); 
      document.getElementById("addBtn").classList.remove("hidden"); 
      document.getElementById("editBtn").classList.add("hidden"); 
    }
    else{ msg.style.color="red"; msg.textContent="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; }
  }catch(e){ msg.style.color="red"; msg.textContent=e.message; }
}

async function editMachine(){
  const code=document.getElementById("machineCode").value.trim();
  const nick=document.getElementById("machineName1").value.trim();
  const name=document.getElementById("machineName").value.trim();
  const dept=document.getElementById("deptCode").value;
  const group=document.getElementById("groupCode").value;
  const status=document.getElementById("status").value;
  const msg=document.getElementById("message");
  if(!code){ msg.style.color="red"; msg.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"; return; }

  const payload={ Action:"Edit", Rows:[{
    "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": code,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1": nick,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£": name,
    "DeptCode": dept,
    "GroupCode": group,
    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": status,
    "ModifiedBy": currentEmp
  }]};

  try{
    const res=await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify(payload)
    });
    if(res.ok){ 
      msg.style.color="green"; msg.textContent="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; 
      machinesData=await fetchTable("MachineMaster"); renderMachineList(); 
      document.getElementById("machineForm").reset(); 
      document.getElementById("addBtn").classList.remove("hidden"); 
      document.getElementById("editBtn").classList.add("hidden"); 
    }
    else{ msg.style.color="red"; msg.textContent="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; }
  }catch(e){ msg.style.color="red"; msg.textContent=e.message; }
}

// Autocomplete
document.getElementById("machineSearch").addEventListener("input", function(){
  const val = this.value.toLowerCase();
  const suggestions = document.getElementById("suggestions");
  suggestions.innerHTML = "";
  if(!val){ suggestions.style.display="none"; return; }

  const matches = machinesData.filter(m => m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"].toLowerCase().includes(val)).slice(0,10);
  matches.forEach(m=>{
    const div = document.createElement("div");
    div.className="autocomplete-suggestion";
    div.textContent = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
    div.addEventListener("click", ()=>{
      // Auto-fill all fields
      document.getElementById("machineSearch").value = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
      document.getElementById("machineCode").value = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      document.getElementById("machineName1").value = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
      document.getElementById("machineName").value = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"];
      document.getElementById("deptCode").value = m.DeptCode;
      document.getElementById("groupCode").value = m.GroupCode;
      document.getElementById("status").value = m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||"";
      document.getElementById("addBtn").classList.add("hidden");
      document.getElementById("editBtn").classList.remove("hidden");
      suggestions.style.display="none";
    });
    suggestions.appendChild(div);
  });
  suggestions.style.display = matches.length ? "block" : "none";
});

// Search all columns
document.getElementById("searchAll").addEventListener("input", renderMachineList);

// Event buttons
document.getElementById("addBtn").addEventListener("click", addMachine);
document.getElementById("editBtn").addEventListener("click", editMachine);

// Init
(async()=>{
  machinesData = await fetchTable("MachineMaster");
  await loadDropdowns();
  renderMachineList();
})();
</script>
</body>
</html>
