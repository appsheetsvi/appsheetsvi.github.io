<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MachineGroup Full</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
body { font-family:'Kanit', sans-serif; background:#f0f4ff; }
.tag { background:#3b82f6; color:white; padding:2px 6px; margin:2px; border-radius:5px; display:inline-flex; align-items:center; cursor:move; }
.tag button { margin-left:4px; font-weight:bold; background:none; border:none; color:white; cursor:pointer; }
.autocomplete-suggestions { position:absolute; background:#fff; border:1px solid #93c5fd; border-radius:6px; max-height:150px; overflow-y:auto; z-index:10; display:none; width:100%; }
.autocomplete-suggestion { padding:0.5rem; cursor:pointer; }
.autocomplete-suggestion:hover { background:#e0f2fe; }
.table-container { overflow-x:auto; }
.success-msg { font-size:1.5rem; color:#16a34a; font-weight:bold; text-align:center; margin-top:0.5rem; }
.search-icon { position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#3b82f6; }
.groupcode-label { display:inline-block; background:#3b82f6; color:white; padding:2px 6px; border-radius:4px; font-weight:bold; }
</style>
</head>
<body class="p-4">
<nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
<a href="https://appsheetsvi.github.io/Menu.html" class="font-semibold">üè† Home</a>
<div class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
</nav>

<h1 class="text-2xl font-bold text-center text-blue-800 mb-6">MachineGroup</h1>

<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏° -->
<div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-6">
  <form id="groupForm" onsubmit="return false;">
    <div class="mb-4">
      <label class="font-semibold text-gray-700">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ MachineGroup</label>
      <input type="text" id="searchGroupPM" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°..." class="w-full border-2 border-blue-300 rounded px-2 py-1">
      <div id="searchGroupPMSuggestions" class="autocomplete-suggestions"></div>
    </div>

    <div class="mb-4">
      <label class="font-semibold text-gray-700">GroupCode</label>
      <div id="gGroupCode" class="groupcode-label">---</div>
    </div>
    <div class="mb-4">
      <label class="font-semibold">GroupName</label>
      <input type="text" id="gGroupName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°..." class="w-full border-2 border-blue-300 rounded px-2 py-1">
    </div>
    <div class="mb-4">
      <label class="font-semibold">DeptCode</label>
      <select id="gDeptCode" required class="w-full border-2 border-blue-300 rounded px-2 py-1"></select>
    </div>
    <div class="mb-4">
      <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
      <textarea id="gProblemDetail" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢..." class="w-full border-2 border-blue-300 rounded px-2 py-1"></textarea>
    </div>
    <div class="mb-4">
      <label class="font-semibold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea id="gCauseAnalysis" placeholder="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏..." class="w-full border-2 border-blue-300 rounded px-2 py-1"></textarea>
    </div>
    <div class="mb-4">
      <label class="font-semibold">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
      <textarea id="gComment" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..." class="w-full border-2 border-blue-300 rounded px-2 py-1"></textarea>
    </div>
    <div class="mb-4">
      <label class="font-semibold">PmTime (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
      <input type="number" id="gPmTime" min="0" placeholder="0" class="w-full border-2 border-blue-300 rounded px-2 py-1">
    </div>

    <div class="mb-4 relative">
      <label class="font-semibold">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
      <input type="text" id="machineInput" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£..." class="w-full border-2 border-blue-300 rounded px-2 py-1">
      <div id="machineSuggestions" class="autocomplete-suggestions"></div>
      <div id="groupMachines" class="mt-2 flex flex-wrap"></div>
    </div>

    <div class="flex gap-2 mb-2">
      <button id="groupAddBtn" type="button" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
      <button id="groupEditBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hidden">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
      <button id="groupCancelBtn" type="button" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
    <div id="groupMsg" class="success-msg hidden">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
  </form>
</div>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
<div class="max-w-5xl mx-auto bg-white p-4 rounded-xl shadow-lg table-container">
  <h2 class="text-xl font-semibold mb-2">MachineGroup(PM)</h2>
  <input type="text" id="searchAll" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå..." class="w-full border-2 border-blue-300 rounded px-2 py-1 mb-2">
  <table id="groupTable" class="min-w-full table-auto border border-gray-300">
    <thead>
      <tr class="bg-blue-100">
        <th class="border px-2 py-1">#</th>
        <th class="border px-2 py-1">GroupCode</th>
        <th class="border px-2 py-1">GroupName(PM)</th>
        <th class="border px-2 py-1">DeptNameEng</th>
        <th class="border px-2 py-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</th>
        <th class="border px-2 py-1">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</th>
        <th class="border px-2 py-1">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</th>
        <th class="border px-2 py-1">PmTime</th>
        <th class="border px-2 py-1">Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const appId="ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey="V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
const currentEmp = localStorage.getItem("EmpCode") || "EMP001";

let machinesData=[], groupsData=[], deptsData=[], selectedMachines=[], editRow=null;

// Fetch Table
async function fetchTable(tableName){
  try{
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Find`,{
      method:"POST",
      headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
      body: JSON.stringify({})
    });
    const text = await res.text();
    return text ? JSON.parse(text) : [];
  } catch(e){ console.error(tableName+" fetch error:", e); return []; }
}

// Load Dropdowns
async function loadDropdowns(){
  deptsData = await fetchTable("Department");
  const deptSelect = document.getElementById("gDeptCode");
  deptSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
  deptsData.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = d.DeptCode;
    opt.textContent = `${d.DeptCode} : ${d.DeptNameEng || d.DeptName || d.DeptCode}`;
    deptSelect.appendChild(opt);
  });
}

// Generate GroupCode
async function generateGroupCode(){
  groupsData = await fetchTable("MachineGroup");
  const date = new Date();
  const yyyy = date.getFullYear();
  const mm = (date.getMonth()+1).toString().padStart(2,'0');
  let max=0;
  groupsData.forEach(g=>{
    if(g.GroupCode?.startsWith(`${yyyy}${mm}`)){
      const n=parseInt(g.GroupCode.slice(-3));
      if(n>max) max=n;
    }
  });
  document.getElementById("gGroupCode").textContent = `${yyyy}${mm}${(max+1).toString().padStart(3,'0')}`;
}

// Render Selected Machines
function renderSelectedMachines(){
  const container = document.getElementById("groupMachines");
  container.innerHTML="";
  selectedMachines.forEach(m=>{
    const div=document.createElement("div");
    div.className="tag";
    div.draggable=true;
    div.innerHTML=`<span>${m}</span><button type="button">&times;</button>`;
    div.querySelector("button").addEventListener("click",()=>{
      selectedMachines = selectedMachines.filter(x=>x!==m);
      renderSelectedMachines();
    });
    container.appendChild(div);
  });
}

// Auto-complete Machines
document.getElementById("machineInput").addEventListener("input",()=>{
  const val = document.getElementById("machineInput").value.toLowerCase();
  const dept = document.getElementById("gDeptCode").value;
  const suggDiv = document.getElementById("machineSuggestions");
  if(!val || !dept){ suggDiv.style.display="none"; return;}
  const filtered = machinesData.filter(m=>m.DeptCode===dept && m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]?.toLowerCase().includes(val));
  suggDiv.innerHTML="";
  filtered.forEach(m=>{
    const div=document.createElement("div");
    div.className="autocomplete-suggestion";
    div.textContent = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
    div.addEventListener("click",()=>{
      if(!selectedMachines.includes(m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"])){
        selectedMachines.push(m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]);
        renderSelectedMachines();
      }
      document.getElementById("machineInput").value="";
      suggDiv.style.display="none";
    });
    suggDiv.appendChild(div);
  });
  suggDiv.style.display = filtered.length>0?"block":"none";
});

// Search GroupName PM
document.getElementById("searchGroupPM").addEventListener("input",()=>{
  const val = document.getElementById("searchGroupPM").value.toLowerCase();
  const suggDiv = document.getElementById("searchGroupPMSuggestions");
  if(!val){ suggDiv.style.display="none"; return;}
  const filtered = groupsData.filter(g=>g.GroupName?.toLowerCase().includes(val));
  suggDiv.innerHTML="";
  filtered.forEach(g=>{
    const div=document.createElement("div");
    div.className="autocomplete-suggestion";
    div.textContent = g.GroupName;
    div.addEventListener("click",()=>{
      document.getElementById("gGroupCode").textContent = g.GroupCode;
      document.getElementById("gGroupName").value = g.GroupName;
      document.getElementById("gDeptCode").value = g.DeptCode;
      document.getElementById("gProblemDetail").value = g["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
      document.getElementById("gCauseAnalysis").value = g["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || "";
      document.getElementById("gComment").value = g["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "";
      document.getElementById("gPmTime").value = g["PmTime"] || 0;
      selectedMachines = machinesData.filter(m=>m.GroupCode===g.GroupCode).map(m=>m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]);
      renderSelectedMachines();
      editRow = g;
      document.getElementById("groupAddBtn").classList.add("hidden");
      document.getElementById("groupEditBtn").classList.remove("hidden");
      document.getElementById("groupCancelBtn").classList.remove("hidden");
      suggDiv.style.display="none";
    });
    suggDiv.appendChild(div);
  });
  suggDiv.style.display = filtered.length>0?"block":"none";
});

// Render Group Table
function renderGroupTable(){
  const tbody = document.querySelector("#groupTable tbody");
  tbody.innerHTML="";
  groupsData.forEach((g,index)=>{
    const tr=document.createElement("tr");
    const dept = deptsData.find(d=>d.DeptCode===g.DeptCode);
    const deptNameEng = dept?.DeptNameEng || g.DeptCode;
    tr.innerHTML = `
      <td class="border px-2 py-1">${index+1}</td>
      <td class="border px-2 py-1">${g.GroupCode}</td>
      <td class="border px-2 py-1">${g.GroupName}</td>
      <td class="border px-2 py-1">${deptNameEng}</td>
      <td class="border px-2 py-1">${g["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || ""}</td>
      <td class="border px-2 py-1">${g["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || ""}</td>
      <td class="border px-2 py-1">${g["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || ""}</td>
      <td class="border px-2 py-1">${g["PmTime"] || 0}</td>
      <td class="border px-2 py-1">
        <button class="bg-green-600 text-white px-2 py-1 rounded editBtn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </td>`;
    tr.querySelector(".editBtn").addEventListener("click",()=>{
      document.getElementById("gGroupCode").textContent = g.GroupCode;
      document.getElementById("gGroupName").value = g.GroupName;
      document.getElementById("gDeptCode").value = g.DeptCode;
      document.getElementById("gProblemDetail").value = g["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "";
      document.getElementById("gCauseAnalysis").value = g["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || "";
      document.getElementById("gComment").value = g["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "";
      document.getElementById("gPmTime").value = g["PmTime"] || 0;
      selectedMachines = machinesData.filter(m=>m.GroupCode===g.GroupCode).map(m=>m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]);
      renderSelectedMachines();
      editRow = g;
      document.getElementById("groupAddBtn").classList.add("hidden");
      document.getElementById("groupEditBtn").classList.remove("hidden");
      document.getElementById("groupCancelBtn").classList.remove("hidden");
    });
    tbody.appendChild(tr);
  });
}

// Reset Form
function resetForm(){
  document.getElementById("groupForm").reset();
  document.getElementById("gProblemDetail").value="";
  document.getElementById("gCauseAnalysis").value="";
  document.getElementById("gComment").value="";
  document.getElementById("gPmTime").value="";
  selectedMachines=[];
  renderSelectedMachines();
  editRow=null;
  document.getElementById("groupAddBtn").classList.remove("hidden");
  document.getElementById("groupEditBtn").classList.add("hidden");
  document.getElementById("groupCancelBtn").classList.add("hidden");
  generateGroupCode();
  document.getElementById("groupMsg").classList.add("hidden");
}

// Show Success Message
function showSuccess(){
  const msg = document.getElementById("groupMsg");
  msg.classList.remove("hidden");
  setTimeout(()=>msg.classList.add("hidden"),3000);
}

// Add / Edit
async function addOrEditMachineGroup(isEdit=false){
  const gCode = document.getElementById("gGroupCode").textContent.trim();
  const gName = document.getElementById("gGroupName").value.trim();
  const gDept = document.getElementById("gDeptCode").value.trim();
  const problem = document.getElementById("gProblemDetail").value.trim();
  const cause = document.getElementById("gCauseAnalysis").value.trim();
  const comment = document.getElementById("gComment").value.trim();
  const pmTime = parseInt(document.getElementById("gPmTime").value)||0;

  if(!gCode || !gName || !gDept){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á"); return; }

  const timestamp = new Date().toISOString();
  const groupObj = {
    GroupCode: gCode,
    GroupName: gName,
    DeptCode: gDept,
    "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": problem,
    "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": cause,
    "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": comment,
    "PmTime": pmTime,
    ModifiedBy: currentEmp,
    ModifiedDate: timestamp
  };

  const action = isEdit?"Edit":"Add";
  if(!isEdit){
    groupObj.CreatedBy = currentEmp;
    groupObj.CreatedDate = timestamp;
  }

  try{
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineGroup/Action`,{
      method:"POST",
      headers:{ "Content-Type":"application/json","ApplicationAccessKey": apiKey },
      body: JSON.stringify({Action:action, Rows:[groupObj]})
    });
    const result = await res.json();
    console.log(action+" result:", result);
    if(result?.Rows && result.Rows.length>0){
      if(isEdit){
        const idx = groupsData.findIndex(g=>g.GroupCode===gCode);
        if(idx>=0) groupsData[idx] = {...groupsData[idx], ...groupObj};
      } else {
        groupsData.push(groupObj);
      }

      // Update machines
      for(const mName of selectedMachines){
        const machine = machinesData.find(m=>m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]===mName);
        if(machine){
          await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
            method:"POST",
            headers:{ "Content-Type":"application/json","ApplicationAccessKey": apiKey },
            body:JSON.stringify({ Action:"Edit", Rows:[{"‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á":machine["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"], "GroupCode":gCode}] })
          });
          machine.GroupCode=gCode;
        }
      }
      renderGroupTable();
      resetForm();
      showSuccess();
    } else {
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å MachineGroup ‡πÑ‡∏î‡πâ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå required ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå");
    }
  } catch(err){ console.error(action+" MachineGroup error:", err); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
}

// Event Listeners
document.getElementById("groupAddBtn").addEventListener("click", ()=>addOrEditMachineGroup(false));
document.getElementById("groupEditBtn").addEventListener("click", ()=>addOrEditMachineGroup(true));
document.getElementById("groupCancelBtn").addEventListener("click", resetForm);

// Search Table All Columns
document.getElementById("searchAll").addEventListener("input",()=>{
  const val = document.getElementById("searchAll").value.toLowerCase();
  const tbody = document.querySelector("#groupTable tbody");
  Array.from(tbody.rows).forEach(r=>{
    r.style.display = Array.from(r.cells).some(td=>td.textContent.toLowerCase().includes(val))?"":"none";
  });
});

// Initial Load
(async()=>{
  machinesData = await fetchTable("MachineMaster");
  await loadDropdowns();
  await generateGroupCode();
  groupsData = await fetchTable("MachineGroup");
  renderGroupTable();
})();
</script>
</body>
</html>
