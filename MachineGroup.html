<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MachineMaster + MachineGroup</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
<style>
body { font-family:'Kanit', sans-serif; background:#f0f4ff; margin:0; padding:1rem; color:#222; }
h1 { text-align:center; color:#1d4ed8; margin-bottom:1rem; }
/* Tabs */
.tabs { display:flex; justify-content:center; margin-bottom:1rem; gap:1rem; }
.tab { padding:0.5rem 1rem; cursor:pointer; border-radius:6px; background:#93c5fd; color:#fff; font-weight:bold; }
.tab.active { background:#2563eb; }
/* Tab content */
.tab-content { display:none; max-width:1000px; margin:auto; }
.tab-content.active { display:block; }
/* Form & Table style */
form { max-width:600px; margin:auto; background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:1rem; }
label { display:block; margin:0.8rem 0 0.3rem; font-weight:bold; font-size:0.9rem; }
input, select, button { width:100%; padding:0.5rem; border:1.5px solid #93c5fd; border-radius:6px; font-size:0.9rem; box-sizing:border-box; }
button { margin-top:1rem; font-weight:bold; cursor:pointer; color:white; border:none; border-radius:6px; }
#addBtn,#groupAddBtn { background:#2563eb; } 
#addBtn:hover,#groupAddBtn:hover { background:#1e40af; }
#editBtn,#groupEditBtn { background:#f59e0b; display:none;} 
#editBtn:hover,#groupEditBtn:hover { background:#b45309; }
.msg { text-align:center; font-weight:bold; margin-top:0.8rem; font-size:0.9rem; }
/* Table */
#machineListTable, #groupListTable { width:100%; border-collapse:collapse; font-size:0.85rem; margin-bottom:1rem;}
thead { background:#2563eb; color:white; }
th, td { padding:0.5rem; border:1px solid #ddd; text-align:left; }
tbody tr:hover { background:#f0f4ff; cursor:pointer; }
.search-row { display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.5rem; }
.search-row input { flex:1; font-size:0.85rem; padding:0.4rem; }
/* Autocomplete */
.autocomplete-wrapper { position:relative; margin-bottom:1rem; }
.autocomplete-input { width:100%; padding:0.5rem; border:1.5px solid #93c5fd; border-radius:6px; font-size:0.9rem; }
.autocomplete-suggestions { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #93c5fd; border-radius:6px; max-height:150px; overflow-y:auto; z-index:10; display:none; }
.autocomplete-suggestion { padding:0.5rem; cursor:pointer; }
.autocomplete-suggestion:hover { background:#e0f2fe; }
@media(max-width:700px){
  table, thead, tbody, th, td, tr { display:block; }
  thead tr { display:none; }
  tbody tr { margin-bottom:0.5rem; border:1px solid #ccc; border-radius:6px; padding:0.3rem; }
  tbody td { border:none; padding:0.3rem 0.5rem; position:relative; padding-left:50%; text-align:left; }
  tbody td::before { position:absolute; top:0.3rem; left:0.5rem; width:45%; white-space:nowrap; font-weight:bold; content:attr(data-label); font-size:0.8rem; }
}
</style>
</head>
<body>
<h1>üì¶ MachineMaster + MachineGroup</h1>

<div class="tabs">
  <div class="tab active" data-tab="machineTab">MachineMaster</div>
  <div class="tab" data-tab="groupTab">MachineGroup</div>
</div>

<!-- MachineMaster Tab -->
<div id="machineTab" class="tab-content active">
  <form id="machineForm" onsubmit="return false;">
    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ NickName -->
    <div class="autocomplete-wrapper">
      <label class="font-semibold text-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</label>
      <input type="text" id="machineSearch" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="autocomplete-input" autocomplete="off"/>
      <div id="suggestions" class="autocomplete-suggestions"></div>
    </div>

    <label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
    <input type="text" id="machineCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" required />

    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</label>
    <input type="text" id="machineName1" required />

    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</label>
    <input type="text" id="machineName" required />

    <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
    <select id="deptCode" required></select>

    <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM)</label>
    <select id="groupCode"></select>

    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
    <select id="status">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
      <option value="‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
      <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
    </select>

    <button id="addBtn" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    <button id="editBtn" type="button">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    <div class="msg" id="message"></div>
  </form>

  <div class="search-row">
    <input type="text" id="searchAll" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå">
  </div>
  <table id="machineListTable">
    <thead>
      <tr>
        <th>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
        <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
        <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM)</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="6" style="text-align:center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
    </tbody>
  </table>
</div>

<!-- MachineGroup Tab -->
<div id="groupTab" class="tab-content">
  <form id="groupForm" onsubmit="return false;">
    <label>GroupCode (Auto)</label>
    <input type="text" id="gGroupCode" readonly />

    <label>GroupName</label>
    <input type="text" id="gGroupName" required />

    <label>DeptCode</label>
    <select id="gDeptCode" required></select>

    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
    <input type="text" id="gSymptom" />

    <label>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
    <input type="text" id="gCause" />

    <label>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
    <input type="text" id="gAction" />

    <button id="groupAddBtn" type="button">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    <button id="groupEditBtn" type="button">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    <div class="msg" id="groupMsg"></div>
  </form>

  <div class="search-row">
    <input type="text" id="searchGroup" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå">
  </div>
  <table id="groupListTable">
    <thead>
      <tr>
        <th>GroupCode</th>
        <th>GroupName</th>
        <th>DeptCode</th>
        <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</th>
        <th>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</th>
        <th>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="6" style="text-align:center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
    </tbody>
  </table>
</div>

<script>
const appId="ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey="V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
const currentEmp = localStorage.getItem("EmpCode") || "EMP001";

let machinesData=[], groupsData=[], deptsData=[];

// ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
async function fetchTable(tableName){
  const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Find`,{
    method:"POST",
    headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
    body:JSON.stringify({})
  });
  return res.json();
}

// ‡πÇ‡∏´‡∏•‡∏î dropdown ‡πÅ‡∏ú‡∏ô‡∏Å
async function loadDropdowns(){
  deptsData = await fetchTable("Department");
  const deptSelects = [document.getElementById("deptCode"), document.getElementById("gDeptCode")];
  deptSelects.forEach(sel=>{
    sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
    deptsData.forEach(d=>{
      const opt = document.createElement("option");
      opt.value = d.DeptCode;
      opt.textContent = `${d.DeptCode} : ${d.DeptNameEng}`;
      sel.appendChild(opt);
    });
  });
}

// --- MachineMaster ---
function renderMachineList(){
  const tbody = document.querySelector("#machineListTable tbody");
  tbody.innerHTML="";
  const filter = document.getElementById("searchAll").value.toLowerCase();
  if(!filter){ tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return;}
  const filtered = machinesData.filter(m=>{
    const deptText = deptsData.find(d=>d.DeptCode===m.DeptCode);
    const str = `${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]||""} ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||""} ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]||""} ${m.DeptCode}:${deptText?deptText.DeptNameEng:""} ${m.GroupCode||""} ${m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||""}`.toLowerCase();
    return str.includes(filter);
  });
  if(filtered.length===0){ tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>`; return;}
  filtered.forEach(m=>{
    const tr = document.createElement("tr");
    const deptText = deptsData.find(d=>d.DeptCode===m.DeptCode);
    tr.innerHTML=`<td data-label="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]||""}</td>
      <td data-label="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)">${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||""}</td>
      <td data-label="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£">${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]||""}</td>
      <td data-label="‡πÅ‡∏ú‡∏ô‡∏Å">${deptText?deptText.DeptNameEng:""}</td>
      <td data-label="‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM)">${m.GroupCode||""}</td>
      <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞">${m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||""}</td>`;
    tr.addEventListener("click",()=>fillMachineForm(m));
    tbody.appendChild(tr);
  });
}

function fillMachineForm(m){
  document.getElementById("machineCode").value=m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
  document.getElementById("machineName1").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
  document.getElementById("machineName").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"];
  document.getElementById("deptCode").value=m.DeptCode;
  document.getElementById("groupCode").value=m.GroupCode;
  document.getElementById("status").value=m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||"";
  document.getElementById("addBtn").style.display="none";
  document.getElementById("editBtn").style.display="block";
}

// Add / Edit MachineMaster
async function addMachine(){
  const code=document.getElementById("machineCode").value.trim();
  const nick=document.getElementById("machineName1").value.trim();
  const name=document.getElementById("machineName").value.trim();
  const dept=document.getElementById("deptCode").value;
  const group=document.getElementById("groupCode").value;
  const status=document.getElementById("status").value;
  const msg=document.getElementById("message");
  if(!code||!nick||!name||!dept){ msg.style.color="red"; msg.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"; return; }

  const payload={ Action:"Add", Rows:[{
    "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": code,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1": nick,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£": name,
    "DeptCode": dept,
    "GroupCode": group,
    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": status,
    "CreatedBy": currentEmp
  }]};

  try{
    const res=await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify(payload)
    });
    if(res.ok){ msg.style.color="green"; msg.textContent="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; machinesData=await fetchTable("MachineMaster"); renderMachineList(); document.getElementById("machineForm").reset(); }
    else { msg.style.color="red"; msg.textContent="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; }
  }catch(e){ msg.style.color="red"; msg.textContent=e.message; }
}

async function editMachine(){
  const code=document.getElementById("machineCode").value.trim();
  const nick=document.getElementById("machineName1").value.trim();
  const name=document.getElementById("machineName").value.trim();
  const dept=document.getElementById("deptCode").value;
  const group=document.getElementById("groupCode").value;
  const status=document.getElementById("status").value;
  const msg=document.getElementById("message");
  if(!code){ msg.style.color="red"; msg.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"; return; }
  const payload={ Action:"Edit", Rows:[{
    "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": code,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1": nick,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£": name,
    "DeptCode": dept,
    "GroupCode": group,
    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": status,
    "ModifiedBy": currentEmp
  }]};
  try{
    const res=await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify(payload)
    });
    if(res.ok){ msg.style.color="green"; msg.textContent="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; machinesData=await fetchTable("MachineMaster"); renderMachineList(); document.getElementById("machineForm").reset(); document.getElementById("addBtn").style.display="block"; document.getElementById("editBtn").style.display="none"; }
    else { msg.style.color="red"; msg.textContent="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; }
  }catch(e){ msg.style.color="red"; msg.textContent=e.message; }
}

// Autocomplete NickName
document.getElementById("machineSearch").addEventListener("input",()=>{
  const val=document.getElementById("machineSearch").value.toLowerCase();
  const sugg=document.getElementById("suggestions");
  if(!val){ sugg.style.display="none"; return; }
  const filtered=machinesData.filter(m=>m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]?.toLowerCase().includes(val));
  sugg.innerHTML="";
  filtered.forEach(m=>{
    const div=document.createElement("div");
    div.className="autocomplete-suggestion";
    div.textContent=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
    div.addEventListener("click",()=>{
      document.getElementById("machineName1").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
      document.getElementById("machineName").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"];
      document.getElementById("machineCode").value=m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      document.getElementById("deptCode").value=m.DeptCode;
      document.getElementById("groupCode").value=m.GroupCode;
      document.getElementById("status").value=m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||"";
      sugg.style.display="none";
      document.getElementById("addBtn").style.display="none";
      document.getElementById("editBtn").style.display="block";
    });
    sugg.appendChild(div);
  });
  sugg.style.display=filtered.length>0?"block":"none";
});

// --- MachineGroup ---
function renderGroupList(){
  const tbody=document.querySelector("#groupListTable tbody");
  tbody.innerHTML="";
  const filter=document.getElementById("searchGroup").value.toLowerCase();
  if(!filter){ tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return;}
  const filtered=groupsData.filter(g=>{
    return `${g.GroupCode||""} ${g.GroupName||""} ${g.DeptCode||""} ${g["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"]||""} ${g["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"]||""} ${g["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"]||""}`.toLowerCase().includes(filter);
  });
  if(filtered.length===0){ tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return;}
  filtered.forEach(g=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td data-label="GroupCode">${g.GroupCode||""}</td>
      <td data-label="GroupName">${g.GroupName||""}</td>
      <td data-label="DeptCode">${g.DeptCode||""}</td>
      <td data-label="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢">${g["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"]||""}</td>
      <td data-label="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏">${g["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"]||""}</td>
      <td data-label="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô">${g["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"]||""}</td>`;
    tr.addEventListener("click",()=>fillGroupForm(g));
    tbody.appendChild(tr);
  });
}

function fillGroupForm(g){
  document.getElementById("gGroupCode").value=g.GroupCode;
  document.getElementById("gGroupName").value=g.GroupName;
  document.getElementById("gDeptCode").value=g.DeptCode;
  document.getElementById("gSymptom").value=g["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"];
  document.getElementById("gCause").value=g["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"];
  document.getElementById("gAction").value=g["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"];
  document.getElementById("groupAddBtn").style.display="none";
  document.getElementById("groupEditBtn").style.display="block";
}

async function addGroup(){
  const code=document.getElementById("gGroupCode").value.trim();
  const name=document.getElementById("gGroupName").value.trim();
  const dept=document.getElementById("gDeptCode").value;
  const symptom=document.getElementById("gSymptom").value.trim();
  const cause=document.getElementById("gCause").value.trim();
  const action=document.getElementById("gAction").value.trim();
  const msg=document.getElementById("groupMsg");
  if(!code||!name||!dept){ msg.style.color="red"; msg.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"; return;}

  const payload={ Action:"Add", Rows:[{
    "GroupCode": code,
    "GroupName": name,
    "DeptCode": dept,
    "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": symptom,
    "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": cause,
    "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": action,
    "CreatedBy": currentEmp
  }]};

  try{
    const res=await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineGroup/Action`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify(payload)
    });
    if(res.ok){ msg.style.color="green"; msg.textContent="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; groupsData=await fetchTable("MachineGroup"); renderGroupList(); document.getElementById("groupForm").reset(); generateGroupCode(); document.getElementById("groupAddBtn").style.display="block"; document.getElementById("groupEditBtn").style.display="none";}
    else{ const t=await res.text(); msg.style.color="red"; msg.textContent="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:"+t; }
  }catch(e){ msg.style.color="red"; msg.textContent=e.message; }
}

async function editGroup(){
  const code=document.getElementById("gGroupCode").value.trim();
  const name=document.getElementById("gGroupName").value.trim();
  const dept=document.getElementById("gDeptCode").value;
  const symptom=document.getElementById("gSymptom").value.trim();
  const cause=document.getElementById("gCause").value.trim();
  const action=document.getElementById("gAction").value.trim();
  const msg=document.getElementById("groupMsg");
  if(!code){ msg.style.color="red"; msg.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å GroupCode"; return;}
  const payload={ Action:"Edit", Rows:[{
    "GroupCode": code,
    "GroupName": name,
    "DeptCode": dept,
    "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": symptom,
    "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": cause,
    "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": action,
    "ModifiedBy": currentEmp
  }]};

  try{
    const res=await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineGroup/Action`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify(payload)
    });
    if(res.ok){ msg.style.color="green"; msg.textContent="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; groupsData=await fetchTable("MachineGroup"); renderGroupList(); document.getElementById("groupForm").reset(); generateGroupCode(); document.getElementById("groupAddBtn").style.display="block"; document.getElementById("groupEditBtn").style.display="none";}
    else{ const t=await res.text(); msg.style.color="red"; msg.textContent="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:"+t;}
  }catch(e){ msg.style.color="red"; msg.textContent=e.message;}
}

// GroupCode Auto
async function generateGroupCode(){
  groupsData=await fetchTable("MachineGroup");
  const date = new Date();
  const yy = (date.getFullYear()+543).toString().slice(-2);
  const mm = (date.getMonth()+1).toString().padStart(2,'0');
  let max=0;
  groupsData.forEach(g=>{
    const n=parseInt(g.GroupCode?.slice(-3));
    if(n>max) max=n;
  });
  document.getElementById("gGroupCode").value=`PM${yy}${mm}${(max+1).toString().padStart(3,'0')}`;
}

// Tab switching
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// Event Listeners
document.getElementById("addBtn").addEventListener("click",addMachine);
document.getElementById("editBtn").addEventListener("click",editMachine);
document.getElementById("groupAddBtn").addEventListener("click",addGroup);
document.getElementById("groupEditBtn").addEventListener("click",editGroup);
document.getElementById("searchAll").addEventListener("input",renderMachineList);
document.getElementById("searchGroup").addEventListener("input",renderGroupList);

// Init
(async()=>{
  await loadDropdowns();
  machinesData=await fetchTable("MachineMaster");
  groupsData=await fetchTable("MachineGroup");
  renderMachineList();
  renderGroupList();
  generateGroupCode();
})();
</script>
</body>
</html>
