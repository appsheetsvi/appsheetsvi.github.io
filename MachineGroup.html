<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> MachineGroup Full</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
body { font-family:'Kanit', sans-serif; background:#f0f4ff; }
.tag { background:#3b82f6; color:white; padding:2px 6px; margin:2px; border-radius:5px; display:inline-flex; align-items:center; cursor:move; }
.tag button { margin-left:4px; font-weight:bold; background:none; border:none; color:white; cursor:pointer; }
.autocomplete-suggestions { position:absolute; background:#fff; border:1px solid #93c5fd; border-radius:6px; max-height:150px; overflow-y:auto; z-index:10; display:none; width:100%; }
.autocomplete-suggestion { padding:0.5rem; cursor:pointer; }
.autocomplete-suggestion:hover { background:#e0f2fe; }
.table-container { overflow-x:auto; }
.success-msg { font-size:1.5rem; color:#16a34a; font-weight:bold; text-align:center; margin-top:0.5rem; }
.search-icon { position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#3b82f6; }
.groupcode-label { display:inline-block; background:#3b82f6; color:white; padding:2px 6px; border-radius:4px; font-weight:bold; }
</style>
</head>
<body class="p-4">
 <div> 
<nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
<a href="https://appsheetsvi.github.io/Menu.html" class="font-semibold">üè† Home</a>
<div class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
</div>
</nav>
<h1 class="text-2xl font-bold text-center text-blue-800 mb-6">MachineGroup</h1>

<!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ GroupName PM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ -->
<div class="max-w-3xl mx-auto bg-white p-4 rounded-xl shadow-lg mb-6 relative">
  <label class="font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á(PM)</label>
  <input type="text" id="searchGroupPM" placeholder="üîç‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°..." class="w-full border-2 border-blue-300 rounded px-2 py-1">
  <span class="search-icon">üîç</span>
  <div id="searchGroupPMSuggestions" class="autocomplete-suggestions"></div>
</div>

<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏° -->
<div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-6">
  <form id="groupForm" onsubmit="return false;">
    <div class="mb-4">
      <label class="font-semibold text-gray-700">GroupCode</label>
      <div id="gGroupCode" class="groupcode-label">---</div>
    </div>
    <div class="mb-4">
      <label class="font-semibold">GroupName</label>
      <input type="text" id="gGroupName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°..." class="w-full border-2 border-blue-300 rounded px-2 py-1">
    </div>
    <div class="mb-4">
      <label class="font-semibold">DeptCode</label>
      <select id="gDeptCode" required class="w-full border-2 border-blue-300 rounded px-2 py-1"></select>
    </div>
    <div class="mb-4 relative">
      <label class="font-semibold">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
      <input type="text" id="machineInput" placeholder="üîç‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£..." class="w-full border-2 border-blue-300 rounded px-2 py-1">
      <div id="machineSuggestions" class="autocomplete-suggestions"></div>
      <div id="groupMachines" class="mt-2 flex flex-wrap"></div>
    </div>
    <div class="flex gap-2 mb-2">
      <button id="groupAddBtn" type="button" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
      <button id="groupEditBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hidden">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
      <button id="groupCancelBtn" type="button" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
    <div id="groupMsg" class="success-msg hidden">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
  </form>
</div>

<!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå -->
<div class="max-w-5xl mx-auto mb-2">
  <input type="text" id="searchAll" placeholder="üîç‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå..." class="w-full border-2 border-blue-300 rounded px-2 py-1">
</div>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
<div class="max-w-5xl mx-auto bg-white p-4 rounded-xl shadow-lg table-container">
  <h2 class="text-xl font-semibold mb-2">MachineGroup(PM)</h2>
  <table id="groupTable" class="min-w-full table-auto border border-gray-300">
    <thead>
      <tr class="bg-blue-100">
        <th class="border px-2 py-1">#</th>
        <th class="border px-2 py-1">GroupCode</th>
        <th class="border px-2 py-1">GroupName(PM)</th>
        <th class="border px-2 py-1">DeptNameEng</th>
        <th class="border px-2 py-1">Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const appId="ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey="V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
const currentEmp = localStorage.getItem("EmpCode") || "EMP001";

let machinesData=[], groupsData=[], deptsData=[], selectedMachines=[], editRow=null;

// Fetch Table
async function fetchTable(tableName){
  try{
    const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Find`,{
      method:"POST",
      headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
      body:JSON.stringify({})
    });
    const text = await res.text();
    return text ? JSON.parse(text) : [];
  } catch(e){ console.error(tableName+" fetch error:", e); return []; }
}

// Load Dropdowns
async function loadDropdowns(){
  deptsData = await fetchTable("Department");
  const deptSelect = document.getElementById("gDeptCode");
  deptSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
  deptsData.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = d.DeptCode;
    opt.textContent = `${d.DeptCode} : ${d.DeptNameEng || d.DeptName || d.DeptCode}`;
    deptSelect.appendChild(opt);
  });
}

// Generate GroupCode
async function generateGroupCode(){
  groupsData = await fetchTable("MachineGroup");
  const date = new Date();
  const yyyy = date.getFullYear();
  const mm = (date.getMonth()+1).toString().padStart(2,'0');
  let max=0;
  groupsData.forEach(g=>{
    if(g.GroupCode?.startsWith(`${yyyy}${mm}`)){
      const n=parseInt(g.GroupCode.slice(-3));
      if(n>max) max=n;
    }
  });
  document.getElementById("gGroupCode").textContent = `${yyyy}${mm}${(max+1).toString().padStart(3,'0')}`;
}

// Render Selected Machines
function renderSelectedMachines(){
  const container = document.getElementById("groupMachines");
  container.innerHTML="";
  selectedMachines.forEach(m=>{
    const div=document.createElement("div");
    div.className="tag";
    div.draggable=true;
    div.innerHTML=`<span>${m}</span><button type="button">&times;</button>`;
    div.querySelector("button").addEventListener("click",()=>{
      selectedMachines = selectedMachines.filter(x=>x!==m);
      renderSelectedMachines();
    });
    container.appendChild(div);
  });
}

// Auto-complete Machines
document.getElementById("machineInput").addEventListener("input",()=>{
  const val = document.getElementById("machineInput").value.toLowerCase();
  const dept = document.getElementById("gDeptCode").value;
  const suggDiv = document.getElementById("machineSuggestions");
  if(!val || !dept){ suggDiv.style.display="none"; return;}
  const filtered = machinesData.filter(m=>m.DeptCode===dept && m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]?.toLowerCase().includes(val));
  suggDiv.innerHTML="";
  filtered.forEach(m=>{
    const div=document.createElement("div");
    div.className="autocomplete-suggestion";
    div.textContent = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
    div.addEventListener("click",()=>{
      if(!selectedMachines.includes(m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"])){
        selectedMachines.push(m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]);
        renderSelectedMachines();
      }
      document.getElementById("machineInput").value="";
      suggDiv.style.display="none";
    });
    suggDiv.appendChild(div);
  });
  suggDiv.style.display = filtered.length>0?"block":"none";
});

// Search GroupName PM (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£)
document.getElementById("searchGroupPM").addEventListener("input",()=>{
  const val = document.getElementById("searchGroupPM").value.toLowerCase();
  const suggDiv = document.getElementById("searchGroupPMSuggestions");
  if(!val){ suggDiv.style.display="none"; return;}
  const filtered = groupsData.filter(g=>g.GroupName?.toLowerCase().includes(val));
  suggDiv.innerHTML="";
  filtered.forEach(g=>{
    const div=document.createElement("div");
    div.className="autocomplete-suggestion";
    div.textContent = g.GroupName;
    div.addEventListener("click",()=>{
      document.getElementById("gGroupCode").textContent = g.GroupCode;
      document.getElementById("gGroupName").value = g.GroupName;
      document.getElementById("gDeptCode").value = g.DeptCode;
      selectedMachines = machinesData.filter(m=>m.GroupCode===g.GroupCode).map(m=>m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]);
      renderSelectedMachines();
      editRow = g;
      document.getElementById("groupAddBtn").classList.add("hidden");
      document.getElementById("groupEditBtn").classList.remove("hidden");
      document.getElementById("groupCancelBtn").classList.remove("hidden");
      suggDiv.style.display="none";
    });
    suggDiv.appendChild(div);
  });
  suggDiv.style.display = filtered.length>0?"block":"none";
});

// Render Group Table
function renderGroupTable(){
  const tbody = document.querySelector("#groupTable tbody");
  tbody.innerHTML="";
  groupsData.forEach((g,index)=>{
    const tr=document.createElement("tr");
    const dept = deptsData.find(d=>d.DeptCode===g.DeptCode);
    const deptNameEng = dept?.DeptNameEng || g.DeptCode;
    tr.innerHTML = `
      <td class="border px-2 py-1">${index+1}</td>
      <td class="border px-2 py-1">${g.GroupCode}</td>
      <td class="border px-2 py-1">${g.GroupName}</td>
      <td class="border px-2 py-1">${deptNameEng}</td>
      <td class="border px-2 py-1">
        <button class="bg-green-600 text-white px-2 py-1 rounded editBtn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </td>`;
    tr.querySelector(".editBtn").addEventListener("click",()=>{
      document.getElementById("gGroupCode").textContent = g.GroupCode;
      document.getElementById("gGroupName").value = g.GroupName;
      document.getElementById("gDeptCode").value = g.DeptCode;
      selectedMachines = machinesData.filter(m=>m.GroupCode===g.GroupCode).map(m=>m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]);
      renderSelectedMachines();
      editRow = g;
      document.getElementById("groupAddBtn").classList.add("hidden");
      document.getElementById("groupEditBtn").classList.remove("hidden");
      document.getElementById("groupCancelBtn").classList.remove("hidden");
    });
    tbody.appendChild(tr);
  });
}

// Save Group
async function saveGroup(){
  const gCode = document.getElementById("gGroupCode").textContent;
  const gName = document.getElementById("gGroupName").value;
  const gDept = document.getElementById("gDeptCode").value;
  if(!gCode || !gName || !gDept){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á"); return;}

  const timestamp = new Date().toLocaleString("th-TH",{hour12:false});
  const newGroup = {GroupCode:gCode, GroupName:gName, DeptCode:gDept, CreatedBy:currentEmp, CreatedDate:timestamp, ModifiedBy:currentEmp, ModifiedDate:timestamp};

  await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineGroup/Action`,{
    method:"POST",
    headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
    body:JSON.stringify({Action:"Add", Rows:[newGroup]})
  });

  groupsData.push(newGroup);

  for(const mName of selectedMachines){
    const machine = machinesData.find(m=>m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]===mName);
    if(machine){
      await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
        method:"POST",
        headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
        body:JSON.stringify({Action:"Edit", Rows:[{"‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á":machine["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"], "GroupCode":gCode}]})
      });
      machine.GroupCode = gCode;
    }
  }

  renderGroupTable();
  resetForm();
  showSuccess();
}

// Edit Group
async function editGroup(){
  if(!editRow) return;
  const gCode = document.getElementById("gGroupCode").textContent;
  const gName = document.getElementById("gGroupName").value;
  const gDept = document.getElementById("gDeptCode").value;
  const timestamp = new Date().toLocaleString("th-TH",{hour12:false});
  const updatedGroup = {...editRow, GroupName:gName, DeptCode:gDept, ModifiedBy:currentEmp, ModifiedDate:timestamp};

  await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineGroup/Action`,{
    method:"POST",
    headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
    body:JSON.stringify({Action:"Edit", Rows:[updatedGroup]})
  });

  const oldMachines = machinesData.filter(m=>m.GroupCode===gCode && !selectedMachines.includes(m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]));
  for(const m of oldMachines){
    await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify({Action:"Edit", Rows:[{"‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á":m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"], "GroupCode":""}]})
    });
    m.GroupCode = "";
  }
  for(const mName of selectedMachines){
    const machine = machinesData.find(m=>m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]===mName);
    if(machine){
      await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
        method:"POST",
        headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
        body:JSON.stringify({Action:"Edit", Rows:[{"‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á":machine["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"], "GroupCode":gCode}]})
      });
      machine.GroupCode = gCode;
    }
  }
  groupsData = groupsData.map(g=>g.GroupCode===gCode ? updatedGroup : g);
  renderGroupTable();
  resetForm();
  showSuccess();
}

// Reset Form
function resetForm(){
  document.getElementById("groupForm").reset();
  selectedMachines=[];
  renderSelectedMachines();
  editRow=null;
  document.getElementById("groupAddBtn").classList.remove("hidden");
  document.getElementById("groupEditBtn").classList.add("hidden");
  document.getElementById("groupCancelBtn").classList.add("hidden");
  generateGroupCode();
  document.getElementById("groupMsg").classList.add("hidden");
}

// Show Success Message
function showSuccess(){
  const msg = document.getElementById("groupMsg");
  msg.classList.remove("hidden");
  setTimeout(()=>msg.classList.add("hidden"),3000);
}

// Init
async function init(){
  await loadDropdowns();
  machinesData = await fetchTable("MachineMaster");
  groupsData = await fetchTable("MachineGroup");
  renderGroupTable();
  generateGroupCode();
}

// Event Listeners
document.getElementById("groupAddBtn").addEventListener("click", saveGroup);
document.getElementById("groupEditBtn").addEventListener("click", editGroup);
document.getElementById("groupCancelBtn").addEventListener("click", resetForm);

// ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
document.getElementById("searchAll").addEventListener("input",()=>{
  const val = document.getElementById("searchAll").value.toLowerCase();
  document.querySelectorAll("#groupTable tbody tr").forEach(tr=>{
    const text = Array.from(tr.children).slice(0,4).map(td=>td.textContent.toLowerCase()).join(" ");
    tr.style.display = text.includes(val) ? "" : "none";
  });
});

init();
</script>

</body>
</html>



