<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MachineMaster</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family:'Kanit', sans-serif; }
.autocomplete-suggestions { position:absolute; z-index:50; background:white; border:1px solid #93c5fd; border-radius:0.5rem; max-height:200px; overflow-y:auto; width:100%; }
.autocomplete-suggestion:hover { background:#e0f2fe; cursor:pointer; }
.highlight { background:#fef08a; }
.table-container { max-height:350px; overflow-x:auto; overflow-y:auto; }
th, td { min-width:120px; }
.toggle-btn { cursor:pointer; font-weight:bold; padding:0.25rem 0.5rem; border-radius:0.375rem; text-align:center; }
.toggle-active { background-color:#34D399; color:white; }
.toggle-inactive { background-color:#F87171; color:white; }
</style>
</head>
<body class="bg-gray-100 p-4">

<h1 class="text-2xl md:text-3xl font-bold text-blue-700 text-center mb-4">üì¶ MachineMaster</h1>

<div class="max-w-5xl mx-auto bg-white p-4 md:p-6 rounded-xl shadow-lg">
  <!-- Form -->
  <form id="machineForm" class="space-y-3 md:space-y-4" onsubmit="return false;">
    <!-- Autocomplete NickName -->
    <div class="relative">
      <label class="block font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</label>
      <input type="text" id="machineSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="w-full border-2 border-blue-300 rounded-md p-2"/>
      <div id="nickSuggestions" class="autocomplete-suggestions"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <input type="text" id="machineCode" class="w-full border-2 border-blue-300 rounded-md p-2" required />
      </div>
      <div>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)</label>
        <input type="text" id="machineName1" class="w-full border-2 border-blue-300 rounded-md p-2" required />
      </div>
      <div>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</label>
        <input type="text" id="machineName" class="w-full border-2 border-blue-300 rounded-md p-2" required />
      </div>
      <div>
        <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
        <select id="deptCode" class="w-full border-2 border-blue-300 rounded-md p-2"></select>
      </div>
      <div class="col-span-1 md:col-span-2 relative">
        <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM) 
          <a href="MachineGroup.html" target="MachineGroup" class="ml-2 text-blue-600 hover:text-blue-800 font-bold">üóÇÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°</a>
        </label>
        <!-- input ‡πÅ‡∏™‡∏î‡∏á GroupName -->
        <input type="text" id="groupName" class="w-full border-2 border-blue-300 rounded-md p-2" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°..."/>
        <div id="groupSuggestions" class="autocomplete-suggestions"></div>
        <!-- hidden ‡πÄ‡∏Å‡πá‡∏ö GroupCode -->
        <input type="hidden" id="groupCode" />
      </div>
      <div>
        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><br>
        <span id="statusBtn" class="toggle-btn toggle-active">Active</span>
      </div>
    </div>

    <div class="flex justify-center gap-2 mt-4">
      <button id="addBtn" type="button" 
        class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow hover:bg-blue-700 hover:shadow-lg transition-all text-base w-1/2 max-w-[120px]">
        ‡πÄ‡∏û‡∏¥‡πà‡∏°
      </button>
      <button id="editBtn" type="button" 
        class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-md shadow hover:bg-yellow-600 hover:shadow-lg transition-all text-base w-1/2 max-w-[120px] hidden">
        ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>
    </div>

    <!-- Section ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
    <div id="recordInfo" class="mt-3 text-sm text-gray-700 flex flex-wrap justify-between">
      <div>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢: <span id="CreatedBy">-</span> | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á: <span id="CreatedDate">-</span></div>
      <div>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÇ‡∏î‡∏¢: <span id="ModifiedBy">-</span> | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: <span id="ModifiedDate">-</span></div>
    </div>

    <div id="message" class="text-center font-semibold mt-2 text-sm md:text-base"></div>
  </form>

  <!-- Search ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå -->
  <div class="my-3">
    <input type="text" id="searchAll" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå..." class="w-full border-2 border-blue-300 rounded-md p-2"/>
  </div>

  <!-- Table -->
  <div class="table-container border rounded-lg shadow">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-blue-600 text-white sticky top-0">
        <tr>
          <th class="px-2 py-2 text-left text-sm md:text-base">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
          <th class="px-2 py-2 text-left text-sm md:text-base">NickName</th>
          <th class="px-2 py-2 text-left text-sm md:text-base">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
          <th class="px-2 py-2 text-left text-sm md:text-base">‡πÅ‡∏ú‡∏ô‡∏Å</th>
          <th class="px-2 py-2 text-left text-sm md:text-base">‡∏Å‡∏•‡∏∏‡πà‡∏° (PM)</th>
          <th class="px-2 py-2 text-left text-sm md:text-base">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody id="machineListTable" class="bg-white divide-y divide-gray-200">
        <tr><td colspan="6" class="text-center py-4 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const appId="ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey="V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
const currentEmp = localStorage.getItem("EmpCode") || "EMP001";

let machinesData=[], groupsData=[], deptsData=[], empData=[];

// Fetch table
async function fetchTable(tableName){
  const res = await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Find`,{
    method:"POST",
    headers:{ "Content-Type":"application/json","ApplicationAccessKey":apiKey },
    body:JSON.stringify({})
  });
  return res.json();
}

// Load dropdowns
async function loadDropdowns(){
  deptsData = await fetchTable("Department");
  groupsData = await fetchTable("MachineGroup");
  empData = await fetchTable("Emp");

  // ‡πÅ‡∏ú‡∏ô‡∏Å
  const deptSelect = document.getElementById("deptCode");
  deptSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
  deptsData.forEach(d=>{
    const opt = document.createElement("option");
    opt.value=d.DeptCode;
    opt.textContent=`${d.DeptCode} : ${d.DeptNameEng}`;
    deptSelect.appendChild(opt);
  });
}

// Toggle button ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
const statusBtn = document.getElementById("statusBtn");
statusBtn.addEventListener("click", ()=>{
  if(statusBtn.textContent==="Active"){
    statusBtn.textContent="Inactive";
    statusBtn.classList.remove("toggle-active");
    statusBtn.classList.add("toggle-inactive");
  } else {
    statusBtn.textContent="Active";
    statusBtn.classList.remove("toggle-inactive");
    statusBtn.classList.add("toggle-active");
  }
});

// ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ/‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
function setMachineCodeReadonly(isReadonly){
  const codeInput = document.getElementById("machineCode");
  codeInput.readOnly = isReadonly;
  if(isReadonly){
    codeInput.classList.add("bg-gray-200");
  } else {
    codeInput.classList.remove("bg-gray-200");
  }
}

// EmpName helper
function getEmpName(code){ const emp = empData.find(e=>e.EmpCode===code); return emp ? emp.EmpName : code; }
function formatDateTH(dateStr){ if(!dateStr) return "-"; const d=new Date(dateStr); return d.toLocaleString("th-TH",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}); }

// Render Table
function renderMachineList(){
  const tbody = document.getElementById("machineListTable");
  tbody.innerHTML="";
  const filter = document.getElementById("searchAll").value.toLowerCase();

  if(!filter){ 
    tbody.innerHTML=`<tr><td colspan="6" class="text-center py-4 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }

  let filtered = machinesData.filter(m=>{
    const deptText = deptsData.find(d=>d.DeptCode===m.DeptCode);
    const str = `${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]||""} ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||""} ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]||""} ${deptText?deptText.DeptNameEng:""} ${groupsData.find(g=>g.GroupCode===m.GroupCode)?.GroupName||""} ${m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||""}`.toLowerCase();
    return str.includes(filter);
  });

  if(filtered.length===0){ 
    tbody.innerHTML=`<tr><td colspan="6" class="text-center py-4 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }

  filtered.forEach(m=>{
    const tr = document.createElement("tr");
    const deptText = deptsData.find(d=>d.DeptCode===m.DeptCode);
    tr.innerHTML=`<td class="px-2 py-1 text-sm">${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]||""}</td>
      <td class="px-2 py-1 text-sm">${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||""}</td>
      <td class="px-2 py-1 text-sm">${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]||""}</td>
      <td class="px-2 py-1 text-sm">${deptText?deptText.DeptNameEng:""}</td>
      <td class="px-2 py-1 text-sm">${groupsData.find(g=>g.GroupCode===m.GroupCode)?.GroupName||""}</td>
      <td class="px-2 py-1 text-sm font-bold ${m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞==="Active"?"text-green-600":"text-red-600"}">${m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞||""}</td>`;
    tr.addEventListener("click",()=>fillMachineForm(m));
    tbody.appendChild(tr);
  });
}

// Fill form
function fillMachineForm(m){
  document.getElementById("machineSearch").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
  document.getElementById("machineCode").value=m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
  document.getElementById("machineName1").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
  document.getElementById("machineName").value=m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"];
  document.getElementById("deptCode").value=m.DeptCode;
  document.getElementById("groupCode").value=m.GroupCode;
  document.getElementById("groupName").value=groupsData.find(g=>g.GroupCode===m.GroupCode)?.GroupName || "";
  statusBtn.textContent=m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ || "Active";
  statusBtn.className = "toggle-btn " + (m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞==="Active"?"toggle-active":"toggle-inactive");
  document.getElementById("addBtn").classList.add("hidden");
  document.getElementById("editBtn").classList.remove("hidden");

  setMachineCodeReadonly(true);

  document.getElementById("CreatedBy").textContent = getEmpName(m.CreatedBy);
  document.getElementById("CreatedDate").textContent = formatDateTH(m.CreatedDate);
  document.getElementById("ModifiedBy").textContent = getEmpName(m.ModifiedBy);
  document.getElementById("ModifiedDate").textContent = formatDateTH(m.ModifiedDate);
}

// Highlight helper
function highlightMatch(text, query){
  if(!query) return text;
  const regex = new RegExp(`(${query})`,"gi");
  return text.replace(regex, `<span class="highlight">$1</span>`);
}

// Autocomplete NickName
document.getElementById("machineSearch").addEventListener("input", function(){
  const val = this.value.toLowerCase();
  const suggestions = document.getElementById("nickSuggestions");
  suggestions.innerHTML="";
  if(!val){ suggestions.style.display="none"; return; }

  const matches = machinesData.filter(m=> m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"].toLowerCase().includes(val) && m.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞==="Active").slice(0,10);
  matches.forEach(m=>{
    const div = document.createElement("div");
    div.className="autocomplete-suggestion";
    div.innerHTML = highlightMatch(m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"], val);
    div.addEventListener("click",()=>{ fillMachineForm(m); suggestions.style.display="none"; });
    suggestions.appendChild(div);
  });
  suggestions.style.display = matches.length ? "block" : "none";
});

// Autocomplete GroupName ‚Üí ‡πÄ‡∏Å‡πá‡∏ö GroupCode
document.getElementById("groupName").addEventListener("input", function(){
  const val = this.value.toLowerCase();
  const dept = document.getElementById("deptCode").value;
  const suggestions = document.getElementById("groupSuggestions");
  suggestions.innerHTML="";
  if(!val || !dept){ suggestions.style.display="none"; return; }

  const matches = groupsData.filter(g=> g.GroupName.toLowerCase().includes(val) && g.DeptCode === dept).slice(0,10);
  matches.forEach(g=>{
    const div = document.createElement("div");
    div.className = "autocomplete-suggestion";
    div.innerHTML = highlightMatch(g.GroupName, val);
    div.addEventListener("click", ()=>{
      document.getElementById("groupName").value = g.GroupName;
      document.getElementById("groupCode").value = g.GroupCode;
      suggestions.style.display = "none";
    });
    suggestions.appendChild(div);
  });
  suggestions.style.display = matches.length ? "block" : "none";
});

// Add / Edit
document.getElementById("addBtn").addEventListener("click", ()=>{ setMachineCodeReadonly(false); addMachine(); });
document.getElementById("editBtn").addEventListener("click", editMachine);

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥
async function addMachine(){
  const code=document.getElementById("machineCode").value.trim();
  const nick=document.getElementById("machineName1").value.trim();
  const name=document.getElementById("machineName").value.trim();
  const dept=document.getElementById("deptCode").value;
  const group=document.getElementById("groupCode").value;
  const status=statusBtn.textContent;
  const msg=document.getElementById("message");
  if(!code||!nick||!name||!dept){ msg.style.color="red"; msg.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"; return; }

  const codeExists = machinesData.some(m => m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] === code);
  const nickExists = machinesData.some(m => m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"] === nick);
  if(codeExists){ msg.style.color="red"; msg.textContent="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß"; return; }
  if(nickExists){ msg.style.color="red"; msg.textContent="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)"; return; }

  const payload={ Action:"Add", Rows:[{
    "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": code,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1": nick,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£": name,
    "DeptCode": dept,
    "GroupCode": group,
    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": status,
    "CreatedBy": currentEmp
  }]};

  try{
    const res=await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify(payload)
    });
    if(res.ok){
      msg.style.color="green"; msg.textContent="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; 
      machinesData=await fetchTable("MachineMaster"); 
      renderMachineList(); 
      document.getElementById("machineForm").reset(); 
      statusBtn.textContent="Active"; 
      statusBtn.className="toggle-btn toggle-active"; 
      document.getElementById("addBtn").classList.remove("hidden"); 
      document.getElementById("editBtn").classList.add("hidden"); 
    }
    else{ msg.style.color="red"; msg.textContent="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; }
  }catch(e){ msg.style.color="red"; msg.textContent=e.message; }
}

async function editMachine(){
  const code=document.getElementById("machineCode").value.trim();
  const nick=document.getElementById("machineName1").value.trim();
  const name=document.getElementById("machineName").value.trim();
  const dept=document.getElementById("deptCode").value;
  const group=document.getElementById("groupCode").value;
  const status=statusBtn.textContent;
  const msg=document.getElementById("message");
  if(!code){ msg.style.color="red"; msg.textContent="‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"; return; }

  const codeExists = machinesData.some(m => m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] === code && m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] !== code);
  const nickExists = machinesData.some(m => m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"] === nick && m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] !== code);
  if(codeExists){ msg.style.color="red"; msg.textContent="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß"; return; }
  if(nickExists){ msg.style.color="red"; msg.textContent="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (NickName)‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß"; return; }

  const payload={ Action:"Edit", Rows:[{
    "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": code,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1": nick,
    "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£": name,
    "DeptCode": dept,
    "GroupCode": group,
    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": status,
    "ModifiedBy": currentEmp
  }]};

  try{
    const res=await fetch(`https://api.appsheet.com/api/v2/apps/${appId}/tables/MachineMaster/Action`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify(payload)
    });
    if(res.ok){ msg.style.color="green"; msg.textContent="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; machinesData=await fetchTable("MachineMaster"); renderMachineList(); }
    else{ msg.style.color="red"; msg.textContent="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; }
  }catch(e){ msg.style.color="red"; msg.textContent=e.message; }
}

// Search All
document.getElementById("searchAll").addEventListener("input", renderMachineList);

// Init
(async()=>{
  await loadDropdowns();
  machinesData = await fetchTable("MachineMaster");
})();
</script>
</body>
</html>





