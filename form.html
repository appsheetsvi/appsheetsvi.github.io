<!DOCTYPE html> 
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f0f9ff;
      min-height: 100vh;
      padding: 1rem;
    }
    main {
      max-width: 700px;
      margin: auto;
      background: white;
      border-radius: 1rem;
      padding: 2rem 2.5rem;
      box-shadow: 0 8px 20px rgb(14 165 233 / 0.3);
    }
    h1 {
      color: #2563eb;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: #1e40af;
    }
    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select,
    textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 2px solid #93c5fd;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="datetime-local"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 8px #3b82f6aa;
      background-color: #f0f9ff;
    }
    input[readonly] {
      background-color: #e0e7ff;
      cursor: not-allowed;
      color: #4b5563;
    }
    .select-searchable {
      position: relative;
    }
    .select-searchable ul {
      position: absolute;
      top: 105%;
      left: 0;
      right: 0;
      background: white;
      border: 1.5px solid #93c5fd;
      border-radius: 0.5rem;
      max-height: 220px;
      overflow-y: auto;
      z-index: 9999;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      margin-top: 0.25rem;
      list-style: none;
      padding-left: 0;
      display: none;
    }
    .select-searchable ul.show {
      display: block;
    }
    .select-searchable li {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    .select-searchable li:hover {
      background-color: #bfdbfe;
    }
    .parts-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .parts-row > * {
      flex: 1 1 100px;
      min-width: 90px;
    }
    .parts-row input[type="text"] {
      flex: 2 1 150px;
    }
    .parts-row input[type="number"],
    .parts-row select {
      max-width: 100px;
    }
    .btn-remove-part {
      background: #ef4444;
      color: white;
      padding: 0.3rem 0.7rem;
      border-radius: 0.5rem;
      cursor: pointer;
      flex-shrink: 0;
      font-weight: bold;
      transition: background-color 0.3s ease;
      border: none;
      height: 38px;
    }
    .btn-remove-part:hover {
      background: #b91c1c;
    }
    .tech-checkboxes {
      max-height: 140px;
      overflow-y: auto;
      border: 2px solid #93c5fd;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      background: #eff6ff;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 1.5rem;
    }
    .tech-checkboxes label {
      cursor: pointer;
      font-weight: 600;
      color: #1e40af;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .tech-checkboxes input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #2563eb;
      cursor: pointer;
    }
    button[type="submit"],
    #btnAddPart {
      background: #2563eb;
      color: white;
      font-weight: 600;
      border-radius: 0.75rem;
      padding: 0.6rem 1.5rem;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 10px rgb(37 99 235 / 0.4);
      border: none;
      width: 100%;
      max-width: 240px;
      margin-top: 0.5rem;
    }
    button[type="submit"]:hover,
    #btnAddPart:hover {
      background: #1e40af;
      box-shadow: 0 5px 15px rgb(30 64 175 / 0.7);
    }
    .footer-text {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.8rem;
      color: #64748b;
      user-select: none;
    }
    /* Responsive */
    @media (max-width: 640px) {
      main {
        padding: 1.5rem 1.5rem;
      }
      .parts-row {
        flex-direction: column;
        align-items: stretch;
      }
      .parts-row > * {
        max-width: 100%;
      }
      button[type="submit"],
      #btnAddPart {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <main>
    <h1 class="text-center text-3xl mb-8">üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h1>
    <form id="repairForm" class="space-y-6" autocomplete="off">

      <!-- ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° -->
      <div>
        <label for="requestNo">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input id="requestNo" name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" readonly placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ" />
      </div>

      <!-- ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô -->
      <div>
        <label for="deptSelect">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
        <select id="deptSelect" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>
        </select>
      </div>

      <!-- ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (searchable) -->
      <div>
        <label for="machineSearch">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <div class="select-searchable">
          <input type="text" id="machineSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." />
          <ul id="machineList"></ul>
        </div>
        <input type="hidden" id="machineCodeHidden" name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" required />
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢ -->
      <div>
        <label for="problemDetail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea id="problemDetail" name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢" rows="3" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"></textarea>
      </div>

      <!-- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ -->
      <div>
        <label for="causeAnalysis">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="causeAnalysis" name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
      </div>

      <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° -->
      <div>
        <label for="dateReport">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input type="datetime-local" id="dateReport" name="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" required />
      </div>

      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏à‡∏≥‡∏Å‡∏±‡∏î 3 ‡∏Ñ‡∏ô) -->
      <div>
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô)</label>
        <div id="techCheckboxes" class="tech-checkboxes"></div>
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà -->
      <div>
        <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
        <div id="partsContainer"></div>
        <button type="button" id="btnAddPart" class="mt-2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
      <div class="text-center">
        <button type="submit" class="w-full max-w-sm">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <p class="footer-text">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <strong>1.2</strong></p>
      </div>

    </form>
  </main>

<script>
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
  const apiBase = `https://api.appsheet.com/api/v2/apps/${appId}/tables/`;

  let machineList = [];
  let empList = [];

  async function fetchFromTable(table, filter = {}) {
    try {
      const res = await fetch(`${apiBase}${table}/Find`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({ filter })
      });
      if (!res.ok) throw new Error(`Fetch error: ${res.status}`);
      return await res.json();
    } catch (e) {
      console.error(e);
      return [];
    }
  }

  async function loadDepartments() {
    const list = await fetchFromTable("Department");
    const sel = document.getElementById("deptSelect");
    sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>`;
    list.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.DeptCode;
      opt.textContent = d.DeptNameEng || d.DeptName || d.DeptCode;
      sel.appendChild(opt);
    });
  }

  async function loadMachinesByDept(deptCode) {
    const list = await fetchFromTable("MachineMaster");
    machineList = list.filter(m => m.DeptCode === deptCode);
    renderMachineList(machineList);
  }

  function renderMachineList(list) {
    const ul = document.getElementById("machineList");
    ul.innerHTML = "";
    if (list.length === 0) {
      ul.classList.remove("show");
      return;
    }
    list.forEach(m => {
      const li = document.createElement("li");
      li.textContent = `${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]} - ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]}`;
      li.dataset.code = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      li.onclick = () => {
        document.getElementById("machineSearch").value = li.textContent;
        document.getElementById("machineCodeHidden").value = li.dataset.code;
        ul.classList.remove("show");
      };
      ul.appendChild(li);
    });
    ul.classList.add("show");
  }

  function filterMachines() {
    const val = document.getElementById("machineSearch").value.toLowerCase();
    const filtered = machineList.filter(m => {
      return (m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] + " " + m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"]).toLowerCase().includes(val);
    });
    renderMachineList(filtered);
  }

  async function loadTechnicians() {
    const list = await fetchFromTable("Emp", { EmpStatus: 0 });
    empList = list.filter(e => e.DeptCode === "A12"); // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å A12
    const container = document.getElementById("techCheckboxes");
    container.innerHTML = "";
    empList.forEach(emp => {
      const id = `tech_${emp.EmpCode}`;
      const label = document.createElement("label");
      label.htmlFor = id;
      label.innerHTML = `<input type="checkbox" id="${id}" name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" value="${emp.EmpCode}" /> ${emp.EmpName} (${emp.EmpCode})`;
      container.appendChild(label);
    });
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà ‡∏û‡∏£‡πâ‡∏≠‡∏° Unit
  function createPartRow(index = 0, data = {}) {
    const div = document.createElement("div");
    div.className = "parts-row";
    div.dataset.index = index;

    div.innerHTML = `
      <input type="text" name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" value="${data.‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà || ""}" required />
      <input type="number" name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="${data.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô || 1}" min="1" required />
      <select name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö" required>
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö --</option>
        <option value="‡∏ä‡∏¥‡πâ‡∏ô" ${data.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö === "‡∏ä‡∏¥‡πâ‡∏ô" ? "selected" : ""}>‡∏ä‡∏¥‡πâ‡∏ô</option>
        <option value="‡πÄ‡∏°‡∏ï‡∏£" ${data.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö === "‡πÄ‡∏°‡∏ï‡∏£" ? "selected" : ""}>‡πÄ‡∏°‡∏ï‡∏£</option>
        <option value="‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°" ${data.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö === "‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°" ? "selected" : ""}>‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</option>
        <option value="‡∏ä‡∏∏‡∏î" ${data.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö === "‡∏ä‡∏∏‡∏î" ? "selected" : ""}>‡∏ä‡∏∏‡∏î</option>
        <option value="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ" ${data.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö === "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ" ? "selected" : ""}>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <button type="button" class="btn-remove-part" title="‡∏•‡∏ö‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">√ó</button>
    `;

    div.querySelector(".btn-remove-part").onclick = () => {
      div.remove();
      updatePartIndices();
    };
    return div;
  }

  function updatePartIndices() {
    const container = document.getElementById("partsContainer");
    [...container.children].forEach((div, i) => div.dataset.index = i);
  }

  function addNewPart(data = {}) {
    const container = document.getElementById("partsContainer");
    const newPart = createPartRow(container.children.length, data);
    container.appendChild(newPart);
  }

  function getSelectedTechnicians() {
    const checked = [...document.querySelectorAll("#techCheckboxes input[type=checkbox]:checked")];
    if (checked.length > 3) {
      alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
      // ‡πÄ‡∏≠‡∏≤ checkbox ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏≠‡∏Å
      checked[checked.length - 1].checked = false;
      return getSelectedTechnicians();
    }
    return checked.map(c => c.value);
  }

  function getPartsData() {
    const container = document.getElementById("partsContainer");
    const parts = [];
    for (const div of container.children) {
      const item = div.querySelector('input[name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"]').value.trim();
      const qty = div.querySelector('input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]').value.trim();
      const unit = div.querySelector('select[name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö"]').value;
      if (item && qty && qty > 0 && unit) {
        parts.push({
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà: item,
          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: Number(qty),
          ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö: unit
        });
      }
    }
    return parts;
  }

  async function generateRequestNo() {
    const list = await fetchFromTable("Machinesymptom");
    let maxNo = 2506000;
    list.forEach(r => {
      const num = Number(r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]);
      if (!isNaN(num) && num > maxNo) maxNo = num;
    });
    return (maxNo + 1).toString();
  }

  async function saveRepairMain(data) {
    const body = {
      Action: "Add",
      Rows: [data]
    };
    const res = await fetch(`${apiBase}Machinesymptom/Add`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }

  async function saveRepairTechnicians(requestNo, empCodes) {
    for (const empCode of empCodes) {
      const techData = {
        ID: `${requestNo}-${empCode}`,
        "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": requestNo,
        EmpCode: empCode,
        "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": "",
        "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": "",
        "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": "",
        "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": ""
      };
      const resp = await fetch(`${apiBase}RepairTechnicians/Add`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({
          Action: "Add",
          Rows: [techData]
        })
      });
      if (!resp.ok) throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏≤‡∏á ${empCode} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    }
  }

  async function saveRepairParts(requestNo, parts) {
    for (const [index, part] of parts.entries()) {
      const partData = {
        ID: `${requestNo}-part-${index + 1}`,
        "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": requestNo,
        "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": part["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"],
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: part["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"],
        ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö: part["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö"]
      };
      const resp = await fetch(`${apiBase}RepairParts/Add`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({
          Action: "Add",
          Rows: [partData]
        })
      });
      if (!resp.ok) throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${part["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"]}`);
    }
  }

  async function init() {
    await loadDepartments();
    await loadTechnicians();
    addNewPart();
    const reqNo = await generateRequestNo();
    document.getElementById("requestNo").value = reqNo;
  }

  document.getElementById("deptSelect").addEventListener("change", (e) => {
    const dept = e.target.value;
    if (dept) {
      loadMachinesByDept(dept);
      document.getElementById("machineSearch").value = "";
      document.getElementById("machineCodeHidden").value = "";
    }
  });

  document.getElementById("machineSearch").addEventListener("input", filterMachines);

  document.getElementById("techCheckboxes").addEventListener("change", () => {
    getSelectedTechnicians();
  });

  document.getElementById("btnAddPart").addEventListener("click", () => addNewPart());

  document.getElementById("repairForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    try {
      const form = e.target;
      const dataMain = {
        "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": form["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"].value.trim(),
        "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": form["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"].value.trim(),
        "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": form["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"].value.trim(),
        "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": form["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"].value.trim(),
        "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": form["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"].value.trim(),
        "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": form["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"].value.trim(),
      };

      if (!dataMain["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"] || !dataMain["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || !dataMain["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || !dataMain["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô");
        return;
      }

      const selectedTechs = getSelectedTechnicians();
      if (selectedTechs.length === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô");
        return;
      }

      const parts = getPartsData();

      await saveRepairMain(dataMain);
      await saveRepairTechnicians(dataMain["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"], selectedTechs);
      if (parts.length > 0) await saveRepairParts(dataMain["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"], parts);

      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      form.reset();

      const newReqNo = await generateRequestNo();
      document.getElementById("requestNo").value = newReqNo;
      document.getElementById("partsContainer").innerHTML = "";
      addNewPart();

    } catch (err) {
      console.error(err);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
    }
  });

  init();
</script>
</body>
</html>
