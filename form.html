<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ + PM</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
<style>
body { font-family:'Sarabun',sans-serif; background:#f0f9ff; min-height:100vh; }
@media (max-width: 640px) {
  input, textarea, select {
    font-size: 1rem;
    padding: 0.5rem 0.75rem;
  }
  label { font-size: 0.95rem; }
  .tech-checkbox { flex: 1 1 250%; } /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
}
input:focus, textarea:focus, select:focus {
  outline:none; border-color:#3b82f6;
  box-shadow:0 0 0 2px rgba(59,130,246,0.4); background:#fff;
}
textarea { min-height:3rem; }
.parts-row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
.parts-row > * { flex:1 1 120px; }
.btn-remove-part {
  background:#ef4444;color:white;padding:4px 8px;border-radius:6px;
  cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;
}
.btn-remove-part:hover { background:#b91c1c; }
.tech-checkboxes { display:flex; flex-wrap:wrap; gap:8px; margin-top:4px; }
.tech-checkbox {
  flex:1 1 250px; background:#f9fafb; border:1px solid #ccc; padding:12px;
  border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.05); display:flex; flex-direction:column;
}
.machine-container {
  border:1px solid #ccc; padding:12px; border-radius:10px;
  margin-bottom:12px; background:#fff; position:relative;
}
.btn-remove-machine {
  position:absolute; top:8px; right:8px;
  background:#ef4444; color:white; padding:2px 6px; border-radius:6px; cursor:pointer;
}
.btn-remove-machine:hover { background:#b91c1c; }
/* ‡∏ã‡πà‡∏≠‡∏ô scroll bar ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ touch */
#deptList, #pmGroupList, .machineList {
  max-height: 200px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
#deptList::-webkit-scrollbar,
#pmGroupList::-webkit-scrollbar,
.machineList::-webkit-scrollbar {
  display: none;
}
@media (max-width: 640px) {
  .tech-checkbox {
    flex: 1 1 100%;   /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
  }
}
</style>
</head>
<body>
<div>  
<nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
  <a href="https://appsheetsvi.github.io/Menu.html" class="font-semibold">üè† Home</a>
  <div class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
</nav>
</div>

<main class="w-full max-w-3xl mx-auto mt-4 p-4 bg-white rounded-lg shadow">  
<h1 class="text-2xl font-bold text-blue-700 text-center mb-6">üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ </h1>

<form id="repairForm" class="grid gap-6" autocomplete="off">
  <!-- ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
      <input name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" readonly class="w-full bg-gray-100"/>
    </div>
    <div>
      <label class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
      <div class="relative">
        <input type="text" id="deptSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å..." class="w-full" required/>
        <ul id="deptList" class="absolute w-full bg-white max-h-40 overflow-y-auto border rounded z-10 hidden"></ul>
      </div>
      <input type="hidden" id="deptCodeHidden" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"/>
    </div>
  </div>

  <!-- PM Group -->
  <div>
    <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (PM)</label>
    <a href="MachineGroup.html" target="MachineGroup" class="ml-2 text-blue-600 hover:text-blue-800 font-bold">üóÇÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°</a>                                                 
    <div class="relative">
      <input type="text" id="pmGroupSearch" placeholder="üîç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Group..." class="w-full" disabled/>
      <ul id="pmGroupList" class="absolute w-full bg-white max-h-40 overflow-y-auto border rounded z-10 hidden"></ul>
    </div>
  </div>

  <!-- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ -->
  <div id="machinesContainer"></div>

  <div class="flex gap-4 flex-wrap">
    <button type="button" id="btnAddMachine" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</button>
    <button type="button" id="btnResetForm" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">‚ôªÔ∏è Reset Form</button>
    <button type="submit" id="submitBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>
</form>
</main>

<script>
const appId="ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey="V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
const apiBase=`https://api.appsheet.com/api/v2/apps/${appId}/tables/`;
let deptList=[], machineList=[], empList=[], groupList=[];
const $=id=>document.getElementById(id);

let deptSelectStartTime = null;   // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô

// ------- Fetch Table -------
async function fetchFromTable(table){
  try{
    const res = await fetch(`${apiBase}${table}/Find`, {
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body: JSON.stringify({})
    });
    if(!res.ok) return [];
    const data = await res.json();
    return data;
  }catch(err){
    console.error("Fetch error:", table, err);
    return [];
  }
}

// ------- Generate Request Number (YYMM###) -------
async function generateNextRequestNumber(){
  const list = await fetchFromTable("RepairTechnicians");
  const nums = list.map(r => r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]).filter(n => !!n);

  const now = new Date();
  const year = now.getFullYear().toString().slice(-2); // ‡∏õ‡∏µ ‡∏Ñ.‡∏®. 2 ‡∏´‡∏•‡∏±‡∏Å
  const month = (now.getMonth() + 1).toString().padStart(2, "0"); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 2 ‡∏´‡∏•‡∏±‡∏Å
  const prefix = year + month; // ‡πÄ‡∏ä‡πà‡∏ô "2511"

  const filtered = nums.filter(n => n.startsWith(prefix));
  if(filtered.length === 0){
    $("repairForm").querySelector('input[name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]').value = prefix + "001";
  } else {
    const max = Math.max(...filtered.map(n => parseInt(n)));
    $("repairForm").querySelector('input[name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]').value = (max + 1).toString();
  }
}

// ------- Load master data -------
async function loadDepartments(){ deptList = await fetchFromTable("Department"); }
async function loadMachines(){ machineList = await fetchFromTable("MachineMaster"); }
async function loadTechnicians(){ 
  const all=await fetchFromTable("Emp"); 
  empList=all.filter(e=>e.EmpStatus==0 && e.DeptCode==="A12"); 
}
async function loadGroups(){ groupList = await fetchFromTable("MachineGroup"); }

// ------- Parts Row -------
function createPartRow(){
  const div=document.createElement("div");
  div.className="parts-row";
  div.innerHTML=`
    <input type="text" name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"/>
    <input type="number" name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" min="1" value="1"/>
    <input type="text" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢"/>
    <button type="button" class="btn-remove-part">x</button>`;
  div.querySelector("button").onclick=()=>div.remove();
  return div;
}

// ------- Technician Box -------
function createTechBox(emp){
  const div = document.createElement("div");
  div.className="tech-checkbox";
  div.innerHTML=`
    <label class="inline-flex items-center space-x-2 font-semibold">
      <input type="checkbox" name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" value="${emp.EmpCode}"/> ${emp.EmpName}
    </label>
    <textarea name="comment_${emp.EmpCode}" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô" class="mt-1"></textarea>
    <div class="flex flex-col flex-1">
      <label class="text-xs">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
      <input type="datetime-local" name="start_${emp.EmpCode}" 
             class="w-full max-w-[140px] sm:max-w-full text-sm px-1" />
    </div>
    <div class="flex flex-col flex-1">
      <label class="text-xs">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö</label>
      <input type="datetime-local" name="end_${emp.EmpCode}" 
             class="w-full max-w-[140px] sm:max-w-full text-sm px-1" />
    </div>
    <div class="flex gap-2 mt-1">
      <label><input type="checkbox" name="status_${emp.EmpCode}" value="‡∏à‡∏ö‡∏á‡∏≤‡∏ô"/> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</label>
      <label><input type="checkbox" name="status_${emp.EmpCode}" value="‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô"/> ‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô</label>
    </div>
    <label class="inline-flex items-center mt-1">
      <input type="checkbox" name="autoCopy_${emp.EmpCode}"/>
      ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    </label>
  `;
  return div;
}

// ------- Machine Row -------
function createMachineRow(){
  const div = document.createElement("div");
  div.className="machine-container";
  div.innerHTML=`
    <button type="button" class="btn-remove-machine">x</button>
    <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
    <div class="relative">
      <input type="text" class="machineSearch w-full" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." required/>
      <ul class="machineList absolute w-full bg-white max-h-40 overflow-y-auto border rounded z-10 hidden"></ul>
    </div>
    <input type="hidden" name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" class="machineCodeHidden" required/>
    <label class="font-semibold mt-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
    <textarea name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢" class="w-full" rows="2" required></textarea>
    <label class="font-semibold mt-2">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
    <textarea name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏" class="w-full" rows="2" required></textarea>
    <label class="font-semibold mt-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô)</label>
    <div class="tech-checkboxes mb-2"></div>
    <label class="font-semibold mt-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label>
    <div class="partsContainer"></div>
    <button type="button" class="btnAddPart mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
  `;
  div.querySelector(".btn-remove-machine").onclick=()=>div.remove();
  div.querySelector(".btnAddPart").onclick=()=>div.querySelector(".partsContainer").appendChild(createPartRow());

  const techContainer = div.querySelector(".tech-checkboxes");
  empList.forEach(emp=>techContainer.appendChild(createTechBox(emp)));

  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3
  techContainer.addEventListener("change", e=>{
    if(e.target.name==="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"){
      const selected=techContainer.querySelectorAll('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]:checked');
      if(selected.length>3){
        e.target.checked=false;
        alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô");
      }
    }
  });

  // Logic ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ä‡πà‡∏≤‡∏á
  techContainer.querySelectorAll('input[type="checkbox"][name^="autoCopy_"]').forEach(cb=>{
  cb.addEventListener("change", ()=>{
    if(!cb.checked) return;
    const code = cb.name.replace("autoCopy_","");
    const sourceDiv = techContainer.querySelector(`input[value="${code}"]`).closest(".tech-checkbox");
    const data = {
      comment: sourceDiv.querySelector(`textarea[name="comment_${code}"]`).value,
      start: sourceDiv.querySelector(`input[name="start_${code}"]`).value,
      end: sourceDiv.querySelector(`input[name="end_${code}"]`).value,
      status: [...sourceDiv.querySelectorAll(`input[name="status_${code}"]:checked`)].map(c=>c.value)
    };
    techContainer.querySelectorAll(".tech-checkbox").forEach(tc=>{
      const empCode = tc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').value;
      if(empCode!==code){
        tc.querySelector(`textarea[name="comment_${empCode}"]`).value = data.comment;
        tc.querySelector(`input[name="start_${empCode}"]`).value = data.start;
        tc.querySelector(`input[name="end_${empCode}"]`).value = data.end;
        tc.querySelectorAll(`input[name="status_${empCode}"]`).forEach(cbx=>{
          cbx.checked = data.status.includes(cbx.value);
        });
      }
    });
  });
});
function copyFirstTechTimeInMachine(machine){
  const techs = machine.querySelectorAll(".tech-checkbox");
  if(techs.length === 0) return;

  const firstTc = techs[0];

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á copy
  const startInput = firstTc.querySelector('input[name^="start_"]');
  const endInput = firstTc.querySelector('input[name^="end_"]');
  if(!startInput.value || !endInput.value) return;

  const startVal = startInput.value;
  const endVal = endInput.value;

  techs.forEach(tc=>{
    if(tc === firstTc) return;
    const empCode = tc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').value;
    tc.querySelector(`input[name="start_${empCode}"]`).value = startVal;
    tc.querySelector(`input[name="end_${empCode}"]`).value = endVal;
  });
}


function copyFirstTechTimeInMachine(machine){
  const techs = machine.querySelectorAll(".tech-checkbox");
  if(techs.length === 0) return;

  const firstTc = techs[0];
  const startVal = firstTc.querySelector('input[name^="start_"]').value;
  const endVal = firstTc.querySelector('input[name^="end_"]').value;

  techs.forEach(tc=>{
    if(tc === firstTc) return;
    const empCode = tc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').value;
    tc.querySelector(`input[name="start_${empCode}"]`).value = startVal;
    tc.querySelector(`input[name="end_${empCode}"]`).value = endVal;
  });
}

  // Autocomplete ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
  const searchInput = div.querySelector(".machineSearch");
  const ul = div.querySelector(".machineList");
  const hiddenInput = div.querySelector(".machineCodeHidden");
  searchInput.addEventListener("input", ()=>{
    const val=searchInput.value.toLowerCase();
    const filtered = machineList.filter(m=>
      m.DeptCode===$("deptCodeHidden").value &&
      (m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]||"").toLowerCase().includes(val)
    );
    ul.innerHTML="";
    filtered.forEach(m=>{
      const li=document.createElement("li");
      li.textContent = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
      li.dataset.code = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      li.className="px-3 py-1 hover:bg-blue-100 cursor-pointer";
      li.onclick=()=>{
        searchInput.value=li.textContent;
        hiddenInput.value=li.dataset.code;
        ul.classList.add("hidden");
      };
      ul.appendChild(li);
    });
    ul.classList.toggle("hidden", filtered.length===0);
  });

  return div;
}

// ----- ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞ Checkbox ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å‡πÑ‡∏õ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ----- //
function copyFirstMachineTechToAllMachines(){
  const machines = document.querySelectorAll(".machine-container");
  if(machines.length < 2) return;

  const firstMachine = machines[0];
  const firstTechs = firstMachine.querySelectorAll(".tech-checkbox");

  machines.forEach((machine, idx) => {
    if(idx === 0) return; // skip ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å
    const techs = machine.querySelectorAll(".tech-checkbox");
    techs.forEach(tc => {
      const empCode = tc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').value;
      const firstTc = Array.from(firstTechs).find(f => 
        f.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').value === empCode
      );
      if(firstTc){
        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å checkbox
        tc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').checked =
          firstTc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').checked;
        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å start/end ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏Å
        const startVal = firstTc.querySelector(`input[name="start_${empCode}"]`).value;
        const endVal = firstTc.querySelector(`input[name="end_${empCode}"]`).value;
        if(startVal) tc.querySelector(`input[name="start_${empCode}"]`).value = startVal;
        if(endVal) tc.querySelector(`input[name="end_${empCode}"]`).value = endVal;
      }
    });
  });
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å
document.addEventListener("change", e => {
  const machines = document.querySelectorAll(".machine-container");
  if(machines.length === 0) return;
  if(e.target.closest(".machine-container") === machines[0]){
    copyFirstMachineTechToAllMachines();
  }
});


// ------- Department search -------
$("deptSearch").addEventListener("input", e=>{
  const val=e.target.value.toLowerCase();
  const ul=$("deptList");
  ul.innerHTML="";
  deptList
    .filter(d=>`${d.NickName||""} : ${d.DeptName||""}`.toLowerCase().includes(val))
    .forEach(d=>{
      const li=document.createElement("li");
      li.textContent=`${d.NickName} : ${d.DeptName}`;
      li.dataset.code=d.DeptCode;
      li.className="px-3 py-1 hover:bg-blue-100 cursor-pointer";
      li.onclick=()=>{
        $("deptSearch").value=li.textContent;
        $("deptCodeHidden").value=li.dataset.code;
        ul.classList.add("hidden");
        $("pmGroupSearch").disabled=false;

        // üïí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
        deptSelectStartTime = new Date();
      };
      ul.appendChild(li);
    });
  $("deptList").classList.remove("hidden");
});

function copyFirstMachineTechToAllMachines(){
  const machines = document.querySelectorAll(".machine-container");
  if(machines.length < 2) return;

  const firstMachine = machines[0];
  const firstTechs = firstMachine.querySelectorAll(".tech-checkbox");

  machines.forEach((machine, idx) => {
    if(idx === 0) return; // skip ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å

    const techs = machine.querySelectorAll(".tech-checkbox");
    techs.forEach(tc => {
      const empCode = tc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').value;
      const firstTc = Array.from(firstTechs).find(f => 
        f.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').value === empCode
      );
      if(firstTc){
        tc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').checked =
          firstTc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').checked;
        tc.querySelector(`input[name="start_${empCode}"]`).value =
          firstTc.querySelector(`input[name="start_${empCode}"]`).value;
        tc.querySelector(`input[name="end_${empCode}"]`).value =
          firstTc.querySelector(`input[name="end_${empCode}"]`).value;
      }
    });
  });
}

// ------- PM Group search -------
$("pmGroupSearch").addEventListener("input", ()=>{
  if(!$("deptCodeHidden").value){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
    $("pmGroupSearch").value="";
    return;
  }
  const val=$("pmGroupSearch").value.toLowerCase();
  const ul=$("pmGroupList");
  ul.innerHTML="";
  groupList
    .filter(g=>g.DeptCode===$("deptCodeHidden").value && (g.GroupName||"").toLowerCase().includes(val))
    .forEach(g=>{
      const li=document.createElement("li");
      li.textContent=g.GroupName;
      li.dataset.code=g.GroupCode;
      li.className="px-3 py-1 hover:bg-blue-100 cursor-pointer";
      li.onclick=()=>{
        $("pmGroupSearch").value=li.textContent;
        ul.classList.add("hidden");

        const machinesInGroup = machineList.filter(m=>
          m.GroupCode==li.dataset.code && m.DeptCode===$("deptCodeHidden").value
        );
        $("machinesContainer").innerHTML="";

        // üïí ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ (GMT+7)
        function formatDateLocal(date) {
          const tzOffset = 7 * 60; // +7 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
          const local = new Date(date.getTime() + tzOffset * 60000);
          return local.toISOString().slice(0, 16);
        }

        let prevEndTime = new Date();
        machinesInGroup.forEach(m=>{
          const row = createMachineRow();

          const pmMinutes = parseInt(m.PmTime) || 10;
          const startStr = formatDateLocal(prevEndTime);
          const endTime = new Date(prevEndTime.getTime() + pmMinutes * 60000);
          const endStr = formatDateLocal(endTime);
          prevEndTime = endTime;

          row.querySelector(".machineSearch").value = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
          row.querySelector(".machineCodeHidden").value = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
          row.querySelector('textarea[name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"]').value =
            m["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"] || "PM ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î";
          row.querySelector('textarea[name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"]').value =
            m["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"] || "‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î PM";

          row.querySelectorAll(".tech-checkbox").forEach(tc=>{
            const empCode = tc.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]').value;
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏ï‡∏¥‡∏° start/end ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            // tc.querySelector(`input[name="start_${empCode}"]`).value = startStr;
            // tc.querySelector(`input[name="end_${empCode}"]`).value = endStr;
            tc.querySelectorAll(`input[name="status_${empCode}"]`).forEach(cbx=>{
              cbx.checked = (cbx.value==="‡∏à‡∏ö‡∏á‡∏≤‡∏ô");
            });
            tc.querySelector(`textarea[name="comment_${empCode}"]`).value =
              g["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"] || "";
          });

          $("machinesContainer").appendChild(row);
          
        });        
      };
      ul.appendChild(li);
    });
  $("pmGroupList").classList.remove("hidden");
});

// ------- Add machine manually -------
$("btnAddMachine").addEventListener("click", ()=>{
  if(!$("deptCodeHidden").value){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  $("machinesContainer").appendChild(createMachineRow());
});

// ------- Reset form -------
$("btnResetForm").addEventListener("click", ()=>{
  $("repairForm").reset();
  $("machinesContainer").innerHTML="";
  generateNextRequestNumber();
});

// ------- ‡πÅ‡∏õ‡∏•‡∏á "‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ" ‡πÄ‡∏õ‡πá‡∏ô HH:MM:SS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Time -------
function secondsToTimeStr(seconds) {
  if (seconds == null) return null;
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  const hh = h.toString().padStart(2, '0');
  const mm = m.toString().padStart(2, '0');
  const ss = s.toString().padStart(2, '0');
  return `${hh}:${mm}:${ss}`;
}

// ‡πÅ‡∏õ‡∏•‡∏á Date ‚Üí HH:MM:SS
function toTimeStr(date){
  if(!date) return null;
  const h = String(date.getHours()).padStart(2,'0');
  const m = String(date.getMinutes()).padStart(2,'0');
  const s = String(date.getSeconds()).padStart(2,'0');
  return `${h}:${m}:${s}`;
}


// ‡πÅ‡∏õ‡∏•‡∏á Date ‚Üí ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö datetime-local ‡∏Ç‡∏≠‡∏á AppSheet
function toThaiDateTimeLocalStr(date){
  if(!date) return null;
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° GMT+7
  const localDate = new Date(date.getTime() + 7*60*60*1000);
  const yyyy = localDate.getFullYear();
  const mm = String(localDate.getMonth()+1).padStart(2,'0');
  const dd = String(localDate.getDate()).padStart(2,'0');
  const hh = String(localDate.getHours()).padStart(2,'0');
  const min = String(localDate.getMinutes()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
}


// ------- Submit -------
$("repairForm").addEventListener("submit", async e=>{
  e.preventDefault();

  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  if (document.querySelectorAll(".machine-container").length === 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    return;
  }

  // üïí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
  let useSeconds = null;
  if (deptSelectStartTime) {
    const now = new Date();
    const diffMs = now - deptSelectStartTime;   // ms
    useSeconds = Math.round(diffMs / 1000);     // ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  }

  const submitBtn=$("submitBtn");
  submitBtn.disabled=true;
  submitBtn.textContent="‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

  try{
    const form = $("repairForm");
    const reqNum = form.querySelector('input[name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]').value;
    const dept = $("deptCodeHidden").value;
    const machines = [...form.querySelectorAll(".machine-container")];

    let techniciansRows=[], partsRows=[];

    machines.forEach(machine=>{
      const machineCode = machine.querySelector(".machineCodeHidden").value;
      const detail = machine.querySelector('textarea[name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"]').value;
      const cause = machine.querySelector('textarea[name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"]').value;

      const techs = [...machine.querySelectorAll('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]:checked')].map(checkbox=>{
        const code=checkbox.value;
        return {
          EmpCode: code,
          comment: machine.querySelector(`textarea[name="comment_${code}"]`).value,
          start: machine.querySelector(`input[name="start_${code}"]`).value,
          end: machine.querySelector(`input[name="end_${code}"]`).value,
          status: [...machine.querySelectorAll(`input[name="status_${code}"]:checked`)]
                    .map(c=>c.value).join(",")
        };
      });

      const parts = [...machine.querySelectorAll(".parts-row")].map((p, idx)=>({
        Seq: idx+1,
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà: p.querySelector('input[name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"]').value,
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: p.querySelector('input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]').value,
        ‡∏´‡∏ô‡πà‡∏ß‡∏¢: p.querySelector('input[name="‡∏´‡∏ô‡πà‡∏ß‡∏¢"]').value
      }));

      // rows ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RepairTechnicians
      techs.forEach(t=>{
        techniciansRows.push({
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNum,
          "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": dept,
          "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
          "EmpCode": t.EmpCode,
          "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": detail,
          "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": cause,
          "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": t.comment,
          "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": t.start,
          "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": t.end,
          "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": t.status,
    "StartBeforeSave": toTimeStr(deptSelectStartTime),
    "EndBeforeSave": toTimeStr(new Date()),
    "TimeBeforeSave": useSeconds != null ? secondsToTimeStr(useSeconds) : null
        });
      });

      // ‡∏´‡∏≤ EmpCode ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å (‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà)
      const firstTech = machine.querySelector('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]:checked');
      const empCode = firstTech ? firstTech.value : "";

      // rows ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RepairParts
      parts.forEach(p=>{
        partsRows.push({
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNum,
          "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
          "EmpCode": empCode,
          "Seq": p.Seq,
          "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": p["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"],
          "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": p["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"],
          "‡∏´‡∏ô‡πà‡∏ß‡∏¢": p["‡∏´‡∏ô‡πà‡∏ß‡∏¢"]
        });
      });
    });

    // Push to AppSheet RepairTechnicians
    await fetch(`${apiBase}RepairTechnicians/Batch`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body: JSON.stringify({Action:"Add",Rows:techniciansRows})
    });

    // Push to AppSheet RepairParts
    await fetch(`${apiBase}RepairParts/Batch`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body: JSON.stringify({Action:"Add",Rows:partsRows})
    });

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    $("repairForm").reset();
    $("machinesContainer").innerHTML="";
    generateNextRequestNumber();
    deptSelectStartTime = null; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏ß‡∏•‡∏≤
  }catch(err){
    console.error(err);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚ùå\n‡∏î‡∏π‡πÉ‡∏ô Console ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ");
  } finally{
    submitBtn.disabled=false;
    submitBtn.textContent="‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  }
});

// ------- Init -------
(async function init(){
  await Promise.all([loadDepartments(), loadMachines(), loadTechnicians(), loadGroups()]);
  await generateNextRequestNumber();
})();
</script>
</body>
</html>
