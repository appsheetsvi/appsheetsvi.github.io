<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f0f9ff; min-height: 100vh; }
    .tech-checkboxes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      padding: 0;
    }
    .tech-checkboxes > div {
      background: #f9fafb;
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .parts-row {
      display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;
    }
    .parts-row > * {
      flex: 1 1 120px;
    }
    .btn-remove-part {
      background: #ef4444;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-remove-part:hover {
      background: #b91c1c;
    }
    #machineList {
      max-height: 200px; 
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <main class="max-w-6xl mx-auto mt-10 p-6 bg-white rounded-xl shadow">
    <h1 class="text-2xl font-bold text-blue-700 text-center mb-6">üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h1>
    <form id="repairForm" class="grid grid-cols-1 gap-6" autocomplete="off">
      <div>
        <label class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" readonly class="w-full border rounded p-2 bg-gray-100" />
      </div>

      <div>
        <label class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
        <select name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" id="deptSelect" required class="w-full border rounded p-2"></select>
      </div>

      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <div class="relative">
          <input type="text" id="machineSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." class="w-full border rounded p-2" />
          <ul id="machineList" class="absolute z-10 bg-white border border-gray-300 w-full rounded mt-1 hidden"></ul>
        </div>
        <input type="hidden" name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" id="machineCodeHidden" required />
      </div>

      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢" class="w-full border rounded p-2" rows="3" required></textarea>
      </div>

      <div>
        <label class="font-semibold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏" class="w-full border rounded p-2" rows="2"></textarea>
      </div>

      <div>
        <label class="font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô)</label>
        <div id="techCheckboxes" class="tech-checkboxes"></div>
      </div>

      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
        <div id="partsContainer"></div>
        <button type="button" id="btnAddPart" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
      </div>

      <div class="text-center mt-4">
        <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg text-lg">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </form>
  </main>

<script>
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
  const apiBase = `https://api.appsheet.com/api/v2/apps/${appId}/tables/`;

  let machineList = [];
  let empList = [];

  async function fetchFromTable(table, filter = {}) {
    const res = await fetch(`${apiBase}${table}/Find`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify({ filter })
    });
    if(!res.ok) {
      console.error("Fetch error:", res.statusText);
      return [];
    }
    return await res.json();
  }

  async function loadDepartments() {
    const list = await fetchFromTable("Department");
    const sel = document.getElementById("deptSelect");
    sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>`;
    list.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.DeptCode;
      opt.textContent = d.DeptNameEng || d.DeptName || d.DeptCode;
      sel.appendChild(opt);
    });
  }

  async function loadMachinesByDept(deptCode) {
    const list = await fetchFromTable("MachineMaster");
    machineList = list.filter(m => m.DeptCode === deptCode);
    renderMachineList(machineList);
  }

  function renderMachineList(list) {
    const ul = document.getElementById("machineList");
    ul.innerHTML = "";
    if (list.length === 0) {
      ul.classList.add("hidden");
      return;
    }
    list.forEach(m => {
      const li = document.createElement("li");
      li.textContent = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
      li.dataset.code = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      li.className = "px-3 py-2 hover:bg-blue-100 cursor-pointer";
      li.onclick = () => {
        document.getElementById("machineSearch").value = li.textContent;
        document.getElementById("machineCodeHidden").value = li.dataset.code;
        ul.classList.add("hidden");
      };
      ul.appendChild(li);
    });
    ul.classList.remove("hidden");
  }

  function filterMachines() {
    const val = document.getElementById("machineSearch").value.toLowerCase();
    const filtered = machineList.filter(m =>
      (m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] + " " + m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]).toLowerCase().includes(val)
    );
    renderMachineList(filtered);
  }

  async function generateNextRequestNumber() {
    const list = await fetchFromTable("Machinesymptom");
    const nums = list.map(r => parseInt(r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"])).filter(n => !isNaN(n));
    const next = Math.max(...nums, 0) + 1;
    document.querySelector('[name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]').value = String(next);
  }

  async function loadTechnicians() {
    const allEmps = await fetchFromTable("Emp");
    empList = allEmps.filter(emp => emp.DeptCode?.toUpperCase() === "A12" && (emp.EmpStatus === 0 || emp.EmpStatus === "0"));

    const container = document.getElementById("techCheckboxes");
    container.innerHTML = "";

    empList.forEach(emp => {
      const id = `emp_${emp.EmpCode}`;
      const wrapper = document.createElement("div");

      // Checkbox + ‡∏ä‡∏∑‡πà‡∏≠
      const label = document.createElement("label");
      label.className = "inline-flex items-center space-x-2 font-semibold";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = "‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö";
      checkbox.value = emp.EmpCode;
      checkbox.id = id;
      label.appendChild(checkbox);
      const span = document.createElement("span");
      span.textContent = emp.EmpName;
      label.appendChild(span);
      wrapper.appendChild(label);

      // textarea ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
      const textarea = document.createElement("textarea");
      textarea.name = `comment_${emp.EmpCode}`;
      textarea.placeholder = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô";
      textarea.className = "w-full mt-2 border rounded p-2 text-sm";
      wrapper.appendChild(textarea);

      // container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö
      const dateContainer = document.createElement("div");
      dateContainer.className = "flex gap-4 mt-2 flex-wrap";

      const startWrapper = document.createElement("div");
      startWrapper.className = "flex flex-col flex-1 min-w-[120px]";
      const startLabel = document.createElement("label");
      startLabel.textContent = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°";
      startLabel.className = "text-xs font-semibold mb-1";
      const startInput = document.createElement("input");
      startInput.type = "datetime-local";
      startInput.name = `start_${emp.EmpCode}`;
      startInput.className = "border rounded p-2 text-sm";
      startWrapper.appendChild(startLabel);
      startWrapper.appendChild(startInput);

      const endWrapper = document.createElement("div");
      endWrapper.className = "flex flex-col flex-1 min-w-[120px]";
      const endLabel = document.createElement("label");
      endLabel.textContent = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö";
      endLabel.className = "text-xs font-semibold mb-1";
      const endInput = document.createElement("input");
      endInput.type = "datetime-local";
      endInput.name = `end_${emp.EmpCode}`;
      endInput.className = "border rounded p-2 text-sm";
      endWrapper.appendChild(endLabel);
      endWrapper.appendChild(endInput);

      dateContainer.appendChild(startWrapper);
      dateContainer.appendChild(endWrapper);
      wrapper.appendChild(dateContainer);

      // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡πÅ‡∏ö‡∏ö radio button
      const statusLabel = document.createElement("div");
      statusLabel.className = "mt-2 font-semibold";
      statusLabel.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á:";
      wrapper.appendChild(statusLabel);

      const statuses = ["‡∏à‡∏ö‡∏á‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô"];
      const statusWrapper = document.createElement("div");
      statusWrapper.className = "flex gap-4 mt-1";

      statuses.forEach(status => {
        const spanLabel = document.createElement("label");
        spanLabel.className = "inline-flex items-center space-x-1 cursor-pointer";

        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = `status_${emp.EmpCode}`;
        radio.value = status;

        spanLabel.appendChild(radio);
        spanLabel.appendChild(document.createTextNode(status));
        statusWrapper.appendChild(spanLabel);
      });

      wrapper.appendChild(statusWrapper);

      container.appendChild(wrapper);
    });

    // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô
    container.addEventListener("change", e => {
      if (e.target.name === "‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö") {
        const checkedBoxes = container.querySelectorAll('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]:checked');
        if (checkedBoxes.length > 3) {
          e.target.checked = false;
          alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        }
      }
    });
  }

  function createPartRow() {
    const div = document.createElement("div");
    div.className = "parts-row";

    const partInput = document.createElement("input");
    partInput.type = "text";
    partInput.name = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà";
    partInput.placeholder = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà";
    partInput.className = "border rounded p-2";

    const qtyInput = document.createElement("input");
    qtyInput.type = "number";
    qtyInput.name = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô";
    qtyInput.min = "1";
    qtyInput.value = 1;
    qtyInput.className = "border rounded p-2";

    const unitInput = document.createElement("input");
    unitInput.type = "text";
    unitInput.name = "‡∏´‡∏ô‡πà‡∏ß‡∏¢";
    unitInput.placeholder = "‡∏´‡∏ô‡πà‡∏ß‡∏¢";
    unitInput.className = "border rounded p-2";

    const btnRemove = document.createElement("button");
    btnRemove.type = "button";
    btnRemove.className = "btn-remove-part";
    btnRemove.textContent = "x";
    btnRemove.title = "‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà";
    btnRemove.onclick = () => div.remove();

    div.appendChild(partInput);
    div.appendChild(qtyInput);
    div.appendChild(unitInput);
    div.appendChild(btnRemove);

    return div;
  }

  function addPartRow() {
    document.getElementById("partsContainer").appendChild(createPartRow());
  }

  function toISOStringFromLocalDatetime(s) {
    if (!s) return null;
    const d = new Date(s);
    return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString();
  }

  let submitting = false;

  async function submitForm(e) {
    e.preventDefault();
    if (submitting) return;
    submitting = true;
    document.getElementById("submitBtn").disabled = true;

    const form = e.target;
    const fd = new FormData(form);

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
    const requiredFields = [
      "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°",
      "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô",
      "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á",
      "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á",
      "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"
    ];
    for(const field of requiredFields){
      if(field === "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"){
        if(!document.getElementById("machineSearch").value.trim()){
          alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
          submitting = false;
          document.getElementById("submitBtn").disabled = false;
          return;
        }
      } else {
        const val = fd.get(field);
        if(!val || val.toString().trim() === ""){
          alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≠‡∏á "${field}" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
          submitting = false;
          document.getElementById("submitBtn").disabled = false;
          return;
        }
      }
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 1 ‡∏Ñ‡∏ô
    const selectedTechs = Array.from(form.querySelectorAll('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]:checked')).map(i => i.value);
    if(selectedTechs.length === 0) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô");
      submitting = false;
      document.getElementById("submitBtn").disabled = false;
      return;
    }

    const dataMain = {};
    for (let [k,v] of fd.entries()) {
      if (!k.startsWith("comment_") && !k.startsWith("start_") && !k.startsWith("end_") && !k.startsWith("status_") && !["‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö","‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô","‡∏´‡∏ô‡πà‡∏ß‡∏¢"].includes(k)) {
        dataMain[k] = v;
      }
    }

    const techDataList = selectedTechs.map(empCode => ({
      EmpCode: empCode,
      comment: form.querySelector(`textarea[name="comment_${empCode}"]`).value.trim(),
      start: toISOStringFromLocalDatetime(form.querySelector(`input[name="start_${empCode}"]`).value),
      end: toISOStringFromLocalDatetime(form.querySelector(`input[name="end_${empCode}"]`).value),
      status: (() => {
        const radios = form.querySelectorAll(`input[name="status_${empCode}"]`);
        for (const r of radios) if(r.checked) return r.value;
        return "";
      })()
    }));

    const partsEls = document.querySelectorAll("#partsContainer > .parts-row");

    let validParts = true;
    const partsData = [];
    partsEls.forEach(row => {
      const item = row.querySelector('input[name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"]').value.trim();
      const qty = row.querySelector('input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]').value;
      const unit = row.querySelector('input[name="‡∏´‡∏ô‡πà‡∏ß‡∏¢"]').value.trim();

      if(item === "") return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà

      if (!qty || !unit) validParts = false;

      partsData.push({ "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": item, "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": parseInt(qty), "‡∏´‡∏ô‡πà‡∏ß‡∏¢": unit });
    });

    if(!validParts) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
      submitting = false;
      document.getElementById("submitBtn").disabled = false;
      return;
    }

    try {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
      const resMain = await fetch(`${apiBase}Machinesymptom/Add`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({ Action: "Add", Rows: [dataMain] })
      });
      if(!resMain.ok) throw "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á
      for (const tech of techDataList) {
        const techData = {
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": dataMain["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"],
          "EmpCode": tech.EmpCode,
          "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": tech.comment,
          "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": tech.start,
          "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": tech.end,
          "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": tech.status
        };

        const resTech = await fetch(`${apiBase}RepairTechnicians/Add`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey
          },
          body: JSON.stringify({ Action: "Add", Rows: [techData] })
        });
        if(!resTech.ok) throw `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏≤‡∏á ${tech.EmpCode} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
      }

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
      for (const tech of techDataList) {
        for (const part of partsData) {
          const partData = {
            "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": dataMain["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"],
            "EmpCode": tech.EmpCode,
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": part["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"],
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": part["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"],
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢": part["‡∏´‡∏ô‡πà‡∏ß‡∏¢"]
          };
          const resPart = await fetch(`${apiBase}RepairParts/Add`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ApplicationAccessKey": apiKey
            },
            body: JSON.stringify({ Action: "Add", Rows: [partData] })
          });
          if(!resPart.ok) throw `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà ${part["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"]} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á ${tech.EmpCode} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
        }
      }

      alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      form.reset();
      document.getElementById("machineCodeHidden").value = "";
      await generateNextRequestNumber();
      document.getElementById("partsContainer").innerHTML = "";
      addPartRow();
    } catch(err) {
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
    } finally {
      submitting = false;
      document.getElementById("submitBtn").disabled = false;
    }
  }

  // event listeners
  document.getElementById("deptSelect").addEventListener("change", (e) => {
    const val = e.target.value;
    if(val) loadMachinesByDept(val);
    else {
      machineList = [];
      renderMachineList([]);
    }
    document.getElementById("machineSearch").value = "";
    document.getElementById("machineCodeHidden").value = "";
  });

  document.getElementById("machineSearch").addEventListener("input", filterMachines);

  document.addEventListener("click", e => {
    if (!document.getElementById("machineList").contains(e.target) && e.target !== document.getElementById("machineSearch")) {
      document.getElementById("machineList").classList.add("hidden");
    }
  });

  document.getElementById("btnAddPart").addEventListener("click", addPartRow);
  document.getElementById("repairForm").addEventListener("submit", submitForm);

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  (async () => {
    await loadDepartments();
    await loadTechnicians();
    addPartRow();
    await generateNextRequestNumber();
  })();

</script>
</body>
</html>
