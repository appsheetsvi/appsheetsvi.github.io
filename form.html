<html lang="th">
<head class="bg-blue-600 text-white p-4 shadow">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f0f9ff;
      min-height: 100vh;
      padding: 1rem;
    }
    main {
      max-width: 700px;
      margin: auto;
      background: white;
      border-radius: 1rem;
      padding: 2rem 2.5rem;
      box-shadow: 0 8px 20px rgb(14 165 233 / 0.3);
    }
    h1 {
      color: #2563eb;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: #1e40af;
    }
    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select,
    textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 2px solid #93c5fd;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="datetime-local"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 8px #3b82f6aa;
      background-color: #f0f9ff;
    }
    input[readonly] {
      background-color: #e0e7ff;
      cursor: not-allowed;
      color: #4b5563;
    }
    .select-searchable {
      position: relative;
      margin-bottom: 1rem;
    }
    .select-searchable ul {
      position: absolute;
      top: 105%;
      left: 0;
      right: 0;
      background: white;
      border: 1.5px solid #93c5fd;
      border-radius: 0.5rem;
      max-height: 220px;
      overflow-y: auto;
      z-index: 9999;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      margin-top: 0.25rem;
      list-style: none;
      padding-left: 0;
      display: none;
    }
    .select-searchable ul.show {
      display: block;
    }
    .select-searchable li {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    .select-searchable li:hover {
      background-color: #bfdbfe;
    }
    .parts-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      align-items: center;
    }
    .parts-row > * {
      flex: 1;
    }
    .btn-remove-part {
      background: #ef4444;
      color: white;
      padding: 0.3rem 0.7rem;
      border-radius: 0.5rem;
      cursor: pointer;
      flex-shrink: 0;
      font-weight: bold;
      transition: background-color 0.3s ease;
      border: none;
    }
    .btn-remove-part:hover {
      background: #b91c1c;
    }
    .tech-checkboxes {
      max-height: 140px;
      overflow-y: auto;
      border: 2px solid #93c5fd;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      background: #eff6ff;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 1.5rem;
    }
    .tech-checkboxes label {
      cursor: pointer;
      font-weight: 600;
      color: #1e40af;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .tech-checkboxes input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #2563eb;
      cursor: pointer;
    }
    button[type="submit"],
    #btnAddPart {
      background: #2563eb;
      color: white;
      font-weight: 600;
      border-radius: 0.75rem;
      padding: 0.6rem 1.5rem;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 10px rgb(37 99 235 / 0.4);
      border: none;
    }
    button[type="submit"]:hover,
    #btnAddPart:hover {
      background: #1e40af;
      box-shadow: 0 5px 15px rgb(30 64 175 / 0.7);
    }
    .footer-text {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.8rem;
      color: #64748b;
      user-select: none;
    }

    /* Custom grid layout for paired fields */
    .form-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .form-row > div {
      flex: 1 1 48%;
      min-width: 220px;
    }
  </style>
  <!-- ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->

</head>
<body>
<nav class="bg-white shadow-md fixed w-full z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-16">
      <!-- ‡πÇ‡∏•‡πÇ‡∏Å‡πâ -->
      <div class="flex items-center">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Logo" class="h-8 w-8 mr-2">
        <span class="font-semibold text-lg text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</span>
      </div>

      <!-- ‡πÄ‡∏°‡∏ô‡∏π -->
      <div class="hidden md:flex space-x-4 items-center">
        <a href="https://appsheetsvi.github.io/Menu.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 text-sm font-medium">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        <a href="#" class="text-gray-700 hover:text-blue-600 px-3 py-2 text-sm font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
        <a href="#" class="text-gray-700 hover:text-blue-600 px-3 py-2 text-sm font-medium">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</a>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
      <div class="md:hidden flex items-center">
        <button id="mobile-menu-button" class="focus:outline-none">
          <svg class="h-6 w-6 text-gray-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
  <div id="mobile-menu" class="md:hidden hidden px-4 pb-3 space-y-1 bg-white shadow">
    <a href="https://appsheetsvi.github.io/Menu.html" class="block text-gray-700 hover:text-blue-600 px-3 py-2 text-base font-medium">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    <a href="#" class="block text-gray-700 hover:text-blue-600 px-3 py-2 text-base font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
    <a href="#" class="block text-gray-700 hover:text-blue-600 px-3 py-2 text-base font-medium">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</a>
  </div>
</nav>

  <main>
    <h1 class="text-center text-3xl mb-8"></h1>
    <form id="repairForm" class="space-y-6" autocomplete="off">

      <!-- ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° -->
      <div>
        <label for="requestNo">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input id="requestNo" name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" readonly placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ" />
      </div>

      <!-- ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô -->
      <div class="form-row">
        <div>
          <label for="deptSelect">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
          <select id="deptSelect" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" required>
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>
          </select>
        </div>
        <div>
          <label for="jobTypeSelect">‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label>
          <select id="jobTypeSelect" name="‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô" required>
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô --</option>
          </select>
        </div>
      </div>

      <!-- ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1 -->
      <div class="form-row">
        
        <div>
          <label for="machineSearch1">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1</label>
          <div class="select-searchable">
            <input type="text" id="machineSearch1" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1..." autocomplete="off" />
            <ul id="machineList1"></ul>
          </div>
          <input type="hidden" id="machineCodeHidden1" name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" />
        </div>
       <div>
          <label for="machineSearchCode">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
          <div class="select-searchable">
            <input type="text" id="machineSearchCode" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." autocomplete="off" />
            <ul id="machineListCode"></ul>
          </div>
          <input type="hidden" id="machineCodeHiddenCode" name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" required />
        </div>
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢ -->
      <div>
        <label for="problemDetail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea id="problemDetail" name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢" rows="3" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"></textarea>
      </div>

      <!-- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ -->
      <div>
        <label for="causeAnalysis">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="causeAnalysis" name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
      </div>

      <!-- ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
      <div>
        <label for="repairComment">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
        <textarea id="repairComment" name="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"></textarea>
      </div>

      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏à‡∏≥‡∏Å‡∏±‡∏î 3 ‡∏Ñ‡∏ô) -->
      <div>
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
        <div id="techCheckboxes" class="tech-checkboxes"></div>
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà -->
      <div>
        <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
        <div id="partsContainer"></div>
        <button type="button" id="btnAddPart" class="mt-2 w-full max-w-xs">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
      </div>

      <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° ‡∏Å‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à -->
      <div class="form-row">
        <div>
          <label for="dateReport">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
          <input type="datetime-local" id="dateReport" name="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" required />
        </div>
        <div>
          <label for="dateFinish">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</label>
          <input type="datetime-local" id="dateFinish" name="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à" />
        </div>
      </div>

      <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á -->
      <div>
        <label for="machineStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <select id="machineStatus" name="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" required>
          <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
          <option value="‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</option>
          <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
          <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏°">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏°</option>
        </select>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
      <div class="text-center">
        <button type="submit" class="w-full max-w-sm">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <p class="footer-text">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <strong>1.1</strong></p>
      </div>
    </form>
  </main>

<script>
  
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
  const apiBase = `https://api.appsheet.com/api/v2/apps/${appId}/tables/`;

  let machineList = [];
  let unitList = [];
  let empList = [];

  async function fetchFromTable(table, filter = {}) {
    try {
      const res = await fetch(`${apiBase}${table}/Find`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({ filter })
      });
      if (!res.ok) throw new Error(`Fetch error: ${res.status}`);
      return await res.json();
    } catch (e) {
      console.error(e);
      return [];
    }
  }

  async function loadDepartments() {
    const list = await fetchFromTable("Department");
    const sel = document.getElementById("deptSelect");
    sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>`;
    list.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.DeptCode;
      opt.textContent = d.DeptNameEng || d.DeptName || d.DeptCode;
      sel.appendChild(opt);
    });
  }

 async function loadJobTypes() {
  const list = await fetchFromTable("MachineJobType");
  const sel = document.getElementById("jobTypeSelect");
  sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô --</option>`;
  list.forEach(jt => {
    const opt = document.createElement("option");
    opt.value = jt.JobCode || jt['‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô'] || jt.Code || "";    // ‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô
    opt.textContent = jt.JobName || jt['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô'] || jt.Name || "";  // ‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô
    sel.appendChild(opt);
  });
}



  async function loadMachinesByDept(deptCode) {
    const list = await fetchFromTable("MachineMaster");
    machineList = list.filter(m => m.DeptCode === deptCode);
    // clear autocomplete lists
    clearAutocomplete('machineList1', 'machineSearch1', 'machineCodeHidden1');
    clearAutocomplete('machineListCode', 'machineSearchCode', 'machineCodeHiddenCode');
  }

  // Clear autocomplete input and hidden field & list
  function clearAutocomplete(ulId, inputId, hiddenId) {
    document.getElementById(ulId).innerHTML = "";
    document.getElementById(ulId).classList.remove("show");
    document.getElementById(inputId).value = "";
    document.getElementById(hiddenId).value = "";
  }

  function renderAutocomplete(list, ulId, inputId, hiddenId, mode) {
  const ul = document.getElementById(ulId);
  ul.innerHTML = "";
  if (list.length === 0) {
    ul.classList.remove("show");
    return;
  }

  if (mode === 'name') {
    const seenNames = new Map();
    list.forEach(m => {
      const name = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
      const code = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      if (name && !seenNames.has(name)) {
        seenNames.set(name, code);
      }
    });
    seenNames.forEach((code, name) => {
      const li = document.createElement("li");
      li.textContent = name;
      li.dataset.code = code;
      li.onclick = () => {
        document.getElementById(inputId).value = name;
        document.getElementById(hiddenId).value = code;
        ul.classList.remove("show");
      };
      ul.appendChild(li);
    });
  } else if (mode === 'code') {
    list.forEach(m => {
      const li = document.createElement("li");
      li.textContent = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      li.dataset.code = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      li.onclick = () => {
        document.getElementById(inputId).value = li.textContent;
        document.getElementById(hiddenId).value = li.dataset.code;
        ul.classList.remove("show");
      };
      ul.appendChild(li);
    });
  }

  ul.classList.add("show");
}


  function filterAutocomplete(inputId, ulId, hiddenId, mode) {
  const val = document.getElementById(inputId).value.toLowerCase();
  if (!val) {
    document.getElementById(ulId).classList.remove("show");
    document.getElementById(hiddenId).value = "";
    return;
  }

  let filtered;

  if (mode === 'name') {
    filtered = machineList.filter(m => (m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"] || "").toLowerCase().includes(val));
  } else if (mode === 'code') {
    // ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1 ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á machineSearch1
    const selectedName = document.getElementById("machineSearch1").value.trim();

    filtered = machineList.filter(m => {
      const matchCodeOrName = (m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] || "").toLowerCase().includes(val) ||
                              (m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"] || "").toLowerCase().includes(val);
      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1 ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const matchNameSelected = selectedName ? (m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"] === selectedName) : true;
      return matchCodeOrName && matchNameSelected;
    });
  }
  renderAutocomplete(filtered, ulId, inputId, hiddenId, mode);
}


  async function loadUnits() {
    const list = await fetchFromTable("Unit");
    unitList = list.map(u => u.Unit);
  }

  async function loadTechnicians() {
    const allEmps = await fetchFromTable("Emp");
    const filtered = allEmps.filter(emp => {
      const deptMatch = emp.DeptCode && emp.DeptCode.toString().toUpperCase() === "A12";
      const statusMatch = emp.EmpStatus === 0 || emp.EmpStatus === "0";
      return deptMatch && statusMatch;
    });
    empList = filtered;
    const container = document.getElementById("techCheckboxes");
    container.innerHTML = "";
    if (empList.length === 0) {
      container.innerHTML = "<p class='text-red-600'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å A12</p>";
      return;
    }
    empList.forEach(emp => {
      const id = `emp_${emp.EmpCode}`;
      const label = document.createElement("label");
      label.className = "inline-flex items-center space-x-2 cursor-pointer";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = "‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö";
      checkbox.value = emp.EmpCode;
      checkbox.id = id;
      checkbox.className = "form-checkbox h-5 w-5 text-blue-600";
      const span = document.createElement("span");
      span.textContent = `${emp.TitleName || ""} ${emp.EmpName || ""} ${emp.LastName || ""}`;
      span.className = "text-gray-700";
      label.appendChild(checkbox);
      label.appendChild(span);
      container.appendChild(label);
    });

    // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏Ñ‡∏ô
    container.querySelectorAll('input[type="checkbox"]').forEach(chk => {
      chk.addEventListener('change', e => {
        const checkedCount = container.querySelectorAll('input[type="checkbox"]:checked').length;
        if (checkedCount > 3) {
          e.target.checked = false;
          alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        }
      });
    });
  }

  function createPartRow() {
    const div = document.createElement("div");
    div.className = "parts-row";

    const partInput = document.createElement("input");
    partInput.type = "text";
    partInput.name = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà";
    partInput.placeholder = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà";
    partInput.required = true;

    const qtyInput = document.createElement("input");
    qtyInput.type = "number";
    qtyInput.name = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô";
    qtyInput.min = "1";
    qtyInput.value = 1;
    qtyInput.required = true;

    const unitSelect = document.createElement("select");
    unitSelect.name = "‡∏´‡∏ô‡πà‡∏ß‡∏¢";
    unitSelect.required = true;
    unitList.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u;
      opt.textContent = u;
      unitSelect.appendChild(opt);
    });

    const btnRemove = document.createElement("button");
    btnRemove.type = "button";
    btnRemove.className = "btn-remove-part";
    btnRemove.textContent = "x";
    btnRemove.title = "‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà";
    btnRemove.onclick = () => div.remove();

    div.appendChild(partInput);
    div.appendChild(qtyInput);
    div.appendChild(unitSelect);
    div.appendChild(btnRemove);

    return div;
  }

  function addPartRow() {
    const container = document.getElementById("partsContainer");
    container.appendChild(createPartRow());
  }

  async function generateNextRequestNumber() {
    const list = await fetchFromTable("Machinesymptom");
    const nums = list
      .map(r => r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"])
      .filter(n => /^\d+$/.test(n))
      .map(n => parseInt(n));
    const next = Math.max(...nums, 0) + 1;
    document.getElementById("requestNo").value = String(next);
  }

  function toISOStringFromLocalDatetime(s) {
    if (!s) return null;
    const d = new Date(s);
    return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString();
  }

  document.getElementById("repairForm").onsubmit = async e => {
    e.preventDefault();
    const form = e.target;
   
    const comment = document.getElementById("repairComment").value.trim();

    const dataMain = {};
    const fd = new FormData(form);
    for (let [k, v] of fd.entries()) {
      if (k === "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" || k === "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à") {
        dataMain[k] = toISOStringFromLocalDatetime(v);
      } else if (!["‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢"].includes(k)) {
        dataMain[k] = v;
      }
    }
    

    const selectedTechs = Array.from(form.querySelectorAll('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]:checked')).map(i => i.value);
    if (selectedTechs.length === 0) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô");
      return;
    }

    const partsEls = document.querySelectorAll("#partsContainer > .parts-row");
    if (partsEls.length === 0) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
      return;
    }

    const partsData = [];
    let validParts = true;
    partsEls.forEach(row => {
      const item = row.querySelector('input[name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"]').value.trim();
      const qty = row.querySelector('input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]').value;
      const unit = row.querySelector('select[name="‡∏´‡∏ô‡πà‡∏ß‡∏¢"]').value;
      if (!item || !qty || !unit) validParts = false;
      partsData.push({ "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": item, "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": parseInt(qty), "‡∏´‡∏ô‡πà‡∏ß‡∏¢": unit });
    });
    if (!validParts) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
      return;
    }

    try {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å Machinesymptom
      let resMain = await fetch(`${apiBase}Machinesymptom/Add`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({ Action: "Add", Rows: [dataMain] })
      });
      if (!resMain.ok) throw "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á RepairTechnicians
      for (let empCode of selectedTechs) {
        let techData = {
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": dataMain["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"],
          "EmpCode": empCode,
          "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": comment  // <<< ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á RepairTechnicians
     
        };
        let resTech = await fetch(`${apiBase}RepairTechnicians/Add`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey
          },
          body: JSON.stringify({ Action: "Add", Rows: [techData] })
        });
        if (!resTech.ok) throw "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      }

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà RepairParts
      for (let part of partsData) {
  let partData = {
    "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": dataMain["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"],
    "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": part["‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"],
    "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": part["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"],
    "‡∏´‡∏ô‡πà‡∏ß‡∏¢": part["‡∏´‡∏ô‡πà‡∏ß‡∏¢"],
    "EmpCode": selectedTechs[0]  // ‡πÄ‡∏≠‡∏≤ EmpCode ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
  };
  let resPart = await fetch(`${apiBase}RepairParts/Add`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "ApplicationAccessKey": apiKey
    },
    body: JSON.stringify({ Action: "Add", Rows: [partData] })
  });
  if (!resPart.ok) throw "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
}

      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
      form.reset();
      clearAutocomplete('machineList1', 'machineSearch1', 'machineCodeHidden1');
      clearAutocomplete('machineListCode', 'machineSearchCode', 'machineCodeHiddenCode');
      document.getElementById("partsContainer").innerHTML = "";
      await generateNextRequestNumber();

    } catch (error) {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error);
      console.error(error);
    }
  };

  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô list ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£
  document.getElementById("deptSelect").addEventListener("change", async e => {
    const dept = e.target.value;
    if (!dept) {
      machineList = [];
      clearAutocomplete('machineList1', 'machineSearch1', 'machineCodeHidden1');
      clearAutocomplete('machineListCode', 'machineSearchCode', 'machineCodeHiddenCode');
      return;
    }
    await loadMachinesByDept(dept);
  });

   const menuBtn = document.getElementById('mobile-menu-button');
  const menu = document.getElementById('mobile-menu');

  menuBtn.addEventListener('click', () => {
    menu.classList.toggle('hidden');
  });

  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô input ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1
  document.getElementById("machineSearch1").addEventListener("input", () => {
    filterAutocomplete('machineSearch1', 'machineList1', 'machineCodeHidden1', 'name');
  });

  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô input ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
  document.getElementById("machineSearchCode").addEventListener("input", () => {
    filterAutocomplete('machineSearchCode', 'machineListCode', 'machineCodeHiddenCode', 'code');
  });

  // ‡∏ã‡πà‡∏≠‡∏ô autocomplete lists ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å
  document.addEventListener("click", e => {
    ["machineSearch1", "machineList1", "machineSearchCode", "machineListCode"].forEach(id => {
      const el = document.getElementById(id);
      if (el && !el.contains(e.target)) {
        if (id.startsWith("machineList")) el.classList.remove("show");
      }
    });
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
  document.getElementById("btnAddPart").addEventListener("click", addPartRow);

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  async function init() {
    await loadDepartments();
    await loadUnits();
    await loadTechnicians();
    await generateNextRequestNumber();
    await loadJobTypes();  // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  }

  init();

</script>
</body>
</html>
