<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #f0f9ff; min-height: 100vh; }
    .tech-checkboxes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .tech-checkboxes > div {
      background: #f9fafb;
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .parts-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .parts-row > * {
      flex: 1 1 120px;
    }
    .btn-remove-part {
      background: #ef4444;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-remove-part:hover {
      background: #b91c1c;
    }
    #machineList, #deptList {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 4px;
      background: white;
      position: absolute;
      width: 100%;
      z-index: 10;
    }
    #deptList.show, #machineList:not(.hidden) {
      display: block;
    }
    #deptList, #machineList {
      display: none;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‡πÅ‡∏•‡∏∞ focus */
    input, textarea, select {
      font-size: 0.875rem; /* text-sm */
      padding: 0.375rem 0.5rem; /* p-1.5 */
      background-color: #eff6ff; /* bg-blue-50 */
      border: 1px solid #cbd5e0; /* border-gray-300 */
      border-radius: 0.375rem; /* rounded-md */
      transition: 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #3b82f6; /* focus:ring-blue-500 */
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
      background-color: #ffffff;
    }
    /* ‡∏ä‡πà‡∏≠‡∏á textarea ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
    textarea {
      min-height: 3rem;
    }
  </style>
</head>
<body>
  <main class="max-w-6xl mx-auto mt-10 p-6 bg-white rounded-xl shadow">
    <h1 class="text-2xl font-bold text-blue-700 text-center mb-6">üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h1>
    <form id="repairForm" class="grid grid-cols-1 gap-6" autocomplete="off">
      <div>
        <label class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" readonly class="w-full bg-gray-100" />
      </div>
      <div>
        <label for="deptSearch" class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
        <div class="relative">
          <input type="text" id="deptSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å..." class="w-full" required />
          <ul id="deptList"></ul>
        </div>
        <input type="hidden" id="deptCodeHidden" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" required />
      </div>
      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <div class="relative">
          <input type="text" id="machineSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." class="w-full" required />
          <ul id="machineList" class="absolute"></ul>
        </div>
        <input type="hidden" name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" id="machineCodeHidden" required />
      </div>
      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢" class="w-full" rows="3" required></textarea>
      </div>
      <div>
        <label class="font-semibold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏" class="w-full" rows="2" required></textarea>
      </div>
      <div>
        <label class="font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô)</label>
        <div id="techCheckboxes" class="tech-checkboxes"></div>
      </div>
      <div>
        <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
        <div id="partsContainer"></div>
        <button type="button" id="btnAddPart" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
      </div>
      <div class="text-center mt-4">
        <button type="submit" id="submitBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-lg text-lg">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </form>
  </main>

  <script>
    const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
    const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
    const apiBase = `https://api.appsheet.com/api/v2/apps/${appId}/tables/`;

    let deptList = [], machineList = [], empList = [];

    const $ = id => document.getElementById(id);

    async function fetchFromTable(table) {
      try {
        const res = await fetch(`${apiBase}${table}/Find`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey
          },
          body: JSON.stringify({})
        });
        if (!res.ok) return [];
        return res.json();
      } catch {
        return [];
      }
    }

    async function generateNextRequestNumber() {
      const list = await fetchFromTable("Machinesymptom");
      const nums = list.map(r => parseInt(r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"])).filter(n => !isNaN(n));
      const nextNum = (Math.max(...nums, 0) + 1).toString();
      $("repairForm").querySelector('input[name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]').value = nextNum;
    }

    async function loadDepartments() {
      deptList = await fetchFromTable("Department");
    }

    $("deptSearch").addEventListener("input", e => {
      const val = e.target.value.toLowerCase();
      const filtered = deptList.filter(d =>
        `${d.NickName || ""} ${d.DeptName || ""}`.toLowerCase().includes(val)
      );
      const ul = $("deptList");
      ul.innerHTML = "";
      filtered.forEach(d => {
        const li = document.createElement("li");
        li.textContent = `${d.NickName || ""} : ${d.DeptName || ""}`;
        li.dataset.code = d.DeptCode;
        li.className = "px-3 py-2 hover:bg-blue-100 cursor-pointer";
        li.onclick = () => {
          $("deptSearch").value = li.textContent;
          $("deptCodeHidden").value = li.dataset.code;
          ul.classList.remove("show");
          loadMachinesByDept(li.dataset.code);
        };
        ul.appendChild(li);
      });
      ul.classList.add("show");
    });

    document.addEventListener("click", e => {
      if (!e.target.closest("#deptSearch") && !e.target.closest("#deptList")) {
        $("deptList").classList.remove("show");
      }
      if (!e.target.closest("#machineSearch") && !e.target.closest("#machineList")) {
        $("machineList").classList.add("hidden");
      }
    });

    async function loadMachinesByDept(code) {
      const list = await fetchFromTable("MachineMaster");
      machineList = list.filter(m => m.DeptCode === code);
      renderMachineList(machineList);
    }

    function renderMachineList(list) {
      const ul = $("machineList");
      ul.innerHTML = "";
      if (!list.length) return ul.classList.add("hidden");
      list.forEach(m => {
        const li = document.createElement("li");
        li.textContent = m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"];
        li.dataset.code = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
        li.className = "px-3 py-2 hover:bg-blue-100 cursor-pointer";
        li.onclick = () => {
          $("machineSearch").value = li.textContent;
          $("machineCodeHidden").value = li.dataset.code;
          ul.classList.add("hidden");
        };
        ul.appendChild(li);
      });
      ul.classList.remove("hidden");
    }

    $("machineSearch").addEventListener("input", () => {
      const val = $("machineSearch").value.toLowerCase();
      const filtered = machineList.filter(m =>
        `${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]} ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]}`.toLowerCase().includes(val)
      );
      renderMachineList(filtered);
    });

    async function loadTechnicians() {
      const all = await fetchFromTable("Emp");
      empList = all.filter(e => e.EmpStatus === 0 || e.EmpStatus === "0");
      const container = $("techCheckboxes");
      container.innerHTML = "";

      empList.forEach(emp => {
        const id = `emp_${emp.EmpCode}`;
        const wrapper = document.createElement("div");

        const label = document.createElement("label");
        label.className = "inline-flex items-center space-x-2 font-semibold";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö";
        checkbox.value = emp.EmpCode;
        checkbox.id = id;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(emp.EmpName));
        wrapper.appendChild(label);

        const comment = document.createElement("textarea");
        comment.name = `comment_${emp.EmpCode}`;
        comment.placeholder = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô";
        comment.className = "w-full mt-2 text-sm";
        wrapper.appendChild(comment);

        const dates = document.createElement("div");
        dates.className = "flex gap-4 mt-2 flex-wrap";

        ["start", "end"].forEach(type => {
          const box = document.createElement("div");
          box.className = "flex flex-col flex-1 min-w-[120px]";
          box.innerHTML = `<label class="text-xs font-semibold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà${type === "start" ? "‡πÄ‡∏£‡∏¥‡πà‡∏°" : "‡∏à‡∏ö"}</label>
            <input type="datetime-local" name="${type}_${emp.EmpCode}" class="text-sm" />`;
          dates.appendChild(box);
        });

        wrapper.appendChild(dates);

        const status = document.createElement("div");
        status.className = "mt-2 font-semibold";
        status.textContent = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á:";
        wrapper.appendChild(status);

        const radioWrapper = document.createElement("div");
        radioWrapper.className = "flex gap-4 mt-1";
        ["‡∏à‡∏ö‡∏á‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô"].forEach(val => {
          const span = document.createElement("label");
          span.className = "inline-flex items-center space-x-1 cursor-pointer";
          span.innerHTML = `<input type="radio" name="status_${emp.EmpCode}" value="${val}"> ${val}`;
          radioWrapper.appendChild(span);
        });

        wrapper.appendChild(radioWrapper);
        container.appendChild(wrapper);
      });

      container.addEventListener("change", e => {
        if (e.target.name === "‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö") {
          const selected = container.querySelectorAll('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]:checked');
          if (selected.length > 3) {
            e.target.checked = false;
            alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
          }
        }
      });
    }

    function createPartRow() {
      const div = document.createElement("div");
      div.className = "parts-row";
      div.innerHTML = `
        <input type="text" name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" />
        <input type="number" name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" min="1" value="1" />
        <input type="text" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" />
        <button type="button" class="btn-remove-part" title="‡∏•‡∏ö">x</button>`;
      div.querySelector("button").onclick = () => div.remove();
      return div;
    }

    $("btnAddPart").addEventListener("click", () => {
      $("partsContainer").appendChild(createPartRow());
    });

    function resetSubmitButton() {
      $("submitBtn").disabled = false;
      $("submitBtn").textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    }

    async function submitAllData(formData) {
      $("submitBtn").disabled = true;
      $("submitBtn").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

      if (!formData.get("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°")) {
        alert("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        resetSubmitButton();
        return;
      }
      if (!formData.get("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô")) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô");
        resetSubmitButton();
        return;
      }
      if (!formData.get("‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á")) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£");
        resetSubmitButton();
        return;
      }
      if (!formData.get("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢")) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢");
        resetSubmitButton();
        return;
      }
      if (!formData.get("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏")) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏");
        resetSubmitButton();
        return;
      }

      const selectedTechs = formData.getAll("‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö");
      if (selectedTechs.length === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô");
        resetSubmitButton();
        return;
      }
      if (selectedTechs.length > 3) {
        alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        resetSubmitButton();
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      for (const empCode of selectedTechs) {
        const comment = formData.get(`comment_${empCode}`) || "";
        const startDate = formData.get(`start_${empCode}`) || "";
        const endDate = formData.get(`end_${empCode}`) || "";
        const status = formData.get(`status_${empCode}`) || "";

        if (comment.trim() === "") {
          alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á ‡∏£‡∏´‡∏±‡∏™ ${empCode}`);
          resetSubmitButton();
          return;
        }
        if (startDate.trim() === "") {
          alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á ‡∏£‡∏´‡∏±‡∏™ ${empCode}`);
          resetSubmitButton();
          return;
        }
        if (endDate.trim() === "") {
          alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á ‡∏£‡∏´‡∏±‡∏™ ${empCode}`);
          resetSubmitButton();
          return;
        }
        if (status.trim() === "") {
          alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á ‡∏£‡∏´‡∏±‡∏™ ${empCode}`);
          resetSubmitButton();
          return;
        }
      }

      try {
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Machinesymptom
        const machineRow = {
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": formData.get("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"),
          "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": formData.get("‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"),
          "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": formData.get("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"),
          "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": formData.get("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"),
          "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": formData.get("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏")
        };
        const payloadMachine = {
          Action: "Add",
          Properties: {},
          Rows: [machineRow]
        };
        let res = await fetch(`${apiBase}Machinesymptom/Action`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey
          },
          body: JSON.stringify(payloadMachine)
        });
        if (!res.ok) throw new Error("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Machinesymptom ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairTechnicians
        const technicians = [];
        empList.forEach(emp => {
          if (selectedTechs.includes(emp.EmpCode)) {
            technicians.push({
              "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": formData.get("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"),
              "EmpCode": emp.EmpCode,
              "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": formData.get(`comment_${emp.EmpCode}`) || "",
              "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": formData.get(`start_${emp.EmpCode}`) || "",
              "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": formData.get(`end_${emp.EmpCode}`) || "",
              "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": formData.get(`status_${emp.EmpCode}`) || ""
            });
          }
        });
        const payloadTech = {
          Action: "Add",
          Properties: {},
          Rows: technicians
        };
        if (technicians.length > 0) {
          res = await fetch(`${apiBase}RepairTechnicians/Action`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ApplicationAccessKey": apiKey
            },
            body: JSON.stringify(payloadTech)
          });
          if (!res.ok) throw new Error("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairTechnicians ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairParts
        const partsRows = document.querySelectorAll(".parts-row");
        const parts = [];
        selectedTechs.forEach(empCode => {
          let seq = 1;
          partsRows.forEach(div => {
            const partName = div.querySelector('input[name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"]').value.trim();
            const qty = div.querySelector('input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]').value.trim();
            const unit = div.querySelector('input[name="‡∏´‡∏ô‡πà‡∏ß‡∏¢"]').value.trim();
            if (partName) {
              parts.push({
                "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": formData.get("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"),
                "EmpCode": empCode,
                "Seq": seq++,
                "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": partName,
                "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": qty,
                "‡∏´‡∏ô‡πà‡∏ß‡∏¢": unit
              });
            }
          });
        });
        const payloadParts = {
          Action: "Add",
          Properties: {},
          Rows: parts
        };
        if (parts.length > 0) {
          res = await fetch(`${apiBase}RepairParts/Action`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ApplicationAccessKey": apiKey
            },
            body: JSON.stringify(payloadParts)
          });
          if (!res.ok) throw new Error("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RepairParts ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }

        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        location.reload();

      } catch (err) {
        alert(err.message);
        resetSubmitButton();
      }
    }

    document.getElementById("repairForm").addEventListener("submit", e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      submitAllData(formData);
    });

    async function init() {
      await loadDepartments();
      await generateNextRequestNumber();
      await loadTechnicians();
    }

    init();
  </script>
</body>
</html>
