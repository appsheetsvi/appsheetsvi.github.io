<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
<style>
body { font-family:'Sarabun',sans-serif; background:#f0f9ff; min-height:100vh; }
input, textarea, select { font-size:0.875rem; padding:0.375rem 0.5rem; border-radius:0.375rem; }
input:focus, textarea:focus, select:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,0.4); background:#fff; }
textarea { min-height:3rem; }
.parts-row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
.parts-row > * { flex:1 1 120px; }
.btn-remove-part { background:#ef4444;color:white;padding:4px 8px;border-radius:6px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center; }
.btn-remove-part:hover { background:#b91c1c; }
.tech-checkboxes > div { background:#f9fafb; border:1px solid #ccc; padding:12px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.05); margin-bottom:6px; }
.machine-container { border:1px solid #ccc; padding:12px; border-radius:10px; margin-bottom:12px; background:#fff; position:relative; }
.btn-remove-machine { position:absolute; top:8px; right:8px; background:#ef4444; color:white; padding:2px 6px; border-radius:6px; cursor:pointer; }
.btn-remove-machine:hover { background:#b91c1c; }
</style>
</head>
<body>
<nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
<a href="#" class="font-semibold">üè† Home</a>
<div class="font-semibold text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
<div></div>
</nav>

<main class="max-w-7xl mx-auto mt-6 p-6 bg-white rounded-xl shadow">
<h1 class="text-2xl font-bold text-blue-700 text-center mb-6">üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h1>

<form id="repairForm" class="grid gap-6" autocomplete="off">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <div>
    <label class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
    <input name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" readonly class="w-full bg-gray-100"/>
  </div>
  <div>
    <label class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
    <div class="relative">
      <input type="text" id="deptSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å..." class="w-full" required/>
      <ul id="deptList" class="absolute w-full bg-white max-h-40 overflow-y-auto border rounded z-10 hidden"></ul>
    </div>
    <input type="hidden" id="deptCodeHidden" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"/>
  </div>
</div>

<div id="machinesContainer"></div>

<div class="flex gap-4 flex-wrap">
  <button type="button" id="btnAddMachine" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</button>
  <button type="button" id="btnResetForm" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">‚ôªÔ∏è Reset Form</button>
  <button type="submit" id="submitBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>
</form>
</main>

<script>
const appId="ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
const apiKey="V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
const apiBase=`https://api.appsheet.com/api/v2/apps/${appId}/tables/`;
let deptList=[], machineList=[], empList=[];
const $=id=>document.getElementById(id);

// Fetch from table
async function fetchFromTable(table){ 
  try{
    const res=await fetch(`${apiBase}${table}/Find`,{
      method:"POST",
      headers:{"Content-Type":"application/json","ApplicationAccessKey":apiKey},
      body:JSON.stringify({})
    });
    if(!res.ok) return [];
    return res.json();
  }catch{return [];}
}

// Generate Request Number
async function generateNextRequestNumber(){
  const list=await fetchFromTable("RepairTechnicians");
  const nums=list.map(r=>parseInt(r["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"])).filter(n=>!isNaN(n));
  const nextNum=(Math.max(...nums,0)+1).toString();
  $("repairForm").querySelector('input[name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]').value=nextNum;
}

// Load Departments, Machines, Technicians
async function loadDepartments(){ deptList=await fetchFromTable("Department"); }
async function loadMachinesByDept(code){ 
  const list=await fetchFromTable("MachineMaster");
  machineList=list.filter(m=>m.DeptCode===code);
}
async function loadTechnicians(){ 
  const all=await fetchFromTable("Emp");
  empList=all.filter(e=>e.EmpStatus==0 && e.DeptCode==="A12"); 
}

// Create Part Row
function createPartRow(){
  const div=document.createElement("div");
  div.className="parts-row";
  div.innerHTML=`<input type="text" name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"/>
    <input type="number" name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" min="1" value="1"/>
    <input type="text" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢"/>
    <button type="button" class="btn-remove-part">x</button>`;
  div.querySelector("button").onclick=()=>div.remove();
  return div;
}

// Create Machine Row
function createMachineRow(){
  const div=document.createElement("div");
  div.className="machine-container";
  div.innerHTML=`<button type="button" class="btn-remove-machine">x</button>
    <label class="font-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
    <div class="relative">
      <input type="text" class="machineSearch w-full" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." required/>
      <ul class="machineList absolute w-full bg-white max-h-40 overflow-y-auto border rounded z-10 hidden"></ul>
    </div>
    <input type="hidden" name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" class="machineCodeHidden" required/>
    <label class="font-semibold mt-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
    <textarea name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢" class="w-full" rows="2" required></textarea>
    <label class="font-semibold mt-2">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
    <textarea name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏" class="w-full" rows="2" required></textarea>
    <label class="font-semibold mt-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô)</label>
    <div class="techCheckboxes tech-checkboxes mb-2"></div>
    <label class="font-semibold mt-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label>
    <div class="partsContainer"></div>
    <button type="button" class="btnAddPart mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>`;
  div.querySelector(".btn-remove-machine").onclick=()=>div.remove();
  div.querySelector(".btnAddPart").onclick=()=>div.querySelector(".partsContainer").appendChild(createPartRow());
  renderTechCheckboxes(div.querySelector(".techCheckboxes"));
  return div;
}

// Render Technicians
function renderTechCheckboxes(container){
  container.innerHTML="";
  empList.forEach(emp=>{
    const wrapper=document.createElement("div"); wrapper.className="mb-2 p-2 border rounded shadow bg-gray-50";
    const label=document.createElement("label"); label.className="inline-flex items-center space-x-2 font-semibold";
    const checkbox=document.createElement("input"); checkbox.type="checkbox"; checkbox.name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"; checkbox.value=emp.EmpCode;
    label.appendChild(checkbox); label.appendChild(document.createTextNode(emp.EmpName));
    wrapper.appendChild(label);

    const comment=document.createElement("textarea"); comment.name=`comment_${emp.EmpCode}`; comment.placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"; comment.className="w-full mt-1 text-sm";
    wrapper.appendChild(comment);

    ["start","end"].forEach(type=>{
      const box=document.createElement("div"); box.className="flex flex-col flex-1 min-w-[120px] mt-1";
      box.innerHTML=`<label class="text-xs font-semibold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà${type==="start"?"‡πÄ‡∏£‡∏¥‡πà‡∏°":"‡∏à‡∏ö"}</label>
        <input type="datetime-local" name="${type}_${emp.EmpCode}" class="text-sm"/>`;
      wrapper.appendChild(box);
    });

    // --- Checkbox ‡∏≠‡∏¥‡∏™‡∏£‡∏∞ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á
    const statusWrapper=document.createElement("div"); 
    statusWrapper.className="flex gap-4 mt-1";
    ["‡∏à‡∏ö‡∏á‡∏≤‡∏ô","‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô"].forEach(val=>{
      const span=document.createElement("label"); 
      span.className="inline-flex items-center space-x-1 cursor-pointer";
      span.innerHTML=`<input type="checkbox" name="status_${emp.EmpCode}" value="${val}"> ${val}`;
      statusWrapper.appendChild(span);
    });
    wrapper.appendChild(statusWrapper);

    const copyWrapper=document.createElement("div"); copyWrapper.className="mt-1";
    copyWrapper.innerHTML=`<label class="inline-flex items-center space-x-2"><input type="checkbox" name="autoCopy_${emp.EmpCode}"/> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</label>`;
    wrapper.appendChild(copyWrapper);

    container.appendChild(wrapper);

    // Copy logic ‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡πà‡∏≤‡∏á
    copyWrapper.querySelector('input').addEventListener("change", ()=>{
      const checked = copyWrapper.querySelector('input').checked;
      if(!checked) return;
      const machineContainer = wrapper.closest(".machine-container");
      const allTechs = machineContainer.querySelectorAll('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]');
      const sourceCode = emp.EmpCode;
      const sourceComment = wrapper.querySelector(`textarea[name="comment_${sourceCode}"]`).value;
      const sourceStart = wrapper.querySelector(`input[name="start_${sourceCode}"]`).value;
      const sourceEnd = wrapper.querySelector(`input[name="end_${sourceCode}"]`).value;
      const sourceStatus = [...wrapper.querySelectorAll(`input[name="status_${sourceCode}"]:checked`)].map(c=>c.value).join(",");

      allTechs.forEach(t=>{
        if(t.value !== sourceCode){
          const tWrapper = t.closest("div");
          tWrapper.querySelector(`textarea[name="comment_${t.value}"]`).value = sourceComment;
          tWrapper.querySelector(`input[name="start_${t.value}"]`).value = sourceStart;
          tWrapper.querySelector(`input[name="end_${t.value}"]`).value = sourceEnd;
          // Copy Checkbox status
          tWrapper.querySelectorAll(`input[name="status_${t.value}"]`).forEach(cb=>{
            cb.checked = sourceStatus.split(",").includes(cb.value);
          });
        }
      });
    });
  });

  container.addEventListener("change", e=>{
    if(e.target.name==="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"){
      const selected=container.querySelectorAll('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]:checked');
      if(selected.length>3){ e.target.checked=false; alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); }
    }
    if(e.target.name.startsWith("end_")){
      const code = e.target.name.replace("end_","");
      const startInput = container.querySelector(`input[name="start_${code}"]`);
      if(startInput.value && e.target.value && e.target.value < startInput.value){
        alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°"); e.target.value="";
      }
    }
  });
}

// --- Add Machine
$("btnAddMachine").addEventListener("click", async ()=>{
  const code=$("deptCodeHidden").value; if(!code){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô"); return; }
  await loadMachinesByDept(code); await loadTechnicians();
  const row=createMachineRow();
  $("machinesContainer").appendChild(row);

  const searchInput=row.querySelector(".machineSearch");
  const ul=row.querySelector(".machineList");
  const hiddenInput=row.querySelector(".machineCodeHidden");

  searchInput.addEventListener("input", ()=>{
    const val=searchInput.value.toLowerCase();
    const filtered=machineList.filter(m=>(`${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]} ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]}`).toLowerCase().includes(val));
    ul.innerHTML="";
    filtered.forEach(m=>{
      const li=document.createElement("li");
      li.textContent=`${m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]} : ${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"]}`;
      li.dataset.code=m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      li.className="px-3 py-1 hover:bg-blue-100 cursor-pointer";
      li.onclick=()=>{ searchInput.value=li.textContent; hiddenInput.value=li.dataset.code; ul.classList.add("hidden"); };
      ul.appendChild(li);
    });
    ul.classList.toggle("hidden", filtered.length===0);
  });
});

// --- Department Search
$("deptSearch").addEventListener("input", e=>{
  const val=e.target.value.toLowerCase();
  const filtered=deptList.filter(d=>`${d.NickName||""} : ${d.DeptName||""}`.toLowerCase().includes(val));
  const ul=$("deptList"); ul.innerHTML="";
  filtered.forEach(d=>{
    const li=document.createElement("li");
    li.textContent=`${d.NickName} : ${d.DeptName}`;
    li.dataset.code=d.DeptCode;
    li.className="px-3 py-1 hover:bg-blue-100 cursor-pointer";
    li.onclick=()=>{ $("deptSearch").value=li.textContent; $("deptCodeHidden").value=li.dataset.code; ul.classList.add("hidden"); };
    ul.appendChild(li);
  });
  $("deptList").classList.remove("hidden");
});

// --- Reset Form
$("btnResetForm").addEventListener("click", ()=>{
  $("repairForm").reset();
  $("machinesContainer").innerHTML="";
  generateNextRequestNumber();
});

// --- Submit ‡πÅ‡∏ö‡∏ö batch
$("repairForm").addEventListener("submit", async e => {
  e.preventDefault();
  const submitBtn = $("submitBtn");
  submitBtn.disabled = true;
  submitBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

  try {
    const form = $("repairForm");
    const reqNum = form.querySelector('input[name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]').value;
    const dept = $("deptCodeHidden").value;
    const machines = [...form.querySelectorAll(".machine-container")];

    let techniciansRows = [];
    let partsRows = [];

    for (const machine of machines) {
      const machineCode = machine.querySelector(".machineCodeHidden").value;
      const detail = machine.querySelector('textarea[name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"]').value;
      const cause = machine.querySelector('textarea[name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"]').value;

      const techs = [...machine.querySelectorAll('input[name="‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"]:checked')].map(checkbox => {
        const code = checkbox.value;
        return {
          EmpCode: code,
          comment: machine.querySelector(`textarea[name="comment_${code}"]`).value,
          start: machine.querySelector(`input[name="start_${code}"]`).value,
          end: machine.querySelector(`input[name="end_${code}"]`).value,
          status: [...machine.querySelectorAll(`input[name="status_${code}"]:checked`)].map(c=>c.value).join(",") || ""
        };
      });

      const parts = [...machine.querySelectorAll(".parts-row")].map((p, idx) => ({
        Seq: idx + 1,
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà: p.querySelector('input[name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà"]').value,
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: p.querySelector('input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]').value,
        ‡∏´‡∏ô‡πà‡∏ß‡∏¢: p.querySelector('input[name="‡∏´‡∏ô‡πà‡∏ß‡∏¢"]').value
      }));

      techs.forEach(t => {
        techniciansRows.push({
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNum,
          "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": dept,
          "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
          "EmpCode": t.EmpCode,
          "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": detail,
          "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": cause,
          "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": t.comment,
          "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°": t.start,
          "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö": t.end,
          "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á": t.status
        });

        parts.forEach(p => {
          partsRows.push({
            "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": reqNum,
            "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": machineCode,
            "EmpCode": t.EmpCode,
            "Seq": p.Seq,
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà": p.‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà,
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": p.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô,
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢": p.‡∏´‡∏ô‡πà‡∏ß‡∏¢
          });
        });
      });
    }

    if (techniciansRows.length > 0) {
      await fetch(`${apiBase}RepairTechnicians/Rows`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
        body: JSON.stringify({ "Action": "Add", "Properties": {}, "Rows": techniciansRows })
      });
    }

    if (partsRows.length > 0) {
      await fetch(`${apiBase}RepairParts/Rows`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "ApplicationAccessKey": apiKey },
        body: JSON.stringify({ "Action": "Add", "Properties": {}, "Rows": partsRows })
      });
    }

    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    form.reset();
    $("machinesContainer").innerHTML = "";
    generateNextRequestNumber();
  } catch (err) {
    console.error(err);
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }

  submitBtn.disabled = false;
  submitBtn.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
});

// --- Init
(async()=>{
  await loadDepartments();
  generateNextRequestNumber();
})();
</script>
</body>
</html>
