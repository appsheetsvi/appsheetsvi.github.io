<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f0f9ff;
      min-height: 100vh;
      padding: 1rem;
    }
    main {
      max-width: 700px;
      margin: auto;
      background: white;
      border-radius: 1rem;
      padding: 2rem 2.5rem;
      box-shadow: 0 8px 20px rgb(14 165 233 / 0.3);
    }
    h1 {
      color: #2563eb;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: #1e40af;
    }
    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select,
    textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 2px solid #93c5fd;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="datetime-local"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 8px #3b82f6aa;
      background-color: #f0f9ff;
    }
    input[readonly] {
      background-color: #e0e7ff;
      cursor: not-allowed;
      color: #4b5563;
    }
    .select-searchable {
      position: relative;
    }
    .select-searchable ul {
      position: absolute;
      top: 105%;
      left: 0;
      right: 0;
      background: white;
      border: 1.5px solid #93c5fd;
      border-radius: 0.5rem;
      max-height: 220px;
      overflow-y: auto;
      z-index: 9999;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      margin-top: 0.25rem;
      list-style: none;
      padding-left: 0;
      display: none;
    }
    .select-searchable ul.show {
      display: block;
    }
    .select-searchable li {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    .select-searchable li:hover {
      background-color: #bfdbfe;
    }
    button[type="submit"],
    button#addPartBtn {
      background: #2563eb;
      color: white;
      font-weight: 600;
      border-radius: 0.75rem;
      padding: 0.6rem 1.5rem;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 10px rgb(37 99 235 / 0.4);
      border: none;
      cursor: pointer;
      margin-top: 1rem;
    }
    button[type="submit"]:hover,
    button#addPartBtn:hover {
      background: #1e40af;
      box-shadow: 0 5px 15px rgb(30 64 175 / 0.7);
    }
    .footer-text {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.8rem;
      color: #64748b;
      user-select: none;
    }
    #technicianList > div,
    #partsList > div {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
    }
    #partsList select {
      flex-grow: 1;
    }
    #partsList input[type=number] {
      width: 4rem;
      padding: 0.25rem 0.5rem;
    }
    .btn-remove-part {
      background: #dc2626;
      color: white;
      font-weight: 700;
      border-radius: 0.5rem;
      border: none;
      padding: 0.2rem 0.5rem;
      cursor: pointer;
    }
    .btn-remove-part:hover {
      background: #b91c1c;
    }
  </style>
</head>
<body>
  <main>
    <h1 class="text-center text-3xl mb-8">üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</h1>
    <form id="repairForm" autocomplete="off" novalidate>

      <!-- ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° -->
      <div class="mb-4">
        <label for="requestNo">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input id="requestNo" name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" readonly placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ" required />
      </div>

      <!-- ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô autocomplete -->
      <div class="mb-4">
        <label for="deptSearch">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
        <div class="select-searchable">
          <input type="text" id="deptSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å..." autocomplete="off" required />
          <ul id="deptList"></ul>
        </div>
        <input type="hidden" id="deptCodeHidden" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" required />
      </div>

      <!-- ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (searchable) -->
      <div class="mb-4">
        <label for="machineSearch">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <div class="select-searchable">
          <input type="text" id="machineSearch" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." autocomplete="off" required />
          <ul id="machineList"></ul>
        </div>
        <input type="hidden" id="machineCodeHidden" name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" required />
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢ -->
      <div class="mb-4">
        <label for="problemDetail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea id="problemDetail" name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢" rows="3" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"></textarea>
      </div>

      <!-- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ -->
      <div class="mb-4">
        <label for="causeAnalysis">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="causeAnalysis" name="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
      </div>

      <!-- ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
      <div class="mb-4">
        <label for="repairComment">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
        <textarea id="repairComment" name="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°"></textarea>
      </div>

      <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á -->
      <div class="mb-4">
        <label for="machineStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <select id="machineStatus" name="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
          <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
          <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
          <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
        </select>
      </div>

      <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° -->
      <div class="mb-4">
        <label for="dateReport">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input type="datetime-local" id="dateReport" name="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" required />
      </div>

      <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à -->
      <div class="mb-6">
        <label for="dateFinish">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</label>
        <input type="datetime-local" id="dateFinish" name="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à" />
      </div>

      <!-- ‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (Checkbox list) -->
      <div class="mb-4">
        <label>‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
        <div id="technicianList" class="border rounded p-2 max-h-40 overflow-auto bg-white"></div>
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà -->
      <div class="mb-6">
        <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label>
        <div id="partsList" class="border rounded p-2 max-h-48 overflow-auto bg-white"></div>
        <button type="button" id="addPartBtn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
      </div>

      <button type="submit">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <p class="footer-text">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <strong>1.1</strong></p>
    </form>
  </main>

<script>
  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
  const apiBase = `https://api.appsheet.com/api/v2/apps/${appId}/tables/`;

  let deptList = [];
  let machineList = [];
  let technicianList = [];
  let partsMasterList = [];
  let partsSelected = [];

  // Fetch data from a table with optional filter
  async function fetchFromTable(table, filter = {}) {
    try {
      const res = await fetch(`${apiBase}${table}/Find`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({ filter })
      });
      if (!res.ok) throw new Error(`Fetch error: ${res.status}`);
      return await res.json();
    } catch (e) {
      console.error(e);
      return [];
    }
  }

  // Load departments for autocomplete
  async function loadDepartments() {
    deptList = await fetchFromTable("Department");
    renderDeptList([]);
  }

  function renderDeptList(filtered) {
    const ul = document.getElementById("deptList");
    ul.innerHTML = "";
    if (filtered.length === 0) {
      ul.classList.remove("show");
      return;
    }
    filtered.forEach(d => {
      const text = d.NickName || d.DeptName || d.DeptCode || "";
      const li = document.createElement("li");
      li.textContent = text;
      li.dataset.code = d.DeptCode || "";
      li.onclick = () => {
        document.getElementById("deptSearch").value = text;
        document.getElementById("deptCodeHidden").value = li.dataset.code;
        ul.classList.remove("show");
        loadMachinesByDept(li.dataset.code);
        document.getElementById("machineSearch").value = "";
        document.getElementById("machineCodeHidden").value = "";
      };
      ul.appendChild(li);
    });
    ul.classList.add("show");
  }

  document.getElementById("deptSearch").addEventListener("input", e => {
    const val = e.target.value.toLowerCase();
    if (!val) {
      renderDeptList([]);
      document.getElementById("deptCodeHidden").value = "";
      return;
    }
    const filtered = deptList.filter(d =>
      (d.NickName || d.DeptName || "").toLowerCase().includes(val)
    );
    renderDeptList(filtered);
  });

  document.addEventListener("click", e => {
    const ds = document.getElementById("deptSearch");
    const dl = document.getElementById("deptList");
    if (!ds.contains(e.target) && !dl.contains(e.target)) {
      dl.classList.remove("show");
    }
  });

  // Load machines filtered by department code
  async function loadMachinesByDept(deptCode) {
    if (!deptCode) {
      machineList = [];
      renderMachineList([]);
      return;
    }
    const list = await fetchFromTable("MachineMaster");
    machineList = list.filter(m => m.DeptCode === deptCode);
    renderMachineList([]);
  }

  function renderMachineList(filtered) {
    const ul = document.getElementById("machineList");
    ul.innerHTML = "";
    if (filtered.length === 0) {
      ul.classList.remove("show");
      return;
    }
    filtered.forEach(m => {
      const li = document.createElement("li");
      li.textContent = `${m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"] || m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]}`;
      li.dataset.code = m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"];
      li.onclick = () => {
        document.getElementById("machineSearch").value = li.textContent;
        document.getElementById("machineCodeHidden").value = li.dataset.code;
        ul.classList.remove("show");
      };
      ul.appendChild(li);
    });
    ul.classList.add("show");
  }

  document.getElementById("machineSearch").addEventListener("input", () => {
    const val = document.getElementById("machineSearch").value.toLowerCase();
    if (!val) {
      renderMachineList([]);
      document.getElementById("machineCodeHidden").value = "";
      return;
    }
    const filtered = machineList.filter(m =>
      (m["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"] + " " + (m["‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£1"] || "")).toLowerCase().includes(val)
    );
    renderMachineList(filtered);
  });

  document.addEventListener("click", e => {
    const ms = document.getElementById("machineSearch");
    const ml = document.getElementById("machineList");
    if (!ms.contains(e.target) && !ml.contains(e.target)) {
      ml.classList.remove("show");
    }
  });

  // Load technicians for checkbox list
  async function loadTechnicians() {
    technicianList = await fetchFromTable("RepairTechnicians");
    const container = document.getElementById("technicianList");
    container.innerHTML = "";
    technicianList.forEach(t => {
      const id = `tech_${t.EmpCode}`;
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = id;
      checkbox.value = t.EmpCode;
      checkbox.name = "technicians";

      const label = document.createElement("label");
      label.htmlFor = id;
      label.textContent = t.EmpName || t.EmpCode;

      const div = document.createElement("div");
      div.appendChild(checkbox);
      div.appendChild(label);
      container.appendChild(div);
    });
  }

  // Load parts master list
  async function loadPartsMaster() {
    partsMasterList = await fetchFromTable("PartsMaster");
    renderPartsList([]);
  }

  // Render parts list with selected items
  function renderPartsList(selectedParts) {
    const container = document.getElementById("partsList");
    container.innerHTML = "";
    selectedParts.forEach((part, i) => {
      const div = document.createElement("div");

      // Select part
      const select = document.createElement("select");
      select.name = `partCode_${i}`;
      select.required = true;
      partsMasterList.forEach(p => {
        const option = document.createElement("option");
        option.value = p.PartCode;
        option.textContent = p.PartName;
        if (p.PartCode === part.partCode) option.selected = true;
        select.appendChild(option);
      });

      // Input quantity
      const qtyInput = document.createElement("input");
      qtyInput.type = "number";
      qtyInput.min = 1;
      qtyInput.name = `partQty_${i}`;
      qtyInput.value = part.qty || 1;
      qtyInput.required = true;

      // Remove button
      const btnRemove = document.createElement("button");
      btnRemove.type = "button";
      btnRemove.className = "btn-remove-part";
      btnRemove.textContent = "‡∏•‡∏ö";
      btnRemove.onclick = () => {
        partsSelected.splice(i, 1);
        renderPartsList(partsSelected);
      };

      div.appendChild(select);
      div.appendChild(qtyInput);
      div.appendChild(btnRemove);
      container.appendChild(div);
    });
  }

  // Add new part item
  document.getElementById("addPartBtn").addEventListener("click", () => {
    if (partsMasterList.length === 0) {
      alert("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà");
      return;
    }
    partsSelected.push({ partCode: partsMasterList[0].PartCode, qty: 1 });
    renderPartsList(partsSelected);
  });

  // Convert local datetime to ISO string (UTC)
  function toISOStringFromLocalDatetime(localDatetime) {
    if (!localDatetime) return null;
    const dt = new Date(localDatetime);
    return dt.toISOString();
  }

  // Generate new Request Number (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢)
  async function generateRequestNo() {
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏õ‡∏µ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô + 4 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏∏‡πà‡∏°
    const now = new Date();
    const y = now.getFullYear() + 543; // ‡∏õ‡∏µ ‡∏û.‡∏®.
    const m = (now.getMonth() + 1).toString().padStart(2, "0");
    const d = now.getDate().toString().padStart(2, "0");
    const randomNum = Math.floor(1000 + Math.random() * 9000);
    return `${y}${m}${d}${randomNum}`;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  document.getElementById("repairForm").onsubmit = async e => {
    e.preventDefault();

    const form = e.target;

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
    const data = {
      "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": form["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"].value.trim(),
      "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô": form["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"].value.trim(),
      "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": form["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"].value.trim(),
      "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢": form["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"].value.trim(),
      "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏": form["‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"].value.trim(),
      "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": form["‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô"].value.trim(),
      "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á": form["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"].value,
      "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": toISOStringFromLocalDatetime(form["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"].value),
      "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à": toISOStringFromLocalDatetime(form["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à"].value),
    };

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    if (!data["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]) {
      alert("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      return;
    }
    if (!data["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"]) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô");
      return;
    }
    if (!data["‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á");
      return;
    }
    if (!data["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢"]) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢");
      return;
    }
    if (!data["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"]) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á");
      return;
    }
    if (!data["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"]) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°");
      return;
    }

    try {
      // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å Machinesymptom
      const resMain = await fetch(`${apiBase}Machinesymptom/Action`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey,
        },
        body: JSON.stringify({
          Action: "Add",
          Rows: [data],
        }),
      });
      if (!resMain.ok) throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${resMain.status})`);

      // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      const selectedTech = Array.from(form.querySelectorAll("input[name='technicians']:checked")).map(el => el.value);
      if (selectedTech.length > 0) {
        const techRows = selectedTech.map(empCode => ({
          "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": data["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"],
          "EmpCode": empCode,
        }));

        const resTech = await fetch(`${apiBase}RepairTechnicians/Action`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey,
          },
          body: JSON.stringify({
            Action: "Add",
            Rows: techRows,
          }),
        });
        if (!resTech.ok) throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${resTech.status})`);
      }

      // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      if (partsSelected.length > 0) {
        // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° partCode_X ‡πÅ‡∏•‡∏∞ partQty_X
        const partRows = [];
        for (let i = 0; i < partsSelected.length; i++) {
          const partCode = form[`partCode_${i}`]?.value;
          const qty = form[`partQty_${i}`]?.value;
          if (partCode && qty > 0) {
            partRows.push({
              "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°": data["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"],
              "PartCode": partCode,
              "Qty": Number(qty),
            });
          }
        }
        if (partRows.length > 0) {
          const resParts = await fetch(`${apiBase}RepairParts/Action`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ApplicationAccessKey": apiKey,
            },
            body: JSON.stringify({
              Action: "Add",
              Rows: partRows,
            }),
          });
          if (!resParts.ok) throw new Error(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${resParts.status})`);
        }
      }

      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      form.reset();
      partsSelected = [];
      renderPartsList(partsSelected);
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà
      const newReqNo = await generateRequestNo();
      form["‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°"].value = newReqNo;
      document.getElementById("deptCodeHidden").value = "";
      document.getElementById("machineCodeHidden").value = "";
      document.getElementById("deptSearch").value = "";
      document.getElementById("machineSearch").value = "";
    } catch (error) {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
    }
  };

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  async function init() {
    await loadDepartments();
    await loadTechnicians();
    await loadPartsMaster();
    const reqNo = await generateRequestNo();
    document.getElementById("requestNo").value = reqNo;
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å init ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
  window.onload = init;

</script>
</body>
</html>
