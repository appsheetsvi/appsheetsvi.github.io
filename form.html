<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡πà‡∏≤‡∏á</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Sarabun', sans-serif;
    margin: 0; padding: 0; background: #f7f9fc;
  }
  .navbar {
    display: flex; justify-content: space-between; align-items: center;
    background: #1976d2; color: white; padding: 0.5rem 1rem;
    font-weight: 600;
  }
  .navbar a.btn {
    color: white; background: #1565c0; text-decoration: none; padding: 0.3rem 0.8rem;
    border-radius: 4px; font-weight: 600;
  }
  .container {
    max-width: 960px; margin: 1rem auto; padding: 0 1rem;
  }
  form {
    background: white; padding: 1rem 1.5rem; border-radius: 8px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(250px,1fr));
    gap: 1rem;
  }
  .field {
    display: flex; flex-direction: column;
  }
  label {
    font-weight: 600; margin-bottom: 0.3rem; font-size: 0.9rem;
  }
  input[type=text], input[type=datetime-local], select, textarea {
    border: 1px solid #ccc; border-radius: 4px;
    padding: 0.4rem 0.6rem; font-size: 0.95rem;
    transition: border-color 0.3s;
    font-family: 'Sarabun', sans-serif;
  }
  input[type=text]:focus, input[type=datetime-local]:focus, select:focus, textarea:focus {
    outline: none; border-color: #1976d2;
    box-shadow: 0 0 5px #1976d2aa;
  }
  textarea {
    resize: vertical;
    min-height: 70px;
  }
  .field.full {
    grid-column: 1 / -1;
  }
  .tech-detail-box {
    margin-top: 1.5rem;
    border: 1px solid #ccc;
    padding: 1rem;
    border-radius: 8px;
    background: #fafafa;
  }
  .tech-detail-box h2 {
    margin-top: 0; margin-bottom: 1rem;
    color: #1976d2;
  }
  .parts-list label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
  }
  #partsContainer {
    display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.8rem;
  }
  .part-row {
    display: flex; gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .part-row input {
    flex: 1 1 150px;
    min-width: 100px;
  }
  .part-row input[name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô[]"] {
    max-width: 80px;
  }
  .part-row button.remove-btn {
    background: #d32f2f; color: white;
    border: none; border-radius: 4px;
    padding: 0.2rem 0.5rem;
    cursor: pointer;
    font-weight: 700;
    font-size: 1.1rem;
    line-height: 1;
    height: 30px;
    width: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .add-part-btn {
    background: #1976d2; color: white;
    border: none; border-radius: 4px;
    padding: 0.4rem 0.8rem;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    margin-top: 0.4rem;
    display: inline-block;
  }
  .submit-btn {
    margin-top: 1.5rem;
    text-align: center;
  }
  .submit-btn button {
    background: #1976d2;
    color: white;
    border: none;
    padding: 0.8rem 2rem;
    font-size: 1.1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  .submit-btn button:hover {
    background: #115293;
  }
  /* For mobile smaller input font and spacing */
  @media (max-width: 480px) {
    .form-grid {
      grid-template-columns: 1fr !important;
    }
    .part-row input {
      flex: 1 1 100%;
      min-width: auto;
    }
    .part-row button.remove-btn {
      width: 28px;
      height: 28px;
      font-size: 1rem;
    }
    .submit-btn button {
      width: 100%;
    }
  }
  /* dropdown autocomplete styling */
  #machineSelect {
    border: 1px solid #ccc;
    border-radius: 4px;
    max-height: 140px;
    overflow-y: auto;
  }
  #machineSelect option {
    padding: 0.3rem;
    cursor: pointer;
  }
  #machineSelect option:hover {
    background-color: #1976d2;
    color: white;
  }
</style>
</head>
<body>

<nav class="navbar">
  <div>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡πà‡∏≤‡∏á</div>
  <div>
    üë§ ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="empCodeDisplay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
    <a href="menu.html" class="btn" style="margin-left: 1rem;">üè† ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
  </div>
</nav>

<div class="container">
  <form id="techForm">
    <div class="form-grid">
      <div class="field">
        <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
        <input type="text" name="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" id="requestNumber" readonly required />
      </div>
      <div class="field">
        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
        <select name="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" id="deptSelect" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>
        </select>
      </div>
      <div class="field">
        <label>‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label>
        <select name="‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô" id="jobTypeSelect" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô --</option>
        </select>
      </div>
      <div class="field">
        <label>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
        <select name="‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç" required>
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">üö® ‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
          <option value="‡∏î‡πà‡∏ß‡∏ô">‚ö†Ô∏è ‡∏î‡πà‡∏ß‡∏ô</option>
          <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô">‚è≥ ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</option>
        </select>
      </div>
      <div class="field">
        <label>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
        <input type="text" id="machineSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." autocomplete="off" required />
        <select name="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" id="machineSelect" size="5" style="display:none; margin-top: 0.3rem; font-size: 0.9rem; cursor:pointer;"></select>
      </div>
      <div class="field full">
        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label>
        <textarea name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢" rows="3" required></textarea>
      </div>
    </div>

    <div class="tech-detail-box">
      <h2>üß∞ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡πà‡∏≤‡∏á</h2>
      <div class="field full">
        <label>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
        <textarea name="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô" rows="3"></textarea>
      </div>
      <div class="parts-list">
        <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
        <div id="partsContainer"></div>
        <button type="button" onclick="addPart()" class="add-part-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</button>
      </div>
      <div class="form-grid">
        <div class="field">
          <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
          <input type="datetime-local" name="‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°" />
        </div>
        <div class="field">
          <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</label>
          <input type="datetime-local" name="‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö" />
        </div>
        <div class="field">
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á</label>
          <select name="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
            <option value="‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</option>
            <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
          </select>
        </div>
      </div>
    </div>

    <div class="submit-btn">
      <button type="submit">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </form>
</div>

<script>
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• login ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô navbar
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || !user.EmpCode) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
    window.location.href = "login.html";
  } else {
    const empCodeDisplay = document.getElementById("empCodeDisplay");
    const fullName = `${user.TitleName || ""} ${user.EmpName || ""} ${user.LastName || ""}`.trim();
    empCodeDisplay.textContent = `${user.EmpCode} ${fullName}`;
  }

  const appId = "ae5d7dce-1c12-4c53-b201-5a2d7c5b5411";
  const apiKey = "V2-b1wGR-Nj1SR-0MhEx-QWCHT-Mllly-cZnc9-PHCAK-r1f85";
  const baseUrl = `https://api.appsheet.com/api/v2/apps/${appId}/tables/`;

  const jobTypeMap = new Map();
  let machineList = [];

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  async function fetchFromTable(table) {
    const res = await fetch(`${baseUrl}${table}/Find`, {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
        "ApplicationAccessKey": apiKey
      },
      body: JSON.stringify({})
    });
    return res.ok ? await res.json() : [];
  }

  async function init() {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î empCode
    const empCode = user.EmpCode;

    // ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î +1
    const ms = await fetchFromTable('Machinesymptom');
    const last = ms.map(r => r['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°']).filter(Boolean).sort().pop();
    const next = last ? String(parseInt(last) + 1).padStart(7, '0') : '2506001';
    document.getElementById('requestNumber').value = next;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
    const depts = await fetchFromTable('Department');
    const sd = document.getElementById('deptSelect');
    sd.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>`;
    depts.filter(d => d.DeptNameEng).sort((a, b) => a.DeptNameEng.localeCompare(b.DeptNameEng))
      .forEach(d => sd.innerHTML += `<option value="${d.DeptCode}">${d.DeptNameEng}</option>`);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô
    const jts = await fetchFromTable('MachineJobType');
    const sj = document.getElementById('jobTypeSelect');
    sj.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô --</option>`;
    jts.forEach(j => {
      jobTypeMap.set(j['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô'], j['‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô']);
      sj.innerHTML += `<option value="${j['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô']}">${j['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô']}</option>`;
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    machineList = await fetchFromTable('MachineMaster');

    // event for machineSearch input
    const machineSearch = document.getElementById('machineSearch');
    const machineSelect = document.getElementById('machineSelect');

    machineSearch.addEventListener('input', () => {
      const val = machineSearch.value.trim().toLowerCase();
      if (!val) {
        machineSelect.style.display = 'none';
        machineSelect.innerHTML = '';
        return;
      }
      const filtered = machineList.filter(m =>
        m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']?.toLowerCase().includes(val) ||
        m['‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£']?.toLowerCase().includes(val)
      );
      if (filtered.length === 0) {
        machineSelect.style.display = 'none';
        machineSelect.innerHTML = '';
        return;
      }
      machineSelect.innerHTML = '';
      filtered.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'];
        opt.textContent = `${m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á']} ‚Äì ${m['‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£']}`;
        machineSelect.appendChild(opt);
      });
      machineSelect.style.display = 'block';
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å dropdown
    machineSelect.addEventListener('change', () => {
      if (machineSelect.value) {
        machineSearch.value = machineSelect.value;
        machineSelect.style.display = 'none';
      }
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å option ‡πÉ‡∏ô select ‡∏î‡πâ‡∏ß‡∏¢ mouse
    machineSelect.addEventListener('click', e => {
      if (e.target.tagName === 'OPTION') {
        machineSearch.value = e.target.value;
        machineSelect.style.display = 'none';
      }
    });

    // ‡∏ñ‡πâ‡∏≤ focus ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô select
    machineSearch.addEventListener('blur', () => {
      setTimeout(() => {
        machineSelect.style.display = 'none';
      }, 200);
    });
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
  function addPart() {
    const c = document.getElementById('partsContainer');
    const div = document.createElement('div');
    div.className = 'part-row';
    div.innerHTML = `
      <input type="text" name="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà[]" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" required/>
      <input type="number" name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required min="1" />
      <input type="text" name="‡∏´‡∏ô‡πà‡∏ß‡∏¢[]" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" required/>
      <button type="button" class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
    `;
    c.appendChild(div);
  }

  // handle form submit
  document.getElementById('techForm').addEventListener('submit', async e => {
    e.preventDefault();

    // validate ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö dropdown ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const machineSearch = document.getElementById('machineSearch');
    const machineVal = machineSearch.value.trim();
    if (!machineVal) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á');
      machineSearch.focus();
      return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    const isValidMachine = machineList.some(m => m['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'] === machineVal);
    if (!isValidMachine) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ');
      machineSearch.focus();
      return;
    }

    const f = new FormData(e.target);

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Machinesymptom
    const main = {};
    f.forEach((v, k) => {
      if (!k.includes('[]')) main[k] = v.trim();
    });

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EmpCode ‡∏à‡∏≤‡∏Å login
    main.EmpCode = user.EmpCode;

    // map ‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (jobTypeMap.has(main['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô'])) {
      main['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô'] = jobTypeMap.get(main['‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô']);
    }

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RepairTechnicians
    const tech = {
      '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°': main['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'],
      EmpCode: user.EmpCode,
      '‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô': f.get('‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô')?.trim() || '',
      '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°': f.get('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°') || null,
      '‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö': f.get('‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö') || null,
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á': f.get('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á') || ''
    };

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
    const parts = [];
    const names = f.getAll('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà[]');
    const nums = f.getAll('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô[]');
    const units = f.getAll('‡∏´‡∏ô‡πà‡∏ß‡∏¢[]');
    for (let i = 0; i < names.length; i++) {
      if (names[i].trim() === '') continue;
      parts.push({
        '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°': main['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'],
        EmpCode: user.EmpCode,
        '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà': names[i].trim(),
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: nums[i],
        ‡∏´‡∏ô‡πà‡∏ß‡∏¢: units[i].trim()
      });
    }

    try {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Machinesymptom
      await fetch(`${baseUrl}Machinesymptom/Action`, {
        method: 'POST',
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({ Action: 'Add', Properties: { Locale: 'th-TH' }, Rows: [main] })
      });

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å RepairTechnicians
      await fetch(`${baseUrl}RepairTechnicians/Action`, {
        method: 'POST',
        headers: {
          "Content-Type": "application/json",
          "ApplicationAccessKey": apiKey
        },
        body: JSON.stringify({ Action: 'Add', Properties: { Locale: 'th-TH' }, Rows: [tech] })
      });

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å RepairParts ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (parts.length > 0) {
        await fetch(`${baseUrl}RepairParts/Action`, {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
            "ApplicationAccessKey": apiKey
          },
          body: JSON.stringify({ Action: 'Add', Properties: { Locale: 'th-TH' }, Rows: parts })
        });
      }

      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      window.location.reload();

    } catch (err) {
      alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + err.message);
      console.error(err);
    }
  });

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  init();

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà 1 ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô default
  addPart();

</script>
</body>
</html>
