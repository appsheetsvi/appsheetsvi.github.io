
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>สแกน QR Code - เปิดกล้องด้วยปุ่ม</title>
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-4">

  <h1 class="text-3xl font-bold mb-6">สแกน QR Code</h1>

  <button id="btnStart" class="mb-4 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition duration-300">
    เปิดกล้องสแกน QR Code
  </button>

  <div id="status" class="mb-4 text-center text-gray-700">ยังไม่ได้เปิดกล้อง</div>

  <div id="qr-reader" class="w-80 max-w-full rounded-lg overflow-hidden shadow-lg"></div>

  <script>
    const btnStart = document.getElementById('btnStart');
    const status = document.getElementById('status');
    const qrReaderId = "qr-reader";

    let html5QrcodeScanner = null;

    btnStart.addEventListener('click', () => {
      if (html5QrcodeScanner) {
        // ถ้ากล้องเปิดอยู่แล้ว ปิดก่อนแล้วเปิดใหม่
        html5QrcodeScanner.clear().then(() => {
          startScanner();
        }).catch(err => {
          status.innerText = "ไม่สามารถปิดกล้องเดิมได้: " + err;
          status.classList.add("text-red-600");
        });
      } else {
        startScanner();
      }
    });

    function startScanner() {
      status.innerText = "กำลังเปิดกล้อง...";
      status.classList.remove("text-red-600");
      status.classList.add("text-gray-700");

      html5QrcodeScanner = new Html5Qrcode(qrReaderId);

      html5QrcodeScanner.start(
        { facingMode: "environment" }, 
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          status.innerText = "เจอ QR Code: " + qrCodeMessage;
          status.classList.remove("text-gray-700");
          status.classList.add("text-green-600");

          html5QrcodeScanner.stop().then(() => {
            // กล้องปิดแล้ว
          }).catch(err => {
            status.innerText = "เกิดข้อผิดพลาดในการปิดกล้อง: " + err;
            status.classList.add("text-red-600");
          });
        },
        errorMessage => {
          // console.log(`Error scanning: ${errorMessage}`); // ใช้ debug ถ้าต้องการ
        }
      ).then(() => {
        status.innerText = "กล้องพร้อมใช้งาน กรุณาสแกน QR Code";
        status.classList.remove("text-gray-700");
        status.classList.remove("text-red-600");
        status.classList.add("text-blue-600");
      }).catch(err => {
        status.innerText = "ไม่สามารถเปิดกล้องได้: " + err;
        status.classList.remove("text-blue-600");
        status.classList.add("text-red-600");
      });
    }
  </script>

</body>
</html>
